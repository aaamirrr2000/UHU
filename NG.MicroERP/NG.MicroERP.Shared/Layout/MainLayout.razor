@inherits LayoutComponentBase
@inject ISnackbar SnackbarService
@inject NavigationManager Nav
@inject IJSRuntime JS

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Dense=true>
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@(() => DrawerToggle())" />

        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <img src="@(Globals.Organization?.Logo ?? "")" class="company-logo" />
            <span style="margin-left:5px; font-size: 24px; color: white; letter-spacing:2px;">
                @(Globals.Organization?.Name ?? "Organization")
                @* @DateTime.Now.ToString("dddd, dd MMMM yyyy") *@
            </span>
        </MudHidden>

        <MudSpacer />

        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <a href="/@(Globals.User?.Dashboard ?? "dashboard")" class="nav-link"><i class="fas fa-home"></i></a>
            <a href="#" class="nav-link"><i class="fa-solid fa-clock"></i> Idle: @_idleDisplay</a>
            <a href="/ChangePasswordPage" class="nav-link"><i class="fas fa-key"></i></a>
            <a href="/" class="nav-link"><i class="fas fa-power-off"></i> </a>
        </MudHidden>

        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <a href="/@(Globals.User?.Dashboard ?? "dashboard")" class="nav-link"><i class="fas fa-home"></i> Home</a>
            <a href="#" class="nav-link"><i class="fa-solid fa-clock"></i> Idle: @_idleDisplay</a>
            <a href="/ChangePasswordPage" class="nav-link"><i class="fas fa-key"></i> Change Password</a>

            @* <a href="/" class="nav-link"><i class="fa-solid fa-code-merge"></i> @(Globals.Version ?? "")</a> *@
            <a href="/" class="nav-link"><i class="fas fa-power-off"></i> Log Out</a>
        </MudHidden>

        <MudThemeProvider @bind-IsDarkMode="@Globals._isDarkMode" Theme="_theme" />
        @if (true)
        {
            <MudSwitch Value="@Globals._isDarkMode"
                       ValueChanged="Save"
                       Color="Color.Primary"
                       Class="ma-4"
                       T="bool"
                       Label="Theme" />
        }
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen">
        <MyNavMenu />
    </MudDrawer>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    bool _drawerOpen = false;
    private MudTheme _theme = new();
    private DotNetObjectReference<MainLayout>? _dotNetRef;
    private string _idleDisplay = "0:00";
    private System.Threading.Timer? _refreshTimer;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (Globals.User == null)
            {
                return;
            }

            if (Globals.User.DarKLightTheme == 1)
            {
                Globals._isDarkMode = true;
            }
            else
            {
                Globals._isDarkMode = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in MainLayout OnParametersSetAsync: {ex.Message}");
        }
    }

    protected async Task Save(bool newValue)
    {
        try
        {
            if (Globals.User == null)
            {
                SnackbarService.Add("User not found. Please log in again.", Severity.Error);
                return;
            }

            Globals._isDarkMode = newValue;

            int theme = newValue ? 1 : 0;
            var theme_name = newValue ? "DARK" : "LIGHT";

            var result = await Functions.PostAsync<UsersModel>($"Users/SetTheme/{Globals.User.Id}/{theme}", null, true);
            if (!result.Success)
            {
                SnackbarService.Add("Theme not updated.", Severity.Error);
                Globals._isDarkMode = !newValue;
            }
            else
            {
                Globals.User.DarKLightTheme = theme;
                SnackbarService.Add($"Theme changed to {theme_name} mode", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error saving theme: {ex.Message}", Severity.Error);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("idleHandler.startIdleTimer", _dotNetRef);
        }
    }

    [JSInvokable]
    public void UpdateIdleTime(int seconds)
    {
        var minutes = seconds / 60;
        var secs = seconds % 60;
        _idleDisplay = $"{minutes}:{secs:D2}";

        // Force UI refresh on the Blazor render thread
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task RefreshPage()
    {
        //await JS.InvokeVoidAsync("location.reload");
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void LogoutUser()
    {
        Nav.NavigateTo("/", true);
        //JS.InvokeVoidAsync("location.replace", "/");
    }

    public void Dispose() => _dotNetRef?.Dispose();
}

<style>
    .nav-link {
        margin: 10px;
        color: white;
        text-decoration: none;
    }

    .company-logo {
        height: 40px;
    }
</style>