@inherits LayoutComponentBase
@using NG.MicroERP.Shared.Models
@inject ISnackbar SnackbarService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject Functions Functions
@inject IFormFactor FormFactor

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider/>


<MudLayout>
    <MudAppBar Elevation="2" Dense="false" Class="professional-navbar">
        <div class="navbar-content">
            <!-- Left Section: Logo and Company Name -->
            <div class="navbar-left">
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <div class="company-brand">
                        @if (!string.IsNullOrEmpty(Globals.Organization?.Logo))
                        {
            <img src="@Globals.GetImageUrl(Globals.Organization.Logo)" alt="Company Logo" class="company-logo" />
                        }
                        <div class="company-info">
                            <span class="company-name">@(Globals.Organization?.Name ?? "Organization")</span>
                            @if (!string.IsNullOrEmpty(Globals.Organization?.Description))
                            {
                                <span class="company-description">@Globals.Organization.Description</span>
                            }
                        </div>
                    </div>
        </MudHidden>
            </div>

            <!-- Center Section: Spacer -->
        <MudSpacer />

            <!-- Right Section: Actions -->
            <div class="navbar-right">
       <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <div class="navbar-actions">
                        <!-- Home Button -->
                        <MudTooltip Text="Dashboard">
                            <MudIconButton Icon="@Icons.Material.Filled.Home"
                                         Color="Color.Inherit"
                                         Hover="true"
                                         Class="navbar-action-btn"
                                         OnClick="@(() => Nav.NavigateTo($"/{Globals.User?.Dashboard ?? "dashboard"}"))" />
                        </MudTooltip>

                        <!-- Settings Menu -->
                        @if (setupParentMenus.Any())
                        {
            <MudMenu @ref="setupMenuRef"
                     OffsetY="true"
                     Dense="true"
                                     AnchorOrigin="Origin.BottomRight"
                                     TransformOrigin="Origin.TopRight">
                <ActivatorContent>
                                    <MudTooltip Text="Settings">
                    <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                   Color="Color.Inherit"
                                                     Hover="true"
                                                     Class="navbar-action-btn" />
                                    </MudTooltip>
                </ActivatorContent>

                <ChildContent>
                    <MudPaper Class="pa-6 setup-mega-menu" Style="width: fit-content; max-width: 1400px;">
                        <div class="setup-menu-grid">
                            @foreach (var parentMenu in setupParentMenus.OrderBy(x => x.SeqNo))
                            {
                                var childItems = setupMenuItems
                                    .Where(x => x.ParentId == parentMenu.MenuId)
                                    .OrderBy(x => x.SeqNo)
                                    .ToList();

                                <div class="setup-menu-column">
                                    <MudText Typo="Typo.subtitle1" Class="mb-3 fw-bold setup-menu-header">
                                        <i class="@parentMenu.Icon me-2" style="font-size: 16px;"></i>
                                        <span class="setup-menu-header-text">@parentMenu.MenuCaption</span>
                                    </MudText>

                                    <div class="setup-menu-items">
                                        @foreach (var item in childItems)
                                        {
                                            <div class="setup-menu-item"
                                                 @onclick="@(() => NavigateToSetupAndClose(item))">
                                                <i class="@item.Icon me-2"></i>
                                                <span class="setup-menu-item-text">@item.MenuCaption</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </MudPaper>
                </ChildContent>
            </MudMenu>
                        }

                        <!-- Date Display -->
                        <MudChip T="string" 
                                 Color="Color.Secondary" 
                                 Variant="Variant.Outlined"
                                 Size="Size.Small"
                                 Class="date-chip">
                            <i class="fas fa-calendar-alt me-2" style="font-size: 12px;"></i>
                @DateTime.Now.ToString("dddd, dd MMMM yyyy")
            </MudChip>
                    </div>
        </MudHidden>
            </div>

        <MudThemeProvider @bind-IsDarkMode="@Globals._isDarkMode" Theme="_theme" />
        </div>
    </MudAppBar>

    <!-- Use inline styles to control drawer width -->
    <MudDrawer @bind-Open="@_drawerOpen" @attributes="@GetDrawerAttributes()">
        <div style="height:100%;">
            <MyNavMenu OnSidebarToggle="HandleSidebarToggle" @ref="navMenuComponent" />
        </div>
    </MudDrawer>

    <!-- Main content with dynamic margin -->
    <MudMainContent Class="@GetMainContentClass()">
        <div class="content-wrapper">
            @Body
        </div>
    </MudMainContent>
</MudLayout>

@code {
    bool _drawerOpen = false;
    private MudTheme _theme = new();
    private DotNetObjectReference<MainLayout>? _dotNetRef;
    private string _idleDisplay = "0:00";
    private System.Threading.Timer? _refreshTimer;
    [Inject] private Globals Globals { get; set; } = null!;
    private List<GroupMenuModel> setupMenuItems = new();
    private List<GroupMenuModel> setupParentMenus = new();
    private MudMenu? setupMenuRef;

    // Sidebar state variables
    private bool _isSidebarExpanded = true;
    private MyNavMenu navMenuComponent;
    private bool _isMobile = false;
    private bool _initialized = false;


    protected override async Task OnInitializedAsync()
    {
        await CheckMobile();
        await LoadSetupMenuItems();
        _initialized = true;
    }

    private async Task LoadSetupMenuItems()
    {
        try
        {
            if (Globals.User == null || Globals.Organization == null)
            {
                Console.WriteLine("LoadSetupMenuItems: User or Organization is null");
                return;
            }

            var organizationId = Globals.User.OrganizationId;
            var groupId = Globals.User.GroupId;

            Console.WriteLine($"LoadSetupMenuItems: Loading for OrganizationId={organizationId}, GroupId={groupId}");

            List<GroupMenuModel> allMenuData = new List<GroupMenuModel>();

            if (groupId == 1)
            {
                // For admin users, try loading directly from Menu table first
                Console.WriteLine("LoadSetupMenuItems: Admin user - loading from Menu table");
                try
                {
                    var menuData = await Functions.GetAsync<List<MyMenuModel>>(
                        $"MyMenu/Search/Live=1",
                        true);

                    if (menuData != null && menuData.Count > 0)
                    {
                        Console.WriteLine($"LoadSetupMenuItems: Direct menu data count: {menuData.Count}");
                        
                        // Convert MyMenuModel to GroupMenuModel for admin
                        allMenuData = menuData
                            .Select(x => new GroupMenuModel
                            {
                                MenuId = x.Id,
                                MenuCaption = x.MenuCaption,
                                ParentId = x.ParentId,
                                Icon = x.Icon,
                                PageName = x.PageName,
                                Parameter = x.Parameter,
                                SeqNo = x.SeqNo,
                                Live = x.Live,
                                GroupId = 1,
                                My_Privilege = "FULL ACCESS",
                                OrganizationId = organizationId
                            })
                            .ToList();
                    }
                    else
                    {
                        // Fallback to permissions view
                        Console.WriteLine("LoadSetupMenuItems: Menu table empty, trying permissions view");
                        allMenuData = await Functions.GetAsync<List<GroupMenuModel>>(
                            $"Permissions/SearchGroupPermissions/{organizationId}/GroupId={groupId}",
                            true) ?? new List<GroupMenuModel>();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"LoadSetupMenuItems: Error loading direct menu: {ex.Message}, falling back to permissions view");
                    allMenuData = await Functions.GetAsync<List<GroupMenuModel>>(
                        $"Permissions/SearchGroupPermissions/{organizationId}/GroupId={groupId}",
                        true) ?? new List<GroupMenuModel>();
                }
            }
            else
            {
                // Non-admin: Load from permissions view
                allMenuData = await Functions.GetAsync<List<GroupMenuModel>>(
                    $"Permissions/SearchGroupPermissions/{organizationId}/GroupId={groupId}",
                true) ?? new List<GroupMenuModel>();
            }

            Console.WriteLine($"LoadSetupMenuItems: Total menu data count: {allMenuData.Count}");

            // Find all parent menu items with Parameter = "SETUP"
            if (groupId == 1)
            {
                // Admin: Get all setup parents, deduplicate by MenuId
                setupParentMenus = allMenuData
                    .Where(x =>
                        (x.Parameter?.ToUpper() == "SETUP" || x.Parameter == "Setup") &&
                        x.ParentId == 0 &&
                        x.Live == 1)
                    .GroupBy(x => x.MenuId)
                    .Select(g => g.First())
                    .OrderBy(x => x.SeqNo)
                    .ToList();
            }
            else
            {
                // Non-admin: Filter by GroupId
                setupParentMenus = allMenuData
                    .Where(x =>
                        (x.Parameter?.ToUpper() == "SETUP" || x.Parameter == "Setup") &&
                        x.ParentId == 0 &&
                        x.Live == 1 &&
                        x.GroupId == groupId &&
                        (x.My_Privilege == "READ ONLY" || x.My_Privilege == "FULL ACCESS"))
                    .OrderBy(x => x.SeqNo)
                    .ToList();
            }

            Console.WriteLine($"LoadSetupMenuItems: Setup parent menus count: {setupParentMenus.Count}");

            if (setupParentMenus.Any())
            {
                // Get all child items of all setup parents
                var setupParentIds = setupParentMenus.Select(p => p.MenuId).ToList();
                
                if (groupId == 1)
                {
                    // Admin: Get all setup children, deduplicate by MenuId
                    setupMenuItems = allMenuData
                        .Where(x =>
                            setupParentIds.Contains(x.ParentId) &&
                            x.Live == 1)
                        .GroupBy(x => x.MenuId)
                        .Select(g => g.First())
                        .OrderBy(x => x.SeqNo)
                        .ToList();
                }
                else
                {
                    // Non-admin: Filter by GroupId and privilege
                    setupMenuItems = allMenuData
                        .Where(x =>
                            setupParentIds.Contains(x.ParentId) &&
                            x.Live == 1 &&
                            x.GroupId == groupId &&
                            (x.My_Privilege == "READ ONLY" || x.My_Privilege == "FULL ACCESS"))
                        .OrderBy(x => x.SeqNo)
                        .ToList();
                }

                Console.WriteLine($"LoadSetupMenuItems: Setup menu items count: {setupMenuItems.Count}");
            }
            else
            {
                setupMenuItems = new List<GroupMenuModel>();
                Console.WriteLine("LoadSetupMenuItems: No setup parent menus found");
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading setup menu items: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private void NavigateToSetup(GroupMenuModel item)
    {
        if (string.IsNullOrEmpty(item.PageName))
        {
            SnackbarService.Add("Page not configured for this setup item", Severity.Warning);
            return;
        }

        // Admin users always have access
        if (Globals.User?.GroupId == 1)
        {
            string url = $"/{item.PageName}";
            
            if (!string.IsNullOrEmpty(item.Parameter) && 
                item.Parameter.ToUpper() != "SETUP" && 
                item.Parameter != "Setup")
            {
                url += $"/{item.Parameter}";
            }
            
            Nav.NavigateTo(url);
            return;
        }

        // Check access using centralized function for non-admin users
        int accessLevel = Globals.PageAccess(Nav, item.PageName);
        
        if (accessLevel < 0)
        {
            SnackbarService.Add("You do not have permission to access this page", Severity.Warning);
            return;
        }

        string url2 = $"/{item.PageName}";
        
        if (!string.IsNullOrEmpty(item.Parameter) && 
            item.Parameter.ToUpper() != "SETUP" && 
            item.Parameter != "Setup")
        {
            url2 += $"/{item.Parameter}";
        }
        
        Nav.NavigateTo(url2);
    }

    private void NavigateToSetupAndClose(GroupMenuModel item)
    {
        // Close the menu first
        if (setupMenuRef != null)
        {
            setupMenuRef.CloseMenuAsync();
        }
        
        // Then navigate
        NavigateToSetup(item);
    }

    private async Task CheckMobile()
    {
        try
        {
            _isMobile = await JS.InvokeAsync<bool>("eval", "window.innerWidth <= 768");

            // Auto-collapse on mobile by default
            if (_isMobile)
            {
                _drawerOpen = false;
                _isSidebarExpanded = false;
            }
            else
            {
                _drawerOpen = true;
                _isSidebarExpanded = true;
            }
        }
        catch
        {
            // Fallback values
            _isMobile = false;
            _drawerOpen = true;
            _isSidebarExpanded = true;
        }
    }

    async void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;

        // If opening drawer on mobile, ensure sidebar is expanded
        if (_drawerOpen && _isMobile)
        {
            _isSidebarExpanded = true;
            if (navMenuComponent != null)
            {
                await InvokeAsync(StateHasChanged);
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private void HandleSidebarToggle(bool isExpanded)
    {
        _isSidebarExpanded = isExpanded;
        StateHasChanged();
    }

    private Dictionary<string, object> GetDrawerAttributes()
    {
        var attributes = new Dictionary<string, object>();

        if (_isSidebarExpanded)
        {
            attributes["Width"] = "240px";
        }
        else
        {
            attributes["Width"] = "52px";
        }

        // Only make it persistent on desktop
        if (!_isMobile)
        {
            attributes["Variant"] = Variant.Filled;
        }
        else
        {
            attributes["Variant"] = Variant.Outlined;
        }

        return attributes;
    }

    private string GetMainContentClass()
    {
        var classes = new List<string>();

        if (!_isMobile)
        {
            if (_isSidebarExpanded)
            {
                classes.Add("sidebar-expanded");
            }
            else
            {
                classes.Add("sidebar-collapsed");
            }
        }
        else
        {
            classes.Add("mobile-view");
        }

        return string.Join(" ", classes);
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (Globals.User.Id == 0)
            {
                Nav.NavigateTo("/");
                //return;
            }

            if (Globals.User.DarKLightTheme == 1)
            {
                Globals._isDarkMode = true;
            }
            else
            {
                Globals._isDarkMode = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in MainLayout OnParametersSetAsync: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("idleHandler.startIdleTimer", _dotNetRef);

            // Add resize listener for responsive behavior
            await JS.InvokeVoidAsync("eval",
                @"window.addEventListener('resize', function() {
                    DotNet.invokeMethodAsync('YourAssemblyName', 'HandleResize');
                });");

            StateHasChanged();
        }
    }

    [JSInvokable]
    public static async Task HandleResize()
    {
        // This will be called from JavaScript when window resizes
        // You might need to implement a service to notify components
    }

    [JSInvokable]
    public void UpdateIdleTime(int seconds)
    {
        var minutes = seconds / 60;
        var secs = seconds % 60;
        _idleDisplay = $"{minutes}:{secs:D2}";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task RefreshPage()
    {
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async void LogoutUser()
    {
        Nav.NavigateTo("/", true);
    }

    public void Dispose() => _dotNetRef?.Dispose();
}

<style>
    /* Professional Navbar Styles */
    .professional-navbar {
        padding: 0 !important;
        min-height: 64px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .navbar-content {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0 24px;
        min-height: 64px;
    }

    .navbar-left {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    .company-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
    }

    .company-logo {
        height: 40px;
        width: 40px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .company-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .company-name {
        font-size: 16px;
        font-weight: 600;
        color: white;
        letter-spacing: 0.3px;
        line-height: 1.2;
    }

    .company-description {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.85);
        letter-spacing: 0.2px;
        line-height: 1.2;
    }

    .navbar-right {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    .navbar-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
    }

    .navbar-action-btn {
        color: rgba(255, 255, 255, 0.9) !important;
        transition: all 0.2s ease;
        padding: 8px !important;
    }

    .navbar-action-btn:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        color: white !important;
        transform: scale(1.05);
    }

    .date-chip {
        background-color: rgba(255, 255, 255, 0.15) !important;
        color: white !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        padding: 6px 12px !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        letter-spacing: 0.3px !important;
    }

    .date-chip i {
        opacity: 0.9;
    }

    /* Responsive adjustments */
    @@media (max-width: 960px) {
        .navbar-content {
            padding: 0 16px;
        }

        .company-name {
            font-size: 14px;
        }

        .company-description {
            font-size: 11px;
        }

        .company-logo {
            height: 36px;
            width: 36px;
        }

        .navbar-actions {
            gap: 8px;
        }

        .date-chip {
            font-size: 11px !important;
            padding: 4px 8px !important;
        }
    }

    /* Mega Menu Styles */
    .mega-menu-paper {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
        border-radius: 8px;
    }

    .mega-menu-header {
        color: var(--mud-palette-text-primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
        margin-bottom: 12px !important;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--mud-palette-divider);
    }

    .mega-menu-list {
        padding: 0 !important;
    }

    .mega-menu-item {
        padding: 8px 0 !important;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 4px;
        margin-bottom: 2px;
    }

    .mega-menu-item:hover {
        background-color: var(--mud-palette-action-hover);
        padding-left: 8px !important;
    }

    .mega-menu-item .mud-list-item-text {
        color: var(--mud-palette-text-primary);
        font-size: 0.875rem;
    }

    .mega-menu-item:hover .mud-list-item-text {
        color: var(--mud-palette-primary);
    }

    /* Main content dynamic margin */
    .mud-main-content.sidebar-expanded {
        margin-left: 240px !important;
        transition: margin-left 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        width: calc(100% - 240px) !important;
    }

    .mud-main-content.sidebar-collapsed {
        margin-left: 52px !important;
        transition: margin-left 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        width: calc(100% - 52px) !important;
    }

    /* Mobile view - no margin */
    .mud-main-content.mobile-view {
        margin-left: 0 !important;
        width: 100% !important;
    }

    /* Ensure content wrapper takes full available space */
    .content-wrapper {
        height: 100%;
        padding: 2px !important;
        background: var(--mud-palette-background);
    }

    /* Drawer styling adjustments */
    .mud-drawer {
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        overflow: hidden !important;
    }

    /* Ensure MudDrawer content doesn't overflow */
    .mud-drawer-content {
        overflow-x: hidden !important;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .mud-main-content.sidebar-expanded,
        .mud-main-content.sidebar-collapsed {
            margin-left: 0 !important;
            width: 100% !important;
        }

        .mud-drawer-open {
            box-shadow: 2px 0 10px rgba(0,0,0,0.2) !important;
        }
    }

    /* Setup Mega Menu Styles */
    .setup-mega-menu {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
        border-radius: 8px;
    }

    .setup-menu-grid {
        display: flex;
        flex-wrap: nowrap;
        gap: 24px;
        width: 100%;
    }

    .setup-menu-column {
        min-width: 250px;
        flex: 0 1 auto;
    }

    .setup-menu-header {
        color: var(--mud-palette-text-primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--mud-palette-divider);
        display: flex;
        align-items: center;
        white-space: nowrap;
    }

    .setup-menu-header-text {
        white-space: nowrap;
    }

    .setup-menu-header i {
        flex-shrink: 0;
    }

    .setup-menu-items {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .setup-menu-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
        color: var(--mud-palette-text-primary);
        font-size: 0.875rem;
        white-space: nowrap;
        width: 100%;
    }

    .setup-menu-item:hover {
        background-color: var(--mud-palette-action-hover);
        color: var(--mud-palette-primary);
    }

    .setup-menu-item i {
        width: 18px;
        text-align: center;
        font-size: 14px;
        margin-right: 8px;
        flex-shrink: 0;
    }

    .setup-menu-item-text {
        white-space: nowrap;
    }
</style>