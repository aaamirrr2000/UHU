@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Globals Globals
@inject IJSRuntime JSRuntime
@inject IFormFactor FormFactor
@using MudBlazor
@inject Functions Functions

@implements IDisposable

<div class="@GetSidebarClass()" @onclick:stopPropagation>
    <!-- Collapse Toggle Button -->
    <div class="sidebar-toggle" @onclick="ToggleSidebar">
        <i class="@GetToggleIcon()" style="font-size: 14px;"></i>
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="sidebar-loading">
            <MudProgressCircular Size="Size.Small" Color="Color.Primary" />
            <MudText Typo="Typo.caption" Class="mt-2">Loading menu...</MudText>
        </div>
    }
    else if (hasError)
    {
        <div class="sidebar-error">
            <i class="fas fa-exclamation-triangle text-warning fa-lg mb-2"></i>
            <MudText Typo="Typo.caption">Failed to load menu</MudText>
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       Size="Size.Small"
                       OnClick="RetryLoadMenu"
                       Class="mt-2">
                Retry
            </MudButton>
        </div>
    }
    else if (MenuGroupData == null || MenuGroupData.Count == 0)
    {
        <div class="sidebar-empty">
            <i class="fas fa-folder-open text-muted fa-lg mb-2"></i>
            <MudText Typo="Typo.caption">No menu items available</MudText>
        </div>
    }
    else
    {
        <!-- User Profile (Only show when expanded) -->
        @if (IsExpanded)
        {
            <div class="user-profile">
                <div class="d-flex align-items-center">
                    <div class="profile-pic-container">
                        @if (Globals.User != null && !string.IsNullOrEmpty(Globals.User.Pic))
                        {
                            <img src="@Globals.User.Pic" alt="Profile" class="profile-pic" />
                        }
                        else
                        {
                            <div class="profile-pic-fallback">
                                <i class="fas fa-user"></i>
                            </div>
                        }
                    </div>
                    <div class="user-details ms-2">
                        <div class="user-name">@Globals.User?.FullName</div>
                        <div class="user-role">@Globals.User?.GroupName</div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Mini Profile when collapsed -->
            <div class="mini-profile" @onclick="() => ExpandTemporarily()">
                @if (Globals.User != null && !string.IsNullOrEmpty(Globals.User.Pic))
                {
                    <img src="@Globals.User.Pic" alt="Profile" class="mini-profile-pic" />
                }
                else
                {
                    <div class="mini-profile-fallback">
                        <i class="fas fa-user"></i>
                    </div>
                }
            </div>
        }

        <!-- Navigation Menu -->
        <div class="nav-menu">

            @foreach (var group in MenuGroupData)
            {
                <div class="nav-group">
                    <!-- Group Header -->
                    <div class="nav-group-header" @onclick="() => ToggleGroup(group.MenuId)">
                        <div class="d-flex align-items-center">
                            <div class="group-icon">
                                <i class="@group.Icon"></i>
                            </div>
                            @if (IsExpanded || temporaryExpand)
                            {
                                <span class="group-title">@group.MenuCaption</span>
                                <MudSpacer />
                                <i class="fas fa-chevron-@(IsGroupExpanded(group.MenuId) ? "down" : "right") group-arrow"></i>
                            }
                        </div>
                    </div>

                    <!-- Group Items -->
                    @if (IsExpanded && IsGroupExpanded(group.MenuId) || temporaryExpand)
                    {
                        <div class="nav-group-items">
                            @if (data != null && Globals.User != null)
                            {
                                var groupItems = data.Where(x =>
                                x.ParentId == group.MenuId &&
                                (Globals.User.GroupId == 1 ||
                                (x.My_Privilege == "READ ONLY" || x.My_Privilege == "FULL ACCESS")))
                                .ToList();

                                @if (groupItems.Count == 0)
                                {
                                    <div class="no-items">
                                        <MudText Typo="Typo.caption" Class="text-muted">No items</MudText>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var item in groupItems)
                                    {
                                        <div class="nav-item @(IsActive(item) ? "active" : "")"
                                             @onclick="() => LoadOption(item)"
                                             @onmouseover="() => ShowTooltip(item)"
                                             @onmouseout="HideTooltip">
                                            <div class="d-flex align-items-center">
                                                <div class="item-icon" @onclick="() => ExpandForIconClick(item)">
                                                    <i class="@item.Icon"></i>
                                                </div>
                                                @if (IsExpanded || temporaryExpand)
                                                {
                                                    <span class="item-title">@item.MenuCaption</span>
                                                }
                                            </div>
                                        </div>

                                        <!-- Tooltip for collapsed state -->
                                        @if (!IsExpanded && showTooltip && tooltipItem == item.MenuId)
                                        {
                                            <div class="item-tooltip" style="left: 52px; top: @tooltipTop">
                                                @item.MenuCaption
                                            </div>
                                        }
                                    }
                                }
                            }
                        </div>
                    }
                </div>
            }

            <!-- Additional Menu Items (Not from Menu Table) -->
            <div class="nav-menu-footer" style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--mud-palette-lines-default);">
                <!-- Reports Link -->
                @if (HasReportsAccess())
                {
                    <div class="nav-item @(IsReportsPageActive() ? "active" : "")"
                         @onclick="NavigateToReports"
                         @onmouseover="() => ShowReportsTooltip()"
                         @onmouseout="HideTooltip">
                        <div class="d-flex align-items-center">
                            <div class="item-icon">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                            @if (IsExpanded || temporaryExpand)
                            {
                                <span class="item-title">Reports</span>
                            }
                        </div>
                        <!-- Tooltip for collapsed state -->
                        @if (!IsExpanded && showTooltip && tooltipItem == -1)
                        {
                            <div class="item-tooltip" style="left: 52px; top: @tooltipTop">
                                Reports
                            </div>
                        }
                    </div>
                }

                <!-- Theme Toggle -->
                <div class="nav-item theme-toggle-item"
                     @onmouseover="() => ShowThemeTooltip()"
                     @onmouseout="HideTooltip">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="item-icon">
                                <i class="@(Globals._isDarkMode ? "fa-solid fa-moon" : "fa-solid fa-sun")"></i>
                            </div>
                            @if (IsExpanded || temporaryExpand)
                            {
                                <span class="item-title">Theme</span>
                            }
                        </div>
                        @if (IsExpanded || temporaryExpand)
                        {
                            <MudSwitch Value="@Globals._isDarkMode" 
                                      ValueChanged="@(async (bool value) => await ToggleTheme(value))" 
                                      Color="Color.Primary" 
                                      Size="Size.Small" 
                                      Class="ms-2" />
                        }
                    </div>
                    <!-- Tooltip for collapsed state -->
                    @if (!IsExpanded && showTooltip && tooltipItem == -2)
                    {
                        <div class="item-tooltip" style="left: 52px; top: @tooltipTop">
                            Theme
                        </div>
                    }
                </div>

                <!-- Change Password -->
                <div class="nav-item @(IsChangePasswordPageActive() ? "active" : "")"
                     @onclick="NavigateToChangePassword"
                     @onmouseover="() => ShowChangePasswordTooltip()"
                     @onmouseout="HideTooltip">
                    <div class="d-flex align-items-center">
                        <div class="item-icon">
                            <i class="fa-solid fa-key"></i>
                        </div>
                        @if (IsExpanded || temporaryExpand)
                        {
                            <span class="item-title">Change Password</span>
                        }
                    </div>
                    <!-- Tooltip for collapsed state -->
                    @if (!IsExpanded && showTooltip && tooltipItem == -3)
                    {
                        <div class="item-tooltip" style="left: 52px; top: @tooltipTop">
                            Change Password
                        </div>
                    }
                </div>

                <!-- Logout -->
                <div class="nav-item logout-item"
                     @onclick="Logout"
                     @onmouseover="() => ShowLogoutTooltip()"
                     @onmouseout="HideTooltip">
                    <div class="d-flex align-items-center">
                        <div class="item-icon">
                            <i class="fa-solid fa-power-off"></i>
                        </div>
                        @if (IsExpanded || temporaryExpand)
                        {
                            <span class="item-title">Logout</span>
                        }
                    </div>
                    <!-- Tooltip for collapsed state -->
                    @if (!IsExpanded && showTooltip && tooltipItem == -4)
                    {
                        <div class="item-tooltip" style="left: 52px; top: @tooltipTop">
                            Logout
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<!-- Overlay when sidebar is expanded on mobile -->
@if (IsExpanded && IsMobile)
{
    <div class="sidebar-overlay" @onclick="ToggleSidebar"></div>
}

<style>
    /* REMOVE THESE CUSTOM VARIABLES - MudBlazor provides them automatically */
    /*
        .sidebar {
            --mud-palette-primary: #594ae2;
            --mud-palette-primary-lighten: #7265e3;
            --mud-palette-primary-darken: #4638c5;
            --mud-palette-surface: #ffffff;
            --mud-palette-background: #f5f7fa;
            --mud-palette-text-primary: #424242;
            --mud-palette-text-secondary: #757575;
            --mud-palette-action-default: #757575;
            --mud-palette-action-disabled: #bdbdbd;
            --mud-palette-divider: #e0e0e0;
        }
        */

    /* Loading, Error, Empty States */
    .sidebar-loading,
    .sidebar-error,
    .sidebar-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
        color: var(--mud-palette-text-secondary);
    }

    .sidebar-error {
        color: var(--mud-palette-warning);
    }

    /* Windows 10 Style Sidebar */
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: 240px;
        background: var(--mud-palette-surface);
        border-right: 1px solid var(--mud-palette-lines-default);
        z-index: 1000;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

        .sidebar.collapsed {
            width: 52px;
        }

        .sidebar.overlay {
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1100;
        }

    /* Toggle Button */
    .sidebar-toggle {
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-bottom: 1px solid var(--mud-palette-lines-default);
        background: var(--mud-palette-background);
        color: var(--mud-palette-text-secondary);
        transition: all 0.2s;
    }

        .sidebar-toggle:hover {
            background: var(--mud-palette-action-hover);
            color: var(--mud-palette-primary);
        }

    /* User Profile */
    .user-profile {
        padding: 16px;
        border-bottom: 1px solid var(--mud-palette-lines-default);
        background: var(--mud-palette-background);
    }

    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--mud-palette-primary);
    }

    .profile-pic-fallback {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--mud-palette-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--mud-palette-primary-contrast);
        font-size: 18px;
    }

    .user-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--mud-palette-text-primary);
        line-height: 1.2;
    }

    .user-role {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        line-height: 1.2;
    }

    /* Mini Profile (Collapsed) */
    .mini-profile {
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-bottom: 1px solid var(--mud-palette-lines-default);
        transition: all 0.2s;
    }

        .mini-profile:hover {
            background: var(--mud-palette-action-hover);
        }

    .mini-profile-pic {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .mini-profile-fallback {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--mud-palette-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--mud-palette-primary-contrast);
        font-size: 14px;
    }

    /* Navigation Menu */
    .nav-menu {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .nav-menu-footer {
        margin-top: auto;
        padding-top: 20px;
        border-top: 1px solid var(--mud-palette-lines-default);
    }

    .theme-toggle-item {
        padding: 8px 12px;
    }

    .logout-item {
        color: var(--mud-palette-error);
    }

    .logout-item:hover {
        background-color: rgba(var(--mud-palette-error-rgb), 0.1);
    }

    .nav-menu {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .nav-menu-footer {
        margin-top: auto;
        padding-top: 20px;
        border-top: 1px solid var(--mud-palette-lines-default);
    }

    .theme-toggle-item {
        padding: 8px 12px;
    }

    .logout-item {
        color: var(--mud-palette-error);
    }

    .logout-item:hover {
        background-color: rgba(var(--mud-palette-error-rgb), 0.1);
    }

    .no-items {
        padding: 12px 16px;
        text-align: center;
        color: var(--mud-palette-text-disabled);
    }

    /* Group Styles */
    .nav-group {
        margin-bottom: 2px;
    }

    .nav-group-header {
        padding: 10px 16px;
        cursor: pointer;
        color: var(--mud-palette-text-primary);
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }

        .nav-group-header:hover {
            background: var(--mud-palette-action-hover);
            border-left-color: var(--mud-palette-primary-lighten);
        }

    .group-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--mud-palette-primary);
        font-size: 14px;
    }

    .group-title {
        font-size: 13px;
        font-weight: 600;
        margin-left: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .group-arrow {
        font-size: 10px;
        color: var(--mud-palette-text-secondary);
        transition: transform 0.2s;
    }

    /* Group Items */
    .nav-group-items {
        background: var(--mud-palette-background);
        border-left: 2px solid var(--mud-palette-primary);
        margin-left: 24px;
        margin-bottom: 4px;
    }

    .nav-item {
        padding: 8px 16px;
        cursor: pointer;
        color: var(--mud-palette-text-primary);
        transition: all 0.2s;
        position: relative;
        border-left: 3px solid transparent;
    }

        .nav-item:hover {
            background: var(--mud-palette-action-hover);
            border-left-color: var(--mud-palette-primary-lighten);
        }

        .nav-item.active {
            background: var(--mud-palette-primary);
            color: var(--mud-palette-primary-contrast);
            border-left-color: var(--mud-palette-primary-darken);
        }

            .nav-item.active .item-icon {
                color: var(--mud-palette-primary-contrast);
            }

    .item-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--mud-palette-text-secondary);
        font-size: 13px;
        cursor: pointer;
    }

    .item-title {
        font-size: 13px;
        margin-left: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    /* Tooltip for collapsed state */
    .item-tooltip {
        position: fixed;
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1200;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--mud-palette-lines-default);
    }

    /* Overlay */
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 900;
    }

    /* Scrollbar Styling */
    .nav-menu::-webkit-scrollbar {
        width: 4px;
    }

    .nav-menu::-webkit-scrollbar-track {
        background: var(--mud-palette-background);
    }

    .nav-menu::-webkit-scrollbar-thumb {
        background: var(--mud-palette-divider);
        border-radius: 2px;
    }

        .nav-menu::-webkit-scrollbar-thumb:hover {
            background: var(--mud-palette-text-disabled);
        }

    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
        }

            .sidebar.expanded {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }
    }

    /* Dark theme specific adjustments */
    .mud-theme-dark .sidebar {
        background: var(--mud-palette-surface);
        border-right-color: var(--mud-palette-lines-default);
    }

    .mud-theme-dark .sidebar-toggle {
        background: var(--mud-palette-background);
        border-bottom-color: var(--mud-palette-lines-default);
    }

    .mud-theme-dark .user-profile {
        background: var(--mud-palette-background);
        border-bottom-color: var(--mud-palette-lines-default);
    }

    .mud-theme-dark .nav-group-items {
        background: rgba(var(--mud-palette-primary-rgb), 0.05);
    }

    .mud-theme-dark .nav-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .mud-theme-dark .item-tooltip {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
        border-color: var(--mud-palette-lines-default);
    }
</style>

@code {
    private List<GroupMenuModel> MenuGroupData = new();
    private List<GroupMenuModel> data = new();
    private bool isLoading = true;
    private bool hasError = false;
    private string factor => FormFactor.GetFormFactor();
    private string platform => FormFactor.GetPlatform();

    // Sidebar state
    private bool IsExpanded = true;
    private bool IsMobile = false;
    private int? expandedGroupId = null;
    private bool temporaryExpand = false;
    private bool showTooltip = false;
    private int? tooltipItem = null;
    private string tooltipTop = "0px";

    [Parameter] public EventCallback<bool> OnSidebarToggle { get; set; } // Add this parameter

    protected override async Task OnInitializedAsync()
    {
        await LoadMenuData();
        await CheckMobile();
    }

    private async Task LoadMenuData()
    {
        try
        {
            isLoading = true;
            hasError = false;
            StateHasChanged();

            // Check if user is authenticated
            if (Globals.User == null || Globals.Organization == null)
            {
                SnackbarService.Add("User session expired. Please login again.", Severity.Warning);
                hasError = true;
                return;
            }

            // Store user reference to avoid null issues during async operations
            var organizationId = Globals.User.OrganizationId;
            var groupId = Globals.User.GroupId;

            Console.WriteLine($"Loading menu for OrganizationId: {organizationId}, GroupId: {groupId}");

            // Load menu data
            var allMenuData = await Functions.GetAsync<List<GroupMenuModel>>(
                $"Permissions/SearchGroupPermissions/{organizationId}",
                true) ?? new List<GroupMenuModel>();

            Console.WriteLine($"Raw data count: {allMenuData.Count}");

            // Store ALL menu items (including reports) in globals for access checking
            Globals.MyPermissions = allMenuData
                .Where(x => x.GroupId == groupId)
                .ToList();

            // Find all setup parent menu items (needed for filtering)
            var setupParents = allMenuData
                .Where(x =>
                    (x.Parameter?.ToUpper() == "SETUP" || x.Parameter == "Setup") &&
                    x.ParentId == 0)
                .Select(x => x.MenuId)
                .Distinct()
                .ToList();

            var setupParentIds = setupParents.ToList();

            if (allMenuData.Count > 0)
            {
                // Filter out reports and setup items (case-insensitive) for display only
                // Exclude: reports, setup parents (by MenuId), and all setup children (by ParentId)
                if (groupId == 1)
                {
                    // Admin: Filter by MenuId and ParentId, regardless of GroupId
                    data = allMenuData
                        .Where(x => 
                            x.Parameter?.ToUpper() != "REPORT" && 
                            x.Parameter != "Report" &&
                            !setupParentIds.Contains(x.MenuId) &&
                            !setupParentIds.Contains(x.ParentId))
                        .GroupBy(x => x.MenuId)
                        .Select(g => g.First())
                        .ToList();
                }
                else
                {
                    // Non-admin: Filter by GroupId, reports, setup parents, and setup children
                    data = allMenuData
                        .Where(x => 
                            x.Parameter?.ToUpper() != "REPORT" && 
                            x.Parameter != "Report" &&
                            !setupParentIds.Contains(x.MenuId) &&
                            !setupParentIds.Contains(x.ParentId) &&
                            x.GroupId == groupId)
                        .ToList();
                }

                Console.WriteLine($"Filtered data count: {data.Count}");

                // Get parent groups (MenuLevel == 0), excluding setup parents
                if (groupId != 1)
                {
                    MenuGroupData = data
                        .Where(parent => parent.ParentId == 0 &&
                            !setupParentIds.Contains(parent.MenuId) &&
                            data.Any(child => child.ParentId == parent.MenuId &&
                                child.GroupId == groupId &&
                                (child.My_Privilege == "READ ONLY" || child.My_Privilege == "FULL ACCESS")))
                        .ToList();
                }
                else
                {
                    // Admin: Get all parent groups except setup parents
                    MenuGroupData = data
                        .Where(x => 
                            x.ParentId == 0 && 
                            !setupParentIds.Contains(x.MenuId) &&
                            data.Any(child => child.ParentId == x.MenuId))
                        .ToList();
                }

                Console.WriteLine($"MenuGroupData count: {MenuGroupData.Count}");

                // Auto-expand first group if available
                if (MenuGroupData.Count > 0)
                {
                    expandedGroupId = MenuGroupData[0].MenuId;
                    Console.WriteLine($"Auto-expanding group: {MenuGroupData[0].MenuCaption}");
                }

                // Log menu structure
                foreach (var group in MenuGroupData)
                {
                    var items = data.Count(x => x.ParentId == group.MenuId);
                    Console.WriteLine($"Group: {group.MenuCaption} ({group.MenuId}), Items: {items}");
                }
            }
            else
            {
                Console.WriteLine("No data returned from API");
                SnackbarService.Add("No menu permissions configured for your account.", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading menu: {ex.Message}");
            SnackbarService.Add($"Failed to load menu: {ex.Message}", Severity.Error);
            hasError = true;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CheckMobile()
    {
        try
        {
            IsMobile = await JSRuntime.InvokeAsync<bool>("eval", "window.innerWidth <= 768");

            // Auto-collapse on mobile
            if (IsMobile)
            {
                IsExpanded = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking mobile: {ex.Message}");
        }
    }

    private void RetryLoadMenu()
    {
        _ = LoadMenuData();
    }

    private void ToggleSidebar()
    {
        IsExpanded = !IsExpanded;

        // Clear temporary states when collapsing
        if (!IsExpanded)
        {
            temporaryExpand = false;
            showTooltip = false;
        }

        // Notify parent about the state change
        OnSidebarToggle.InvokeAsync(IsExpanded);

        StateHasChanged();
    }

    private void ToggleGroup(int groupId)
    {
        if (expandedGroupId == groupId)
        {
            expandedGroupId = null;
        }
        else
        {
            expandedGroupId = groupId;
        }
        StateHasChanged();
    }

    private bool IsGroupExpanded(int groupId)
    {
        return expandedGroupId == groupId;
    }

    private void ExpandForIconClick(GroupMenuModel item)
    {
        if (!IsExpanded)
        {
            temporaryExpand = true;
            expandedGroupId = item.ParentId;

            // Auto-navigate after a short delay
            Task.Delay(300).ContinueWith(_ =>
            {
                InvokeAsync(() =>
                {
                    LoadOption(item);
                    // Auto-collapse after navigation
                    temporaryExpand = false;
                    StateHasChanged();
                });
            });
        }
        else
        {
            LoadOption(item);
        }
    }

    private void ExpandTemporarily()
    {
        if (!IsExpanded && IsMobile)
        {
            IsExpanded = true;
            StateHasChanged();
        }
    }

    private void ShowTooltip(GroupMenuModel item)
    {
        if (!IsExpanded)
        {
            showTooltip = true;
            tooltipItem = item.MenuId;
            StateHasChanged();
        }
    }

    private void HideTooltip()
    {
        showTooltip = false;
        tooltipItem = null;
        StateHasChanged();
    }

    private void LoadOption(GroupMenuModel item)
    {
        try
        {
            //Console.WriteLine($"Loading option: {item.MenuCaption}, Page: {item.PageName}, Info: {item.Parameter}");

            Globals.SelectedMenuItem = item.MenuCaption!;

            // Navigate to the page
            var url = $"/{item.PageName}/{item.Parameter}";
            //Console.WriteLine($"Navigating to: {url}");
            NavManager.NavigateTo(url);

            // Auto-collapse on mobile after selection
            if (IsMobile)
            {
                IsExpanded = false;
                temporaryExpand = false;
            }
        }
        catch (Exception ex)
        {
            //Console.WriteLine($"Error navigating: {ex.Message}");
            SnackbarService.Add($"Navigation error: {ex.Message}", Severity.Error);
        }
    }

    private bool IsActive(GroupMenuModel item)
    {
        return Globals.SelectedMenuItem == item.MenuCaption;
    }

    private bool HasReportsAccess()
    {
        try
        {
            if (Globals.User == null) return false;
            
            var allMenuItems = Globals.MyPermissions ?? new List<GroupMenuModel>();
            
            // Find report header(s) - menu items with Parameter = "REPORT"
            var reportHeaders = allMenuItems.Where(x => 
                (x.Parameter?.ToUpper() == "REPORT" || x.Parameter == "Report") &&
                x.Live == 1);
            
            if (!reportHeaders.Any()) return false;
            
            var reportHeaderIds = reportHeaders.Select(h => h.MenuId).ToList();
            
            // Check if any menu items have ParentId matching report header MenuIds (these are the actual reports)
            var reports = allMenuItems.Where(x => 
                reportHeaderIds.Contains(x.ParentId) &&
                x.Live == 1);
            
            if (!reports.Any()) return false;
            
            // Admin (GroupId 1) has access to all reports
            if (Globals.User.GroupId == 1)
                return true;
            
            // For non-admin users, check if they have access to at least one report
            return reports.Any(x => 
                x.GroupId == Globals.User.GroupId &&
                (x.My_Privilege == "FULL ACCESS" || x.My_Privilege == "READ ONLY"));
        }
        catch
        {
            return false;
        }
    }

    private bool IsReportsPageActive()
    {
        var currentUri = NavManager.Uri;
        return currentUri.Contains("/ReportsPage", StringComparison.OrdinalIgnoreCase);
    }

    private void NavigateToReports()
    {
        NavManager.NavigateTo("/ReportsPage");
        Globals.SelectedMenuItem = "Reports";
        
        // Auto-collapse on mobile after selection
        if (IsMobile)
        {
            IsExpanded = false;
            temporaryExpand = false;
        }
    }

    private void ShowReportsTooltip()
    {
        if (!IsExpanded)
        {
            showTooltip = true;
            tooltipItem = -1; // Use -1 for Reports
            StateHasChanged();
        }
    }

    private string GetToggleIcon()
    {
        return IsExpanded ? "fas fa-chevron-left" : "fas fa-chevron-right";
    }

    private string GetSidebarClass()
    {
        var classes = new List<string> { "sidebar" };

        if (!IsExpanded)
        {
            classes.Add("collapsed");
        }

        if (IsMobile && IsExpanded)
        {
            classes.Add("overlay");
        }

        if (IsExpanded)
        {
            classes.Add("expanded");
        }

        return string.Join(" ", classes);
    }

    private bool IsChangePasswordPageActive()
    {
        var currentUri = NavManager.Uri;
        return currentUri.Contains("/ChangePasswordPage", StringComparison.OrdinalIgnoreCase);
    }

    private void NavigateToChangePassword()
    {
        NavManager.NavigateTo("/ChangePasswordPage");
        Globals.SelectedMenuItem = "Change Password";
        
        // Auto-collapse on mobile after selection
        if (IsMobile)
        {
            IsExpanded = false;
            temporaryExpand = false;
        }
    }

    private void ShowChangePasswordTooltip()
    {
        if (!IsExpanded)
        {
            showTooltip = true;
            tooltipItem = -3; // Use -3 for Change Password
            StateHasChanged();
        }
    }

    private async Task ToggleTheme(bool isDark)
    {
        try
        {
            if (Globals.User == null)
            {
                SnackbarService.Add("User not found. Please log in again.", Severity.Error);
                return;
            }

            Globals._isDarkMode = isDark;
            int theme = isDark ? 1 : 0;
            string themeName = isDark ? "DARK" : "LIGHT";

            var result = await Functions.PostAsync<UsersModel>($"Users/SetTheme/{Globals.User.Id}/{theme}", null, true);
            if (!result.Success)
            {
                SnackbarService.Add("Theme not updated.", Severity.Error);
                Globals._isDarkMode = !isDark;
            }
            else
            {
                Globals.User.DarKLightTheme = theme;
                SnackbarService.Add($"Theme changed to {themeName} mode", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error saving theme: {ex.Message}", Severity.Error);
        }
    }

    private void ShowThemeTooltip()
    {
        if (!IsExpanded)
        {
            showTooltip = true;
            tooltipItem = -2; // Use -2 for Theme
            StateHasChanged();
        }
    }

    private void Logout()
    {
        // Clear user data first
        Globals.User = null;
        Globals.MyPermissions = null;
        data = new();
        MenuGroupData = new();
        
        // Navigate to login page
        NavManager.NavigateTo("/", true);
    }

    private void ShowLogoutTooltip()
    {
        if (!IsExpanded)
        {
            showTooltip = true;
            tooltipItem = -4; // Use -4 for Logout
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        // Clean up if needed
    }

    
}