@inherits LayoutComponentBase
@inject ISnackbar SnackbarService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject Functions Functions
@inject IFormFactor FormFactor

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout Class="uniget-layout">
    <!-- Top header bar (UniGetUI style) -->
    <MudAppBar Elevation="0" Dense="true" Class="uniget-appbar">
        <div class="uniget-appbar-left">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" OnClick="DrawerToggle" Class="uniget-appbar-icon" />
            <div class="uniget-appbar-logo">
                @if (!string.IsNullOrWhiteSpace(Globals.Organization?.Logo))
                {
                    <img src="@Globals.GetImageUrl(Globals.Organization.Logo)" alt="Logo" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Business" />
                }
            </div>
            <MudText Typo="Typo.subtitle1" Class="uniget-appbar-title" Title="@(Globals.Organization?.Description ?? Globals.Organization?.Name ?? "AMS")">
                @(Globals.Organization?.Description ?? Globals.Organization?.Name ?? "AMS")
            </MudText>
        </div>

        <MudSpacer />

        <!-- Center: Search -->
        <div class="uniget-appbar-search">
            <MudTextField @bind-Value="_searchText"
                         Placeholder="Search..."
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         HideSpinButtons="true"
                         Adornment="Adornment.End"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         IconSize="Size.Small"
                         Class="uniget-search-field"
                         Immediate="false" />
        </div>

        <MudSpacer />

        <div class="uniget-appbar-right">
            <MudChip T="string" Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="uniget-datetime-chip">
                @_currentDateTime
            </MudChip>
            <MudMenu AnchorOrigin="Origin.BottomLeft"
                     TransformOrigin="Origin.TopLeft"
                     @bind-Open="_userMenuOpen"
                     Class="uniget-user-menu"
                     Style="position: relative;">
                <ActivatorContent>
                    <MudIconButton Icon="@Icons.Material.Filled.Person"
                                  Class="uniget-appbar-icon"
                                  aria-label="User menu" />
                </ActivatorContent>
                <ChildContent>
                    <div class="uniget-user-dropdown">
                        <div class="uniget-user-dropdown-header">
                            @if (Globals.User != null && !string.IsNullOrWhiteSpace(Globals.User.Pic))
                            {
                                <div class="uniget-user-avatar">
                                    <img src="@Globals.GetImageUrl(Globals.User.Pic)" alt="Profile" />
                                </div>
                            }
                            else
                            {
                                <div class="uniget-user-avatar uniget-user-avatar-placeholder">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </div>
                            }
                            <div class="uniget-user-info">
                                <div class="uniget-user-name">@(Globals.User?.FullName ?? "User")</div>
                                <div class="uniget-user-email">@(Globals.User?.Email ?? "")</div>
                                <div class="uniget-user-role">@(Globals.User?.GroupName ?? "")</div>
                                @if (Globals.Organization != null)
                                {
                                    <div class="uniget-user-org">@(Globals.Organization.Name ?? Globals.Organization.Description)</div>
                                }
                            </div>
                        </div>
                        <hr />
                        <MudDivider />
                        <MudList T="string" Dense="true" Class="uniget-user-actions">
                            <MudListItem Href="/ChangePasswordPage" Icon="@Icons.Material.Filled.Lock" IconColor="Color.Primary" @onclick="() => _userMenuOpen = false">Change Password</MudListItem>
                            <MudListItem @onclick="LogoutAsync" Icon="@Icons.Material.Filled.Logout" IconColor="Color.Error">Log out</MudListItem>
                        </MudList>
                    </div>
                </ChildContent>
            </MudMenu>
            <MudThemeProvider @bind-IsDarkMode="@Globals._isDarkMode" Theme="_theme" />
        </div>
    </MudAppBar>

    <MudDrawer Open="@(_isMobile ? _drawerOpen : true)"
               OpenChanged="@((v) => { if (_isMobile) _drawerOpen = v; })"
               ClipMode="DrawerClipMode.Always"
               Elevation="2"
               Class="@($"uniget-drawer {(_isSidebarExpanded ? "drawer-wide" : "drawer-narrow")}")"
               Variant="@(_isMobile ? DrawerVariant.Temporary : DrawerVariant.Persistent)">
        <div class="uniget-drawer-content">
            <UniGetNavMenu IsCollapsed="@(!_isSidebarExpanded)" OnSidebarToggle="HandleSidebarToggle" OnThemeToggle="Save" @ref="_navMenu" />
        </div>
    </MudDrawer>

    <MudMainContent Class="@($"uniget-main {GetMainContentClass()}")">
        <div class="uniget-content-wrapper" @key="Globals.SessionRestoredTrigger">
            @Body
        </div>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _userMenuOpen = false;
    private MudTheme _theme = new();
    private string _currentDateTime = "";
    private string _searchText = "";
    private bool _isSidebarExpanded = true;
    private UniGetNavMenu? _navMenu;
    private bool _isMobile = false;
    private System.Threading.Timer? _refreshTimer;

    [Inject] private Globals Globals { get; set; } = null!;

    private async Task LogoutAsync()
    {
        _userMenuOpen = false;
        await SessionStorageHelper.ClearSessionAsync(JS);
        Globals.SessionRestoreAttempted = false;
        Nav.NavigateTo("/", true);
    }

    protected override async Task OnInitializedAsync()
    {
        UpdateDateTime();
        _refreshTimer = new System.Threading.Timer(_ => InvokeAsync(() => { UpdateDateTime(); StateHasChanged(); }), null, TimeSpan.FromSeconds(60), TimeSpan.FromSeconds(60));
        await CheckMobile();
        if (_isMobile) _drawerOpen = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var restored = await SessionStorageHelper.RestoreSessionAsync(JS, Globals);
            Globals.SessionRestoreAttempted = true;
            if (!restored && (Globals.User == null || Globals.User.Id == 0))
                Nav.NavigateTo("/", true);
            else
            {
                if (restored && Globals.User?.Id > 0)
                    Globals.SessionRestoredTrigger++;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void UpdateDateTime() => _currentDateTime = DateTime.Now.ToString("ddd, dd MMM Â· HH:mm");

    private async Task CheckMobile()
    {
        try
        {
            _isMobile = await JS.InvokeAsync<bool>("eval", "window.innerWidth <= 768");
            if (_isMobile) _drawerOpen = false;
        }
        catch { _isMobile = false; }
    }

    private void DrawerToggle()
    {
        if (_isMobile)
            _drawerOpen = !_drawerOpen;
        else
            _isSidebarExpanded = !_isSidebarExpanded;
        StateHasChanged();
    }

    private void HandleSidebarToggle(bool isExpanded)
    {
        _isSidebarExpanded = isExpanded;
        StateHasChanged();
    }

    private string GetMainContentClass()
    {
        if (_isMobile) return _drawerOpen ? "drawer-open mobile-visible" : "mobile";
        return _isSidebarExpanded ? "drawer-open" : "drawer-closed";
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (Globals.User?.DarKLightTheme == 1)
                Globals._isDarkMode = true;
            else
                Globals._isDarkMode = false;
        }
        catch { }
    }


    private async Task Save(bool newValue)
    {
        try
        {
            if (Globals.User == null) return;
            Globals._isDarkMode = newValue;
            int theme = newValue ? 1 : 0;
            var (success, _, _) = await Functions.PostAsync<UsersModel>($"Users/SetTheme/{Globals.User.Id}/{theme}", null, true);
            if (success)
            {
                Globals.User.DarKLightTheme = theme;
                SnackbarService.Add(newValue ? "Theme: Dark" : "Theme: Light", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    public void Dispose() => _refreshTimer?.Dispose();
}

<style>
    .uniget-layout { min-height: 100vh; }
    .uniget-appbar {
        min-height: 48px !important;
        padding-left: 8px !important;
        padding-right: 16px !important;
        background: var(--mud-palette-appbar-background) !important;
        border-bottom: 1px solid var(--mud-palette-lines-default);
    }
    .uniget-appbar-left {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
    }
    .uniget-appbar-icon { margin: 0 4px !important; }
    .uniget-user-menu .mud-paper { min-width: 280px; max-width: 320px; max-height: 80vh; border-radius: 12px; overflow-x: hidden; overflow-y: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.12); display: flex; flex-direction: column; }
    .uniget-user-dropdown { padding: 0; overflow-x: hidden; overflow-y: auto; max-height: 80vh; }
    .uniget-user-dropdown-header { display: flex; align-items: flex-start; gap: 12px; padding: 16px; background: var(--mud-palette-surface); min-width: 0; }
    .uniget-user-avatar { width: 48px; height: 48px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: var(--mud-palette-primary); display: flex; align-items: center; justify-content: center; }
    .uniget-user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .uniget-user-avatar-placeholder { color: var(--mud-palette-primary-contrast); }
    .uniget-user-avatar-placeholder .mud-icon { font-size: 28px; }
    .uniget-user-info { min-width: 0; flex: 1; overflow: hidden; }
    .uniget-user-name { font-weight: 600; font-size: 0.95rem; color: var(--mud-palette-text-primary); line-height: 1.3; margin-bottom: 2px; overflow-wrap: break-word; word-break: break-word; }
    .uniget-user-email { font-size: 0.8rem; color: var(--mud-palette-text-secondary); line-height: 1.3; word-break: break-all; overflow-wrap: break-word; }
    .uniget-user-role { font-size: 0.75rem; color: var(--mud-palette-primary); margin-top: 4px; }
    .uniget-user-org { font-size: 0.75rem; color: var(--mud-palette-text-secondary); margin-top: 2px; }
    .uniget-user-actions { padding: 4px 0 !important; overflow-x: hidden; min-width: 0; }
    .uniget-user-actions .mud-list-item { border-radius: 8px; margin: 0 8px 2px; }
    .uniget-appbar-logo {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.1);
    }
    .uniget-appbar-logo img { width: 100%; height: 100%; object-fit: contain; }
    .uniget-appbar-logo .mud-icon { font-size: 20px; }
    .uniget-appbar-title {
        font-weight: 600 !important;
        font-size: 1rem !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 320px;
    }
    .uniget-appbar-search {
        flex: 1;
        max-width: 400px;
        margin: 0 24px;
    }
    .uniget-search-field .mud-input-root { background: var(--mud-palette-background); border-radius: 8px; }
    .uniget-appbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .uniget-datetime-chip {
        font-size: 0.75rem !important;
        font-weight: 500 !important;
    }
    .uniget-drawer { }
    .uniget-drawer-content { height: 100%; overflow: auto; }
    .uniget-main {
        transition: margin-left 0.25s ease;
        padding-top: 48px !important;
    }
    .uniget-main.drawer-open { margin-left: 280px !important; }
    .uniget-main.drawer-closed { margin-left: 56px !important; }
    .uniget-drawer.drawer-wide { width: 280px !important; min-width: 280px !important; }
    .uniget-drawer.drawer-narrow { width: 56px !important; min-width: 56px !important; }
    .uniget-main.mobile { margin-left: 0 !important; }
    .uniget-content-wrapper {
        height: 100%;
        padding: 16px;
        background: var(--mud-palette-background);
        overflow: auto;
    }
    @@media (max-width: 768px) {
        .uniget-appbar-search { display: none; }
        .uniget-main.drawer-open,
        .uniget-main.drawer-closed { margin-left: 0 !important; }
    }
</style>
