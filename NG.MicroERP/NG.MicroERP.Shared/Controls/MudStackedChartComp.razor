@using NG.MicroERP.Shared.Reports

@* <MudPaper Class="p-4"> *@

@if (HasError)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-3">
        An error occurred while loading the chart: @ErrorMessage
    </MudAlert>
}
else if (ChartGroupData != null)
{
    <div style="display:flex; flex-direction:column; align-items:center; width:100%;">
        <div style="text-align:center; margin-bottom:8px;">
            <span style="font-weight:600; color:#6c757d; font-size:16px;">
                @StatusTypeDisplay Status Overview
            </span>
        </div>

        <div style="width:100%; height:300px;">
            <MudChart ChartType="ChartType.StackedBar"
                      ChartSeries="@ChartGroupData.Series"
                      XAxisLabels="@ChartGroupData.Labels"
                      Width="100%"
                      Height="100%"
                      LegendPosition="@_legendPosition"
                      Options="options"
                      AxisChartOptions="_axisChartOptions"
                      Class="rotated-xlabels" />
        </div>
    </div>
}
else
{
    <div class="text-muted fst-italic">
        No attendance data found for department ID @ParentDepartment.
    </div>
}

@* </MudPaper> *@

<style>
    .multiline-labels .mud-chart-x-axis text {
        font-size: 10px;
        text-anchor: middle;
        white-space: normal;
        word-wrap: break-word;
        max-width: 80px;
    }
</style>

@code {
    [Parameter] public List<DailyAttendanceModel> Data { get; set; } = new();
    [Parameter] public int? ParentDepartment { get; set; }
    [Parameter] public string StatusType { get; set; } = "arrival"; // "arrival" or "leaving"
    
    private AxisChartOptions _axisChartOptions = new()
    {
        StackedBarWidthRatio = 0.6,
        XAxisLabelRotation = 45,
    };

    private object options = new
    {
        indexAxis = "y", // horizontal bars
        plugins = new
        {
            legend = new { display = true, position = "top" }
        },
        responsive = true,
        scales = new
        {
            x = new { stacked = true },
            y = new { stacked = true }
        }
    };

    private Position _legendPosition = Position.Right;

    private string StatusTypeDisplay =>
        StatusType.Equals("leaving", StringComparison.OrdinalIgnoreCase)
        ? "Leaving"
        : "Arrival";

    private ChartGroup? ChartGroupData;
    private bool HasError = false;
    private string ErrorMessage = string.Empty;

    protected override void OnParametersSet()
    {
        BuildChart();
    }

    private void BuildChart()
    {
        HasError = false;
        ErrorMessage = string.Empty;
        ChartGroupData = null;

        try
        {
            if (Data == null || Data.Count == 0 || ParentDepartment == null)
                return;

            // Get all sub-departments under this parent
            var allSubDepartments = Data
                .Where(x => x.ParentDepartmentId == ParentDepartment)
                .Select(x => new { x.DepartmentId, x.Department })
                .Distinct()
                .ToList();

            if (!allSubDepartments.Any())
            {
                var selfDept = Data
                    .Where(x => x.DepartmentId == ParentDepartment)
                    .Select(x => new { DepartmentId = x.DepartmentId, Department = x.Department })
                    .Distinct()
                    .ToList();

                allSubDepartments = selfDept;
            }

            // Group data by sub-department
            var grouped = allSubDepartments
                         .Select(sd =>
                         {
                             var deptData = Data
                                 .Where(x => x.DepartmentId == sd.DepartmentId)
                                 .ToList();

                             // Ensure StatusCounts is never null
                             var statusCounts = deptData.Any()
                                 ? (StatusType.Equals("leaving", StringComparison.OrdinalIgnoreCase)
                                     ? deptData.GroupBy(x => x.LeavingStatus)
                                               .ToDictionary(s => s.Key ?? "Unknown", s => s.Count())
                                     : deptData.GroupBy(x => x.ArrivalStatus)
                                               .ToDictionary(s => s.Key ?? "Unknown", s => s.Count()))
                                 : new Dictionary<string, int>();

                             return new
                             {
                                 ChildDept = sd.Department ?? "Unknown",
                                 StatusCounts = statusCounts
                             };
                         })
                         .ToList();


            var allStatuses = grouped
                .SelectMany(g => g.StatusCounts.Keys)
                .Distinct()
                .OrderBy(s => s)
                .ToList();

            var labels = grouped.Select(g => g.ChildDept).ToArray();

            var series = allStatuses.Select(status =>
                new ChartSeries
                {
                    Name = status,
                    Data = grouped.Select(g =>
                        g.StatusCounts.TryGetValue(status, out var c) ? (double)c : 0
                    ).ToArray()
                }).ToList();

            ChartGroupData = new ChartGroup
            {
                Status = $"{StatusTypeDisplay} Status Overview",
                Labels = labels,
                Series = series
            };
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = ex.Message;
            Console.Error.WriteLine($"[AttendanceChart Error] {ex}");
        }
    }


    private class ChartGroup
    {
        public string Status { get; set; } = string.Empty;
        public string[] Labels { get; set; } = Array.Empty<string>();
        public List<ChartSeries> Series { get; set; } = new();
    }
}
