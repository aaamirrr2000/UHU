@using MudBlazor
@typeparam TItem

<MudAutocomplete T="TItem"
                 Value="@_selectedItem"
                 ValueChanged="@OnValueChanged"
                 SearchFunc="@SearchItems"
                 ToStringFunc="@ItemToString"
                 Clearable="true"
                 DebounceInterval="300"
                 @attributes="AdditionalAttributes">

    <ProgressIndicatorTemplate>
        <MudProgressLinear Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
    </ProgressIndicatorTemplate>
</MudAutocomplete>

@code {
    [Parameter] public string? Label { get; set; } = "Select";

    // Original object binding
    [Parameter] public TItem SelectedValue { get; set; } = default!;
    [Parameter] public EventCallback<TItem> SelectedValueChanged { get; set; }

    // ID binding
    [Parameter] public int SelectedId { get; set; }
    [Parameter] public EventCallback<int> SelectedIdChanged { get; set; }
    [Parameter] public Func<TItem, int>? IdProperty { get; set; }

    // Data and display
    [Parameter] public List<TItem> DataList { get; set; } = new();
    [Parameter] public Func<TItem, string>? DisplayProperty { get; set; }
    [Parameter] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private TItem? _selectedItem;

    protected override void OnParametersSet()
    {
        // Initialize or update selected item when parameters change
        _selectedItem = GetSelectedItem();
    }

    private async Task<IEnumerable<TItem>> SearchItems(string value, CancellationToken token)
    {
        await Task.Delay(100, token);

        if (string.IsNullOrEmpty(value))
            return DataList.Take(20);

        return DataList.Where(x =>
            ItemToString(x)?.Contains(value, StringComparison.InvariantCultureIgnoreCase) == true
        );
    }

    private string ItemToString(TItem item)
    {
        if (item == null) return string.Empty;
        return DisplayProperty?.Invoke(item) ?? item?.ToString() ?? string.Empty;
    }

    private async Task OnValueChanged(TItem newValue)
    {
        _selectedItem = newValue;

        if (IdProperty != null)
        {
            var newId = newValue != null ? IdProperty(newValue) : 0;
            await SelectedIdChanged.InvokeAsync(newId);
        }
        else
        {
            SelectedValue = newValue;
            await SelectedValueChanged.InvokeAsync(newValue);
        }
    }

    private TItem? GetSelectedItem()
    {
        if (IdProperty != null && SelectedId > 0 && DataList?.Any() == true)
        {
            // Find item by ID
            return DataList.FirstOrDefault(x => IdProperty(x) == SelectedId);
        }

        return SelectedValue;
    }
}
