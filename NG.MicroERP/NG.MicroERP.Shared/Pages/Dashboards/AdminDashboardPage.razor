@page "/AdminDashboardPage"
@using System.Linq
@using NG.MicroERP.Shared.Reports
@inject NavigationManager Nav

<Loading IsLoading="@isLoading"/>


<div class="p-3" style="margin:5px;">

    <div class="d-flex justify-content-between align-items-center mb-4 w-100">
        <!-- Dashboard Title -->
        <div class="flex-grow-1 me-3">
            <MudText Typo="Typo.h3" Class="text-primary fw-bold mb-0">
                Ministry of IT & Telecom
            </MudText>
            <MudText Typo="Typo.subtitle1" Class="text-secondary fw-medium">
                Detailed Attendance Dashboard
            </MudText>
        </div>

        <!-- Date Picker -->
        <div class="me-3">
            <MudDatePicker @bind-Value="StartDate"
                           Label="Select Date"
                           DateFormat="yyyy-MM-dd"
                           Variant="Variant.Outlined"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.CalendarToday"
                           DateChanged="OnStartDateChanged"
                           Style="width: 350px;" />
        </div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-stretch gap-3 mb-4 w-100">
        <div class="flex-fill" style="flex: 1 1 18%; min-width: 220px;">
            <MudCardComp Heading="Total Employees"
                            Subheading="Total workforce recorded within the selected period"
                            Number="@TotalEmployees.ToString()"
                            ChartType="bar"
                            OnDownload="@EmplopyeeData"
                         BackgroundColor="#FEA178" 
                         ChartColor="White"/>
        </div>
        <div class="flex-fill" style="flex: 1 1 18%; min-width: 220px;">
            <MudCardComp Heading="Arrived On-Time"
                            Subheading="Employees who reported on or before scheduled time"
                            Number="@OnTimeArrivalCount.ToString()"
                            Percentage="@((TotalEmployees > 0 ? (OnTimeArrivalCount * 100.0 / TotalEmployees) : 0))"
                            ChartType="line"
                            OnDownload="@OnTimeArrivalData"
                         BackgroundColor="#28a745"
                         ChartColor="White" />
        </div>
            <div class="flex-fill" style="flex: 1 1 18%; min-width: 220px;">
                <MudCardComp Heading="Arrived Late"
                                Subheading="Employees who reported late during the selected period"
                                Number="@LateArrivalCount.ToString()"
                         Percentage="@((TotalEmployees > 0 ? (LateArrivalCount * 100.0 / TotalEmployees) : 0))"
                                ChartType="dot"
                                OnDownload="@LateArrivalData"
                         BackgroundColor="#ffc107"
                         ChartColor="White" />
        </div>
        <div class="flex-fill" style="flex: 1 1 18%; min-width: 250px;">
            <MudCardComp Heading="Absent"
                            Subheading="Employees marked as absent or officially on leave"
                            Number="@AbsentCount.ToString()"
                         Percentage="@((TotalEmployees > 0 ? (AbsentCount * 100.0 / TotalEmployees) : 0))"
                            ChartType="donut"
                            OnDownload="@AbsentArrivalData"
                         BackgroundColor="#dc3545"
                         ChartColor="White" />
        </div>
        <div class="flex-fill" style="flex: 1 1 18%; min-width: 250px;">
            <MudCardComp Heading="On Leave"
                            Subheading="Employees currently on leave within the selected period"
                            Number="@OnLeaveCount.ToString()"
                         Percentage="@((TotalEmployees > 0 ? (OnLeaveCount * 100.0 / TotalEmployees) : 0))"
                         ChartType="area"
                            OnDownload="@OnLeaveArrivalData"
                         BackgroundColor="#17a2b8"
                         ChartColor="White" />
        </div>

        <div class="flex-fill" style="flex: 1 1 18%; min-width: 250px;">
            <MudCardComp Heading="Left Before Time"
                         Subheading="Employees left office before time"
                         Number="@BeforeTimeLeavingCount.ToString()"
                         Percentage="@((TotalEmployees > 0 ? (BeforeTimeLeavingCount * 100.0 / TotalEmployees) : 0))"
                         ChartType="sparkline"
                         OnDownload="@BeforeTimeLeavingData"
                         BackgroundColor="#fd7e14"
                         ChartColor="White" />
        </div>

    </div>


    <div class="row mb-4 w-100">
        <!-- First 6 columns: both donut charts -->
        <div class="col-12 col-md-6 d-flex justify-content-center align-items-center">
            <div class="d-flex justify-content-between w-100">
                <!-- Arrival Donut -->
                @if (ArrivalData?.Any() == true && ArrivalLabels?.Any() == true)
                {
                    <MudDonutComp Data="@ArrivalData"
                                  Labels="@ArrivalLabels"
                                  Title="Arrival" />
                }

                <!-- Leaving Donut -->
                @if (LeavingData?.Any() == true && LeavingLabels?.Any() == true)
                {
                    <MudDonutComp Data="@LeavingData"
                                  Labels="@LeavingLabels"
                                  Title="Leaving" />
                }
            </div>
        </div>

        <!-- Second 6 columns: empty but keeps the first col-6 limited -->
        <div class="col-12 col-md-6">
            <!-- Department Selection -->
            <div class="row mb-4 w-100">
                <div class="col-12 col-md-4" style="margin: 10px;">
                    <MudSelect @bind-Value="ParentDeptId"
                               Placeholder="Select Parent Department"
                               Variant="Variant.Outlined"
                               Clearable="true"
                               Class="w-100">
                        @if (parentDepartments?.Any() == true)
                        {
                            foreach (var dept in parentDepartments)
                            {
                                <MudSelectItem T="int" Value="@dept.Id">@dept.DepartmentName</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </div>
            </div>

            <!-- Arrival & Leaving Charts -->
            <div class="row mb-4 w-100">
                <div class="col-12 col-md-6 mb-3">
                        <MudStackedChartComp Data="@data"
                                             ParentDepartment="@ParentDeptId"
                                             StatusType="arrival" />
                </div>
                <div class="col-12 col-md-6 mb-3">
                        <MudStackedChartComp Data="@data"
                                             ParentDepartment="@ParentDeptId"
                                             StatusType="leaving" />
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Table -->
    <div class="row mb-5 w-100">
        <div class="col-12">
            @if (dataDownload != null && dataDownload.Count != 0)
            {
                <MudPaper Class="p-3 shadow-sm w-100" Style="max-height:600px; overflow-y:auto;">
                    <AttendanceDetailReport Data="@dataDownload" />
                </MudPaper>
            }
            else
            {
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="text-center mt-3">
                    No Data Found
                </MudText>
            }

        </div>
    </div>
</div>

<style>
    .mud-chart.rotated-xlabels .mud-chart-x-axis text {
        transform: rotate(-45deg);
        text-anchor: end;
        dominant-baseline: middle;
        font-size: 12px;
    }

    .mud-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

        .mud-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

    .donut-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }
</style>


@code {
    private DateTime? _startDate = DateTime.Now;

    private DateTime StartDate
    {
        get => _startDate ?? DateTime.Today;
        set
        {
            _startDate = value;
            _ = OnDateChanged();
        }
    }

    private List<DailyAttendanceModel>? data;
    private List<DailyAttendanceModel>? dataDownload;
    private bool isLoading = true;

    // Summary counts with better null handling
    private int TotalEmployees => data?.Select(x => x.EmpId).Distinct().Count() ?? 0;

    private int LateArrivalCount => data?.Count(x => x.ArrivalStatus == "LATE") ?? 0;
    private int OnTimeArrivalCount => data?.Count(x => x.ArrivalStatus == "ON TIME") ?? 0;
    private int AbsentCount => data?.Count(x => x.ArrivalStatus == "ABSENT" ) ?? 0;
    private int OnLeaveCount => data?.Count(x => x.ArrivalStatus == "ON LEAVE") ?? 0;

    private int BeforeTimeLeavingCount => data?.Count(x => x.LeavingStatus == "BEFORE TIME") ?? 0;
    private int OnTimeLeavingCount => data?.Count(x => x.LeavingStatus == "ON TIME") ?? 0;
    private int IncompleteCount => data?.Count(x => x.LeavingStatus == "INCOMPLETE") ?? 0;

    //Donut Charts
    private double[]? attendanceData;
    private string[]? attendanceLabels;

    private double[]? ArrivalData;
    private string[]? ArrivalLabels;

    private double[]? LeavingData;
    private string[]? LeavingLabels;

    List<DepartmentsModel> Par = new();
    public int ParentDeptId { get; set; } = 0;
    List<DepartmentsModel> parentDepartments = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        // int PagePrivilege = Globals.PageAccess(Nav, "AdminDashboardPage");
        // if (PagePrivilege == -1)
        // {
        //     return;
        // }

        // Fetch parent departments
        Par = await Functions.GetAsync<List<DepartmentsModel>>($"Departments/Search", true) ?? new List<DepartmentsModel>();
        parentDepartments = Par
            .Where(d => d.ParentId == null || d.ParentId == 0)
            .ToList();

        // Select the first department if available
        if (parentDepartments.Any())
            ParentDeptId = parentDepartments.First().Id;

        // Set default date
        _startDate = DateTime.Now;

        // Load all data
        await GetAll();

        isLoading = false;
    }


    protected override async Task OnParametersSetAsync()
    {
        Par = await Functions.GetAsync<List<DepartmentsModel>>($"Departments/Search", true) ?? new List<DepartmentsModel>();
        parentDepartments = Par
            .Where(d => d.ParentId == null || d.ParentId == 0)
            .ToList();

    }
    
    private async Task OnStartDateChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            _startDate = date.Value;
            await OnDateChanged();
        }
    }

    private async Task OnDateChanged()
    {
        await GetAll();
        await EmplopyeeData();
    }

    private async Task GetAll()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            await Task.Delay(300);
          

            string apiUrl = $"DailyAttendance/GetAttendanceReport/{StartDate:yyyy-MM-dd}/{StartDate:yyyy-MM-dd}";
            data = await Functions.GetAsync<List<DailyAttendanceModel>>(apiUrl, true) ?? new List<DailyAttendanceModel>();


            if (data?.Any() == true)
            {
                // Group for Arrival
                var arrivalGrouped = data
                    .Where(x => !string.IsNullOrEmpty(x.ArrivalStatus))
                    .GroupBy(x => x.ArrivalStatus)
                    .Select(g => new
                    {
                        Label = g.Key ?? "Unknown",
                        Count = g.Count()
                    })
                    .ToList();

                ArrivalLabels = arrivalGrouped.Select(g => g.Label).ToArray();
                ArrivalData = arrivalGrouped.Select(g => (double)g.Count).ToArray();

                // Group for Leaving
                var leavingGrouped = data
                    .Where(x => !string.IsNullOrEmpty(x.LeavingStatus))
                    .GroupBy(x => x.LeavingStatus)
                    .Select(g => new
                    {
                        Label = g.Key ?? "Unknown",
                        Count = g.Count()
                    })
                    .ToList();

                LeavingLabels = leavingGrouped.Select(g => g.Label).ToArray();
                LeavingData = leavingGrouped.Select(g => (double)g.Count).ToArray();
            }
            else
            {
                ArrivalLabels = LeavingLabels = Array.Empty<string>();
                ArrivalData = LeavingData = Array.Empty<double>();
            }


        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching attendance data: {ex.Message}");
            data = new List<DailyAttendanceModel>();

            ArrivalLabels = LeavingLabels = Array.Empty<string>();
            ArrivalData = LeavingData = Array.Empty<double>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task EmplopyeeData()
    {
        dataDownload = data;
        StateHasChanged();
    }

        private async Task OnTimeArrivalData()
    {
        dataDownload = data.Where(x => x.ArrivalStatus == "ON TIME").ToList();
        StateHasChanged();
    }

    private async Task LateArrivalData()
    {
        dataDownload = data.Where(x => x.ArrivalStatus == "LATE").ToList();
        StateHasChanged();
    }

    private async Task AbsentArrivalData()
    {
        dataDownload = data.Where(x => x.ArrivalStatus == "ABSENT").ToList();
        StateHasChanged();
    }

    private async Task OnLeaveArrivalData()
    {
        dataDownload = data.Where(x => x.ArrivalStatus == "ON LEAVE").ToList();
        StateHasChanged();
    }

    private async Task BeforeTimeLeavingData()
    {
        dataDownload = data.Where(x => x.LeavingStatus == "BEFORE TIME").ToList();
        StateHasChanged();
    }
}