@page "/ShipmentPage/{Action}/{CurrentRecord?}"
@using System.Collections.ObjectModel
@using NG.MicroERP.Shared.Models

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<div class="d-flex flex-column" style="margin: 5px; height: 100%; overflow-y: auto;">
    <div class="text-end mb-3" style="position: sticky; top: 0; background: white; z-index: 10; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
        @if (Action != "VIEW")
        {
            <MudButton StartIcon="@(Action == "INSERT" ? Icons.Material.TwoTone.Save : Icons.Material.TwoTone.Edit)"
                      Variant="Variant.Outlined"
                      Color="Color.Success"
                      Size="Size.Small"
                      OnClick="Save"
                      Class="action-button">
                @(Action == "INSERT" ? "Save" : "Update")
            </MudButton>
            @if (Action == "UPDATE")
            {
                <MudButton StartIcon="@Icons.Material.TwoTone.Delete"
                          Variant="Variant.Outlined"
                          Color="Color.Error"
                          Size="Size.Small"
                          OnClick="Delete"
                          Class="action-button">
                    Delete
                </MudButton>
            }
        }
    </div>

    <!-- Shipment Header -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row g-2">
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Shipment No</label>
                    <MudTextField @bind-Value="record.ShipmentNo" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Shipment Type <span style='color:red;'>*</span></label>
                    <MudSelect T="string" @bind-Value="record.ShipmentType" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@isReadOnly">
                        <MudSelectItem Value="@("INCOMING")">INCOMING</MudSelectItem>
                        <MudSelectItem Value="@("OUTGOING")">OUTGOING</MudSelectItem>
                        <MudSelectItem Value="@("TRANSFER")">TRANSFER</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Location <span style='color:red;'>*</span></label>
                    @if (isReadOnly || Globals.User.GroupId != 1)
                    {
                        <MudTextField Value="@(Locations.FirstOrDefault(l => l.Id == record.LocationId)?.Name ?? "")" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="LocationsModel" DataList="@Locations" DisplayProperty="@(p => p.Name)" IdProperty="@(p => p.Id)" @bind-SelectedId="record.LocationId" Variant="Variant.Outlined" Label="Location" FullWidth="@true" />
                    }
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Party</label>
                    @if (isReadOnly)
                    {
                        <MudTextField Value="@(Parties.FirstOrDefault(p => p.Id == record.PartyId)?.DisplayName ?? "")" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="PartiesModel" DataList="@Parties" DisplayProperty="@(p => p.DisplayName)" IdProperty="@(p => p.Id)" @bind-SelectedId="record.PartyId" Variant="Variant.Outlined" FullWidth="@true" />
                    }
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Shipment Date <span style='color:red;'>*</span></label>
                    <MudDatePicker @bind-Date="record.ShipmentDate" DateFormat="yyyy-MM-dd" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Expected Date</label>
                    <MudDatePicker @bind-Date="record.ExpectedDate" DateFormat="yyyy-MM-dd" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Status</label>
                    <MudSelect T="string" @bind-Value="record.Status" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@isReadOnly">
                        <MudSelectItem Value="@("PENDING")">PENDING</MudSelectItem>
                        <MudSelectItem Value="@("IN_TRANSIT")">IN_TRANSIT</MudSelectItem>
                        <MudSelectItem Value="@("RECEIVED")">RECEIVED</MudSelectItem>
                        <MudSelectItem Value="@("PARTIAL")">PARTIAL</MudSelectItem>
                        <MudSelectItem Value="@("COMPLETED")">COMPLETED</MudSelectItem>
                        <MudSelectItem Value="@("CANCELLED")">CANCELLED</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Reference No</label>
                    <MudTextField @bind-Value="record.ReferenceNo" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Courier <span style='color:red;'>*</span></label>
                    @if (isReadOnly)
                    {
                        <MudTextField Value="@(Couriers.FirstOrDefault(c => c.Id == record.CourierId)?.DisplayName ?? "")" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="PartiesModel" DataList="@Couriers" DisplayProperty="@(p => p.DisplayName)" IdProperty="@(p => p.Id)" @bind-SelectedId="record.CourierId" Variant="Variant.Outlined" Label="Courier" FullWidth="@true" />
                    }
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Tracking Number</label>
                    <MudTextField @bind-Value="record.TrackingNumber" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
            </div>
        </MudCardContent>
    </MudCard>

    <!-- Shipment Details -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <MudText Typo="Typo.subtitle2" Class="fw-bold">Shipment Items</MudText>
                @if (!isReadOnly)
                {
                    <MudButton StartIcon="@Icons.Material.TwoTone.Add"
                              Variant="Variant.Outlined"
                              Color="Color.Success"
                              Size="Size.Small"
                              OnClick="AddDetailLine">
                        Add Line
                    </MudButton>
                }
            </div>
            <div style="max-height: 350px; overflow-y: auto;">
                <MudTable Items="@record.Details" Hover="true" Dense="@true" Bordered="true" Striped="true" StickyHeader="true">
                    <HeaderContent>
                        <MudTh Style="width:5%;">#</MudTh>
                        <MudTh Style="width:5%;">â‹®</MudTh>
                        <MudTh Style="width:20%;">Item <span style='color:red;'>*</span></MudTh>
                        <MudTh Style="width:10%;">Stock Condition</MudTh>
                        <MudTh Style="width:10%;" Class="text-end">Quantity <span style='color:red;'>*</span></MudTh>
                        <MudTh Style="width:10%;" Class="text-end">Received Qty</MudTh>
                        <MudTh Style="width:10%;" Class="text-end">Unit Price</MudTh>
                        <MudTh Style="width:10%;" Class="text-end">Total Price</MudTh>
                        <MudTh Style="width:20%;">Description</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="detail">
                        @{ var index = record.Details.IndexOf(detail) + 1; }
                        <MudTd>@index</MudTd>
                        <MudTd>
                            @if (!isReadOnly)
                            {
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="@true">
                                    <MudMenuItem OnClick="@(() => RemoveDetailLine(detail))" Color="Color.Error">
                                        <MudIcon Icon="@Icons.Material.Filled.Delete" Class="me-2" />Delete
                                    </MudMenuItem>
                                </MudMenu>
                            }
                        </MudTd>
                        <MudTd>
                            @if (isReadOnly)
                            {
                                <MudTextField Value="@(Items.FirstOrDefault(i => i.Id == detail.ItemId)?.DisplayName ?? "")" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@true" />
                            }
                            else
                            {
                                <AutoComplete TItem="ItemsModel" DataList="@Items" DisplayProperty="@(p => p.DisplayName)" IdProperty="@(p => p.Id)" @bind-SelectedId="detail.ItemId" Variant="Variant.Outlined" Label="Item" FullWidth="@true" />
                            }
                        </MudTd>
                        <MudTd>
                            <MudSelect T="string" @bind-Value="detail.StockCondition" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly">
                                <MudSelectItem Value="@("NEW")">NEW</MudSelectItem>
                                <MudSelectItem Value="@("USED")">USED</MudSelectItem>
                                <MudSelectItem Value="@("DAMAGED")">DAMAGED</MudSelectItem>
                            </MudSelect>
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.Quantity" Format="#,##0.00" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly" @bind-Value:after="@(() => CalculateDetailTotal(detail))" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.ReceivedQuantity" Format="#,##0.00" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.UnitPrice" Format="#,##0.00" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly" @bind-Value:after="@(() => CalculateDetailTotal(detail))" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.TotalPrice" Format="#,##0.00" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@true" />
                        </MudTd>
                        <MudTd>
                            <MudTextField @bind-Value="detail.Description" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2" style="font-size: 0.9rem;">
                <MudText Typo="Typo.body2" Class="fw-bold">Total Quantity: <span style="color: #4CAF50;">@TotalQuantity.ToString("N2")</span></MudText>
                <MudText Typo="Typo.body2" Class="fw-bold">Total Value: <span style="color: #2196F3;">@TotalValue.ToString("C")</span></MudText>
            </div>
        </MudCardContent>
    </MudCard>

    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row">
                <div class="col-12">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Notes</label>
                    <MudTextField @bind-Value="record.Notes" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Lines="3" FullWidth="@true" />
                </div>
            </div>
        </MudCardContent>
    </MudCard>
</div>

@code {
    ShipmentModel record = new();
    List<LocationsModel> Locations = new();
    List<PartiesModel> Parties = new();
    List<PartiesModel> Couriers = new();
    List<ItemsModel> Items = new();

    [Parameter] public string? Action { get; set; } = "INSERT";
    [Parameter] public int CurrentRecord { get; set; } = 0;
    [Parameter] public EventCallback OnSaved { get; set; }

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;

    private double TotalQuantity => record.Details?.Sum(d => d.Quantity) ?? 0;
    private double TotalValue => record.Details?.Sum(d => d.TotalPrice) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        if (record.Details == null)
            record.Details = new ObservableCollection<ShipmentDetailModel>();
        
        Locations = await Functions.GetAsync<List<LocationsModel>>($"Locations/Search/OrganizationId={Globals.User.OrganizationId} AND IsActive=1", true) ?? new List<LocationsModel>();
        Parties = await Functions.GetAsync<List<PartiesModel>>($"Parties/Search/OrganizationId={Globals.User.OrganizationId} AND IsActive=1", true) ?? new List<PartiesModel>();
        Couriers = Parties.Where(p => p.PartyType?.ToUpper() == "SUPPLIER").ToList();
        Items = await Functions.GetAsync<List<ItemsModel>>($"Items/Search", true) ?? new List<ItemsModel>();

        if (Action == "INSERT")
        {
            Clear();
            isReadOnly = false;
        }
        else if (CurrentRecord > 0)
        {
            await Get(CurrentRecord);
        }
    }

    protected async Task Get(int id)
    {
        LoadingPanel = true;
        record = await Functions.GetAsync<ShipmentModel>($"Shipments/Get/{id}", true) ?? new ShipmentModel();
        if (record.Details == null)
            record.Details = new ObservableCollection<ShipmentDetailModel>();
        // Lock location for non-admin users
        if (Globals.User.GroupId != 1 && record.LocationId != Globals.User.LocationId)
        {
            record.LocationId = Globals.User.LocationId;
        }
        isReadOnly = Action == "VIEW";
        LoadingPanel = false;
    }

    protected void Clear()
    {
        Action = "INSERT";
        record = new ShipmentModel();
        record.Details = new ObservableCollection<ShipmentDetailModel>();
        record.ShipmentType = "INCOMING";
        record.Status = "PENDING";
        record.ShipmentDate = DateTime.Today;
        // Set location for non-admin users
        if (Globals.User.GroupId != 1)
        {
            record.LocationId = Globals.User.LocationId;
        }
        isReadOnly = false;
    }

    protected void AddDetailLine()
    {
        if (record.Details == null)
            record.Details = new ObservableCollection<ShipmentDetailModel>();
        record.Details.Add(new ShipmentDetailModel { SeqNo = record.Details.Count + 1, StockCondition = "NEW" });
        StateHasChanged();
    }

    protected void RemoveDetailLine(ShipmentDetailModel detail)
    {
        if (record.Details != null)
        {
            record.Details.Remove(detail);
            for (int i = 0; i < record.Details.Count; i++)
                record.Details[i].SeqNo = i + 1;
            StateHasChanged();
        }
    }

    protected void CalculateDetailTotal(ShipmentDetailModel detail)
    {
        detail.TotalPrice = detail.Quantity * detail.UnitPrice;
        record.TotalQuantity = TotalQuantity;
        record.TotalValue = TotalValue;
        record.TotalItems = record.Details?.Count ?? 0;
        StateHasChanged();
    }

    protected async Task Delete()
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete this record?");
        if (res == false) return;
        Action = "SOFTDELETE";
        await Save();
    }

    protected async Task Save()
    {
        if (record.Details == null || record.Details.Count == 0)
        {
            SnackbarService.Add("Please add at least one item line.", Severity.Warning);
            return;
        }

        if (record.LocationId <= 0)
        {
            SnackbarService.Add("Please select a location.", Severity.Warning);
            return;
        }

        if (record.CourierId <= 0)
        {
            SnackbarService.Add("Please select a courier.", Severity.Warning);
            return;
        }

        if (!record.ShipmentDate.HasValue)
        {
            SnackbarService.Add("Please select a shipment date.", Severity.Warning);
            return;
        }

        record.OrganizationId = Globals.User.OrganizationId;
        record.CreatedBy = Globals.User.Id;
        record.CreatedOn = DateTime.Now;
        record.CreatedFrom = Globals.ClientInfo;
        record.UpdatedBy = Globals.User.Id;
        record.UpdatedOn = DateTime.Now;
        record.UpdatedFrom = Globals.ClientInfo;
        record.TotalQuantity = TotalQuantity;
        record.TotalValue = TotalValue;
        record.TotalItems = record.Details.Count;

        LoadingPanel = true;
        var result = await Functions.PostAsync<ShipmentModel>($"Shipments/{Action}", record, true);
        LoadingPanel = false;

        if (result.Success == false || result.Result == null)
        {
            SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
        }
        else
        {
            await OnSaved.InvokeAsync();
            SnackbarService.Add($"Record {Action} Successfully", Severity.Success);
        }
    }
}
