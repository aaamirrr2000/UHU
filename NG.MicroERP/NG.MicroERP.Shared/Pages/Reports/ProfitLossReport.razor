@page "/ProfitLossReport"
@using NG.MicroERP.Shared.Models
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals
@inject IJSRuntime JSRuntime

<PageTitle>Profit & Loss Report</PageTitle>
<Loading IsLoading="@LoadingPanel" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-0" Style="padding: 2px;">
    <div class="dashboard-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div>
                <MudText Typo="Typo.h5" Class="mb-0 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="me-2" Style="color: white;" />
                    Profit & Loss Report
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted mt-1" Style="color: rgba(255,255,255,0.85) !important;">Income statement for selected period</MudText>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2 mt-md-0 flex-wrap">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <MudDatePicker @bind-Date="startDate"
                                   Label="Start Date"
                                   DateFormat="dd MMM yyyy"
                                   Variant="Variant.Outlined"
                                   Style="background: rgba(255,255,255,0.95); width: 160px;" />
                    <MudDatePicker @bind-Date="endDate"
                                   Label="End Date"
                                   DateFormat="dd MMM yyyy"
                                   Variant="Variant.Outlined"
                                   Style="background: rgba(255,255,255,0.95); width: 160px;" />
                </div>
                <MudButton StartIcon="@Icons.Material.TwoTone.Search" 
                           Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary"
                           Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                           OnClick="@(() => LoadReport())">
                    Generate
                </MudButton>
                <MudButton StartIcon="@Icons.Material.TwoTone.Print" 
                           Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Info"
                           Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                           OnClick="@(() => PrintReport())">
                    Print
                </MudButton>
            </div>
        </div>
    </div>

    @if (reportData != null)
    {
        <MudPaper Elevation="3" Class="pa-4" Style="border-radius: 12px;">
            <div class="text-center mb-4">
                <MudText Typo="Typo.h5" Class="fw-bold">PROFIT & LOSS STATEMENT</MudText>
                <MudText Typo="Typo.body1">For the period from @startDate.Value.ToString("dd MMM yyyy") to @endDate.Value.ToString("dd MMM yyyy")</MudText>
            </div>

            <!-- Revenue Section -->
            <MudText Typo="Typo.h6" Class="mt-4 mb-2 fw-bold">REVENUE</MudText>
            <MudTable T="string" Dense="true" Hover="true" Striped="true">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in reportData.Revenue)
                    {
                        <tr>
                            <td>@item.AccountName</td>
                            <td class="text-end">@item.Amount.ToString("N2")</td>
                        </tr>
                    }
                    <tr class="fw-bold">
                        <td>Total Revenue</td>
                        <td class="text-end">@reportData.Revenue.Sum(x => x.Amount).ToString("N2")</td>
                    </tr>
                </tbody>
            </MudTable>

            <!-- Expenses Section -->
            <MudText Typo="Typo.h6" Class="mt-4 mb-2 fw-bold">EXPENSES</MudText>
            <MudTable T="string" Dense="true" Hover="true" Striped="true">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in reportData.Expenses)
                    {
                        <tr>
                            <td>@item.AccountName</td>
                            <td class="text-end">@item.Amount.ToString("N2")</td>
                        </tr>
                    }
                    <tr class="fw-bold">
                        <td>Total Expenses</td>
                        <td class="text-end">@reportData.Expenses.Sum(x => x.Amount).ToString("N2")</td>
                    </tr>
                </tbody>
            </MudTable>

            <!-- Net Profit/Loss -->
            <div class="mt-4 pt-3 border-top">
                @{
                    var netProfit = reportData.Revenue.Sum(x => x.Amount) - reportData.Expenses.Sum(x => x.Amount);
                    var netProfitClass = netProfit >= 0 ? "fw-bold text-success" : "fw-bold text-error";
                    var netProfitLabel = netProfit >= 0 ? "Profit" : "Loss";
                }
                <div class="row">
                    <div class="col-md-6">
                        <MudText Typo="Typo.h6" Class="fw-bold">Net @netProfitLabel:</MudText>
                    </div>
                    <div class="col-md-6 text-end">
                        <MudText Typo="Typo.h6" Class="@netProfitClass">
                            @netProfit.ToString("N2")
                        </MudText>
                    </div>
                </div>
            </div>
        </MudPaper>
    }
    else if (!LoadingPanel && startDate.HasValue && endDate.HasValue)
    {
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudText Typo="Typo.body1">No data available for the selected period.</MudText>
        </MudPaper>
    }
</MudContainer>

<style>
    .dashboard-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 8px;
    }
</style>

@code
{
    public DateTime? startDate { get; set; } = DateTime.Today.AddMonths(-1);
    public DateTime? endDate { get; set; } = DateTime.Today;
    private bool LoadingPanel { get; set; } = false;
    private ProfitLossReportModel? reportData;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        if (!startDate.HasValue || !endDate.HasValue)
        {
            SnackbarService.Add("Please select date range", Severity.Warning);
            return;
        }

        if (startDate > endDate)
        {
            SnackbarService.Add("Start date must be earlier than end date", Severity.Warning);
            return;
        }

        LoadingPanel = true;
        try
        {
            var startStr = startDate.Value.ToString("yyyy-MM-dd");
            var endStr = endDate.Value.ToString("yyyy-MM-dd");
            reportData = await Functions.GetAsync<ProfitLossReportModel>(
                $"Reports/ProfitLoss/{Globals.User.OrganizationId}/{startStr}/{endStr}", 
                true) ?? new ProfitLossReportModel
            {
                Revenue = new List<ProfitLossItemModel>(),
                Expenses = new List<ProfitLossItemModel>()
            };
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading report: {ex.Message}", Severity.Error);
            reportData = new ProfitLossReportModel
            {
                Revenue = new List<ProfitLossItemModel>(),
                Expenses = new List<ProfitLossItemModel>()
            };
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    private void PrintReport()
    {
        JSRuntime.InvokeVoidAsync("window.print");
    }
}

