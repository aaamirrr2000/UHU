@page "/PurchaseOrdersPage/{Action}/{CurrentRecord?}"

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<div class="page-container">
    <!-- Action Buttons - Delete button first -->
    <div class="action-toolbar">
        @if (Action != "VIEW")
        {
            @if (Action == "UPDATE")
            {
                <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="Delete" Class="action-btn">
                    <MudIcon Icon="@Icons.Material.Filled.Delete" Class="mr-1" />
                    Delete
                </MudButton>
            }

            <MudButton Variant="Variant.Filled" OnClick="Save" Color="Color.Primary" Class="action-btn">
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                @(Action == "INSERT" ? "Save" : "Update")
            </MudButton>

            <MudButton Variant="Variant.Filled" OnClick="DetailDialog" Color="Color.Secondary" Class="action-btn">
                <MudIcon Icon="@Icons.Material.Filled.Details" Class="mr-1" />
                Order Settings
            </MudButton>
        }
    </div>



    <MyModelDialog Width="50%" Height="60%" @ref="_DialogOrderDetails" Title="Order Settings">
        <HeaderContent>
            <div style="text-align: center; padding: 10px 0;">
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Update purchase order information including status, payment terms, and delivery details.
                </MudText>
            </div>
        </HeaderContent>
        <ChildContent>
            <!-- Details Section -->
            <div class="section-container">

                <EditForm Model="record" OnSubmit="Save">
                    <MudForm>
                        <div class="form-grid">
                            <!-- Row 1: Basic Information -->
                            <div class="form-field">
                                <MudText Class="field-label">Reference No</MudText>
                                <MudTextField @bind-Value="record.ReferenceNo"
                                              placeholder="Enter reference"
                                              ReadOnly="@isReadOnly"
                                              Variant="Variant.Outlined"
                                              Dense="true" />
                            </div>

                            <div class="form-field">
                                <MudText Class="field-label">Status</MudText>
                                <MudSelect T="int" @bind-Value="record.Status"
                                           Placeholder="Select Status"
                                           Clearable="true"
                                           ReadOnly="@isReadOnly"
                                           Variant="Variant.Outlined"
                                           Dense="true">
                                    <MudSelectItem T="int" Value="0">Draft</MudSelectItem>
                                    <MudSelectItem T="int" Value="1">Pending</MudSelectItem>
                                    <MudSelectItem T="int" Value="2">Approved</MudSelectItem>
                                    <MudSelectItem T="int" Value="3">Rejected</MudSelectItem>
                                    <MudSelectItem T="int" Value="4">Completed</MudSelectItem>
                                    <MudSelectItem T="int" Value="5">Cancelled</MudSelectItem>
                                </MudSelect>
                            </div>

                            <div class="form-field">
                                <MudText Class="field-label">Priority</MudText>
                                <MudSelect T="int" @bind-Value="record.Priority"
                                           Placeholder="Select Priority"
                                           Clearable="true"
                                           ReadOnly="@isReadOnly"
                                           Variant="Variant.Outlined"
                                           Dense="true">
                                    <MudSelectItem T="int" Value="0">Low</MudSelectItem>
                                    <MudSelectItem T="int" Value="1">Normal</MudSelectItem>
                                    <MudSelectItem T="int" Value="2">High</MudSelectItem>
                                    <MudSelectItem T="int" Value="3">Urgent</MudSelectItem>
                                </MudSelect>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <!-- Row 2: Currency and Payment -->
                            <div class="form-field">
                                <MudText Class="field-label">Currency</MudText>
                                <MudSelect @bind-Value="record.CurrencyId"
                                           Placeholder="Select Currency"
                                           Clearable="true"
                                           Variant="Variant.Outlined"
                                           Dense="true">
                                    @foreach (var currency in Cur)
                                    {
                                        <MudSelectItem T="int" Value="@currency.Id">@currency.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </div>

                            <div class="form-field">
                                <MudText Class="field-label">Exchange Rate</MudText>
                                <MudNumericField @bind-Value="record.ExchangeRate"
                                                 placeholder="0.00"
                                                 ReadOnly="@isReadOnly"
                                                 Format="#,##0.00"
                                                 Variant="Variant.Outlined"
                                                 Dense="true" />
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-field">
                                <MudText Class="field-label">Payment Terms</MudText>
                                <MudTextField @bind-Value="record.PaymentTerms"
                                              placeholder="Enter terms"
                                              ReadOnly="@isReadOnly"
                                              Variant="Variant.Outlined"
                                              Dense="true" />
                            </div>

                            <!-- Row 3: Delivery Information -->
                            <div class="form-field">
                                <MudText Class="field-label">Expected Delivery</MudText>
                                <MudDatePicker @bind-Value="record.ExpectedDelivery"
                                               Format="yyyy-MM-dd"
                                               placeholder="Select Date"
                                               ReadOnly="@isReadOnly"
                                               Variant="Variant.Outlined"
                                               Dense="true" />
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div>
                                <MudText style="font-size: 0.875rem; font-weight: 600; color: #495057; margin-bottom: 4px; display: block;">
                                    Delivery Address
                                </MudText>
                                <MudTextField @bind-Value="record.DeliveryAddress"
                                              placeholder="Enter complete delivery address"
                                              ReadOnly="@isReadOnly"
                                              Variant="Variant.Outlined"
                                              Dense="true"
                                              FullWidth="true"
                                              Lines="2" />
                            </div>

                            <div>
                                <MudText style="font-size: 0.875rem; font-weight: 600; color: #495057; margin-bottom: 4px; display: block;">
                                    Remarks
                                </MudText>
                                <MudTextField @bind-Value="record.Remarks"
                                              placeholder="Additional notes or instructions"
                                              ReadOnly="@isReadOnly"
                                              Variant="Variant.Outlined"
                                              Dense="true"
                                              FullWidth="true"
                                              Lines="2" />
                            </div>
                        </div>
                    </MudForm>
                </EditForm>
            </div>
        </ChildContent>
        <FooterContent>
            <div style="text-align: center; padding: 10px 0;">
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Define payment terms, delivery address, and order status.
                </MudText>
            </div>
        </FooterContent>
    </MyModelDialog>

    <!-- Header Section -->
    <div class="section-container">
        <div class="section-header">
            <MudAvatar Color="Color.Primary" Class="header-avatar">
                <MudIcon Icon="@Icons.Material.Filled.Receipt" />
            </MudAvatar>
            <div class="header-info">
                <MudText Typo="Typo.h5" Class="fw-bold mb-1">Purchase Order</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Manage purchase orders and items</MudText>
            </div>
            <MudSpacer/>
            <MudText @bind-Value="record.PONumber"/>
        </div>

        <!-- Header Fields - 3 Column Grid -->
        <div class="form-grid">

            <div class="form-field">
                <MudText Class="field-label">Customer</MudText>
                <MudSelect @bind-Value="record.CustomerId"
                           Placeholder="Select Customer"
                           Clearable="true"
                           Variant="Variant.Outlined"
                           Dense="true">
                    @foreach (var customer in Cus)
                    {
                        <MudSelectItem T="int" Value="@customer.Id">@customer.Name</MudSelectItem>
                    }
                </MudSelect>
            </div>

            <div class="form-field">
                <MudText Class="field-label">PO Date</MudText>
                <MudDatePicker @bind-Value="record.PODate"
                               Format="yyyy-MM-dd"
                               placeholder="Select Date"
                               ReadOnly="@isReadOnly"
                               Variant="Variant.Outlined"
                               Dense="true" />
            </div>

            <div class="form-field">
                <MudText Class="field-label">Expected Delivery</MudText>
                <MudDatePicker @bind-Value="record.ExpectedDelivery"
                               Format="yyyy-MM-dd"
                               placeholder="Select Date"
                               ReadOnly="@isReadOnly"
                               Variant="Variant.Outlined"
                               Dense="true" />
            </div>
        </div>
    </div>

    

    <!-- Items Section -->
    <div class="section-container">
        <div class="section-header">
            <div class="section-title">
                <MudIcon Icon="@Icons.Material.Filled.ListAlt" Size="Size.Medium" Color="Color.Primary" Class="mr-2" />
                <MudText Typo="Typo.h6" Class="fw-bold">Order Items</MudText>
            </div>

            @if (Action != "VIEW")
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@AddNewItem" Size="Size.Small">
                    <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-1" Size="Size.Small" />
                    Add Item
                </MudButton>
            }
        </div>

        <!-- Items Table -->
        <div class="table-container">
            <MudTable Items="@purchaseOrderDetails" Dense="true" Hover="true" ReadOnly="@isReadOnly" Striped="true">
                <HeaderContent>
                    @if (Action != "VIEW")
                    {
                        <MudTh Width="50px"></MudTh>
                    }
                    <MudTh Width="60px">#</MudTh>
                    <MudTh Width="200px">Item</MudTh>
                    <MudTh Width="200px">Description</MudTh>
                    <MudTh Width="120px">Qty</MudTh>
                    <MudTh Width="130px">Unit Price</MudTh>
                    <MudTh Width="100px">Disc %</MudTh>
                    <MudTh Width="100px">Tax %</MudTh>
                    <MudTh Width="140px">Total</MudTh>
                    <MudTh Width="140px">Delivery Date</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @if (Action != "VIEW")
                    {
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="@(() => RemoveItem(context))" />
                        </MudTd>
                    }
                    <MudTd>@context.SrNo</MudTd>
                    <MudTd>
                        @if (isReadOnly)
                        {
                            <MudText>@context.ItemName</MudText>
                        }
                        else
                        {
                            <MudSelect T="int" @bind-Value="context.ItemId"
                                       Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       OnValueChanged="@((int val) => OnItemSelected(context, val))"
                                       Style="width: 180px">
                                <MudSelectItem Value="0">Select Item</MudSelectItem>
                                @foreach (var item in itemsList)
                                {
                                    <MudSelectItem Value="@item.Id">@item.Name</MudSelectItem>
                                }
                            </MudSelect>
                        }
                    </MudTd>
                    <MudTd>
                        @if (isReadOnly)
                        {
                            <MudText>@context.ItemDescription</MudText>
                        }
                        else
                        {
                            <MudTextField @bind-Value="context.ItemDescription"
                                          Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          Style="width: 180px" />
                        }
                    </MudTd>
                    <MudTd>
                        @if (isReadOnly)
                        {
                            <MudText>@context.Quantity.ToString("N2")</MudText>
                        }
                        else
                        {
                            <MudNumericField @bind-Value="context.Quantity"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Format="#,##0.00"
                                             OnValueChanged="@((double val) => CalculateLineTotal(context))"
                                             Style="width: 100px" />
                        }
                    </MudTd>
                    <MudTd>
                        @if (isReadOnly)
                        {
                            <MudText>@context.UnitPrice.ToString("N2")</MudText>
                        }
                        else
                        {
                            <MudNumericField @bind-Value="context.UnitPrice"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Format="#,##0.00"
                                             OnValueChanged="@((double val) => CalculateLineTotal(context))"
                                             Style="width: 110px" />
                        }
                    </MudTd>
                    <MudTd>
                        @if (isReadOnly)
                        {
                            <MudText>@context.DiscountPercent.ToString("N2")</MudText>
                        }
                        else
                        {
                            <MudNumericField @bind-Value="context.DiscountPercent"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Format="#,##0.00"
                                             OnValueChanged="@((double val) => CalculateLineTotal(context))"
                                             Style="width: 80px" />
                        }
                    </MudTd>
                    <MudTd>
                        @if (isReadOnly)
                        {
                            <MudText>@context.TaxPercent.ToString("N2")</MudText>
                        }
                        else
                        {
                            <MudNumericField @bind-Value="context.TaxPercent"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Format="#,##0.00"
                                             OnValueChanged="@((double val) => CalculateLineTotal(context))"
                                             Style="width: 80px" />
                        }
                    </MudTd>
                    <MudTd>
                        <MudText Class="fw-bold">@context.LineTotal.ToString("N2")</MudText>
                    </MudTd>
                    <MudTd>
                        @if (isReadOnly)
                        {
                            <MudText>@context.DeliveryDate.ToString("yyyy-MM-dd")</MudText>
                        }
                        else
                        {
                            <MudDatePicker @bind-Value="context.DeliveryDate"
                                           Format="yyyy-MM-dd"
                                           placeholder="Delivery Date"
                                           Variant="Variant.Outlined"
                                           Size="Size.Small"
                                           Style="width: 130px" />
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </div>

        <!-- Summary Section -->
        <div class="summary-container">
            <div class="summary-card">
                <div class="summary-row">
                    <MudText Typo="Typo.body2">Sub Total:</MudText>
                    <MudText Typo="Typo.body2" Class="fw-bold">@subTotal.ToString("N2")</MudText>
                </div>
                <div class="summary-row">
                    <MudText Typo="Typo.body2">Discount:</MudText>
                    <MudText Typo="Typo.body2" Class="fw-bold text-error">- @totalDiscount.ToString("N2")</MudText>
                </div>
                <div class="summary-row">
                    <MudText Typo="Typo.body2">Tax:</MudText>
                    <MudText Typo="Typo.body2" Class="fw-bold text-warning">+ @totalTax.ToString("N2")</MudText>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-row grand-total">
                    <MudText Typo="Typo.h6">Grand Total:</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="fw-bold">@grandTotal.ToString("N2")</MudText>
                </div>
            </div>
        </div>
    </div>

    <!-- Charges Section -->
    @if (purchaseOrderCharges.Any())
    {
        <div class="section-container">
            <div class="section-title">
                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Medium" Color="Color.Primary" Class="mr-2" />
                <MudText Typo="Typo.h6" Class="fw-bold">Additional Charges</MudText>
            </div>

            <div class="table-container">
                <MudTable Items="@purchaseOrderCharges" Dense="true" Hover="true" ReadOnly="@isReadOnly" Striped="true">
                    <HeaderContent>
                        <MudTh Width="200px">Charge Description</MudTh>
                        <MudTh Width="100px">Type</MudTh>
                        <MudTh Width="120px">Value</MudTh>
                        <MudTh Width="120px">Amount</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.ChargeDescription</MudTd>
                        <MudTd>@(context.IsPercentage == 1 ? "Percentage" : "Fixed")</MudTd>
                        <MudTd>
                            @if (context.IsPercentage == 1)
                            {
                                <MudText>@context.PercentageValue.ToString("N2")%</MudText>
                            }
                            else
                            {
                                <MudText>@context.Amount.ToString("N2")</MudText>
                            }
                        </MudTd>
                        <MudTd>
                            <MudText Class="fw-bold">@context.ChargeAmount.ToString("N2")</MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        </div>
    }
</div>


@code {
    PurchaseOrdersModel record = new();
    List<PartiesModel> Cus = new();
    List<CurrenciesModel> Cur = new();
    List<ItemsModel> itemsList = new();
    List<PurchaseOrderDetailsModelExt> purchaseOrderDetails = new();
    List<PurchaseOrderChargesModelExt> purchaseOrderCharges = new();

    public int AccessLevel { get; set; } = 0;
    public MyModelDialog? _DialogOrderDetails;

    [Parameter] public string Action { get; set; } = "INSERT";
    [Parameter] public string? CurrentRecord { get; set; }

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;

    private double subTotal = 0;
    private double totalDiscount = 0;
    private double totalTax = 0;
    private double grandTotal = 0;

    protected override async Task OnInitializedAsync()
    {
        AccessLevel = Globals.PageAccess(NavManager, "PurchaseOrdersDashboard");
        await GetAll();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        GetDefaultValues();
    }

    protected async Task GetAll()
    {
        LoadingPanel = true;

        Cus = await Functions.GetAsync<List<PartiesModel>>($"Parties/Search", true) ?? new List<PartiesModel>();
        Cur = await Functions.GetAsync<List<CurrenciesModel>>($"Currencies/Search", true) ?? new List<CurrenciesModel>();
        itemsList = await Functions.GetAsync<List<ItemsModel>>($"Items/Search", true) ?? new List<ItemsModel>();

        if (Action == "INSERT")
        {
            record = new PurchaseOrdersModel();
            isReadOnly = false;
            purchaseOrderDetails = new List<PurchaseOrderDetailsModelExt>();
            AddNewItem();
        }
        else if (Action == "UPDATE")
        {
            await Get(CurrentRecord);
            isReadOnly = false;
        }
        else if (Action == "VIEW")
        {
            await Get(CurrentRecord);
            isReadOnly = true;
        }

        CalculateTotals();
        LoadingPanel = false;
    }

    protected async Task Get(string? id)
    {
        LoadingPanel = true;
        record = await Functions.GetAsync<PurchaseOrdersModel>($"PurchaseOrders/Get/{id}", true) ?? new();

        if (record.Id > 0)
        {
            var details = await Functions.GetAsync<List<PurchaseOrderDetailsModel>>($"PurchaseOrders/GetDetails/{id}", true) ?? new();
            var charges = await Functions.GetAsync<List<PurchaseOrderChargesModel>>($"PurchaseOrders/GetCharges/{id}", true) ?? new();

            // Convert details to extended models
            purchaseOrderDetails = details.Select((d, index) =>
            {
                var ext = new PurchaseOrderDetailsModelExt();
                // Copy all properties from base model
                ext.Id = d.Id;
                ext.Guid = d.Guid;
                ext.PurchaseOrderId = d.PurchaseOrderId;
                ext.ItemId = d.ItemId;
                ext.ItemDescription = d.ItemDescription;
                ext.Quantity = d.Quantity;
                ext.UnitPrice = d.UnitPrice;
                ext.DiscountPercent = d.DiscountPercent;
                ext.TaxPercent = d.TaxPercent;
                ext.DeliveryDate = d.DeliveryDate;
                ext.Remarks = d.Remarks;
                ext.CreatedBy = d.CreatedBy;
                ext.CreatedOn = d.CreatedOn;
                ext.UpdatedBy = d.UpdatedBy;
                ext.UpdatedOn = d.UpdatedOn;
                ext.IsSoftDeleted = d.IsSoftDeleted;
                ext.RowVersion = d.RowVersion;

                // Add UI-specific properties
                ext.SrNo = index + 1;
                ext.ItemName = itemsList.FirstOrDefault(i => i.Id == d.ItemId)?.Name ?? "";
                ext.LineTotal = CalculateItemTotal(d);

                return ext;
            }).ToList();

            // Convert charges to extended models
            purchaseOrderCharges = charges.Select(c =>
            {
                var ext = new PurchaseOrderChargesModelExt();
                // Copy all properties from base model
                ext.Id = c.Id;
                ext.Guid = c.Guid;
                ext.PurchaseOrderId = c.PurchaseOrderId;
                ext.AccountId = c.AccountId;
                ext.ChargeDescription = c.ChargeDescription;
                ext.Amount = c.Amount;
                ext.IsPercentage = c.IsPercentage;
                ext.PercentageValue = c.PercentageValue;
                ext.CreatedBy = c.CreatedBy;
                ext.CreatedOn = c.CreatedOn;
                ext.UpdatedBy = c.UpdatedBy;
                ext.UpdatedOn = c.UpdatedOn;
                ext.IsSoftDeleted = c.IsSoftDeleted;
                ext.RowVersion = c.RowVersion;

                // Add UI-specific property
                ext.ChargeAmount = c.IsPercentage == 1 ? (subTotal * c.PercentageValue / 100) : c.Amount;

                return ext;
            }).ToList();
        }
        else
        {
            purchaseOrderDetails = new List<PurchaseOrderDetailsModelExt>();
            purchaseOrderCharges = new List<PurchaseOrderChargesModelExt>();
        }

        CalculateTotals();
        LoadingPanel = false;
    }

    private double CalculateItemTotal(PurchaseOrderDetailsModel item)
    {
        double lineAmount = item.Quantity * item.UnitPrice;
        double discountAmount = lineAmount * (item.DiscountPercent / 100);
        double amountAfterDiscount = lineAmount - discountAmount;
        double taxAmount = amountAfterDiscount * (item.TaxPercent / 100);
        return amountAfterDiscount + taxAmount;
    }

    protected void GetDefaultValues()
    {
        if (Cus.Any() && record.CustomerId == 0)
            record.CustomerId = Cus.First().Id;
        if (Cur.Any() && record.CurrencyId == 0)
            record.CurrencyId = Cur.First().Id;

        StateHasChanged();
    }

    private void AddNewItem()
    {
        var newItem = new PurchaseOrderDetailsModelExt
        {
            Id = 0,
            PurchaseOrderId = record.Id,
            SrNo = purchaseOrderDetails.Count + 1,
            ItemId = 0,
            ItemDescription = "",
            Quantity = 1,
            UnitPrice = 0,
            DiscountPercent = 0,
            TaxPercent = 0,
            DeliveryDate = DateTime.Today,
            Remarks = "",
            LineTotal = 0
        };

        purchaseOrderDetails.Add(newItem);
        CalculateTotals();
        StateHasChanged();
    }

    private async Task OnItemSelected(PurchaseOrderDetailsModelExt poItem, int itemId)
    {
        if (itemId > 0)
        {
            var selectedItem = itemsList.FirstOrDefault(x => x.Id == itemId);
            if (selectedItem != null)
            {
                poItem.ItemName = selectedItem.Name ?? "";
                poItem.ItemDescription = selectedItem.Description ?? "";
                poItem.UnitPrice = selectedItem.CostPrice;
                CalculateLineTotal(poItem);
                StateHasChanged();
            }
        }
    }

    private void RemoveItem(PurchaseOrderDetailsModelExt item)
    {
        purchaseOrderDetails.Remove(item);
        for (int i = 0; i < purchaseOrderDetails.Count; i++)
        {
            purchaseOrderDetails[i].SrNo = i + 1;
        }
        CalculateTotals();
        StateHasChanged();
    }

    private void CalculateLineTotal(PurchaseOrderDetailsModelExt item)
    {
        item.LineTotal = CalculateItemTotal(item);
        CalculateTotals();
        StateHasChanged();
    }

    private void CalculateTotals()
    {
        subTotal = purchaseOrderDetails.Sum(x => x.Quantity * x.UnitPrice);
        totalDiscount = purchaseOrderDetails.Sum(x => (x.Quantity * x.UnitPrice) * (x.DiscountPercent / 100));
        totalTax = purchaseOrderDetails.Sum(x =>
            ((x.Quantity * x.UnitPrice) - ((x.Quantity * x.UnitPrice) * (x.DiscountPercent / 100))) * (x.TaxPercent / 100));
        grandTotal = subTotal - totalDiscount + totalTax;

        // Add charges to grand total
        foreach (var charge in purchaseOrderCharges)
        {
            charge.ChargeAmount = charge.IsPercentage == 1 ? (subTotal * charge.PercentageValue / 100) : charge.Amount;
            grandTotal += charge.ChargeAmount;
        }
    }

    protected async Task Clear()
    {
        Action = "INSERT";
        record = new PurchaseOrdersModel();
        purchaseOrderDetails = new List<PurchaseOrderDetailsModelExt>();
        purchaseOrderCharges = new List<PurchaseOrderChargesModelExt>();
        isReadOnly = false;
        AddNewItem();
    }

    protected async Task Edit(string? id)
    {
        await Get(id);
        Action = "UPDATE";
        isReadOnly = false;
    }

    protected async Task Delete()
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete existing record?");
        if (!res) return;

        Action = "SOFTDELETE";
        await Save();
    }

    private void DetailDialog()
    {
        _DialogOrderDetails.Show();
    }


    protected async Task Save()
    {
        try
        {
            LoadingPanel = true;

            record.OrganizationId = Globals.User.OrganizationId;
            record.CreatedBy = Globals.User.Id;
            record.CreatedOn = DateTime.Now;
            record.CreatedFrom = Functions.GetComputerDetails();
            record.UpdatedBy = Globals.User.Id;
            record.UpdatedOn = DateTime.Now;
            record.UpdatedFrom = Functions.GetComputerDetails();

            string url = char.ToUpper(Action[0]) + Action.Substring(1).ToLower();
            var result = await Functions.PostAsync<PurchaseOrdersModel>($"PurchaseOrders/{url}", record, true);

            if (!result.Success)
            {
                await Functions.ShowMessage(dialogService, "error", "Record Not Saved");
            }
            else
            {
                if (!url.Contains("delete", StringComparison.OrdinalIgnoreCase) && result.Result != null)
                {
                    // Save purchase order details
                    foreach (var item in purchaseOrderDetails)
                    {
                        // Create base model from extended model
                        var detailModel = new PurchaseOrderDetailsModel
                        {
                            Id = item.Id,
                            Guid = item.Guid,
                            PurchaseOrderId = result.Result.Id,
                            ItemId = item.ItemId,
                            ItemDescription = item.ItemDescription,
                            Quantity = item.Quantity,
                            UnitPrice = item.UnitPrice,
                            DiscountPercent = item.DiscountPercent,
                            TaxPercent = item.TaxPercent,
                            DeliveryDate = item.DeliveryDate,
                            Remarks = item.Remarks,
                            CreatedBy = Globals.User.Id,
                            CreatedOn = DateTime.Now,
                            UpdatedBy = Globals.User.Id,
                            UpdatedOn = DateTime.Now
                        };

                        await Functions.PostAsync<PurchaseOrderDetailsModel>($"PurchaseOrders/SaveDetail", detailModel, true);
                    }

                    // Save purchase order charges
                    foreach (var charge in purchaseOrderCharges)
                    {
                        // Create base model from extended model
                        var chargeModel = new PurchaseOrderChargesModel
                        {
                            Id = charge.Id,
                            Guid = charge.Guid,
                            PurchaseOrderId = result.Result.Id,
                            AccountId = charge.AccountId,
                            ChargeDescription = charge.ChargeDescription,
                            Amount = charge.Amount,
                            IsPercentage = charge.IsPercentage,
                            PercentageValue = charge.PercentageValue,
                            CreatedBy = Globals.User.Id,
                            CreatedOn = DateTime.Now,
                            UpdatedBy = Globals.User.Id,
                            UpdatedOn = DateTime.Now
                        };

                        await Functions.PostAsync<PurchaseOrderChargesModel>($"PurchaseOrders/SaveCharge", chargeModel, true);
                    }

                    await Functions.ShowMessage(dialogService, "success", $"Record {Action} Successfully");
                    await Edit(result.Result.Id.ToString());
                }
                else
                {
                    await Functions.ShowMessage(dialogService, "success", $"Record {Action} Successfully");
                    await Clear();
                }
            }
        }
        catch (Exception ex)
        {
            await Functions.ShowMessage(dialogService, "error", $"Error saving record: {ex.Message}");
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    public class PurchaseOrderDetailsModelExt : PurchaseOrderDetailsModel
    {
        public int SrNo { get; set; }
        public string ItemName { get; set; } = "";
        public double LineTotal { get; set; }
    }

    public class PurchaseOrderChargesModelExt : PurchaseOrderChargesModel
    {
        public double ChargeAmount { get; set; }
    }
}

            
<style>
    .page-container {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        background-color: #f8f9fa;
        min-height: 100vh;
    }

    .action-toolbar {
        display: flex;
        justify-content: flex-start;
        gap: 12px;
        padding: 12px 0;
    }

    .action-btn {
        min-width: 120px;
        height: 40px;
        font-weight: 500;
    }

    .section-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 0px solid #e9ecef;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e9ecef;
    }

    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e9ecef;
    }

    .header-avatar {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #3f51b5 0%, #2196f3 100%);
    }

    .header-info {
        flex: 1;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        width: 100%;
        margin:10px;
    }

    .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .two-column {
        grid-column: span 2;
    }

    .field-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
    }

    .table-container {
        margin: 20px 0;
        overflow-x: auto;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }

    .summary-container {
        display: flex;
        justify-content: flex-end;
        margin-top: 24px;
    }

    .summary-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        min-width: 300px;
        border: 1px solid #dee2e6;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }

    .summary-divider {
        height: 1px;
        background-color: #dee2e6;
        margin: 12px 0;
    }

    .grand-total {
        padding-top: 12px;
        border-top: 2px solid #dee2e6;
    }

    .text-error {
        color: #dc3545;
    }

    .text-warning {
        color: #fd7e14;
    }

    /* Responsive adjustments */
    @@media (max-width: 1200px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .two-column {
            grid-column: span 1;
        }
    }

    @@media (max-width: 768px) {
        .page-container {
            padding: 12px;
        }

        .section-container {
            padding: 16px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .two-column {
            grid-column: span 1;
        }

        .action-toolbar {
            flex-direction: column;
            align-items: stretch;
        }

        .action-btn {
            width: 100%;
        }

        .summary-card {
            min-width: 100%;
        }

        .section-header, .section-title {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
    }

    @@media (max-width: 480px) {
        .table-container {
            margin: 0 -12px;
            border-left: none;
            border-right: none;
            border-radius: 0;
        }
    }
</style>