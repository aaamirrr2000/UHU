@page "/StockMovementReport/{id:int}"
@using NG.MicroERP.Shared.Models
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@inject Functions Functions
@inject Globals Globals

@if (movement != null)
{
    <div class="movement-actions no-print text-end mb-3">
        <button class="btn btn-outline-secondary me-2" @onclick="GoBack">
            <i class="fas fa-arrow-left me-1"></i> Back
        </button>
        <button class="btn btn-primary" @onclick="PrintReport">
            <i class="fas fa-print me-1"></i> Print
        </button>
    </div>

    <div id="stock-movement-print-content" class="movement-receipt shadow p-4 bg-white rounded">
        <!-- Header -->
        <div class="text-center mb-4">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <img src="@Globals.GetImageUrl(Globals.Organization.Logo)" alt="Logo" class="img-fluid rounded" style="height: 60px;" />
                </div>
                <div class="col-md-8">
                    <h2 class="fw-bold m-0">@Globals.Organization.Name</h2>
                    <h5 class="text-muted mt-1">@GetDocumentTypeName(movement.DocumentType)</h5>
                </div>
            </div>
            <p class="text-muted mt-2">Date: @movement.MovementDate?.ToString("dd-MMM-yyyy")</p>
        </div>

        <!-- Info Table -->
        <table class="table table-bordered table-sm">
            <tbody>
                <tr>
                    <th style="width: 35%;">Document #</th>
                    <td><strong>@movement.MovementNo</strong></td>
                </tr>
                <tr>
                    <th>Document Type</th>
                    <td>@GetDocumentTypeName(movement.DocumentType)</td>
                </tr>
                <tr>
                    <th>Movement Type</th>
                    <td>@movement.MovementType</td>
                </tr>
                @if (movement.FromLocationId > 0)
                {
                    <tr>
                        <th>From Location</th>
                        <td>@movement.FromLocationName</td>
                    </tr>
                }
                @if (movement.ToLocationId > 0)
                {
                    <tr>
                        <th>To Location</th>
                        <td>@movement.ToLocationName</td>
                    </tr>
                }
                <tr>
                    <th>Movement Date</th>
                    <td>@movement.MovementDate?.ToString("dd-MMM-yyyy")</td>
                </tr>
                <tr>
                    <th>Status</th>
                    <td><strong>@movement.Status</strong></td>
                </tr>
                @if (!string.IsNullOrWhiteSpace(movement.ReferenceNo))
                {
                    <tr>
                        <th>Reference No</th>
                        <td>@movement.ReferenceNo</td>
                    </tr>
                }
                @if (!string.IsNullOrWhiteSpace(movement.Reason))
                {
                    <tr>
                        <th>Reason</th>
                        <td>@movement.Reason</td>
                    </tr>
                }
                @if (movement.ApprovedBy > 0)
                {
                    <tr>
                        <th>Approved By</th>
                        <td>@movement.ApprovedByName</td>
                    </tr>
                    @if (movement.ApprovedDate.HasValue)
                    {
                        <tr>
                            <th>Approved Date</th>
                            <td>@movement.ApprovedDate.Value.ToString("dd-MMM-yyyy HH:mm:ss")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <!-- Items Table -->
        @if (movement.Details != null && movement.Details.Count > 0)
        {
            <div class="mt-4">
                <h5 class="fw-bold mb-3">Items</h5>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Stock Condition</th>
                            <th class="text-end">Quantity</th>
                            <th class="text-end">Unit Cost</th>
                            <th class="text-end">Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var detail in movement.Details.OrderBy(d => d.SeqNo))
                        {
                            <tr>
                                <td>@detail.SeqNo</td>
                                <td>@detail.ItemCode</td>
                                <td>@detail.ItemName</td>
                                <td>@detail.StockCondition</td>
                                <td class="text-end">@detail.Quantity.ToString("N2")</td>
                                <td class="text-end">@detail.UnitCost.ToString("N2")</td>
                                <td class="text-end"><strong>@detail.TotalCost.ToString("N2")</strong></td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4" class="text-end">Total:</th>
                            <th class="text-end">@movement.Details.Sum(d => d.Quantity).ToString("N2")</th>
                            <th></th>
                            <th class="text-end"><strong>@movement.Details.Sum(d => d.TotalCost).ToString("N2")</strong></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(movement.Notes))
        {
            <div class="mt-3 mb-4">
                <strong>Notes:</strong>
                <p>@movement.Notes</p>
            </div>
        }

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-md-6">
                <p><strong>Created By:</strong> @(movement.CreatedBy > 0 ? "User " + movement.CreatedBy : "System")</p>
                <p><strong>Created Date:</strong> @movement.CreatedOn.ToString("dd-MMM-yyyy HH:mm:ss")</p>
            </div>
            <div class="col-md-6">
                @if (movement.UpdatedOn != DateTime.MinValue)
                {
                    <p><strong>Modified By:</strong> @(movement.UpdatedBy > 0 ? "User " + movement.UpdatedBy : "System")</p>
                    <p><strong>Modified Date:</strong> @movement.UpdatedOn.ToString("dd-MMM-yyyy HH:mm:ss")</p>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }
    private StockMovementModel? movement;
    private bool LoadingPanel { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        Globals.AccessLevel = Globals.PageAccess(NavManager, "StockMovementsDashboard");
        LoadingPanel = true;
        movement = await Functions.GetAsync<StockMovementModel>($"StockMovements/Get/{id}", true);
        LoadingPanel = false;
    }

    private async Task PrintReport()
    {
        await JSRuntime.InvokeVoidAsync("printStockMovement");
    }

    private void GoBack()
    {
        NavManager.NavigateTo("/StockMovementsDashboard");
    }

    private string GetDocumentTypeName(string? documentType)
    {
        return documentType?.ToUpper() switch
        {
            "GRN" => "Goods Receipt Note",
            "SIR" => "Stock Issue Requisition",
            "STN" => "Stock Transfer Note",
            "ADJ" => "Adjustment",
            "RTN" => "Return",
            "DMG" => "Damage",
            "LSS" => "Loss",
            _ => "Stock Movement"
        };
    }
}

<style>
    .movement-receipt {
        max-width: 800px;
        width: 100%;
        margin: auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .movement-receipt .table th, .movement-receipt .table td {
        padding: 8px;
        text-align: left;
    }

    .movement-receipt .table th {
        background-color: #f2f2f2;
    }

    .text-center {
        text-align: center;
    }

    @@media print {
        .no-print {
            display: none !important;
        }

        body {
            margin: 0;
            padding: 20px;
        }

        .movement-receipt {
            box-shadow: none;
            border: none;
            max-width: 100%;
        }
    }
</style>

<script>
    function printStockMovement() {
        var printContent = document.getElementById('stock-movement-print-content');
        if (printContent) {
            var originalContent = document.body.innerHTML;
            document.body.innerHTML = '<div>' + printContent.innerHTML + '</div>';
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }
    }
</script>
