@page "/StockMovementPage/{Action}/{CurrentRecord?}"
@using System.Collections.ObjectModel
@using NG.MicroERP.Shared.Models

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<div class="d-flex flex-column" style="margin: 5px; height: 100%; overflow-y: auto;">
    <div class="text-end mb-3" style="position: sticky; top: 0; background: white; z-index: 10; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
        @if (Action != "VIEW")
        {
            <MudButton Variant="Variant.Filled" OnClick="Save" Color="Color.Info" Class="px-3 py-2 mr-2" Style="height:40px; min-width: 100px;">
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                @(Action == "INSERT" ? "Save" : "Update")
            </MudButton>
            @if (Action == "UPDATE")
            {
                <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="Delete" Class="px-3 py-2 mr-2" Style="height:40px; min-width: 100px;">
                    <MudIcon Icon="@Icons.Material.Filled.Delete" Class="mr-1" />
                    Delete
                </MudButton>
            }
        }
    </div>

    <!-- Movement Header -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row g-2">
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Document No</label>
                    <MudTextField @bind-Value="record.MovementNo" ReadOnly="@true" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                    <MudText Typo="Typo.caption" Class="text-muted">Auto-generated</MudText>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Document Type</label>
                    <MudSelect T="string" @bind-Value="record.DocumentType" @bind-Value:after="OnDocumentTypeChanged" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@isReadOnly">
                        <MudSelectItem Value="@("GRN")">GRN - Goods Receipt Note</MudSelectItem>
                        <MudSelectItem Value="@("SIR")">SIR - Stock Issue Requisition</MudSelectItem>
                        <MudSelectItem Value="@("STN")">STN - Stock Transfer Note</MudSelectItem>
                        <MudSelectItem Value="@("ADJ")">ADJ - Adjustment</MudSelectItem>
                        <MudSelectItem Value="@("RTN")">RTN - Return</MudSelectItem>
                        <MudSelectItem Value="@("DMG")">DMG - Damage</MudSelectItem>
                        <MudSelectItem Value="@("LSS")">LSS - Loss</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Movement Type</label>
                    <MudSelect T="string" @bind-Value="record.MovementType" @bind-Value:after="OnMovementTypeChanged" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@isReadOnly">
                        <MudSelectItem Value="@("TRANSFER")">TRANSFER</MudSelectItem>
                        <MudSelectItem Value="@("ADJUSTMENT")">ADJUSTMENT</MudSelectItem>
                        <MudSelectItem Value="@("RETURN")">RETURN</MudSelectItem>
                        <MudSelectItem Value="@("DAMAGE")">DAMAGE</MudSelectItem>
                        <MudSelectItem Value="@("LOSS")">LOSS</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">From Location</label>
                    @if (isReadOnly || Globals.User.GroupId != 1)
                    {
                        <MudTextField Value="@(Locations.FirstOrDefault(l => l.Id == record.FromLocationId)?.Name ?? "")" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="LocationsModel" DataList="@Locations" DisplayProperty="@(p => p.Name)" IdProperty="@(p => p.Id)" @bind-SelectedId="record.FromLocationId" Variant="Variant.Outlined" Label="" FullWidth="@true" />
                    }
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">To Location</label>
                    @if (isReadOnly || Globals.User.GroupId != 1)
                    {
                        <MudTextField Value="@(Locations.FirstOrDefault(l => l.Id == record.ToLocationId)?.Name ?? "")" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="LocationsModel" DataList="@Locations" DisplayProperty="@(p => p.Name)" IdProperty="@(p => p.Id)" @bind-SelectedId="record.ToLocationId" Variant="Variant.Outlined" Label="" FullWidth="@true" />
                    }
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Movement Date</label>
                    <MudDatePicker @bind-Date="record.MovementDate" DateFormat="yyyy-MM-dd" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Status</label>
                    <MudSelect T="string" @bind-Value="record.Status" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" ReadOnly="@isReadOnly">
                        <MudSelectItem Value="@("PENDING")">PENDING</MudSelectItem>
                        <MudSelectItem Value="@("IN_TRANSIT")">IN_TRANSIT</MudSelectItem>
                        <MudSelectItem Value="@("COMPLETED")">COMPLETED</MudSelectItem>
                        <MudSelectItem Value="@("CANCELLED")">CANCELLED</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Reference No</label>
                    <MudTextField @bind-Value="record.ReferenceNo" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Reason</label>
                    <MudTextField @bind-Value="record.Reason" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Dense="@true" FullWidth="@true" />
                </div>
            </div>
        </MudCardContent>
    </MudCard>

    <!-- Movement Details -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <MudText Typo="Typo.subtitle2" Class="fw-bold">Movement Items</MudText>
                @if (!isReadOnly)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" Dense="@true" OnClick="AddDetailLine">Add Line</MudButton>
                }
            </div>
            <div style="max-height: 350px; overflow-y: auto;">
                <MudTable Items="@record.Details" Hover="true" Dense="@true" Bordered="true" Striped="true" StickyHeader="true">
                    <HeaderContent>
                        <MudTh Style="width:5%;">#</MudTh>
                        <MudTh Style="width:5%;">â‹®</MudTh>
                        <MudTh Style="width:25%;">Item</MudTh>
                        <MudTh Style="width:10%;">Stock Condition</MudTh>
                        <MudTh Style="width:10%;" Class="text-end">Quantity</MudTh>
                        <MudTh Style="width:10%;" Class="text-end">Unit Cost</MudTh>
                        <MudTh Style="width:10%;" Class="text-end">Total Cost</MudTh>
                        <MudTh Style="width:25%;">Description</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="detail">
                        @{ var index = record.Details.IndexOf(detail) + 1; }
                        <MudTd>@index</MudTd>
                        <MudTd>
                            @if (!isReadOnly)
                            {
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="@true">
                                    <MudMenuItem OnClick="@(() => RemoveDetailLine(detail))" Color="Color.Error">
                                        <MudIcon Icon="@Icons.Material.Filled.Delete" Class="me-2" />Delete
                                    </MudMenuItem>
                                </MudMenu>
                            }
                        </MudTd>
                        <MudTd>
                            @if (isReadOnly)
                            {
                                <MudTextField Value="@(Items.FirstOrDefault(i => i.Id == detail.ItemId)?.DisplayName ?? "")" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@true" />
                            }
                            else
                            {
                                <AutoComplete TItem="ItemsModel" DataList="@Items" DisplayProperty="@(p => p.DisplayName)" IdProperty="@(p => p.Id)" @bind-SelectedId="detail.ItemId" Variant="Variant.Outlined" Label="" FullWidth="@true" />
                            }
                        </MudTd>
                        <MudTd>
                            <MudSelect T="string" @bind-Value="detail.StockCondition" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly">
                                <MudSelectItem Value="@("NEW")">NEW</MudSelectItem>
                                <MudSelectItem Value="@("USED")">USED</MudSelectItem>
                                <MudSelectItem Value="@("DAMAGED")">DAMAGED</MudSelectItem>
                            </MudSelect>
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.Quantity" Format="#,##0.00" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly" @bind-Value:after="@(() => CalculateDetailTotal(detail))" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.UnitCost" Format="#,##0.00" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly" @bind-Value:after="@(() => CalculateDetailTotal(detail))" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.TotalCost" Format="#,##0.00" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@true" />
                        </MudTd>
                        <MudTd>
                            <MudTextField @bind-Value="detail.Description" Variant="Variant.Outlined" FullWidth="@true" Dense="@true" ReadOnly="@isReadOnly" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2" style="font-size: 0.9rem;">
                <MudText Typo="Typo.body2" Class="fw-bold">Total Quantity: <span style="color: #4CAF50;">@TotalQuantity.ToString("N2")</span></MudText>
                <MudText Typo="Typo.body2" Class="fw-bold">Total Value: <span style="color: #2196F3;">@TotalValue.ToString("C")</span></MudText>
            </div>
        </MudCardContent>
    </MudCard>

    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row">
                <div class="col-12">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Notes</label>
                    <MudTextField @bind-Value="record.Notes" ReadOnly="@isReadOnly" Variant="Variant.Outlined" Lines="3" FullWidth="@true" />
                </div>
            </div>
        </MudCardContent>
    </MudCard>
</div>

@code {
    StockMovementModel record = new();
    List<LocationsModel> Locations = new();
    List<ItemsModel> Items = new();

    [Parameter] public string? Action { get; set; } = "INSERT";
    [Parameter] public int CurrentRecord { get; set; } = 0;
    [Parameter] public EventCallback OnSaved { get; set; }

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;

    private double TotalQuantity => record.Details?.Sum(d => d.Quantity) ?? 0;
    private double TotalValue => record.Details?.Sum(d => d.TotalCost) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        if (record.Details == null)
            record.Details = new ObservableCollection<StockMovementDetailModel>();
        
        Locations = await Functions.GetAsync<List<LocationsModel>>($"Locations/Search/OrganizationId={Globals.User.OrganizationId} AND IsActive=1", true) ?? new List<LocationsModel>();
        Items = await Functions.GetAsync<List<ItemsModel>>($"Items/Search", true) ?? new List<ItemsModel>();

        if (Action == "INSERT")
        {
            Clear();
            isReadOnly = false;
        }
        else if (CurrentRecord > 0)
        {
            await Get(CurrentRecord);
        }
    }

    protected async Task Get(int id)
    {
        LoadingPanel = true;
        record = await Functions.GetAsync<StockMovementModel>($"StockMovements/Get/{id}", true) ?? new StockMovementModel();
        if (record.Details == null)
            record.Details = new ObservableCollection<StockMovementDetailModel>();
        // Lock location for non-admin users
        if (Globals.User.GroupId != 1)
        {
            if (record.FromLocationId != Globals.User.LocationId)
                record.FromLocationId = Globals.User.LocationId;
            if (record.ToLocationId != Globals.User.LocationId)
                record.ToLocationId = Globals.User.LocationId;
        }
        isReadOnly = Action == "VIEW";
        LoadingPanel = false;
    }

    protected void Clear()
    {
        Action = "INSERT";
        record = new StockMovementModel();
        record.Details = new ObservableCollection<StockMovementDetailModel>();
        record.MovementType = "TRANSFER";
        record.DocumentType = "STN"; // Default to Stock Transfer Note
        record.Status = "PENDING";
        record.MovementDate = DateTime.Today;
        // Set location for non-admin users
        if (Globals.User.GroupId != 1)
        {
            record.FromLocationId = Globals.User.LocationId;
            record.ToLocationId = Globals.User.LocationId;
        }
        isReadOnly = false;
    }

    protected void OnDocumentTypeChanged()
    {
        // Auto-update MovementType based on DocumentType if not set
        if (string.IsNullOrWhiteSpace(record.MovementType))
        {
            record.MovementType = record.DocumentType?.ToUpper() switch
            {
                "GRN" => "TRANSFER",  // Goods Receipt is a transfer in
                "SIR" => "TRANSFER",  // Stock Issue is a transfer out
                "STN" => "TRANSFER",  // Stock Transfer Note
                "ADJ" => "ADJUSTMENT", // Adjustment
                "RTN" => "RETURN",     // Return
                "DMG" => "DAMAGE",     // Damage
                "LSS" => "LOSS",       // Loss
                _ => "TRANSFER"
            };
        }
        StateHasChanged();
    }

    protected void OnMovementTypeChanged()
    {
        // Auto-update DocumentType based on MovementType if not set
        if (string.IsNullOrWhiteSpace(record.DocumentType))
        {
            record.DocumentType = record.MovementType?.ToUpper() switch
            {
                "TRANSFER" => "STN",  // Stock Transfer Note
                "ADJUSTMENT" => "ADJ", // Adjustment
                "RETURN" => "RTN",     // Return
                "DAMAGE" => "DMG",     // Damage
                "LOSS" => "LSS",       // Loss
                _ => "STN"
            };
        }
        StateHasChanged();
    }

    protected void AddDetailLine()
    {
        if (record.Details == null)
            record.Details = new ObservableCollection<StockMovementDetailModel>();
        record.Details.Add(new StockMovementDetailModel { SeqNo = record.Details.Count + 1, StockCondition = "NEW" });
        StateHasChanged();
    }

    protected void RemoveDetailLine(StockMovementDetailModel detail)
    {
        if (record.Details != null)
        {
            record.Details.Remove(detail);
            for (int i = 0; i < record.Details.Count; i++)
                record.Details[i].SeqNo = i + 1;
            StateHasChanged();
        }
    }

    protected void CalculateDetailTotal(StockMovementDetailModel detail)
    {
        detail.TotalCost = detail.Quantity * detail.UnitCost;
        StateHasChanged();
    }

    protected async Task Delete()
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete this record?");
        if (res == false) return;
        Action = "SOFTDELETE";
        await Save();
    }

    protected async Task Save()
    {
        if (record.Details == null || record.Details.Count == 0)
        {
            SnackbarService.Add("Please add at least one item line.", Severity.Warning);
            return;
        }

        if (record.FromLocationId == 0 && record.ToLocationId == 0)
        {
            SnackbarService.Add("Please select at least one location (From or To).", Severity.Warning);
            return;
        }

        record.OrganizationId = Globals.User.OrganizationId;
        record.CreatedBy = Globals.User.Id;
        record.CreatedOn = DateTime.Now;
        record.CreatedFrom = Globals.ClientInfo;
        record.UpdatedBy = Globals.User.Id;
        record.UpdatedOn = DateTime.Now;
        record.UpdatedFrom = Globals.ClientInfo;

        LoadingPanel = true;
        var result = await Functions.PostAsync<StockMovementModel>($"StockMovements/{Action}", record, true);
        LoadingPanel = false;

        if (result.Success == false || result.Result == null)
        {
            SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
        }
        else
        {
            await OnSaved.InvokeAsync();
            SnackbarService.Add($"Record {Action} Successfully", Severity.Success);
        }
    }
}

