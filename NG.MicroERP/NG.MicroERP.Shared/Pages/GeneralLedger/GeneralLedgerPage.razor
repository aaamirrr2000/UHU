@page "/GeneralLedgerPage/{Action}/{CurrentRecord?}"
@using System.Collections.ObjectModel
@using NG.MicroERP.Shared.Pages.Invoices

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject FileUploadService FileUploadService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<div class="d-flex flex-column" style="margin: 5px; height: 100%; overflow-y: auto;">

    <div class="text-end mb-3" style="position: sticky; top: 0; background: white; z-index: 10; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
        @if (Action != "VIEW")
        {
            <MudButton Variant="Variant.Filled" OnClick="Save" Color="Color.Info" Class="px-3 py-2 mr-2" Style="height:40px; min-width: 100px;">
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                @(Action == "INSERT" ? "Save" : "Update")
            </MudButton>

            <!-- Preview Entry - Available before and after saving -->
            <MudButton Variant="Variant.Filled" OnClick="ShowGLPreview" Color="Color.Info" Class="px-3 py-2 mr-2" Style="height:40px; min-width: 100px;"
                       Disabled="@(record?.Details == null || !record.Details.Any() || record.Details.All(d => d.DebitAmount == 0 && d.CreditAmount == 0))">
                <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="mr-1" />
                @(CurrentRecord > 0 && record?.IsPosted == 1 ? "View Entry" : "Preview Entry")
            </MudButton>

            @if (Action == "UPDATE" && record.IsPosted == 0)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="Delete" Class="px-3 py-2 mr-2" Style="height:40px; min-width: 100px;">
                    <MudIcon Icon="@Icons.Material.Filled.Delete" Class="mr-1" />
                    Delete
                </MudButton>
            }
        }
    </div>

    <!-- Period Validation Warning -->
    @if (!string.IsNullOrWhiteSpace(PeriodValidationMessage))
    {
        <MudAlert Severity="Severity.Warning" Class="mb-2" Variant="Variant.Outlined" Dense="true">
            <MudText Typo="Typo.body2">@PeriodValidationMessage</MudText>
        </MudAlert>
    }
    else if (PeriodValidationChecked && record?.EntryDate != null && record.OrganizationId > 0)
    {
        <MudAlert Severity="Severity.Success" Class="mb-2" Variant="Variant.Outlined" Dense="true">
            <MudText Typo="Typo.body2">✓ Period is OPEN - You can save transactions for this date.</MudText>
        </MudAlert>
    }

    <!-- Entry Header Information -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row g-2">
                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Entry No</label>
                    <MudTextField id="EntryNo"
                                  Value="@(record.EntryNo ?? "Auto-generated")"
                                  placeholder="Entry No (Auto-generated)"
                                  ReadOnly="true"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  FullWidth="@true" />
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Entry Date</label>
                    <MudDatePicker @bind-Date="record.EntryDate"
                                   @bind-Date:after="OnEntryDateChanged"
                                   DateFormat="yyyy-MM-dd"
                                   placeholder="Entry Date"
                                   ReadOnly="@isReadOnly"
                                   Variant="Variant.Outlined"
                                   Dense="@true"
                                   FullWidth="@true" />
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Source</label>
                    <MudTextField Value="@(record.Source ?? "MANUAL")"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  FullWidth="@true"
                                  ReadOnly="@true" />
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Location</label>
                    @if (isReadOnly || Globals.User.GroupId != 1)
                    {
                        <MudTextField Value="@(Loc.FirstOrDefault(l => l.Id == record.LocationId)?.Name ?? "")"
                                      Variant="Variant.Outlined"
                                      Dense="@true"
                                      FullWidth="@true"
                                      ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="LocationsModel"
                                      DataList="@Loc"
                                      DisplayProperty="@(p => p.Name)"
                                      IdProperty="@(p => p.Id)"
                                      @bind-SelectedId="record.LocationId"
                                      Variant="Variant.Outlined"
                                      Label=""
                                      FullWidth="@true" />
                    }
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Reference Type</label>
                    @if (isReadOnly)
                    {
                        <MudTextField Value="@(record.ReferenceType ?? "JOURNAL")"
                                      Variant="Variant.Outlined"
                                      Dense="@true"
                                      FullWidth="@true"
                                      ReadOnly="@true" />
                    }
                    else
                    {
                        <MudSelect T="string"
                                    @bind-Value="record.ReferenceType"
                                    Placeholder="Reference Type"
                                    Variant="Variant.Outlined"
                                    Clearable="true"
                                    Dense="@true"
                                    FullWidth="@true">
                            @if (RefTypes != null && RefTypes.Any())
                            {
                                if (string.IsNullOrWhiteSpace(record.ReferenceType))
                                {
                                    record.ReferenceType = RefTypes.First().ListValue;
                                }
                                foreach (var i in RefTypes)
                                {
                                    <MudSelectItem T="string" Value="@i.ListValue">@i.ListValue</MudSelectItem>
                                }
                            }
                            else
                            {
                                <MudSelectItem T="string" Value="@("JOURNAL")">JOURNAL</MudSelectItem>
                                <MudSelectItem T="string" Value="@("INVOICE")">INVOICE</MudSelectItem>
                                <MudSelectItem T="string" Value="@("PAYMENT")">PAYMENT</MudSelectItem>
                                <MudSelectItem T="string" Value="@("RECEIPT")">RECEIPT</MudSelectItem>
                                <MudSelectItem T="string" Value="@("CASHBOOK")">CASHBOOK</MudSelectItem>
                                <MudSelectItem T="string" Value="@("ADJUSTMENT")">ADJUSTMENT</MudSelectItem>
                            }
                        </MudSelect>
                    }
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Reference No</label>
                    <MudTextField id="ReferenceNo"
                                  @bind-Value="record.ReferenceNo"
                                  placeholder="Reference No"
                                  ReadOnly="@isReadOnly"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  FullWidth="@true" />
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Party (Optional)</label>
                    @if (isReadOnly)
                    {
                        <MudTextField Value="@(Par.FirstOrDefault(p => p.Id == record.PartyId)?.DisplayName ?? "")"
                                      Variant="Variant.Outlined"
                                      Dense="@true"
                                      FullWidth="@true"
                                      ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="PartiesModel"
                                      DataList="@Par"
                                      DisplayProperty="@(p => p.DisplayName)"
                                      IdProperty="@(p => p.Id)"
                                      @bind-SelectedId="record.PartyId"
                                      Variant="Variant.Outlined"
                                      Label=""
                                      FullWidth="@true" />
                    }
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Description</label>
                    <MudTextField id="Description"
                                  @bind-Value="record.Description"
                                  placeholder="Description"
                                  ReadOnly="@isReadOnly"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  FullWidth="@true" />
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Base Currency</label>
                    <MudTextField Value="@(Currencies.FirstOrDefault(c => c.Id == record.BaseCurrencyId)?.DisplayName ?? "")"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  FullWidth="@true"
                                  ReadOnly="true" />
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Entered Currency</label>
                    @if (isReadOnly)
                    {
                        <MudTextField Value="@(Currencies.FirstOrDefault(c => c.Id == record.EnteredCurrencyId)?.DisplayName ?? "")"
                                      Variant="Variant.Outlined"
                                      Dense="@true"
                                      FullWidth="@true"
                                      ReadOnly="@true" />
                    }
                    else
                    {
                        <AutoComplete TItem="CurrenciesModel"
                                      DataList="@Currencies"
                                      DisplayProperty="@(p => p.DisplayName)"
                                      IdProperty="@(p => p.Id)"
                                      @bind-SelectedId="record.EnteredCurrencyId"
                                      @bind-SelectedId:after="OnEnteredCurrencyChanged"
                                      Label=""
                                      Variant="Variant.Outlined"
                                      FullWidth="@true" />
                    }
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Exchange Rate</label>
                    <MudNumericField @bind-Value="record.ExchangeRate"
                                     Format="#,##0.000000"
                                     placeholder="Exchange Rate"
                                     ReadOnly="@isReadOnly"
                                     Variant="Variant.Outlined"
                                     Dense="@true"
                                     FullWidth="@true" />
                </div>
            </div>
        </MudCardContent>
    </MudCard>

    <!-- Account Details -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <MudText Typo="Typo.subtitle2" Class="fw-bold">Account Details</MudText>
                @if (!isReadOnly)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Add" 
                              Variant="Variant.Filled" 
                              Color="Color.Success" 
                              Size="Size.Small"
                              Dense="@true"
                              OnClick="AddDetailLine">
                        Add Line
                    </MudButton>
                }
            </div>

            <div class="d-flex align-items-center gap-2 mb-2" style="flex-wrap: wrap; font-size: 0.9rem;">
                <MudText Typo="Typo.body2" Class="fw-bold">
                    Debit: <span style="color: #4CAF50;">@TotalDebit.ToString("N2")</span>
                </MudText>
                <MudText Typo="Typo.body2" Class="fw-bold">
                    Credit: <span style="color: #2196F3;">@TotalCredit.ToString("N2")</span>
                </MudText>
                @if (Math.Abs(TotalDebit - TotalCredit) < 0.01)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Balanced</MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">
                        Diff: @Math.Abs(TotalDebit - TotalCredit).ToString("N2")
                    </MudChip>
                }
            </div>

            <div style="max-height: 350px; overflow-y: auto;">
                <MudTable Items="@record.Details"
                          Hover="true"
                          Dense="@true"
                          Bordered="true"
                          Striped="true"
                          StickyHeader="true">
                    <HeaderContent>
                        <MudTh Style="width:5%;">#</MudTh>
                        <MudTh Style="width:5%;">⋮</MudTh>
                        <MudTh Style="width:25%;">Account</MudTh>
                        <MudTh Style="width:20%;">Description</MudTh>
                        <MudTh Style="width:15%;" Class="text-end">Debit</MudTh>
                        <MudTh Style="width:15%;" Class="text-end">Credit</MudTh>
                        <MudTh Style="width:15%;">Party</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="detail">
                        @{
                            var index = record.Details.IndexOf(detail) + 1;
                        }
                        <MudTd>@index</MudTd>
                        <MudTd>
                            @if (!isReadOnly)
                            {
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="@true">
                                    <MudMenuItem OnClick="@(() => RemoveDetailLine(detail))" Color="Color.Error">
                                        <MudIcon Icon="@Icons.Material.Filled.Delete" Class="me-2" />
                                        Delete
                                    </MudMenuItem>
                                </MudMenu>
                            }
                        </MudTd>
                        <MudTd>
                            @if (isReadOnly)
                            {
                                <MudTextField Value="@(Acc.FirstOrDefault(a => a.Id == detail.AccountId)?.DisplayName ?? "")"
                                              Variant="Variant.Outlined"
                                              FullWidth="@true"
                                              Dense="@true"
                                              ReadOnly="@true" />
                            }
                            else
                            {
                                <AutoComplete TItem="ChartOfAccountsModel"
                                              DataList="@Acc"
                                              DisplayProperty="@(p => p.DisplayName)"
                                              IdProperty="@(p => p.Id)"
                                              @bind-SelectedId="detail.AccountId"
                                              Variant="Variant.Outlined"
                                              Label=""
                                              FullWidth="@true" />
                            }
                        </MudTd>
                        <MudTd>
                            <MudTextField @bind-Value="detail.Description"
                                          Variant="Variant.Outlined"
                                          FullWidth="@true"
                                          Dense="@true"
                                          ReadOnly="@isReadOnly" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.DebitAmount"
                                             Format="#,##0.00"
                                             Variant="Variant.Outlined"
                                             FullWidth="@true"
                                             Dense="@true"
                                             ReadOnly="@isReadOnly"
                                             @bind-Value:after="@(() => OnAmountChanged(detail))" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.CreditAmount"
                                             Format="#,##0.00"
                                             Variant="Variant.Outlined"
                                             FullWidth="@true"
                                             Dense="@true"
                                             ReadOnly="@isReadOnly"
                                             @bind-Value:after="@(() => OnAmountChanged(detail))" />
                        </MudTd>
                        <MudTd>
                            @if (isReadOnly)
                            {
                                <MudTextField Value="@(Par.FirstOrDefault(p => p.Id == detail.PartyId)?.DisplayName ?? "")"
                                              Variant="Variant.Outlined"
                                              FullWidth="@true"
                                              Dense="@true"
                                              ReadOnly="@true" />
                            }
                            else
                            {
                                <AutoComplete TItem="PartiesModel"
                                              DataList="@Par"
                                              DisplayProperty="@(p => p.DisplayName)"
                                              IdProperty="@(p => p.Id)"
                                              @bind-SelectedId="detail.PartyId"
                                              Variant="Variant.Outlined"
                                              Label=""
                                              FullWidth="@true" />
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        </MudCardContent>
    </MudCard>

    <!-- Additional Information -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Notes</label>
                    <MudTextField @bind-Value="record.Notes"
                                  placeholder="Additional notes"
                                  ReadOnly="@isReadOnly"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  Lines="2"
                                  FullWidth="@true" />
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Document Attachment (Optional)</label>
                    <div class="mt-2">
                        @if (!isReadOnly)
                        {
                            <InputFile class="form-control" OnChange="OnFileInputChanged" />
                        }
                        @if (!string.IsNullOrWhiteSpace(record.FileAttachment))
                        {
                            <a href="@record.FileAttachment" download class="btn btn-link" style="font-size: 12px; margin-top: 5px;">
                                <i class="fas fa-download me-1"></i>@record.FileAttachment
                            </a>
                        }
                    </div>
                </div>
            </div>
        </MudCardContent>
    </MudCard>

</div>

<style>
    .gl-preview-dialog {
        z-index: 10000 !important;
    }
    
    .mud-dialog-container {
        z-index: 10000 !important;
    }
    
    .mud-snackbar-container {
        z-index: 10001 !important;
    }
</style>

@code
{
    GeneralLedgerHeaderModel record = new();
    List<LocationsModel> Loc = new();
    List<PartiesModel> Par = new();
    List<ChartOfAccountsModel> Acc = new();
    List<CurrenciesModel> Currencies = new();
    List<TypeCodeModel> RefTypes = new();

    [Parameter] public string? Action { get; set; } = "INSERT";
    [Parameter] public int CurrentRecord { get; set; } = 0;
    [Parameter] public EventCallback OnSaved { get; set; }

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;
    private string PeriodValidationMessage { get; set; } = string.Empty;
    private bool PeriodValidationChecked { get; set; } = false;

    private double TotalDebit => record.Details?.Sum(d => d.DebitAmount) ?? 0;
    private double TotalCredit => record.Details?.Sum(d => d.CreditAmount) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Ensure Details collection is initialized
            if (record.Details == null)
                record.Details = new System.Collections.ObjectModel.ObservableCollection<GeneralLedgerDetailModel>();
            
            Globals.AccessLevel = Globals.PageAccess(NavManager, "GeneralLedgerDashboard");
            await GetAll();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error initializing: {ex.Message}", Severity.Error);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            GetDefaultValues();
        }
    }

    protected async Task GetAll()
    {
        try
        {
            LoadingPanel = true;
            Loc = await Functions.GetAsync<List<LocationsModel>>($"Locations/Search", true) ?? new List<LocationsModel>();
            Par = await Functions.GetAsync<List<PartiesModel>>($"Parties/Search", true) ?? new List<PartiesModel>();
            Acc = await Functions.GetAsync<List<ChartOfAccountsModel>>($"ChartOfAccounts/Search", true) ?? new List<ChartOfAccountsModel>();
            Currencies = await Functions.GetAsync<List<CurrenciesModel>>($"Currencies/Search", true) ?? new List<CurrenciesModel>();
            RefTypes = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/REFERENCE TYPE", true) ?? new List<TypeCodeModel>();

            if (Action == "INSERT")
            {
                Clear();
                GetDefaultValues();
                isReadOnly = false;
            }
            else if (CurrentRecord > 0)
            {
                await Get(CurrentRecord);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    protected void GetDefaultValues()
    {
        if (Loc != null && Loc.Any() && record.LocationId == 0)
        {
            record.LocationId = Globals.User.LocationId;
        }
        if (string.IsNullOrWhiteSpace(record.Source))
        {
            record.Source = "MANUAL";
        }
        // Set base currency and entered currency to default
        if (Currencies != null && Currencies.Any())
        {
            var baseCurrency = Currencies.FirstOrDefault(c => c.IsBaseCurrency == 1);
            if (baseCurrency != null)
            {
                if (record.BaseCurrencyId == 0)
                    record.BaseCurrencyId = baseCurrency.Id;
                if (record.EnteredCurrencyId == 0)
                    record.EnteredCurrencyId = baseCurrency.Id;
            }
        }
        if (record.ExchangeRate == 0)
            record.ExchangeRate = 1.0;

        StateHasChanged();
    }

    protected async Task Get(int id)
    {
        try
        {
            LoadingPanel = true;
            record = await Functions.GetAsync<GeneralLedgerHeaderModel>($"GeneralLedger/Get/{id}", true) ?? new GeneralLedgerHeaderModel();
            if (record.Details == null)
                record.Details = new ObservableCollection<GeneralLedgerDetailModel>();
            if (string.IsNullOrWhiteSpace(record.Source))
                record.Source = "MANUAL";
            // Lock location for non-admin users
            if (Globals.User.GroupId != 1 && record.LocationId != Globals.User.LocationId)
            {
                record.LocationId = Globals.User.LocationId;
            }
            // Set default exchange rate if not set
            if (record.ExchangeRate == 0)
                record.ExchangeRate = 1.0;
            // Set read-only if posted or in VIEW mode
            isReadOnly = Action == "VIEW" || record.IsPosted == 1;
            await ValidatePeriodAsync();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading record: {ex.Message}", Severity.Error);
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    protected async void Clear()
    {
        Action = "INSERT";
        record = new GeneralLedgerHeaderModel();
        record.Details = new ObservableCollection<GeneralLedgerDetailModel>();
        record.Source = "MANUAL"; // Always MANUAL for manual entries
        record.ReferenceType = "JOURNAL"; // Auto-set to JOURNAL for manual entries
        isReadOnly = false;
        record.EntryDate = DateTime.Now;
        record.LocationId = Globals.User.LocationId;
        // Set base currency (get from organization or first base currency)
        var baseCurrency = Currencies.FirstOrDefault(c => c.IsBaseCurrency == 1);
        if (baseCurrency != null)
        {
            record.BaseCurrencyId = baseCurrency.Id;
            record.EnteredCurrencyId = baseCurrency.Id; // Default entered currency to base currency
        }
        record.ExchangeRate = 1.0; // Default exchange rate to 1.0
        AddDetailLine(); // Add one empty line
        await ValidatePeriodAsync();
    }

    private void OnEnteredCurrencyChanged()
    {
        // When entered currency changes, auto-populate exchange rate
        // If entered currency is same as base currency, set rate to 1.0
        if (record.EnteredCurrencyId == record.BaseCurrencyId)
        {
            record.ExchangeRate = 1.0;
        }
        else if (record.EnteredCurrencyId > 0 && record.BaseCurrencyId > 0)
        {
            // If different currency, set default rate to 1.0 (user can change it)
            // In a real scenario, you might fetch the exchange rate from an API here
            record.ExchangeRate = 1.0;
        }
        StateHasChanged();
    }

    private async Task OnEntryDateChanged()
    {
        await ValidatePeriodAsync();
    }

    private async Task ValidatePeriodAsync()
    {
        PeriodValidationChecked = false;
        PeriodValidationMessage = string.Empty;
        
        if (record?.EntryDate == null || record.OrganizationId == 0)
        {
            PeriodValidationMessage = string.Empty;
            await InvokeAsync(StateHasChanged);
            return;
        }

        try
        {
            string moduleType = "GENERALLEDGER"; // General Ledger module type
            string dateStr = record.EntryDate.Value.ToString("yyyy-MM-dd");
            var result = await Functions.GetAsync<PeriodCloseModel>(
                $"PeriodClose/GetOpenPeriod/{record.OrganizationId}/{dateStr}/{moduleType}", 
                true);

            PeriodValidationChecked = true;

            // Period is OPEN if we get a valid result with Id > 0 and Status is OPEN or OPEN_PENDING
            // Period is CLOSED if result is null, Id is 0, or Status is CLOSE
            if (result != null && result.Id > 0 && 
                (result.Status?.ToUpper() == "OPEN" || result.Status?.ToUpper() == "OPEN_PENDING"))
            {
                // Period is open - clear any warning
                PeriodValidationMessage = string.Empty;
            }
            else
            {
                // Period is closed - show warning
                PeriodValidationMessage = $"⚠️ Period is CLOSED for {moduleType} module on {dateStr}. You cannot save transactions for this date. Please ensure the period is open before saving.";
            }
        }
        catch (Exception ex)
        {
            PeriodValidationChecked = true;
            PeriodValidationMessage = $"Error checking period status: {ex.Message}";
            SnackbarService.Add(PeriodValidationMessage, Severity.Error);
        }
        
        await InvokeAsync(StateHasChanged);
    }

    protected void AddDetailLine()
    {
        if (record.Details == null)
            record.Details = new ObservableCollection<GeneralLedgerDetailModel>();
        
        record.Details.Add(new GeneralLedgerDetailModel
        {
            SeqNo = record.Details.Count + 1
        });
        StateHasChanged();
    }

    protected void RemoveDetailLine(GeneralLedgerDetailModel detail)
    {
        if (record.Details != null)
        {
            record.Details.Remove(detail);
            // Reorder sequence numbers
            for (int i = 0; i < record.Details.Count; i++)
            {
                record.Details[i].SeqNo = i + 1;
            }
            StateHasChanged();
        }
    }

    protected void OnAmountChanged(GeneralLedgerDetailModel detail)
    {
        // Ensure only debit or credit is set, not both - both cannot have value at the same time
        if (detail.DebitAmount > 0)
            detail.CreditAmount = 0;
        if (detail.CreditAmount > 0)
            detail.DebitAmount = 0;
        
        record.TotalDebit = TotalDebit;
        record.TotalCredit = TotalCredit;
        StateHasChanged();
    }

    protected async Task Delete()
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete existing record?");
        if (res == false)
            return;

        Action = "SOFTDELETE";
        await Save();
    }

    protected async Task Save()
    {
        try
        {
            // Validate
            if (record.Details == null || record.Details.Count == 0)
            {
                SnackbarService.Add("Please add at least one account line.", Severity.Warning);
                return;
            }

            if (Math.Abs(TotalDebit - TotalCredit) > 0.01)
            {
                SnackbarService.Add($"Entry is not balanced. Total Debit: {TotalDebit:N2}, Total Credit: {TotalCredit:N2}", Severity.Error);
                return;
            }

            record.OrganizationId = Globals.User.OrganizationId;
            record.CreatedBy = Globals.User.Id;
            record.CreatedOn = DateTime.Now;
            record.CreatedFrom = Globals.ClientInfo;
            record.UpdatedBy = Globals.User.Id;
            record.UpdatedOn = DateTime.Now;
            record.UpdatedFrom = Globals.ClientInfo;
            record.TotalDebit = TotalDebit;
            record.TotalCredit = TotalCredit;
            // Source is always MANUAL for manual entries (other sources come from invoices/cashbook)
            if (string.IsNullOrWhiteSpace(record.Source) || Action == "INSERT")
                record.Source = "MANUAL";

            LoadingPanel = true;
            var result = await Functions.PostAsync<GeneralLedgerHeaderModel>($"GeneralLedger/{Action}", record, true);
            LoadingPanel = false;

            if (result.Success == false || result.Result == null)
            {
                SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
            }
            else
            {
                var res = result.Result;
                await OnSaved.InvokeAsync();
                SnackbarService.Add($"Record {Action} Successfully", Severity.Success);
                
                await Get(res.Id);
                CurrentRecord = res.Id;
                Action = "UPDATE";
            }
        }
        catch (Exception ex)
        {
            LoadingPanel = false;
            SnackbarService.Add($"Error saving General Ledger Entry: {ex.Message}", Severity.Error);
        }
    }

    protected async Task ShowGLPreview()
    {
        try
        {
            // Validate required fields for preview (works before saving)
            if (record?.Details == null || !record.Details.Any())
            {
                SnackbarService.Add("Please add at least one account entry first", Severity.Warning);
                return;
            }

            if (record.Details.All(d => d.DebitAmount == 0 && d.CreditAmount == 0))
            {
                SnackbarService.Add("Please enter debit or credit amounts for at least one entry", Severity.Warning);
                return;
            }

            // Validate organization is set
            if (record.OrganizationId == 0)
            {
                record.OrganizationId = Globals.User.OrganizationId;
            }

            // If record is saved, ensure we have latest data, otherwise use current form data
            GeneralLedgerHeaderModel previewData;
            if (CurrentRecord > 0)
            {
                // Get the full entry with details from database
                previewData = await Functions.GetAsync<GeneralLedgerHeaderModel>($"GeneralLedger/Get/{CurrentRecord}", true);
                if (previewData == null)
                {
                    SnackbarService.Add("Unable to load entry details", Severity.Error);
                    return;
                }
            }
            else
            {
                // Use current form data for preview
                previewData = new GeneralLedgerHeaderModel
                {
                    Id = 0,
                    EntryNo = record.EntryNo ?? "PREVIEW",
                    EntryDate = record.EntryDate ?? DateTime.Today,
                    OrganizationId = record.OrganizationId,
                    LocationId = record.LocationId,
                    Source = record.Source ?? "MANUAL",
                    Description = record.Description,
                    ReferenceNo = record.ReferenceNo,
                    ReferenceType = record.ReferenceType,
                    PartyId = record.PartyId,
                    BaseCurrencyId = record.BaseCurrencyId,
                    EnteredCurrencyId = record.EnteredCurrencyId,
                    Details = new ObservableCollection<GeneralLedgerDetailModel>(record.Details.Select(d => new GeneralLedgerDetailModel
                    {
                        Id = d.Id,
                        AccountId = d.AccountId,
                        AccountCode = d.AccountCode,
                        AccountName = d.AccountName,
                        AccountType = d.AccountType,
                        DebitAmount = d.DebitAmount,
                        CreditAmount = d.CreditAmount,
                        Description = d.Description,
                        PartyId = d.PartyId
                    }))
                };
            }

            var parameters = new DialogParameters<InvoiceGLPreviewDialog>
            {
                { x => x.PreviewData, previewData },
                { x => x.RecordId, CurrentRecord },
                { x => x.IsPostedToGL, record.IsPosted == 1 },
                { x => x.OnPostToGL, EventCallback.Factory.Create(this, async () => 
                {
                    if (CurrentRecord == 0)
                    {
                        SnackbarService.Add("Please save the entry before posting", Severity.Warning);
                        return;
                    }
                    await PostEntry();
                    // Refresh preview after posting
                    await ShowGLPreview();
                }) }
            };

            var options = new DialogOptions()
            {
                MaxWidth = MaxWidth.Large,
                FullWidth = true,
                CloseButton = true,
                CloseOnEscapeKey = true,
                BackdropClick = false,
                Position = DialogPosition.Center
            };

            await dialogService.ShowAsync<InvoiceGLPreviewDialog>("General Ledger Entry Preview", parameters, options);
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    protected async Task PostEntry()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(record.EntryNo))
            {
                SnackbarService.Add("Entry No is required", Severity.Warning);
                return;
            }

            if (record.IsPosted == 1)
            {
                SnackbarService.Add("This entry is already posted", Severity.Info);
                return;
            }

            var res = await Functions.ShowConfirmation(dialogService, "Do you want to post this entry? Once posted, it cannot be modified.");
            if (res == false)
                return;

            LoadingPanel = true;
            var result = await Functions.PostAsync<string>($"GeneralLedger/PostEntry", record.EntryNo, true);
            LoadingPanel = false;

            if (result.Success == false)
            {
                SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
            }
            else
            {
                SnackbarService.Add("Entry posted successfully", Severity.Success);
                // Reload entry to get updated IsPosted status
                await Get(CurrentRecord);
            }
        }
        catch (Exception ex)
        {
            LoadingPanel = false;
            SnackbarService.Add($"Error posting entry: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnFileInputChanged(InputFileChangeEventArgs e)
    {
        try
        {
            var result = await Functions.FileUpload(e, FileUploadService, 25);

            if (result.Item1 == true)
            {
                record.FileAttachment = result.Item2;
                SnackbarService.Add("Document uploaded successfully", Severity.Success);
            }
            else
            {
                SnackbarService.Add($"Error: {result.Item2}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Exception: {ex.Message}", Severity.Error);
            record.FileAttachment = null;
        }
    }
}
