@page "/CashBookDashboard"

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<div class="row" style="margin: 2px; height: 90vh; display: flex;">
    <MyDrawer @ref="_drawer" Title="CashBook" FaIcon="fas fa-address-book">
        <HeaderContent>
        </HeaderContent>
        <ChildContent>
            <EditForm Model="record" OnSubmit="Save">
                <MudForm>
                    <CashBookPage Action="@Action" CurrentRecord="record.Id" OnSaved="ChildSaved"/>
                </MudForm>
            </EditForm>
        </ChildContent>
        <FooterContent>
        </FooterContent>
    </MyDrawer>

    @if (data == null)
    {
        <SimpleLoading />
    }
    else
    {
        <div class="row">
            <MudDataGrid T="CashBookModel"
                         MultiSelection="false"
                         Items="@data"
                         SortMode="SortMode.Multiple"
                         Filterable="true"
                         Hideable="true"
                         RowsPerPage="10"
                         Dense="true"
                         Striped="true"
                         Hover="true"
                         Class="professional-grid elevation-8">

                   <ToolBarContent>
        <div class="grid-toolbar-wrapper">
            <div class="grid-toolbar" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1.25rem;
                min-height: 56px;
                width: 100%;
            ">
                <div class="toolbar-left" style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                ">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" 
                             style="color: white !important; font-size: 1.5rem !important; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));"/>
                    <MudText Typo="Typo.h6" style="
                        color: white !important;
                        font-weight: 600 !important;
                        font-size: 1.1rem !important;
                        letter-spacing: 0.3px !important;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                        margin: 0 !important;
                    ">
                        CashBook Management
                    </MudText>
                </div>
                
                <div class="toolbar-right" style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    flex-wrap: nowrap;
                    white-space: nowrap;
                ">
                    <MudButton StartIcon="@Icons.Material.TwoTone.Add" 
                              Size="MudBlazor.Size.Small" 
                              Variant="Variant.Filled" 
                              Color="Color.Success"
                              style="
                                  border-radius: 6px !important;
                                  padding: 0.375rem 0.875rem !important;
                                  font-weight: 500 !important;
                                  font-size: 0.875rem !important;
                                  text-transform: none !important;
                                  border: none !important;
                                  min-width: 80px;
                                  height: 32px;
                                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                                  background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%) !important;
                              "
                              OnClick="@(() => Clear())">
                        New
                    </MudButton>

                    <MudButton StartIcon="@Icons.Material.TwoTone.Refresh" 
                              Size="MudBlazor.Size.Small" 
                              Variant="Variant.Filled" 
                              Color="Color.Info"
                              style="
                                  border-radius: 6px !important;
                                  padding: 0.375rem 0.875rem !important;
                                  font-weight: 500 !important;
                                  font-size: 0.875rem !important;
                                  text-transform: none !important;
                                  border: none !important;
                                  min-width: 80px;
                                  height: 32px;
                                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                                  background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important;
                              "
                              OnClick="@(() => Refresh())">
                        Refresh
                    </MudButton>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="position: relative;">
                                        <InputDate @bind-Value="startDate"
                                                   Format="yyyy-MM-dd"
                                                   class="styled-date-input"
                                                   style="
                           width: 140px;
                           background: rgba(255, 255, 255, 0.1);
                           border: 1px solid rgba(255, 255, 255, 0.3);
                           border-radius: 6px;
                           color: white;
                           padding: 8px 12px;
                           font-size: 0.875rem;
                       " />
                                        <label style="
                position: absolute;
                top: -8px;
                left: 8px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 0 4px;
                font-size: 0.75rem;
                color: white;
                border-radius: 2px;
            ">Start Date</label>
                                    </div>

                                    <div style="position: relative;">
                                        <InputDate @bind-Value="endDate"
                                                   Format="yyyy-MM-dd"
                                                   class="styled-date-input"
                                                   style="
                           width: 140px;
                           background: rgba(255, 255, 255, 0.1);
                           border: 1px solid rgba(255, 255, 255, 0.3);
                           border-radius: 6px;
                           color: white;
                           padding: 8px 12px;
                           font-size: 0.875rem;
                       " />
                                        <label style="
                position: absolute;
                top: -8px;
                left: 8px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 0 4px;
                font-size: 0.75rem;
                color: white;
                border-radius: 2px;
            ">End Date</label>
                                    </div>
                                </div>

                    <MudButton StartIcon="@Icons.Material.TwoTone.Search"
                              Size="MudBlazor.Size.Small"
                              Variant="Variant.Filled"
                              Color="Color.Primary"
                              style="
                                  border-radius: 6px !important;
                                  padding: 0.375rem 0.875rem !important;
                                  font-weight: 500 !important;
                                  font-size: 0.875rem !important;
                                  text-transform: none !important;
                                  border: none !important;
                                  min-width: 80px;
                                  height: 32px;
                                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                                  background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important;
                              "
                              OnClick="@(() => GetAll())">
                        Search
                    </MudButton>
                </div>
            </div>
        </div>
    </ToolBarContent>

                <Columns>
                    <TemplateColumn Title="Actions"
                                    CellStyle="width: 80px; min-width: 80px;"
                                    HeaderClass="grid-header">
                        <CellTemplate Context="row">
                            <div class="actions-cell">
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="actions-menu">
                                    <MudMenuItem OnClick="@(() => View(row.Item.Id))"
                                                 Class="menu-item view-item">
                                        <MudIcon Icon="@Icons.Material.Filled.Visibility" Class="menu-icon" />
                                        <span>View</span>
                                    </MudMenuItem>
                                    <MudMenuItem OnClick="@(() => Edit(row.Item.Id))"
                                                 Class="menu-item edit-item">
                                        <MudIcon Icon="@Icons.Material.Filled.Edit" Class="menu-icon" />
                                        <span>Edit</span>
                                    </MudMenuItem>
                                    <MudMenuItem OnClick="@(() => Print(row.Item.Id))"
                                                 Class="menu-item print-item">
                                        <MudIcon Icon="@Icons.Material.Filled.Print" Class="menu-icon" />
                                        <span>Print</span>
                                    </MudMenuItem>
                                    <MudMenuItem OnClick="@(() => Delete(row.Item.Id))"
                                                 Color="Color.Error"
                                                 Class="menu-item delete-item">
                                        <MudIcon Icon="@Icons.Material.Filled.Delete" Class="menu-icon" />
                                        <span>Delete</span>
                                    </MudMenuItem>
                                </MudMenu>
                            </div>
                        </CellTemplate>
                    </TemplateColumn>

                    <PropertyColumn Property="x => x.SeqNo"
                                    Title="Seq No"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="80px" />

                    <PropertyColumn Property="x => x.TranDate"
                                    Title="Transaction Date"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Format="dd-MMM-yyyy"
                                    Width="120px" />

                    <PropertyColumn Property="x => x.Description"
                                    Title="Description"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="200px" />

                    <PropertyColumn Property="x => x.TranType"
                                    Title="Transaction Type"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="120px" />

                    <PropertyColumn Property="x => x.PaymentMethod"
                                    Title="Payment Method"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="130px" />

                    <PropertyColumn Property="x => x.RefNo"
                                    Title="Reference #"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="120px" />

                    <PropertyColumn Property="x => x.TranRef"
                                    Title="Bill Transaction"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="150px" />

                </Columns>

                <PagerContent>
                    <div class="pager-container">
                        <MudDataGridPager T="CashBookModel" Class="grid-pager" />
                    </div>
                </PagerContent>

            </MudDataGrid>
        </div>
    }
</div>

@code
{
    static List<CashBookModel> data = new();
    static CashBookModel record = new();

    public DateTime startDate { get; set; } = DateTime.Today;
    public DateTime endDate { get; set; } = DateTime.Today;


    public string? Action { get; set; } = "INSERT";

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;
    private MyDrawer _drawer = new();

    protected override async Task OnInitializedAsync()
    {
        await GetAll();
    }

    protected async Task GetAll()
    {
        if (startDate > endDate)
        {
            SnackbarService.Add("Start date must be earlier than end date.", Severity.Warning);
            return;
        }

        var formattedStartDate = startDate.ToString("yyyy-MM-dd");
        var formattedEndDate = endDate.ToString("yyyy-MM-dd");


        string Criteria = string.Empty;

        LoadingPanel = true;

        if (Globals.User.GroupId != 1)
        {
            Criteria = $" and LocationId = {Globals.User.LocationId}";
        }

        Criteria = $"CAST(TranDate as DATE) >= '{formattedStartDate}' and CAST(TranDate as DATE) <= '{formattedEndDate}' {Criteria}"!;
        data = await Functions.GetAsync<List<CashBookModel>>($"CashBook/Search/{Criteria}", true) ?? new List<CashBookModel>();
         LoadingPanel = false;

        await InvokeAsync(StateHasChanged);
    }

    protected async Task Get(int id)
    {
        LoadingPanel = true;
        record = await Functions.GetAsync<CashBookModel>($"CashBook/Get/{id}", true) ?? new CashBookModel();
        LoadingPanel = false;
    }

    protected async Task Clear()
    {
        Action = "INSERT";
        record = new CashBookModel();
        isReadOnly = false;
        await _drawer.OpenDrawerAsync();
    }

    protected async Task Refresh()
    {
        data = await Functions.GetAsync<List<CashBookModel>>($"CashBook/Search", true) ?? new List<CashBookModel>();
    }

    protected async Task View(int id)
    {
        await Get(id);
        Action = "VIEW";
        isReadOnly = true;
        await _drawer.OpenDrawerAsync();
    }

    protected async Task Edit(int id)
    {
        await Get(id);
        Action = "UPDATE"; 
        isReadOnly = false;
        await _drawer.OpenDrawerAsync();
    }

    protected async Task Delete(int id)
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete existing record?");
        if (res == false)
            return;

        Action = "SOFTDELETE";
        await Get(id);
        await Save();
    }

    protected void Print(int id)
    {
        var url = $"/CashBookReport/{id}";
        JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }

    protected async Task Save()
    {
        LoadingPanel = true;
         
        record.OrganizationId = Globals.User.OrganizationId;
        record.CreatedBy = Globals.User.Id;
        record.CreatedOn = DateTime.Now;
        record.CreatedFrom = Globals.ClientInfo;
        record.UpdatedBy = Globals.User.Id;
        record.UpdatedOn = DateTime.Now;
        record.UpdatedFrom = Globals.ClientInfo;

        var result = await Functions.PostAsync<CashBookModel>($"CashBook/{Action}", record, true);
        if (result.Success == false)
        {
            SnackbarService.Add($"Record Not Deleted", Severity.Error);
        }
        else
        {
            SnackbarService.Add($"Record Deleted Successfully", Severity.Success);
            if (Action?.Contains("delete", StringComparison.OrdinalIgnoreCase) == false) await Edit(result.Result!.Id);
        }
    
        data = await Functions.GetAsync<List<CashBookModel>>($"CashBook/Search", true) ?? new List<CashBookModel>();
        LoadingPanel = false;
        await _drawer.CloseDrawerAsync();
     
    }

    private async Task ChildSaved()
    {
        await GetAll();
        await _drawer.CloseDrawerAsync();
        StateHasChanged();
    }

}

