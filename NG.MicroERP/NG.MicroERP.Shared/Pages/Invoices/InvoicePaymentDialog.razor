@using System.Collections.ObjectModel
@inject IDialogService dialogService
@inject ISnackbar Snackbar
@inject Functions Functions

<MudDialog @bind-Visible="_visible" Options="_dialogOptions">
    <TitleContent>
        <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudItem xs="10">
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" />
                    Payments
                </MudText>
            </MudItem>
        </MudGrid>
    </TitleContent>

    <DialogContent>
        <MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
            <!-- Payment Entry Card -->
            <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 12px;">
                <div class="d-flex align-items-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Payment" 
                             Size="Size.Large" 
                             Color="Color.Primary" 
                             Class="me-3" />
                    <div>
                        <MudText Typo="Typo.h6" Class="mb-0 fw-bold">Add Payment</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">Enter payment details</MudText>
                    </div>
                </div>
                <MudDivider Class="mb-4" />

                <MudGrid>
                    <MudItem xs="12" md="4">
                        <label class="form-label fw-bold mb-1" style="font-size: 0.85rem;">Payment Method <span style='color:red;'>*</span></label>
                        <MudSelect T="int"
                                   @bind-Value="InvoicePayments.AccountId"
                                   Placeholder="Select Payment Method"
                                   Variant="Variant.Outlined"
                                   Clearable="@false"
                                   FullWidth="@true"
                                   Dense="@true"
                                   @bind-Value:after="PaymentMethodChanged"
                                   Class="mb-3">
                            @if (PaymentMethod != null)
                            {
                                @foreach (var pm in PaymentMethod)
                                {
                                    <MudSelectItem T="int" Value="@pm.Id">@pm.Name</MudSelectItem>
                                }
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Label="Payment Reference"
                                      @bind-Value="InvoicePayments.PaymentRef"
                                      Variant="Variant.Outlined"
                                      Dense="@true"
                                      FullWidth="@true"
                                      Class="mb-3" />
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudNumericField Label="Amount"
                                         @bind-Value="InvoicePayments.Amount"
                                         Variant="Variant.Outlined"
                                         Dense="@true"
                                         Format="#,##0.00"
                                         InputClass="text-end"
                                         FullWidth="@true"
                                         Class="mb-3" />
                    </MudItem>
                </MudGrid>

                <!-- Balance and Actions -->
                <MudDivider Class="my-4" />
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <MudPaper Elevation="1" Class="pa-3" Style="border-radius: 8px; border-left: 4px solid var(--mud-palette-error);">
                        <MudText Typo="Typo.body2" Class="fw-bold mb-1">Remaining Balance</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold mb-0" Color="Color.Error">
                            @(CalculateRemainingBalance().ToString("#,##0.00"))
                        </MudText>
                    </MudPaper>

                    <div class="d-flex gap-2">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="AddPayment"
                                   Size="Size.Medium">
                            Add Payment
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.Close"
                                   OnClick="CloseDialogMethod"
                                   Size="Size.Medium">
                            Close
                        </MudButton>
                    </div>
                </div>
            </MudPaper>

            <!-- Payments List Card -->
            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px;">
                <div class="d-flex align-items-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.List" 
                             Size="Size.Large" 
                             Color="Color.Info" 
                             Class="me-3" />
                    <div>
                        <MudText Typo="Typo.h6" Class="mb-0 fw-bold">Payment History</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">List of all payments</MudText>
                    </div>
                </div>
                <MudDivider Class="mb-4" />

                <MudTable T="InvoicePaymentModel"
                          Items="@Record.InvoicePayments"
                          Dense="true"
                          Hover="true"
                          Bordered="true"
                          Striped="true"
                          Elevation="0">

                    <HeaderContent>
                        <MudTh Style="width:120px;">Actions</MudTh>
                        <MudTh>Payment Method</MudTh>
                        <MudTh>Payment Reference</MudTh>
                        <MudTh Class="text-end">Amount</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>
                            <MudButton StartIcon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       Variant="Variant.Filled"
                                       Color="Color.Error"
                                       OnClick="@(() => DeletePayment(context))">
                                Remove
                            </MudButton>
                        </MudTd>
                        <MudTd>@context.PaymentMethod</MudTd>
                        <MudTd>@context.PaymentRef</MudTd>
                        <MudTd Class="text-end fw-bold">@context.Amount.ToString("N2")</MudTd>
                    </RowTemplate>

                    <FooterContent></FooterContent>
                </MudTable>

                <!-- Summary Footer -->
                <MudDivider Class="my-4" />
                <MudPaper Elevation="1" Class="pa-3" Style="border-radius: 8px; background: var(--mud-palette-grey-lighteren);">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <div class="d-flex justify-content-between mb-2">
                                <MudText Typo="Typo.body1" Class="fw-bold">Invoice Total:</MudText>
                                <MudText Typo="Typo.body1" Class="fw-bold" Color="Color.Success">
                                    @Record.Invoice.TotalInvoiceAmount.ToString("#,##0.00")
                                </MudText>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <div class="d-flex justify-content-between">
                                <MudText Typo="Typo.body1" Class="fw-bold">Total Paid:</MudText>
                                <MudText Typo="Typo.body1" Class="fw-bold" Color="Color.Primary">
                                    @Record.Invoice.TotalPayments.ToString("#,##0.00")
                                </MudText>
                            </div>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudPaper>
        </MudContainer>
    </DialogContent>
</MudDialog>

@code {
    private bool _visible;
    private DialogOptions _dialogOptions = new()
    {
        CloseOnEscapeKey = true,
        FullWidth = false,
        MaxWidth = MaxWidth.False,
        CloseButton = true,
        BackdropClick = true
    };

    [Parameter] public InvoicesModel Record { get; set; } = new();
    [Parameter] public InvoicePaymentModel InvoicePayments { get; set; } = new();
    [Parameter] public List<ChartOfAccountsModel> PaymentMethod { get; set; } = new();
    [Parameter] public EventCallback OnPaymentMethodChange { get; set; }
    [Parameter] public EventCallback OnAddPayment { get; set; }
    [Parameter] public EventCallback<InvoicePaymentModel> OnDeletePayment { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        // Auto-populate amount with remaining balance when dialog is opened
        if (_visible && InvoicePayments != null)
        {
            if (InvoicePayments.Amount == 0)
            {
                InvoicePayments.Amount = CalculateRemainingBalance();
            }
            if (InvoicePayments.PaidOn == default)
            {
                InvoicePayments.PaidOn = DateTime.UtcNow;
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    /// <summary>
    /// Calculates the remaining balance considering already-added payments
    /// </summary>
    private decimal CalculateRemainingBalance()
    {
        if (Record == null || Record.Invoice == null)
            return 0;

        decimal totalPaid = Record.InvoicePayments?.Sum(x => x.Amount) ?? 0;
        return Record.Invoice.TotalInvoiceAmount - totalPaid;
    }

    private async Task AddPayment()
    {
        if (InvoicePayments == null || InvoicePayments.Amount <= 0)
        {
            Snackbar.Add("Please enter a valid payment amount", Severity.Warning);
            return;
        }

        // Validate AccountId (Payment Method) is selected
        if (InvoicePayments.AccountId == 0)
        {
            Snackbar.Add("Please select a Payment Method. Payment Method is required.", Severity.Warning);
            return;
        }

        // Validate payment amount doesn't exceed remaining balance
        decimal remainingBalance = CalculateRemainingBalance();
        if (InvoicePayments.Amount > remainingBalance)
        {
            Snackbar.Add($"Payment amount exceeds remaining balance of {remainingBalance:N2}", Severity.Warning);
            return;
        }

        // Resolve account name from PaymentMethod lookup (dialog binds AccountId)
        var methodName = PaymentMethod?.FirstOrDefault(pm => pm.Id == InvoicePayments.AccountId)?.Name
                         ?? InvoicePayments.PaymentMethod
                         ?? string.Empty;

        // Update InvoicePayments with resolved payment method name and default PaidOn if needed
        InvoicePayments.PaymentMethod = methodName;
        if (InvoicePayments.PaidOn == default)
        {
            InvoicePayments.PaidOn = DateTime.UtcNow;
        }
        
        // Notify parent to add payment and recalculate totals
        if (OnAddPayment.HasDelegate)
        {
            await OnAddPayment.InvokeAsync();
        }
        
        // Reset the input model after parent has processed
        InvoicePayments = new InvoicePaymentModel();
        
        // Trigger refresh so balance updates dynamically
        await InvokeAsync(StateHasChanged);
    }

    private async Task DeletePayment(InvoicePaymentModel payment)
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do You want to REMOVE Payment?");
        if (res == false) return;

        try
        {
            await OnDeletePayment.InvokeAsync(payment);
            // Refresh UI after payment deletion
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting payment: {ex.Message}", Severity.Error);
        }
    }

    private async Task CloseDialogMethod()
    {
        try
        {
            await OnClose.InvokeAsync();
            _visible = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error closing dialog: {ex.Message}", Severity.Error);
        }
    }

    private async Task PaymentMethodChanged()
    {
        if (OnPaymentMethodChange.HasDelegate)
            await OnPaymentMethodChange.InvokeAsync();
    }

    public async Task Open()
    {
        // Auto-populate amount with remaining balance when opening
        if (InvoicePayments != null)
        {
            InvoicePayments.Amount = CalculateRemainingBalance();
            if (InvoicePayments.PaidOn == default)
            {
                InvoicePayments.PaidOn = DateTime.UtcNow;
            }
        }

        _visible = true;
        await InvokeAsync(StateHasChanged);
    }

    public async Task CloseDialog()
    {
        await CloseDialogMethod();
    }
}