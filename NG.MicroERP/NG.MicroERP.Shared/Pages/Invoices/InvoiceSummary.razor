@page "/InvoiceSummary/{InvoiceType?}"
@using NG.MicroERP.Shared.Models

@inject Functions Functions
@inject Globals Globals
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject IJSRuntime JSRuntime

<Loading IsLoading="@isLoading" />

<div class="container-fluid p-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1">@InvoiceType Invoice Summary</h3>
            <p class="text-muted mb-0">@startDate.ToString("dd MMM yyyy") to @endDate.ToString("dd MMM yyyy")</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" @onclick="LoadReport">
                <i class="fas fa-sync me-1"></i> Refresh
            </button>
            <button class="btn btn-success btn-sm" @onclick="PrintReport">
                <i class="fas fa-print me-1"></i> Print
            </button>
        </div>
    </div>

    <!-- Date Range -->
    <div class="card mb-4">
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label small mb-1">Start Date</label>
                    <input type="date" class="form-control form-control-sm" @bind="startDate" @bind:format="yyyy-MM-dd" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">End Date</label>
                    <input type="date" class="form-control form-control-sm" @bind="endDate" @bind:format="yyyy-MM-dd" />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary btn-sm w-100" @onclick="LoadReport">
                        <i class="fas fa-search me-1"></i> Load Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (invoices == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading report data...</p>
        </div>
    }
    else
    {
        <!-- Compact Summary Cards Row -->
        <div class="row mb-4 g-2">
            <!-- Total Invoices Card -->
            <div class="col-xl-3 col-md-4 col-6">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body p-2 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0 small">Total Invoices</h6>
                            <i class="fas fa-file-invoice fa-sm"></i>
                        </div>
                        <div class="mt-auto">
                            <h5 class="mb-2 fw-bold text-center">@totalInvoices</h5>
                            <div class="text-center small opacity-75 mb-2">
                                <div>Invoices</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Bill Amount Card -->
            <div class="col-xl-3 col-md-4 col-6">
                <div class="card bg-info text-white h-100">
                    <div class="card-body p-2 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0 small">Total Bill Amount</h6>
                            <i class="fas fa-money-bill-wave fa-sm"></i>
                        </div>
                        <div class="mt-auto">
                            <h5 class="mb-2 fw-bold text-center">@totalBillAmount.ToString("N2")</h5>
                            <div class="text-center small opacity-75 mb-2">
                                <div>Bill Amount</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Paid Amount Card -->
            <div class="col-xl-3 col-md-4 col-6">
                <div class="card bg-success text-white h-100">
                    <div class="card-body p-2 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0 small">Total Paid Amount</h6>
                            <i class="fas fa-check-circle fa-sm"></i>
                        </div>
                        <div class="mt-auto">
                            <h5 class="mb-2 fw-bold text-center">@totalPaidAmount.ToString("N2")</h5>
                            <div class="text-center small opacity-75 mb-2">
                                <div>Paid</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Balance Amount Card -->
            <div class="col-xl-3 col-md-4 col-6">
                @{
                    var balanceClass = totalBalanceAmount >= 0 ? "bg-warning" : "bg-danger";
                    var balanceIcon = totalBalanceAmount >= 0 ? "fa-clock" : "fa-exclamation-triangle";
                }
                <div class="card @balanceClass text-white h-100">
                    <div class="card-body p-2 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0 small">Total Balance</h6>
                            <i class="fas @balanceIcon fa-sm"></i>
                        </div>
                        <div class="mt-auto">
                            <h5 class="mb-2 fw-bold text-center">@totalBalanceAmount.ToString("N2")</h5>
                            <div class="text-center small opacity-75 mb-2">
                                <div>Outstanding</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (!invoices.Any())
        {
            <div class="alert alert-info py-2 mb-4">
                <i class="fas fa-info-circle me-2"></i> No invoices found for the selected period.
            </div>
        }

        <!-- Invoice Details -->
        <div class="card">
            <div class="card-header bg-light py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-1 fa-xs text-secondary"></i>
                        <small>Invoice Details (@invoices.Count records)</small>
                    </h6>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0" style="table-layout: fixed;">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-2" style="width: 8%;">Date</th>
                                <th style="width: 10%;">Code</th>
                                @if (Globals.User.GroupId == 1)
                                {
                                    <th style="width: 10%;">Location</th>
                                }
                                <th style="width: 15%;">Party</th>
                                <th style="width: 10%;">Status</th>
                                <th class="text-end border-start" style="width: 10%;">Bill Amount</th>
                                <th class="text-end" style="width: 10%;">Paid Amount</th>
                                <th class="text-end pe-2 border-end" style="width: 10%;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in invoices.OrderBy(x => x.TranDate).ThenBy(x => x.ID))
                            {
                                <tr>
                                    <td class="ps-2">@invoice.TranDate.ToString("dd MMM yyyy")</td>
                                    <td>@invoice.Code</td>
                                    @if (Globals.User.GroupId == 1)
                                    {
                                        <td>@invoice.Location</td>
                                    }
                                    <td class="text-truncate" title="@invoice.PartyName">@invoice.PartyName</td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(invoice.Status)">
                                            @invoice.Status
                                        </span>
                                    </td>
                                    <td class="text-end fw-bold border-start">@((decimal)invoice.BillAmount).ToString("N2")</td>
                                    <td class="text-end text-success fw-bold">@((decimal)invoice.TotalPaidAmount).ToString("N2")</td>
                                    <td class="text-end fw-bold pe-2 border-end @(invoice.BalanceAmount >= 0 ? "text-warning" : "text-success")">
                                        @((decimal)invoice.BalanceAmount).ToString("N2")
                                    </td>
                                </tr>
                            }

                            <!-- Totals Row -->
                            <tr class="table-primary">
                                <td class="ps-2 fw-bold" colspan="@(Globals.User.GroupId == 1 ? 5 : 4)">Totals</td>
                                <td class="text-end fw-bold border-start">@totalBillAmount.ToString("N2")</td>
                                <td class="text-end fw-bold text-success">@totalPaidAmount.ToString("N2")</td>
                                <td class="text-end fw-bold pe-2 border-end @(totalBalanceAmount >= 0 ? "text-warning" : "text-success")">
                                    @totalBalanceAmount.ToString("N2")
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string InvoiceType { get; set; } = "SALE";
    
    private List<InvoicesAllModel> invoices = new();
    private DateTime startDate = DateTime.Today.AddDays(-30);
    private DateTime endDate = DateTime.Today;
    private bool isLoading = false;

    private int totalInvoices = 0;
    private decimal totalBillAmount = 0;
    private decimal totalPaidAmount = 0;
    private decimal totalBalanceAmount = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!string.IsNullOrEmpty(InvoiceType))
            {
                InvoiceType = InvoiceType.ToUpper();
            }
            else
            {
                InvoiceType = "SALE";
            }

            if (InvoiceType == "SALE")
                Globals.AccessLevel = Globals.PageAccess(NavManager, "SaleDashboard");
            else if (InvoiceType == "PURCHASE")
                Globals.AccessLevel = Globals.PageAccess(NavManager, "PurchaseDashboard");

            await LoadReport();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error initializing page: {ex.Message}", Severity.Error);
            invoices = new List<InvoicesAllModel>();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(InvoiceType))
        {
            InvoiceType = InvoiceType.ToUpper();
        }
        else
        {
            InvoiceType = "SALE";
        }
        
        await LoadReport();
    }

    private async Task LoadReport()
    {
        if (startDate > endDate)
        {
            SnackbarService.Add("Start date must be earlier than end date.", Severity.Warning);
            return;
        }

        try
        {
            isLoading = true;
            StateHasChanged();

            string formattedStartDate = startDate.ToString("yyyy-MM-dd");
            string formattedEndDate = endDate.ToString("yyyy-MM-dd");
            string criteria = $"i.InvoiceType = '{InvoiceType}' and CAST(ISNULL(i.TranDate, i.CreatedOn) AS DATE) >= '{formattedStartDate}' and CAST(ISNULL(i.TranDate, i.CreatedOn) AS DATE) <= '{formattedEndDate}'";

            if (Globals.User.GroupId != 1)
            {
                criteria += $" and LocationId = {Globals.User.LocationId}";
            }

            string encodedCriteria = Uri.EscapeDataString(criteria);
            string apiUrl = $"Invoice/Search/{encodedCriteria}";

            var result = await Functions.GetAsync<List<InvoicesAllModel>>(apiUrl, true);
            invoices = result ?? new List<InvoicesAllModel>();

            CalculateSummaries();

            if (invoices.Any())
            {
                SnackbarService.Add($"Summary loaded: {invoices.Count} invoices", Severity.Success);
            }
            else
            {
                SnackbarService.Add($"No invoices found for the selected period", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading summary: {ex.Message}", Severity.Error);
            invoices = new List<InvoicesAllModel>();
            ResetSummaryValues();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void CalculateSummaries()
    {
        totalInvoices = invoices.Count;
        totalBillAmount = invoices.Sum(x => (decimal)x.BillAmount);
        totalPaidAmount = invoices.Sum(x => (decimal)x.TotalPaidAmount);
        totalBalanceAmount = invoices.Sum(x => (decimal)x.BalanceAmount);
    }

    private void ResetSummaryValues()
    {
        totalInvoices = 0;
        totalBillAmount = 0;
        totalPaidAmount = 0;
        totalBalanceAmount = 0;
    }

    private string GetStatusBadgeClass(string status)
    {
        if (string.IsNullOrEmpty(status))
            return "bg-secondary";

        return status.ToUpper() switch
        {
            "PAID" => "bg-success",
            "PARTIAL" => "bg-warning",
            "UNPAID" => "bg-danger",
            "CANCELLED" => "bg-dark",
            _ => "bg-secondary"
        };
    }

    private async void PrintReport()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("print");
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error printing: {ex.Message}", Severity.Error);
        }
    }
}
