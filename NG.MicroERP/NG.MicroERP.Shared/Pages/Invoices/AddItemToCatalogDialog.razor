@using NG.MicroERP.Shared.Models
@using MudBlazor
@inject Functions Functions

<MudDialog>
    <DialogContent>
        <MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
            <MudGrid Spacing="3" GutterSize="GutterSize.Small">
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="fw-bold mb-3">Add Item to Catalog</MudText>
                    <MudDivider Class="mb-3" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="NewItem.Name"
                                  Label="Item Name"
                                  Variant="Variant.Outlined"
                                  FullWidth="true"
                                  Required="true"
                                  RequiredError="Item name is required"
                                  Margin="Margin.Normal"
                                  Class="new-item-field" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="int"
                               @bind-Value="NewItem.CategoryId"
                               Label="Category"
                               Variant="Variant.Outlined"
                               FullWidth="true"
                               Required="true"
                               RequiredError="Category is required"
                               Margin="Margin.Normal"
                               Class="new-item-field">
                        @if (Categories != null && Categories.Any())
                        {
                            @foreach (var category in Categories)
                            {
                                <MudSelectItem T="int" Value="@category.Id">@category.Name</MudSelectItem>
                            }
                        }
                        else
                        {
                            <MudSelectItem T="int" Value="0" Disabled="true">No categories available</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="string"
                               @bind-Value="NewItem.StockType"
                               Label="Stock Type"
                               Variant="Variant.Outlined"
                               FullWidth="true"
                               Margin="Margin.Normal"
                               Class="new-item-field">
                        <MudSelectItem T="string" Value=@("ITEM")>Item</MudSelectItem>
                        <MudSelectItem T="string" Value=@("SERVICE")>Service</MudSelectItem>
                        <MudSelectItem T="string" Value=@("FIXED ASSET")>Fixed Asset</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField T="double"
                                    @bind-Value="NewItem.BasePrice"
                                    Label="Base Price"
                                    Variant="Variant.Outlined"
                                    FullWidth="true"
                                    Margin="Margin.Normal"
                                    Format="#,##0.00"
                                    Min="0"
                                    Class="new-item-field" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField T="double"
                                    @bind-Value="NewItem.CostPrice"
                                    Label="Cost Price"
                                    Variant="Variant.Outlined"
                                    FullWidth="true"
                                    Margin="Margin.Normal"
                                    Format="#,##0.00"
                                    Min="0"
                                    Class="new-item-field" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="NewItem.Description"
                                  Label="Description"
                                  Variant="Variant.Outlined"
                                  FullWidth="true"
                                  Margin="Margin.Normal"
                                  Lines="2"
                                  Class="new-item-field" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="NewItem.Unit"
                                  Label="Unit of Measure"
                                  Variant="Variant.Outlined"
                                  FullWidth="true"
                                  Margin="Margin.Normal"
                                  Class="new-item-field" />
                </MudItem>
            </MudGrid>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Color="Color.Default">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Save Item</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .new-item-field {
        margin-bottom: 8px;
    }

    :deep(.mud-dialog-actions) {
        padding: 16px 24px;
        border-top: 1px solid rgba(0, 0, 0, 0.12);
        gap: 12px;
    }
</style>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string ItemName { get; set; } = string.Empty;
    [Parameter] public double UnitPrice { get; set; } = 0;
    [Parameter] public List<CategoriesModel> Categories { get; set; } = new();
    [Parameter] public int OrganizationId { get; set; }
    [Parameter] public int CreatedBy { get; set; }
    [Parameter] public string CreatedFrom { get; set; } = string.Empty;

    public ItemsModel NewItem { get; set; } = new ItemsModel();

    protected override async Task OnInitializedAsync()
    {
        NewItem.Name = ItemName;
        NewItem.BasePrice = UnitPrice;
        NewItem.CostPrice = UnitPrice;
        NewItem.OrganizationId = OrganizationId;
        NewItem.CreatedBy = CreatedBy;
        NewItem.CreatedFrom = CreatedFrom;
        NewItem.IsActive = 1;
        NewItem.StockType = "ITEM";

        // Set default Revenue and Expense Account IDs from Chart of Accounts
        // Priority: 'ITEM REVENUE' / 'ITEM EXPENSE' -> 'MANUAL ITEM REVENUE' / 'MANUAL ITEM EXPENSE'
        try
        {
            // Get default Revenue Account (for SALE invoices)
            // First try 'ITEM REVENUE', then fallback to 'MANUAL ITEM REVENUE'
            if (!NewItem.RevenueAccountId.HasValue || NewItem.RevenueAccountId.Value == 0)
            {
                var revenueAccounts = await Functions.GetAsync<List<ChartOfAccountsModel>>(
                    $"ChartOfAccounts/Search/InterfaceType='ITEM REVENUE'", true) ?? new List<ChartOfAccountsModel>();
                
                var revenueAccount = revenueAccounts?.FirstOrDefault(a => a.OrganizationId == OrganizationId && a.IsActive == 1);
                
                // Fallback to 'MANUAL ITEM REVENUE' if 'ITEM REVENUE' not found
                if (revenueAccount == null || revenueAccount.Id == 0)
                {
                    revenueAccounts = await Functions.GetAsync<List<ChartOfAccountsModel>>(
                        $"ChartOfAccounts/Search/InterfaceType='MANUAL ITEM REVENUE'", true) ?? new List<ChartOfAccountsModel>();
                    revenueAccount = revenueAccounts?.FirstOrDefault(a => a.OrganizationId == OrganizationId && a.IsActive == 1);
                }
                
                if (revenueAccount != null && revenueAccount.Id > 0)
                {
                    NewItem.RevenueAccountId = revenueAccount.Id;
                }
            }

            // Get default Expense Account (for PURCHASE invoices)
            // First try 'ITEM EXPENSE', then fallback to 'MANUAL ITEM EXPENSE'
            if (!NewItem.ExpenseAccountId.HasValue || NewItem.ExpenseAccountId.Value == 0)
            {
                var expenseAccounts = await Functions.GetAsync<List<ChartOfAccountsModel>>(
                    $"ChartOfAccounts/Search/InterfaceType='ITEM EXPENSE'", true) ?? new List<ChartOfAccountsModel>();
                
                var expenseAccount = expenseAccounts?.FirstOrDefault(a => a.OrganizationId == OrganizationId && a.IsActive == 1);
                
                // Fallback to 'MANUAL ITEM EXPENSE' if 'ITEM EXPENSE' not found
                if (expenseAccount == null || expenseAccount.Id == 0)
                {
                    expenseAccounts = await Functions.GetAsync<List<ChartOfAccountsModel>>(
                        $"ChartOfAccounts/Search/InterfaceType='MANUAL ITEM EXPENSE'", true) ?? new List<ChartOfAccountsModel>();
                    expenseAccount = expenseAccounts?.FirstOrDefault(a => a.OrganizationId == OrganizationId && a.IsActive == 1);
                }
                
                if (expenseAccount != null && expenseAccount.Id > 0)
                {
                    NewItem.ExpenseAccountId = expenseAccount.Id;
                }
            }
        }
        catch (Exception ex)
        {
            // If account lookup fails, continue without setting defaults
            // The item will still be created, but account IDs will remain null
            // and will fall back to invoice-level or InterfaceType lookup during GL posting
            Console.WriteLine($"AddItemToCatalogDialog: Error fetching default accounts: {ex.Message}");
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private void Save()
    {
        if (string.IsNullOrWhiteSpace(NewItem.Name))
        {
            return;
        }
        if (NewItem.CategoryId == 0)
        {
            return;
        }

        MudDialog.Close(DialogResult.Ok(NewItem));
    }
}
