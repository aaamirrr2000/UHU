@page "/PermissionsDashboard"

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<MyModelDialog Width="20%" Height="45%" @ref="_myDialog" Title="Permission">
    <HeaderContent>
        <div class="text-center" style="overflow-x: hidden;">
            <p>A Permissions Management System allows organizations to define and control user access to various system functionalities based on predefined permission levels. This ensures that users can only perform actions that align with their roles and responsibilities, enhancing security and operational efficiency.</p>
        </div>
    </HeaderContent>
    <ChildContent>
        <EditForm Model="record" OnSubmit="Save">
            <MudForm>
                <MudSelect T="string" Label="Permission" @bind-Value="record.My_Privilege" class="w-100">
                    <MudSelectItem T="string" Value=@("NO ACCESS")>NO ACCESS</MudSelectItem>
                    <MudSelectItem T="string" Value=@("VIEW ONLY")>VIEW ONLY</MudSelectItem>
                    <MudSelectItem T="string" Value=@("FULL ACCESS")>FULL ACCESS</MudSelectItem>
                </MudSelect>
            </MudForm>
        </EditForm>
    </ChildContent>
    <FooterContent>
        <div class="mt-5 text-center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Class="px-4 py-2">
                Save
            </MudButton>
        </div>
    </FooterContent>
</MyModelDialog>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-0" Style="padding: 2px;">
    <div class="dashboard-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div>
                <MudText Typo="Typo.h5" Class="mb-0 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Class="me-2" Style="color: white;" />
                    Permissions Management
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted mt-1" Style="color: rgba(255,255,255,0.85) !important;">Configure menu access permissions by group</MudText>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                <MudSelect T="int" 
                           @bind-Value="selectedGroup" 
                           @bind-Value:after="OnGroupChanged"
                           Label="Group"
                           Variant="Variant.Outlined">
                    @if (GroupsData != null)
                    {
                        @foreach (var a in GroupsData)
                        {
                            <MudSelectItem T="int" Value="@a.Id">@a.Name</MudSelectItem>
                        }
                    }
                </MudSelect>
            </div>
        </div>
    </div>

    @if (PreData == null)
    {
        <SimpleLoading />
    }
    else
    {
        <MudPaper Elevation="3" Style="border-radius: 12px; overflow: hidden;">
            <MudDataGrid T="GroupMenuModel"
                         MultiSelection="false"
                         Items="@PreData"
                         SortMode="SortMode.Multiple"
                         Filterable="true"
                         Hideable="true"
                         RowsPerPage="10"
                         Dense="true"
                         Striped="true"
                         Class="professional-grid elevation-8">

                <Columns>
                        <TemplateColumn Title="Actions"
                                        CellStyle="width: 120px; min-width: 120px;"
                                        HeaderClass="grid-header">
                            <CellTemplate Context="row">
                                <div class="actions-cell">
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                             Color="Color.Primary"
                                             Dense="true"
                                             Class="actions-menu">
                                        @if (Globals.AccessLevel == 1)
                                        {
                                            <MudMenuItem OnClick="@(() => NoAccess(row.Item.MenuId))"
                                                         Class="menu-item">
                                                <MudIcon Icon="@Icons.Material.Filled.Block"
                                                         Color="Color.Error"
                                                         Class="menu-icon" />
                                                <span>No Access</span>
                                            </MudMenuItem>

                                            @if (row.Item.ParentId != 0)
                                            {
                                                <MudMenuItem OnClick="@(() => ReadOnly(row.Item.MenuId))"
                                                             Class="menu-item">
                                                    <MudIcon Icon="@Icons.Material.Filled.Visibility"
                                                             Color="Color.Warning"
                                                             Class="menu-icon" />
                                                    <span>Read Only</span>
                                                </MudMenuItem>
                                            }

                                            <MudMenuItem OnClick="@(() => FullAccess(row.Item.MenuId))"
                                                         Class="menu-item">
                                                <MudIcon Icon="@Icons.Material.Filled.Verified"
                                                         Color="Color.Success"
                                                         Class="menu-icon" />
                                                <span>Full Access</span>
                                            </MudMenuItem>
                                        }
                                    </MudMenu>
                                </div>
                            </CellTemplate>
                        </TemplateColumn>

                        <TemplateColumn Title="Menu Item"
                                        Sortable="true"
                                        Filterable="true"
                                        Width="280px"
                                        HeaderClass="grid-header"
                                        CellClass="grid-cell">
                            <CellTemplate Context="row">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    @if (row.Item.ParentId == 0)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Dashboard"
                                                 Style="font-size: 1.2rem;"
                                                 Color="Color.Primary" />
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.MenuOpen"
                                                 Style="font-size: 1rem; margin-left: 4px;"
                                                 Color="Color.Secondary" />
                                    }

                                    <MudText Typo="Typo.body1" Style="@(row.Item.ParentId == 0 ? "font-weight: 600;" : "font-weight: 400; margin-left: 4px;")">
                                        @row.Item.MenuCaption
                                    </MudText>
                                </div>
                            </CellTemplate>
                        </TemplateColumn>

                        <TemplateColumn Title="Current Access"
                                        CellStyle="width: 150px; min-width: 150px;"
                                        HeaderClass="grid-header"
                                        CellClass="grid-cell">
                            <CellTemplate Context="row">
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    @if (row.Item.My_Privilege == "NO ACCESS")
                                    {
                                        <MudChip Color="Color.Error" Variant="Variant.Filled" Size="Size.Small">
                                            <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" Class="me-1" />
                                            No Access
                                        </MudChip>
                                    }
                                    else if (row.Item.My_Privilege == "READ ONLY")
                                    {
                                        <MudChip Color="Color.Warning" Variant="Variant.Filled" Size="Size.Small">
                                            <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Class="me-1" />
                                            Read Only
                                        </MudChip>
                                    }
                                    else if (row.Item.My_Privilege == "FULL ACCESS")
                                    {
                                        <MudChip Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">
                                            <MudIcon Icon="@Icons.Material.Filled.Verified" Size="Size.Small" Class="me-1" />
                                            Full Access
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudChip Color="Color.Default" Variant="Variant.Filled" Size="Size.Small">
                                            <MudIcon Icon="@Icons.Material.Filled.Help" Size="Size.Small" Class="me-1" />
                                            Undefined
                                        </MudChip>
                                    }
                                </div>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>

                    <PagerContent>
                        <div class="pager-container">
                            <MudDataGridPager T="GroupMenuModel" Class="grid-pager" />
                        </div>
                    </PagerContent>
            </MudDataGrid>
        </MudPaper>
    }
</MudContainer>

<style>
    .dashboard-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 8px;
    }

    .dashboard-header .mud-typography {
        color: white !important;
    }

    .dashboard-header .text-muted {
        color: rgba(255, 255, 255, 0.85) !important;
    }

    .dashboard-header .mud-select {
        color: var(--mud-palette-text-primary) !important;
    }

    .dashboard-header .mud-select .mud-input-root {
        color: var(--mud-palette-text-primary) !important;
    }

    /* Dark mode adjustments */
    .mud-theme-dark .dashboard-header {
        background: linear-gradient(135deg, var(--mud-palette-primary-darken) 0%, var(--mud-palette-primary) 100%);
    }

    .mud-theme-dark .dashboard-header .mud-select {
        background: rgba(255,255,255,0.1) !important;
    }

    .mud-theme-dark .dashboard-header .mud-select .mud-input-root {
        color: white !important;
    }
</style>

@code
{
    List<GroupMenuModel> PreData = new();
    GroupMenuModel record = new();
    public MyModelDialog? _myDialog;

    private static List<GroupsModel> GroupsData = new();
    private int selectedGroup = 2;
    private int selectedMenu = 1;
    private string selectedAccessLevel = "NO ACCESS";


    public string? Action { get; set; } = "INSERT";

    bool isReadOnly = true;
    
    private bool LoadingPanel { get; set; } = false;
    private MyDrawer _drawer = new();

    protected override async Task OnInitializedAsync()
    {
        Globals.AccessLevel = Globals.PageAccess(NavManager, "PermissionDashboard");
        await GetAll();
    }

    protected async Task GetAll()
    {
        LoadingPanel = true;
        GroupsData = await Functions.GetAsync<List<GroupsModel>>($"Groups/Search/Id!=1", true) ?? new List<GroupsModel>();
        await OnGroupChanged();
        LoadingPanel = false;
    }

    protected async Task Get(int id)
    {
        LoadingPanel = true;
        record = await Functions.GetAsync<GroupMenuModel>($"GroupMenu/Search/GroupId={id}", true) ?? new GroupMenuModel();
        LoadingPanel = false;
    }

    protected async Task NoAccess(int id)
    {
        selectedAccessLevel = "NO ACCESS";
        selectedMenu = id;
        await Save();
    }

    protected async Task ReadOnly(int id)
    {
        selectedAccessLevel = "READ ONLY";
        selectedMenu = id; 
        await Save();
    }

    protected async Task FullAccess(int id)
    {
        selectedAccessLevel = "FULL ACCESS";
        selectedMenu = id; 
        await Save();
    }

    protected async Task Save()
    {
        LoadingPanel = true;

        PermissionsModel rec = new();

        rec.GroupId = selectedGroup;
        rec.MenuId = selectedMenu;
        rec.Privilege = selectedAccessLevel;
        rec.OrganizationId = Globals.User.OrganizationId;
        rec.CreatedBy = Globals.User.Id;
        rec.CreatedOn = DateTime.Now;
        rec.CreatedFrom = Globals.ClientInfo;
        rec.UpdatedBy = Globals.User.Id;
        rec.UpdatedOn = DateTime.Now;
        rec.UpdatedFrom = Globals.ClientInfo;
        rec.IsActive = 1;
        rec.IsSoftDeleted = 0;

        var (success, result, message) = await Functions.PostAsync<Newtonsoft.Json.Linq.JObject>($"Permissions/Save", rec, true);
        if (success == true && result != null)
        {
            var successProp = result["success"]?.ToString();
            var messageProp = result["message"]?.ToString();
            
            if (successProp == "True" || successProp == "true" || successProp == "1")
            {
                SnackbarService.Add(messageProp ?? "Permission saved successfully", Severity.Success);
            }
            else
            {
                SnackbarService.Add(messageProp ?? "Failed to save permission", Severity.Error);
            }
        }
        else
        {
            SnackbarService.Add(message ?? "Failed to save permission. Please try again.", Severity.Error);
        }

        await OnGroupChanged();
        LoadingPanel = false;
    }

    private async Task OnGroupChanged()
    {
        if (Globals.User == null)
            return;

        try
        {
            LoadingPanel = true;
            var result = await Functions.GetAsync<List<GroupMenuModel>>($"Permissions/SearchGroupPermissions/{Globals.User.OrganizationId}/GroupId={selectedGroup}", true);
            PreData = result ?? new List<GroupMenuModel>();
            
            if (PreData.Count > 0)
            {
                PreData = PreData
                        .OrderBy(x => x.ParentId == 0 ? x.MenuId : PreData.FirstOrDefault(p => p.MenuId == x.ParentId)?.MenuId ?? x.MenuId)
                        .ThenBy(x => x.ParentId)
                        .ThenBy(x => x.MenuId)
                        .ToList();
            }
            else
            {
                // If no data, try to load menu items directly to show what's available
                var menuItems = await Functions.GetAsync<List<MyMenuModel>>($"MyMenu/Search", true) ?? new List<MyMenuModel>();
                if (menuItems.Count > 0)
                {
                    PreData = menuItems
                        .Where(x => x.Live == 1 && x.IsSoftDeleted == 0)
                        .Select(x => new GroupMenuModel
                        {
                            MenuId = x.Id,
                            MenuCaption = x.MenuCaption,
                            ParentId = x.ParentId,
                            PageName = x.PageName,
                            Icon = x.Icon,
                            SeqNo = x.SeqNo,
                            Live = x.Live,
                            GroupId = selectedGroup,
                            OrganizationId = Globals.User.OrganizationId,
                            My_Privilege = "NO ACCESS"
                        })
                        .OrderBy(x => x.SeqNo)
                        .ThenBy(x => x.ParentId)
                        .ThenBy(x => x.MenuId)
                        .ToList();
                }
            }
            
            StateHasChanged();
            LoadingPanel = false;
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading permissions: {ex.Message}", Severity.Error);
            PreData = new List<GroupMenuModel>();
            LoadingPanel = false;
            StateHasChanged();
        }
    }

}

