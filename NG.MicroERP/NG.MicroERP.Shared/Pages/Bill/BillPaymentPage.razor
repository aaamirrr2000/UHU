@page "/BillPaymentPage/{BillId:int?}"

<MudDialog @bind-Visible="Visible" Options="DialogOptions">
    <TitleContent>
        <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudItem xs="10">
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" />
                    Payments for Bill #@BillId
                </MudText>
            </MudItem>
        </MudGrid>
    </TitleContent>

    <DialogContent>
        <MudPaper Class="pa-4" Style="max-width: 600px; width: 100%; border: 1px solid #ccc; border-radius: 8px; min-height: 70vh; margin: 5px; padding: 5px;">
            <MudGrid GutterSize="GutterSize.Small">
                <div class="row summary-row">
                    <div class="col-4 summary-col">
                        <MudSelect T="string"
                                   Dense="true"
                                   @bind-Value="PaymentModel.PaymentMethod"
                                   Variant="Variant.Outlined"
                                   Label="Payment Method"
                                   Style="text-align: center;"
                                   Class="summary-value">
                            @foreach (var pm in PaymentMethods)
                            {
                                <MudSelectItem Value="@pm">@pm</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div class="col-4 summary-col">
                        <MudTextField T="string"
                                      Dense="true"
                                      @bind-Value="PaymentModel.PaymentRef"
                                      Variant="Variant.Outlined"
                                      Label="Payment Reference"
                                      Class="summary-value"
                                      Style="text-align: center;" />
                    </div>

                    <div class="col-4 summary-col">
                        <MudTextField T="decimal"
                                      Dense="true"
                                      @bind-Value="PaymentModel.AmountPaid"
                                      Variant="Variant.Outlined"
                                      Label="Amount"
                                      Class="summary-value"
                                      Style="text-align: right;" />
                    </div>

                    <div class="col-4 summary-col mt-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="AddPayment">Add Payment</MudButton>
                    </div>
                </div>

                <MudTable Items="@Payments"
                          Dense="true"
                          Hover="true"
                          Bordered="true"
                          Striped="true"
                          RowsPerPage="10"
                          Breakpoint="Breakpoint.Sm"
                          Elevation="0"
                          MultiSelection="false">

                    <HeaderContent>
                        <MudTh style="width:160px;">Actions</MudTh>
                        <MudTh>Method</MudTh>
                        <MudTh>Reference</MudTh>
                        <MudTh>Amount</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.TwoTone.DeleteSweep"
                                           Size="Size.Small"
                                           Variant="Variant.Filled"
                                           Color="Color.Error"
                                           OnClick="@(() => DeletePayment(context))" />
                        </MudTd>
                        <MudTd>@context.PaymentMethod</MudTd>
                        <MudTd>@context.PaymentRef</MudTd>
                        <MudTd>@context.AmountPaid.ToString("N2")</MudTd>
                    </RowTemplate>

                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudGrid>
        </MudPaper>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="CloseDialog" Variant="Variant.Text" Color="Color.Default">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter] public int BillId { get; set; }
    [Parameter] public List<BillPaymentModel> Payments { get; set; } = new();
    [Parameter] public List<string> PaymentMethods { get; set; } = new();

    private BillPaymentModel PaymentModel { get; set; } = new();
    private DialogOptions DialogOptions => new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    private void AddPayment()
    {
        if (!string.IsNullOrWhiteSpace(PaymentModel.PaymentMethod) && PaymentModel.AmountPaid > 0)
        {
            Payments.Add(new BillPaymentModel
            {
                BillId = BillId,
                PaymentMethod = PaymentModel.PaymentMethod,
                PaymentRef = PaymentModel.PaymentRef,
                AmountPaid = PaymentModel.AmountPaid,
                PaidOn = DateTime.Now
            });

            PaymentModel = new(); // Reset form
        }
    }

    private void DeletePayment(BillPaymentModel payment)
    {
        Payments.Remove(payment);
    }

    private async Task CloseDialog()
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
    }
}
