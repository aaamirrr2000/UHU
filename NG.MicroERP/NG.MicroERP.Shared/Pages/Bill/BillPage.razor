@page "/BillPage/{Act}/{Id:int?}"
@page "/BillPage"
@using System.Collections.ObjectModel
@using System.Text.Json
@inject NavigationManager NavManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudLayout>
    <MudAppBar Elevation="2" Color="Color.Surface" Dense="true"
               Class="app-bar px-3 py-2 w-100"
               Fixed="false"
               Style="margin-left: 0; border-top: 1px solid gray;">

        <MudGrid AlignItems="Center" GutterSize="GutterSize.None">
            <!-- Left Section -->
            <MudItem xs="12" sm="9">
                <div class="d-flex align-items-center justify-content-start flex-wrap" style="gap: 4px; max-width: 100%;">

                    <!-- Bill Type Dropdown -->
                    <MudSelect Dense="true"
                               T="string"
                               @bind-Value="record.Bill.BillType"
                               Variant="Variant.Filled"
                               Style="min-width: 150px; max-width: 200px;">
                        @if (BillType != null)
                        {
                            @foreach (var pm in BillType)
                            {
                                <MudSelectItem Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <!-- Transaction Date -->
                    <MudDatePicker @bind-Value="record.Bill.TranDate"
                                   Dense="true"
                                   Variant="Variant.Filled"
                                   Style="width: 250px;" />

                    <!-- Action Buttons -->
                    <MudTooltip Text="Options">
                        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Info" OnClick="Options" Variant="Variant.Filled" />
                    </MudTooltip>

                    <MudTooltip Text="New">
                        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="Clear" Variant="Variant.Filled" />
                    </MudTooltip>

                    @if (Act != "VIEW")
                    {
                        <MudTooltip Text="Save">
                            <MudIconButton Icon="@Icons.Material.Filled.Save" Color="Color.Warning" OnClick="Save" Variant="Variant.Filled" />
                        </MudTooltip>
                    }

                    @if (Id != 0)
                    {
                        <MudTooltip Text="Print">
                            <MudIconButton Icon="@Icons.Material.Filled.Print" Color="Color.Secondary" OnClick="Print" Variant="Variant.Filled" />
                        </MudTooltip>
                    }

                    <MudTooltip Text="Customer">
                        <MudIconButton Icon="@Icons.Material.Filled.Person" Color="Color.Primary" OnClick="AddParty" Variant="Variant.Filled" />
                    </MudTooltip>

                </div>
            </MudItem>

            <!-- Right Section: Bill# -->
            <MudItem xs="12" sm="3">
                <MudTextField T="string"
                              Dense="true"
                              Variant="Variant.Filled"
                              Placeholder="Bill #"
                              @bind-Value="record.Bill.SeqNo"
                              Style="width: 100%;" />
            </MudItem>
        </MudGrid>
    </MudAppBar>



    <!-- Main content -->
    <MudMainContent Class="p-4" Style="margin-left:0;">
        <MudGrid>
            <!-- Left: Items & summary -->
            <MudItem xs="12" md="7">
                <!-- Items table -->
                <MudCard Elevation="1" Class="d-flex flex-column" Style="height:65vh; overflow:hidden;">
                    <MudCardContent Class="p-0" Style="flex-grow: 1; overflow: hidden;">

                        <div style="height: 600px; overflow-y: auto;">
                            <MudTable Items="record.BillDetails.Reverse()"
                                      Hover="true"
                                      Dense="true"
                                      StickyHeader="true"
                                      Elevation="0"
                                      Bordered="true"
                                      Breakpoint="Breakpoint.Xs"
                                      Striped="false"
                                      Class="billing-table"
                                      Style="min-width: 900px;">
                                <HeaderContent>
                                    <MudTh Width="5%" Align="Align.Center" Style="@GetFooterStyle()">#</MudTh>
                                    <MudTh Width="5%" Align="Align.Center" Style="@GetFooterStyle()">(...)</MudTh>
                                    <MudTh Align="Align.Center" Style="@GetFooterStyle()">Item</MudTh>
                                    <MudTh Width="10%" Align="Align.Right" Style="@GetFooterStyle()">Qty</MudTh>
                                    <MudTh Width="10%" Align="Align.Right" Style="@GetFooterStyle()">Price</MudTh>
                                    <MudTh Width="10%" Align="Align.Right" Style="@GetFooterStyle()">Discount</MudTh>
                                    <MudTh Width="10%" Align="Align.Right" Style="@GetFooterStyle()">Tax</MudTh>
                                    <MudTh Width="10%" Align="Align.Right" Style="@GetFooterStyle()">Amount</MudTh>
                                </HeaderContent>

                                <RowTemplate Context="row">
                                    @{
                                        // Serial in reverse: first in gets highest serial, last in gets 1
                                        var serial = record.BillDetails.Count - record.BillDetails.IndexOf(row);
                                        var itemAmount = (row.Qty * row.UnitPrice) - row.DiscountAmount;
                                    }
                                    <MudTd Align="Align.Center">@serial</MudTd>
                                    <MudTd Align="Align.Center">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Size="Size.Small"
                                                       Color="Color.Error"
                                                       OnClick="@(() => DeleteItem(row))" />
                                    </MudTd>
                                    <MudTd>
                                        <MudText Typo="Typo.subtitle2" Class="fw-semibold" Color="Color.Primary">
                                            @row.ItemName
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted" Color="Color.Error">
                                            @row.ServingSize
                                        </MudText>
                                    </MudTd>
                                    <MudTd Align="Align.Right">
                                        <MudNumericField T="double"
                                                         Dense="true"
                                                         Min="0"
                                                         HideSpinButtons="false"
                                                         Value="row.Qty"
                                                         ValueChanged="@((double newQty) => OnRowQtyChanged(row, newQty))"
                                                         InputClass="text-end no-bottom-border"
                                                         ToStringFormat="#,##0.00"
                                                         Class="w-100"
                                                         Style="text-align:right;" />

                                    </MudTd>
                                    <MudTd Style="text-align:right;">@row.UnitPrice.ToString("#,##0.00")</MudTd>
                                    <MudTd Style="text-align:right;">@row.DiscountAmount.ToString("#,##0.00")</MudTd>
                                    <MudTd Style="text-align:right;">@row.TaxAmount.ToString("#,##0.00")</MudTd>
                                    <MudTd Style="text-align:right;">
                                        <MudText Color="@(itemAmount < 0 ? Color.Error : Color.Default)">
                                            @itemAmount.ToString("#,##0.00")
                                        </MudText>
                                    </MudTd>
                                </RowTemplate>

                                <FooterContent>
                                    <MudTd ColSpan="3" style="@GetFooterStyle(true)">
                                        <b>Total</b>
                                    </MudTd>
                                    <MudTd style="@GetFooterStyle()">
                                        <b>@TotalQty.ToString("#,##0.00")</b>
                                    </MudTd>
                                    <MudTd style="@GetFooterStyle()" />
                                    <MudTd style="@GetFooterStyle()">
                                        <b>@TotalDiscountAmount.ToString("#,##0.00")</b>
                                    </MudTd>
                                    <MudTd style="@GetFooterStyle()">
                                        <b>@TotalTaxAmount.ToString("#,##0.00")</b>
                                    </MudTd>
                                    <MudTd style="@GetFooterStyle()">
                                        <b>@record.Bill.SubTotalAmount.ToString("#,##0.00")</b>
                                    </MudTd>
                                </FooterContent>
                            </MudTable>
                        </div>
                    </MudCardContent>
                </MudCard>
                    
              <MudCard Class="mt-2" Elevation="1">
                <MudCardContent>

                   <div class="row summary-row">
                        <!-- Row 1 -->
                        <div class="col-md-4 summary-col">
                                <MudTextField T="decimal"
                                              Dense="true"
                                              Value="record.Bill.TotalServiceChargeAmount"
                                              Variant="Variant.Outlined"
                                              Label="Service Charges"
                                              Class="summary-value"
                                              InputClass="text-end"
                                              Format="#,##0.00"
                                              ReadOnly />
                        </div>

                        <div class="col-md-4 summary-col">
                            <MudTooltip Text="Tax">
                                <MudIconButton Icon="@Icons.Material.Filled.Receipt" Color="Color.Info" OnClick="OpenTaxDialog" Variant="Variant.Filled" />
                            </MudTooltip>
                                <MudTextField T="decimal"
                                              Dense="true"
                                              Value="record.Bill.TotalTaxAmount"
                                              Variant="Variant.Outlined"
                                              Label="Tax"
                                              Class="summary-value"
                                              InputClass="text-end"
                                              Format="#,##0.00"
                                              ReadOnly />
                        </div>

                        <div class="col-md-4 summary-col">
                                <MudNumericField T="decimal"
                                                 Dense="true"
                                                 @bind-Value="record.Bill.DiscountAmount"
                                                 @bind-Value:after="OnDiscountChanged"
                                                 Class="summary-value"
                                                 Variant="Variant.Outlined"
                                                 Label="Discount"
                                                 HideSpinButtons="true"
                                                 InputClass="text-end"
                                                 Format="#,##0.00" />

                        </div>
                    </div>

                    <div class="row summary-row mt-2">
                        <!-- Row 2 -->
                        <div class="col-md-4 summary-col">
                                <MudTextField T="decimal"
                                              Dense="true"
                                              Variant="Variant.Outlined"
                                              Label="Billed Amount"
                                              Value="record.Bill.BilledAmount"
                                              Class="summary-value"
                                              InputClass="text-end"
                                              Format="#,##0.00"
                                              ReadOnly />
                                </div>

                        <div class="col-md-4 summary-col">
                            
                            <MudTooltip Text="Payment Info">
                                <MudIconButton Icon="@Icons.Material.Filled.Payments" Color="Color.Info" OnClick="OpenPaymentDialog" Variant="Variant.Filled" />
                            </MudTooltip>
                                <MudTextField T="decimal"
                                              Dense="true"
                                              Variant="Variant.Outlined"
                                              Label="Paid Amount"
                                              Class="summary-value"
                                              Value="record.Bill.TotalPaidAmount"
                                              InputClass="text-end"
                                              Format="#,##0.00"
                                              ReadOnly />
                        </div>

                        <div class="col-md-4 summary-col">
                            <MudNumericField T="decimal"
                                Label="Net Amount"
                                Value="record.Bill.BalanceAmount"
                                ReadOnly="true"
                                Dense="true"
                                Variant="Variant.Outlined"
                                Class="summary-value"
                                HideSpinButtons="true"
                                InputClass="text-end"
                                Format="#,##0.00"
                                Style="width: 100%;"
                                Culture="@CultureInfo.GetCultureInfo("en-US")" />
                        </div>

                        <div class="col-md-4 summary-col">
                            <!-- Optional: Reserved for future or empty placeholder -->
                        </div>
                    </div>

                </MudCardContent>
            </MudCard>

            </MudItem>

            <!-- Right: Favourites / Recent -->
            <MudItem xs="12" md="5">

                <div style="display: flex; align-items: center; gap: 8px; margin: 2px; padding: 2px;">
                     <!-- Barcode Field -->
                    <MudTextField T="string"
                                    Dense="true"
                                    Variant="Variant.Filled"
                                    Placeholder="Scan or Enter Barcode"
                                    @bind-Value="ClickedItem.Code"
                                    Style="width: 180px;" />

                    <!-- Search Button -->
                    <MudTooltip Text="Search">
                        <MudIconButton Icon="@Icons.Material.Filled.Search"
                                       Color="Color.Error"
                                       OnClick="@(() => AddItemDialogShow(ClickedItem.Code!, "s"))"
                                       Variant="Variant.Filled" />
                    </MudTooltip>
                </div>

                <MudTabs Rounded="true" Centered="false" Elevation="1" Class="mb-2" ScrollButtons="ScrollButtons.Auto">
                    <MudTabPanel Text=@($"Items") Class="p-2">
                        <div class="d-flex flex-row gap-3" style="height: 500vh; overflow: auto;">

                            <div style="width: 240px; height: 750px; overflow-y: auto; background-color: lightgray; border-radius: 0px; padding: 8px; margin-top: 10px;">
                                <div style="display: flex; flex-direction: column;">
                                    @foreach (var category in _categories)
                                    {
                                        <button @onclick="() => LoadItemsByCategory(category)"
                                                style="display: flex; align-items: center; justify-content: flex-start; width: 100%; text-align: left; border: none; background-color: transparent; padding: 8px 10px; border-radius: 0px; margin-bottom: 4px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); transition: background-color 0.2s ease;"
                                                onmouseover="this.style.backgroundColor='rgba(0,0,0,0.1)'"
                                                onmouseout="this.style.backgroundColor='transparent'">

                                            @if (!string.IsNullOrWhiteSpace(category.Pic))
                                            {
                                                <img src="@category.Pic"
                                                     alt="@category.Name"
                                                     style="width: 36px; height: 36px; object-fit: cover; border-radius: 50%; margin-right: 10px; flex-shrink: 0;" />
                                            }
                                            else
                                            {
                                                <div style="width: 36px; height: 36px; border-radius: 50%; background-color: #ccc; color: #333; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0;">
                                                    @category.Name.Substring(0, 1).ToUpper()
                                                </div>
                                            }

                                            <span style="font-weight: 600; font-size: 14px; color: #212529; white-space: nowrap;">
                                                @category.Name (@category.ItemCount)
                                            </span>
                                        </button>
                                    }
                                </div>
                            </div>


                            <!-- Right Column: Items -->
                            <div class="flex-grow-1">
                                <MudTextField Dense="true" Class="mb-2 p-2" Placeholder="Search…"
                                              @bind-Value="ClickedItem.Name"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Search" />

                                <MudGrid GutterSize="GutterSize.Small">
                                    @foreach (var fav in SelectedItems.Where(f => string.IsNullOrWhiteSpace(ClickedItem.Name) || f.Name!.Contains(ClickedItem!.Name!, StringComparison.OrdinalIgnoreCase)))
                                    {
                                        <MudItem xs="6" sm="4" md="3">
                                            <div class="position-relative"
                                                 style="cursor: pointer; width: 100%; height: 150px; border-radius: 10px; overflow: hidden;"
                                                 @onclick="@(async () => await AddItemDialogShow(fav.Id.ToString()))">
                                                <img src="@fav.Pic"
                                                     alt="@fav.Name"
                                                     style="width: 100%; height: 100%; object-fit: cover;" />
                                                <div class="position-absolute bottom-0 w-100"
                                                     style="background-color: rgba(0, 0, 0, 0.7); padding: 6px 4px;">
                                                    <div class="text-white text-center fw-semibold" style="font-size: 14px;">
                                                        @fav.Name
                                                    </div>
                                                    <div class="text-white text-center" style="font-size: 12px;">
                                                        @fav.RetailPrice.ToString("#,##0.00")
                                                    </div>
                                                </div>
                                            </div>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </div>

                        </div>
                    </MudTabPanel>

                    <MudTabPanel Text=@($"Favorites ({MaxItems:#,##0})") Class="p-2">

                        <MudTextField Dense="true" Class="mb-2 p-2" Placeholder="Search…" @bind-Value="SelectedFavItem.Name" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />

                        <MudGrid GutterSize="GutterSize.Small">
                            @foreach (var fav in FavItemsData.Where(f => string.IsNullOrWhiteSpace(SelectedFavItem.Name) || f.Name!.Contains(SelectedFavItem.Name, StringComparison.OrdinalIgnoreCase)))
                            {
                                <MudItem xs="6" sm="4" md="3">
                                    <div class="position-relative"
                                         style="cursor: pointer; width: 100%; height: 150px; border-radius: 10px; overflow: hidden;"
                                         @onclick="@(async () => await AddItemDialogShow(fav.Id.ToString()))">

                                        <!-- Full background image -->
                                        <img src="@fav.Pic"
                                             alt="@fav.Name"
                                             style="width: 100%; height: 100%; object-fit: cover;" />

                                        <!-- Bottom overlay -->
                                        <div class="position-absolute bottom-0 w-100"
                                             style="background-color: rgba(0, 0, 0, 0.7); padding: 6px 4px;">
                                            <div class="text-white text-center fw-semibold" style="font-size: 14px;">
                                                @fav.Name
                                            </div>
                                            <div class="text-white text-center" style="font-size: 12px;">
                                                @fav.RetailPrice.ToString("#,##0.00")
                                            </div>
                                        </div>
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>

                    </MudTabPanel>
                    <MudTabPanel Text=@($"Recent ({MaxItems:#,##0})") Class="p-2">

                        <MudTextField Dense="true" Class="mb-2 p-2" Placeholder="Search…" @bind-Value="SelectedRecentItem.Name" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                        
                       <MudGrid GutterSize="GutterSize.Small">
                            @foreach (var fav in RecentItemsData.Where(f => string.IsNullOrWhiteSpace(SelectedRecentItem.Name) || f.Name!.Contains(SelectedRecentItem.Name, StringComparison.OrdinalIgnoreCase)))
                            {
                                <MudItem xs="6" sm="4" md="3">
                                    <div class="position-relative"
                                         style="cursor: pointer; width: 100%; height: 150px; border-radius: 10px; overflow: hidden;"
                                         @onclick="@(async () => await AddItemDialogShow(fav.Id.ToString()))">

                                        <!-- Full-size image -->
                                        <img src="@fav.Pic"
                                             alt="@fav.Name"
                                             style="width: 100%; height: 100%; object-fit: cover;" />

                                        <!-- Overlay with name and price -->
                                        <div class="position-absolute bottom-0 w-100"
                                             style="background-color: rgba(0, 0, 0, 0.7); padding: 6px 4px;">
                                            <div class="text-white text-center fw-semibold" style="font-size: 14px;">
                                                @fav.Name
                                            </div>
                                            <div class="text-white text-center" style="font-size: 12px;">
                                                @fav.RetailPrice.ToString("#,##0.00")
                                            </div>
                                        </div>
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>

                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    </MudMainContent>
    @* Options ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MyDrawer @ref="_drawer" Title="Options" FaIcon="fas fa-address-book">
        <HeaderContent>
        </HeaderContent>
        <ChildContent>
                <MudForm>
                    <MudPaper Class="p-4" Elevation="0">
                        <!-- Customer Dropdown -->
                        <MudItem Class="mb-5">
                        <MudSelect T="int"
                                   Value="record.Bill.PartyId"
                                   ValueChanged="OnPartyChanged"
                                   ValueExpression="() => record.Bill.PartyId"
                                   Disabled="@Disabled"
                                   Label="Select Customer"
                                   Dense="true">
                            @if (Parties != null)
                            {
                                @foreach (var customer in Parties)
                                {
                                    <MudSelectItem T="int" Value="@customer.Id">@customer.Name</MudSelectItem>
                                }
                            }
                        </MudSelect>

                        </MudItem>

                        <!-- Service Type Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="string" @bind-Value="record.Bill.ServiceType" Disabled="@Disabled" Label="Select Service Type" Dense="true">
                                @if (ServiceTypes != null)
                                {
                                    @foreach (var pm in ServiceTypes)
                                    {
                                        <MudSelectItem T="string" Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Bill Status Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="string" @bind-Value="record.Bill.Status" Disabled="@Disabled" Label="Select Bill Status" Dense="true">
                                @if (BillStatus != null)
                                {
                                    @foreach (var pm in BillStatus)
                                    {
                                        <MudSelectItem T="string" Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Table Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="int" @bind-Value="record.Bill.TableId" Disabled="@Disabled" Label="Select Table" Dense="true">
                                @if (Tables != null)
                                {
                                    @foreach (var option in Tables)
                                    {
                                        <MudSelectItem T="int" Value="@option.Id">@($"{option.TableNumber} - {option.TableLocation}")</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Sales ID Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="int" @bind-Value="record.Bill.SalesId" Disabled="@Disabled" Label="Select Sales ID" Dense="true">
                                @if (SalesId != null)
                                {
                                    @foreach (var option in SalesId)
                                    {
                                        <MudSelectItem T="int" Value="@option.Id">@option.Fullname</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                       @*  <!-- Close Button -->
                        <MudButton Variant="Variant.Filled" OnClick="CloseOptions" Class="px-2 py-2 mt-1 mr-2" Style="height:40px;">
                            <MudIcon Icon="@Icons.Material.Filled.Close" Class="mr-1" />
                            Close
                        </MudButton> *@
                    </MudPaper>
                </MudForm>
        </ChildContent>
        <FooterContent>
        </FooterContent>
    </MyDrawer>

    @* Parties ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MyDrawer @ref="_drawerParty" Title="Customer Details" FaIcon="fas fa-address-book">
        <HeaderContent>
        </HeaderContent>
        <ChildContent>
                <MudForm>
                    <MudPaper Class="p-4" Elevation="0">

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Name</MudText>
                        <MudTextField T="string" Placeholder="Customer (Optional)" Label="Customer (Optional)" @bind-Value="record.Bill.PartyName" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Phone</MudText>
                        <MudTextField T="string" Placeholder="Phone (Optional)" Label="Phone (Optional)" @bind-Value="record.Bill.PartyPhone" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Email</MudText>
                        <MudTextField T="string" InputType="InputType.Email" Placeholder="Email (Optional)" Label="Email (Optional)" Style="text-transform: unset;" @bind-Value="record.Bill.PartyEmail" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Address</MudText>
                        <MudTextField T="string" Placeholder="Address (Optional)" Label="Address (Optional)" @bind-Value="record.Bill.PartyAddress" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                    </MudPaper>
                </MudForm>
        </ChildContent>
        <FooterContent>
        </FooterContent>
    </MyDrawer>

     @* Items Selection ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MudDialog @bind-Visible="_DialogItemsDetails" Options="_dialogOptions">

        <TitleContent>
            <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudItem xs="10">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                        Item details
                    </MudText>
                </MudItem>

            </MudGrid>
        </TitleContent>

        <DialogContent>

            <MudGrid Class="w-100" Justify="Justify.Center" AlignItems="AlignItems.Start">
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="pa-6" Style="background-color: var(--mud-palette-surface); border-radius: 12px;">

                        <!-- Item Info -->
                        <div class="row g-4 align-items-center mb-3">
                            <!-- Image -->
                            <div class="col-md-3 text-center">
                                <img src="@SelectedItem.Pic" alt="Item Image"
                                     style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px;" />
                            </div>

                            <!-- Name and Quantity Controls -->
                            <div class="col-md-6 d-flex flex-column align-items-center justify-content-center">
                                <MudText Typo="Typo.h5" Class="fw-bold mb-3" style="letter-spacing: 3px; font-size: 36px;">@SelectedItem.Name</MudText>
                                <MudText Typo="Typo.subtitle1" Class="fw-semibold mb-2" style="letter-spacing: 1px; font-size: 12px; color: yellow;">@SelectedItem.Description</MudText>

                                @if (SelectedItem.IsInventoryItem == 1)
                                {
                                    <div class="d-inline-flex align-items-center justify-content-center"
                                    style="border: 1px solid #ccc; border-radius: 8px; overflow: hidden;">

                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Error"
                                                   Style="width: 60px; height: 60px; border-radius: 0;"
                                                   OnClick="@(() => DecreaseQty(SelectedItem))">
                                            <MudIcon Icon="@Icons.Material.Filled.Remove" />
                                        </MudButton>

                                        <MudNumericField T="double"
                                                         Value="SelectedItem.Qty"
                                                         ValueChanged="@((double val) => OnQtyChanged(val))"
                                                         Variant="Variant.Outlined"
                                                         HideSpinButtons="true"
                                                         Class="fw-bold text-secondary text-center"
                                                         Style="width: 120px; height: 60px; border-left: 1px solid #ccc; border-right: 1px solid #ccc; font-size: 24px;" />



                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Success"
                                                   Style="width: 60px; height: 60px; border-radius: 0;"
                                                   OnClick="@(() => IncreaseQty(SelectedItem))">
                                            <MudIcon Icon="@Icons.Material.Filled.Add" />
                                        </MudButton>
                                    </div>
                                }
                            </div>

                            <!-- Price -->
                            <div class="col-md-3 text-end">
                                <MudText Typo="Typo.h5" Class="fw-bold mb-3" style="letter-spacing: 3px; font-size: 12px;">Rate / Item</MudText>
                                <MudNumericField T="double"
                                                 @bind-Value="SelectedItem.RetailPrice"
                                                 Variant="Variant.Outlined"
                                                 HideSpinButtons="true"
                                                 Class="fw-bold text-danger text-end"
                                                 Style="font-size: 48px; width: 100%;"
                                                 ToStringFormat="N2" />
                            </div>
                        </div>

                        <!-- Serving Size Selector -->
                        <div class="p-3 rounded shadow-sm mb-3">

                            @if (SelectedItem?.ServingSizes?.Any() == true)
                            {
                                <MudText Typo="Typo.subtitle1" Class="fw-semibold mb-2">Choose Varity:</MudText>
                                <div class="d-flex flex-wrap gap-3">
                                    @foreach (var size in SelectedItem.ServingSizes)
                                    {
                                        <MudCard Style="width: 160px; cursor: pointer;"
                                                 Elevation="@(SelectedItem.ServingSize == size.Size ? 6 : 1)"
                                                 Class="text-center"
                                                 @onclick="@(() => OnServingSizeChanged(size.Size, SelectedItem))">

                                            <MudCardMedia Image="@size.Pic" Height="100" />

                                            <MudCardContent>
                                                <MudText Typo="Typo.subtitle2" Class="fw-semibold">@size.Size</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@($"{size.Price:N2}")</MudText>
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </div>
                            }
                            else
                            {
                                <MudText Color="Color.Warning" Typo="Typo.caption">
                                    No varity available for this item.
                                </MudText>
                            }
                        </div>

                        <!-- Add to Cart -->
                        <MudDivider Class="my-3" />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.ShoppingCart"
                                   Class="w-100 fw-bold py-3"
                                   OnClick="@(() => AddToCart(SelectedItem!))">
                            Add to Cart
                        </MudButton>

                    </MudPaper>
                </MudItem>
            </MudGrid>

        </DialogContent>

        <DialogActions>
           @*  <MudButton OnClick="OnCancel" Color="Color.Primary" Variant="Variant.Filled">Cancel</MudButton> *@
        </DialogActions>
    </MudDialog>

    @* Tax & Service Charges ---------------------------------------------------------------------------------------------------------------------------------------- *@
    
       <MudDialog @bind-Visible="_DialogTax" Options="_dialogPayment">
        <TitleContent>
            <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudItem xs="10">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" />
                        Charges
                    </MudText>
                </MudItem>
            </MudGrid>
        </TitleContent>

        <DialogContent>

            <MudTable Items="@record.BillCharges" Dense="true">
                <HeaderContent>
                    <MudTh>Description</MudTh>
                    <MudTh>Calculation</MudTh>
                    <MudTh class="text-end">Amount</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        @if (context.AmountType == "PERCENTAGE")
                        {
                            <span>@context.RuleName @@ @($"{context.Rate:#,##0.00}%")</span>
                        }
                        else if (context.AmountType == "FLAT")
                        {
                            <span>@context.RuleName @($"{context.Rate:#,##0.00}/-")</span>
                        }
                    </MudTd>
                    <MudTd>
                        @if (context.AmountType == "PERCENTAGE")
                        {
                            <span>@($"{record.Bill.SubTotalAmount:#,##0.00} x {context.Rate:#,##0.00}% = {context.CalculatedAmount:#,##0.00}")</span>
                        }
                        else if (context.AmountType == "FLAT")
                        {
                            <span>@($"Flat Amount = {context.CalculatedAmount:#,##0.00}")</span>
                        }
                    </MudTd>
                    <MudTd class="text-end">@context.CalculatedAmount.ToString("#,##0.00")</MudTd>
                </RowTemplate>

                <FooterContent>
                    <MudTd colspan="2" class="text-end font-weight-bold">Total</MudTd>
                    <MudTd class="text-end font-weight-bold">
                        @record.BillCharges.Sum(x => x.CalculatedAmount).ToString("#,##0.00")
                    </MudTd>
                </FooterContent>
            </MudTable>


        </DialogContent>

        <DialogActions>
            <!-- Optional Save / Apply buttons -->
        </DialogActions>
    </MudDialog>


    @* Payment ---------------------------------------------------------------------------------------------------------------------------------------- *@

    <MudDialog @bind-Visible="_DialogPayment" Options="_dialogPayment">
    <TitleContent>
        <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudItem xs="10">
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" />
                    Payments
                </MudText>
            </MudItem>
        </MudGrid>
    </TitleContent>

    <DialogContent>
        <MudPaper Class="pa-4" Style="max-width: 700px; width: 100%; border: 1px solid #ccc; border-radius: 8px; min-height: 50vh;">
            <MudGrid GutterSize="GutterSize.Small" Class="mb-4">
                <MudItem xs="12" sm="4">
                    <MudSelect T="string"
                                Dense="true"
                                @bind-Value="BillPayments.PaymentMethod"
                                @bind-Value:after="OnPaymentMethodChange"
                                Variant="Variant.Outlined"
                                Label="Payment Method"
                                Class="w-100 text-center">
                        @foreach (var pm in PaymentMethod)
                        {
                            <MudSelectItem Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudTextField T="string"
                                    Dense="true"
                                    @bind-Value="BillPayments.PaymentRef"
                                    Variant="Variant.Outlined"
                                    Label="Payment Reference"
                                    Class="w-100 text-center" />
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudTextField T="decimal"
                                    Dense="true"
                                    @bind-Value="BillPayments.AmountPaid"
                                    Variant="Variant.Outlined"
                                    Label="Net Amount"
                                    Class="w-100 text-end" />
                </MudItem>

                <MudItem xs="3" class="d-flex justify-end mt-2">
                    <MudButton Variant="Variant.Filled"
                                Color="Color.Info"
                                OnClick="AddPayment">
                        Add Payment
                    </MudButton>
                </MudItem>

                <MudItem xs="2" class="d-flex justify-end mt-2">
                    <MudButton Variant="Variant.Filled"
                                Color="Color.Info"
                                OnClick="ClosePaymentDialog">
                        Close
                    </MudButton>
                </MudItem>

            </MudGrid>

            <MudTable Items="@record.BillPayments"
                        Dense="true"
                        Hover="true"
                        Bordered="true"
                        Striped="true"
                        SortLabel="Sort By"
                        RowsPerPage="10"
                        Breakpoint="Breakpoint.Sm"
                        Elevation="0"
                        MultiSelection="false">

                <HeaderContent>
                    <MudTh style="width:160px;">Actions</MudTh>
                    <MudTh>Payment Method</MudTh>
                    <MudTh>Payment Reference</MudTh>
                    <MudTh class="text-end">Amount</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.TwoTone.DeleteSweep"
                                        Size="Size.Small"
                                        Variant="Variant.Filled"
                                        Color="Color.Error"
                                        OnClick="() => DeletePayment(context)" />
                    </MudTd>
                    <MudTd>@context.PaymentMethod</MudTd>
                    <MudTd>@context.PaymentRef</MudTd>
                    <MudTd class="text-end">@context.AmountPaid.ToString("N2")</MudTd>
                </RowTemplate>

                    <FooterContent>
                        <MudTd colspan="2" class="text-end font-weight-bold">Total</MudTd>
                        <MudTd class="text-end font-weight-bold">
                            @record.Bill.TotalPaidAmount.ToString("#,##0.00")
                        </MudTd>
                    </FooterContent>
            </MudTable>
        </MudPaper>
    </DialogContent>

    <DialogActions>
        <!-- Add Save or Close buttons if required -->
    </DialogActions>
    </MudDialog>


</MudLayout>

@code {
    // =======================
    // 1. Parameters
    // =======================
    [Parameter] public int? Id { get; set; } = 0;
    [Parameter] public string? Act { get; set; } = "INSERT";
    [CascadingParameter] private bool isReadOnly { get; set; }
    public bool Disabled { get; set; } = true;
    private DateRange _dateRange { get; set; } = new DateRange(DateTime.Now.Date, DateTime.Now.AddDays(5).Date);

    // =======================
    // 2. Main Models
    // =======================
    private BillsModel record = new();
    private BillDetailModel BillItems = new();
    private BillPaymentModel BillPayments = new();

    // =======================
    // 3. Selected Item & State Flags
    // =======================
    public bool QtyEnableDisable { get; set; } = true;
    public bool PriceEnableDisable { get; set; } = true;
    public bool IsInventoryItem { get; set; } = true;
    public bool ServiceSizeEnableDisable { get; set; } = true;
    private string searchText = string.Empty;
    private bool LoadingPanel { get; set; } = false;

    // =======================
    // 4. Dialog Components (Drawers)
    // =======================
    private MyDrawer _drawer = new();
    private MyDrawer _drawerParty = new();
    private bool _DialogServiceCharges;
    private bool _DialogTax;
    private bool _DialogItemsDetails;
    private bool _DialogPayment;

    private DialogOptions _dialogOptions = new()
    {
        CloseOnEscapeKey = true,
        FullWidth = true,
        MaxWidth = MaxWidth.Medium,
        CloseButton = true,
        BackdropClick = true
    };

    private DialogOptions _dialogSCTax = new()
    {
        CloseOnEscapeKey = true,
        FullWidth = false,
        MaxWidth = MaxWidth.False,
        CloseButton = true,
        BackdropClick = true
    };

    private DialogOptions _dialogPayment = new()
    {
        CloseOnEscapeKey = true,
        FullWidth = false,
        MaxWidth = MaxWidth.False,
        CloseButton = true,
        BackdropClick = true
    };


    // =======================
    // 5. Supporting Lists
    // =======================
    private List<PartiesModel> Parties = new();
    private List<RestaurantTablesModel>? Tables { get; set; } = null!;
    public List<EmployeesModel> SalesId { get; set; } = new();
    private List<CategoriesModel> _categories = new();
    private PartiesModel SelectedParty = new();

    // =======================
    // 6. TypeCode Data
    // =======================
    private List<TypeCodeModel> PaymentMethod = new();
    private List<TypeCodeModel> StockCondition = new();
    private List<TypeCodeModel> ServiceTypes = new();
    private List<TypeCodeModel> BillStatus = new();
    private List<TypeCodeModel> BillType = new();
    public string? SelectedStockCondition { get; set; } = "NEW";

    // =======================
    // 7. Items Data
    // =======================
    private List<ItemsModel> ItemsData { get; set; } = new();
    private List<ItemsModel> FilteredItems { get; set; } = new();
    private List<ItemsModel> FavItemsData = new();
    private List<ItemsModel> RecentItemsData = new();
    public int MaxItems { get; set; } = 12;

    public List<ItemsModel> SelectedItems { get; set; } = new();
    public ItemsModel SelectedItem { get; set; } = new();
    public ItemsModel ClickedItem { get; set; } = new();
    public ItemsModel SelectedFavItem { get; set; } = new();
    public ItemsModel SelectedRecentItem { get; set; } = new();

    // =======================
    // 8. Serving Sizes
    // =======================
    public string? ServingSizes { get; set; } = string.Empty;
    public string? SelectedServingSize { get; set; } = string.Empty;
    private List<ServingSizeModel>? ServingSizeOptions { get; set; } = null!;

    // =======================
    // 10. Tax & Service Charges
    // =======================
    List<BillChargeModel> billCharge = new();
    private double TotalQty => record.BillDetails.Sum(i => i.Qty);
    private double TotalDiscountAmount => record.BillDetails.Sum(i => i.DiscountAmount);
    private double TotalTaxAmount => record.BillDetails.Sum(i => i.TaxAmount);

    // private decimal TotalBilledDetailAmount => Totals().BillItemsTotal;
    // private decimal TotalServiceCharges => Totals().BillServiceChargesTotal;
    // private decimal TotalTax => Totals().BillTaxTotal;
    // private decimal TotalPayment => Totals().BillPaymentsTotal;
    // private decimal TotalBilledAmount => TotalBilledDetailAmount + TotalServiceCharges + TotalTax - Convert.ToDecimal(record.Bill.DiscountAmount);
    // private decimal TotalNetAmount => TotalBilledAmount - TotalPayment;

    // private decimal TotalBilledDetailAmount => Totals().BillItemsTotal;
    // private decimal TotalServiceCharges => Totals().BillServiceChargesTotal;
    // private decimal TotalTax => Totals().BillTaxTotal;
    // private decimal TotalPayment => Totals().BillPaymentsTotal;
    // private decimal TotalBilledAmount => TotalBilledDetailAmount + TotalServiceCharges + TotalTax - Convert.ToDecimal(record.Bill.DiscountAmount);
    // private decimal TotalNetAmount => TotalBilledAmount - TotalPayment;

    // -------------------------- Lifecycle --------------------------
    protected override async Task OnInitializedAsync()
    {
        await GetAll();
    }

    protected async override void OnParametersSet()
    {
        if (Act == "INSERT")
        {
            Clear();
        }
        else
        {
            await Get(Id);
        }
    }

    private string GetFooterStyle(bool isHeader = false)
    {
        var background = Globals._isDarkMode ? "white" : "#1e1e1e";
        var color = Globals._isDarkMode ? "black" : "white";
        return $"background-color:{background}; color:{color}; text-align:right;";
    }


    // -------------------------- Data Loaders --------------------------
    protected async Task GetAll()
    {
        LoadingPanel = true;

        await LoadCategories();
        ItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/Search", true) ?? new List<ItemsModel>();
        FavItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/Search/1=1/TOP {MaxItems}", true) ?? new List<ItemsModel>();
        RecentItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/SearchRecent/TOP {MaxItems}", true) ?? new List<ItemsModel>();
        Parties = await Functions.GetAsync<List<PartiesModel>>($"Parties/Search?PARTYTYPE=CUSTOMER", true) ?? new List<PartiesModel>();
        PaymentMethod = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/PAYMENT METHOD", true) ?? new List<TypeCodeModel>();
        StockCondition = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/STOCK CONDITION", true) ?? new List<TypeCodeModel>();
        ServiceTypes = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/SERVICE TYPE", true) ?? new List<TypeCodeModel>();
        BillStatus = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/BILL STATUS", true) ?? new List<TypeCodeModel>();
        Tables = await Functions.GetAsync<List<RestaurantTablesModel>>($"RestaurantTables/Search", true) ?? new List<RestaurantTablesModel>();
        SalesId = await Functions.GetAsync<List<EmployeesModel>>($"Employees/Search", true) ?? new List<EmployeesModel>();
        BillType = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/BILL TYPE", true) ?? new List<TypeCodeModel>();

        // if (Act == "INSERT")
        // {
        //     Clear();
        // }
        // else
        // {
        //     await Get(Id);
        // }

        LoadingPanel = false;
    }

    private async Task Get(int? id)
    {
        if (id != 0)
        {
            LoadingPanel = true;
            record = await Functions.GetAsync<BillsModel>($"Bill/Get?Id={id}", true) ?? new BillsModel();
            if (record.Bill == null)
            {
                var rec = new BillsModel();
                record.Bill = rec.Bill;
                record.Bill.TranDate = DateTime.Now.AddHours(Convert.ToDouble(Globals.Organization.GMT));
                record.BillCharges = rec.BillCharges;
                record.BillPayments = rec.BillPayments;

                foreach (var i in rec.BillDetails)
                {
                    var row = new BillItemReportModel
                    {
                        ItemId = i.ItemId,
                        ItemName = i.ItemName!,
                        UnitPrice = i.UnitPrice,
                        ServingSize = i.ServingSize,
                        Qty = i.Qty,
                        DiscountAmount = i.DiscountAmount * i.Qty,
                        TaxAmount = i.TaxAmount * i.Qty
                    };

                    record.BillDetails.Add(row);

                }

                await CalculateTotalNetAmountAsync();
            }

            LoadingPanel = false;
            StateHasChanged();
        }
    }

    private async Task LoadCategories()
    {
        _categories = await Functions.GetAsync<List<CategoriesModel>>("Categories/SearchCategoriesHavingSomeItems", true) ?? new();
        if (_categories.Any())
        {
            await LoadItemsByCategory(_categories[0]);
        }
    }

    private async Task LoadItemsByCategory(CategoriesModel category)
    {
        SelectedItems = await Functions.GetAsync<List<ItemsModel>>($"Items/Search/CategoriesId={category.Id}", true) ?? new();
    }


    // -------------------------- UI Helpers --------------------------
    private async void Clear()
    {
        record = new BillsModel();

        if (string.IsNullOrEmpty(record.Bill.Status) && BillStatus?.Any() == true)
            record.Bill.Status = BillStatus.First().ListValue;

        if (Parties != null && Parties.Any() && record.Bill.PartyId == default)
            record.Bill.PartyId = Parties.First().Id;

        if (Tables != null && Tables.Any() && record.Bill.TableId == default)
            record.Bill.TableId = Tables.First().Id;

        if (SalesId != null && SalesId.Any() && record.Bill.SalesId == default)
            record.Bill.SalesId = SalesId.First().Id;

        record.Bill.BillType = "SALE";
        record.Bill.PartyId=1;
        Disabled = Act == "VIEW";
        record.Bill.TranDate = DateTime.Now.AddHours(Convert.ToDouble(Globals.Organization.GMT));
        // TotalServiceCharges = 0;
        // TotalTax = 0;
        await CalculateTotalNetAmountAsync();

    } 

    private void Print()
    {
        var url = $"/BillReport/1/{Id}";                
        JS.InvokeVoidAsync("open", url, "_blank");
    }

    // -------------------------- Item Dialog --------------------------
    private async Task AddItemDialogShow(string input, string dataType = "i")
    {
        FilterItems();

        string routeSuffix;

        // Normalize dataType
        dataType = dataType.Trim().ToLower();

        if (dataType == "i" && int.TryParse(input, out int id))
        {
            routeSuffix = $"/Items.Id={id}";
        }
        else if (dataType == "s")
        {
            // Escape single quote if needed (for safety)
            string safeInput = input.Replace("'", "''");
            routeSuffix = $"/Items.Code='{safeInput}'";
        }
        else
        {
            SelectedItem = null!;
            return;
        }

        var itm = await Functions.GetAsync<List<ItemsModel>>($"Items/Search{routeSuffix}", true) ?? new List<ItemsModel>();

        if (itm.Count == 0)
        {
            SelectedItem = null!;
            return;
        }

        SelectedItem = itm.FirstOrDefault()!;
        SelectedItem.Qty = 1;
        SelectedStockCondition = "NEW";
        searchText = string.Empty;

        SelectedItem.ServingSizes = new List<ServingSizeModel>();

        if (!string.IsNullOrWhiteSpace(SelectedItem.ServingSize))
        {
            try
            {
                var sizes = JsonSerializer.Deserialize<List<ServingSizeModel>>(SelectedItem.ServingSize);
                if (sizes?.Any() == true)
                {
                    SelectedItem.ServingSizes = sizes;
                    SelectedItem.ServingSize = sizes.FirstOrDefault()?.Size ?? "Medium";
                }
                else
                {
                    SelectedItem.ServingSize = "Medium";
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ServingSize deserialization failed: {ex.Message}");
                SelectedItem.ServingSize = "Medium";
            }
        }
        else
        {
            SelectedItem.ServingSize = "Medium";
        }

        _DialogItemsDetails = true;
    }

    private void FilterItems()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            FilteredItems = ItemsData;
        }
        else
        {
            FilteredItems = ItemsData
                .Where(item =>
                    (item.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (item.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (item.CategoryName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }

        SelectedItem = FilteredItems.FirstOrDefault()!;

    }

    private async void OnDiscountChanged()
    {
        await CalculateTotalNetAmountAsync();
    }

    // -------------------------- Tax & Charges --------------------------
    private void OpenTaxDialog()
    {        
        _DialogTax = true;
    }

    private async Task<(decimal ServiceCharges, decimal Tax)> CalculateCharges(decimal BilledAmountForCalaulation)
    {
        var formattedStartDate = _dateRange.Start?.ToString("yyyy-MM-dd") ?? string.Empty;
        var formattedEndDate = _dateRange.End?.ToString("yyyy-MM-dd") ?? string.Empty;
        string criteria = $"{formattedStartDate}/{formattedEndDate}/{BilledAmountForCalaulation}";

        var billCharges = await Functions.GetAsync<List<BillChargeModel>>($"Bill/CalculateBillCharges/{criteria}", true);

        record.BillCharges = new ObservableCollection<BillChargeModel>(billCharges ?? new List<BillChargeModel>());

        decimal serviceCharges = record.BillCharges
            .Where(c => c.ChargeCategory == "SERVICE" && c.RuleType == "CHARGE")
            .Sum(c => c.CalculatedAmount);

        decimal tax = record.BillCharges
            .Where(c => c.ChargeCategory == "TAX" && c.RuleType == "CHARGE")
            .Sum(c => c.CalculatedAmount);

        return (serviceCharges, tax);
    }

    private async Task GetCharges()
    {
        double TotalBillAmount = 0;
        foreach (var i in record.BillDetails)
        {
            TotalBillAmount += (i.Qty * i.UnitPrice) + i.TaxAmount - i.DiscountAmount;
        }

        var Charges = await CalculateCharges(Convert.ToDecimal(TotalBillAmount));
        record.Bill.TotalServiceChargeAmount = Charges.ServiceCharges;
        record.Bill.TotalTaxAmount = Charges.Tax;
        Totals();
    }

    private async Task CalculateTotalNetAmountAsync()
    {
        Totals();
        StateHasChanged();
    }

    private async void DeleteItem(BillItemReportModel item)
    {
        record.BillDetails.Remove(item);
        await GetCharges();
        await CalculateTotalNetAmountAsync();
    }


    // private (decimal BillItemsTotal, decimal BillServiceChargesTotal, decimal BillTaxTotal, decimal BillPaymentsTotal) Totals()
    // {
    //     //Bill Detail Total
    //     double TotalBillAmount = 0;
    //     foreach (var i in record.BillDetails)
    //     {
    //         TotalBillAmount += (i.Qty * i.UnitPrice) + i.TaxAmount - i.DiscountAmount;
    //     }

    //     //Payments Total
    //     decimal TotalPaymentsAmount = 0;
    //     foreach (var i in record.BillPayments)
    //     {
    //         TotalPaymentsAmount += i.AmountPaid;
    //     }

    //     //Service Charges
    //     decimal TotalServiceChargesAmount = 0;

    //     foreach (var i in record.BillCharges.Where(x => x.ChargeCategory != "TAX"))
    //     {
    //         TotalServiceChargesAmount += i.CalculatedAmount;
    //     }

    //     //Tax
    //     decimal TotalTaxAmount = 0;

    //     foreach (var i in record.BillCharges.Where(x => x.ChargeCategory == "TAX"))
    //     {
    //         TotalTaxAmount += i.CalculatedAmount;
    //     }


    //     return (Convert.ToDecimal(TotalBillAmount), Convert.ToDecimal(TotalServiceChargesAmount), Convert.ToDecimal(TotalTaxAmount), Convert.ToDecimal(TotalPaymentsAmount));
    // }

    private void Totals()
    {
        Globals.BillGridTotals(record);    
    }

    private void DeleteCharge(BillChargeModel charge)
    {
        if (record.BillCharges?.Contains(charge) == true)
        {
            record.BillCharges.Remove(charge);
        }
    }

    private async Task OnRowQtyChanged(BillItemReportModel row, double newQty)
    {
        row.Qty = newQty;

        var item = ItemsData.FirstOrDefault(i => i.Id == row.ItemId);
        if (item != null)
        {
            row.DiscountAmount = item.Discount * row.Qty;
            row.TaxAmount = item.Tax * row.Qty;
        }

        await GetCharges();
        await CalculateTotalNetAmountAsync();
        StateHasChanged();
    }

    // -------------------------- Payments --------------------------
    private void OpenPaymentDialog()
    {
        
        _DialogPayment = true;
    }

    private async void OnPaymentMethodChange()
    {
        BillPayments.AmountPaid = record.Bill.BalanceAmount;
    }

    private async void AddPayment()
    {
        BillPayments = new BillPaymentModel();
        await CalculateTotalNetAmountAsync();
    }

    private async void DeletePayment(BillPaymentModel payment)
    {
        record.BillPayments.Remove(payment);
        //BillPayments.AmountPaid = record.Bill.BalanceAmount;
        await CalculateTotalNetAmountAsync();
    }

    private void ClosePaymentDialog()
    {
        _DialogPayment = false;
    }

    // -------------------------- Varity Dialog --------------------------
    private void IncreaseQty(ItemsModel item)
    {
        item.Qty++;
        UpdateItemPrice(item);
    }

    private void DecreaseQty(ItemsModel item)
    {
        if (item.Qty > 1)
        {
            item.Qty--;
            UpdateItemPrice(item);
        }
    }

    private void OnServingSizeChanged(string selectedSize, ItemsModel item)
    {
        item.ServingSize = selectedSize;
        UpdateItemPrice(item);
    }

    private void UpdateItemPrice(ItemsModel item)
    {
        var selectedSize = item.ServingSizes?.FirstOrDefault(s => s.Size == item.ServingSize);
        if (selectedSize != null)
        {
            //item.RetailPrice = Convert.ToDouble(selectedSize.Price) * item.Qty;
            item.RetailPrice = Convert.ToDouble(selectedSize.Price);

        }
    }

    private void OnQtyChanged(double val)
    {
        SelectedItem.Qty = val;
        UpdateItemPrice(SelectedItem);
    }

    private async void OnItemChanged(BillDetailModel row, int selectedItemId)
    {
        var item = ItemsData.FirstOrDefault(x => x.Id == selectedItemId);
        if (item == null) return;

        row.ItemId = item.Id;
        row.Item = item.Name!;
        row.UnitPrice = item.RetailPrice;
        row.ServingSize = item.ServingSize;
        row.TaxAmount = 0;
        await GetCharges();
        await CalculateTotalNetAmountAsync();
    }

    private async void AddToCart(ItemsModel selectedItem)
    {
        if (selectedItem == null) return;
        if (selectedItem.RetailPrice    == 0) return;   

        var row = new BillItemReportModel
        {
            ItemId = selectedItem.Id,
            ItemName = selectedItem.Name!,
            UnitPrice = selectedItem.RetailPrice,
            ServingSize = selectedItem.ServingSize,
            Qty = selectedItem.Qty,
            DiscountAmount = selectedItem.Discount * selectedItem.Qty,
            TaxAmount = selectedItem.Tax * selectedItem.Qty
        };

        record.BillDetails.Add(row);
        _DialogItemsDetails = false;
        await GetCharges();
        await CalculateTotalNetAmountAsync();
    }

    // -------------------------- Items Grid --------------------------
    private async Task AddBlankRow()
    {
        var firstItem = ItemsData.FirstOrDefault();
        if (firstItem == null) return;

        record.BillDetails.Add(new BillItemReportModel
        {
            ItemId = firstItem.Id,
            ItemName = firstItem.Name!,
            ServingSize = firstItem.ServingSize,
            Qty = 1,
            UnitPrice = firstItem.RetailPrice,
            DiscountAmount = 0,
            TaxAmount = 0
        });

        await Task.Delay(10);
        StateHasChanged();
    }


    private async void AddItem()
    {

        // if (BillItems.ServingSize is null)
        // {
        //     var res = await Functions.ShowConfirmation(dialogService, "You havenot selected SERVINGSIZE, do you want to continue?");
        //     if (res == false)
        //         return;
        // }

        BillItemReportModel BillItem = new();
        BillItem.ItemId = SelectedItem.Id;
        BillItem.ItemName= BillItems.Item;
        BillItem.ServingSize = BillItems.ServingSize;
        BillItem.StockCondition = BillItems.StockCondition;
        BillItem.Qty= BillItems.Qty;
        BillItem.UnitPrice= BillItems.UnitPrice;
        BillItem.DiscountAmount=BillItems.DiscountAmount;
        BillItem.TaxAmount = BillItems.TaxAmount;
        BillItem.Status = "COMPLETE";
        record.BillDetails.Add(BillItem);

        await GetCharges();
        await CalculateTotalNetAmountAsync();
        SelectedItem = null!;
        //_myDialogItemSelection!.Hide();
        StateHasChanged();

    }

    private void OnRowClick(TableRowClickEventArgs<ItemsModel> args)
    {
        var selectedItem = args.Item;
        Console.WriteLine($"Row clicked: {args.Item?.Name}");
        Select(selectedItem!);
    }


    private void Select(ItemsModel item)
    {
        if (item == null) return;

        SelectedServingSize = string.Empty;
        SelectedItem = item;
        //ItemsModel item = ItemsData.FirstOrDefault(x => x.Id == id)!;

        BillDetailModel New_Item = new()
        {
            Qty = 1,
            UnitPrice = item.RetailPrice,
            DiscountAmount = item.Discount,
            Item = item.Name!,
            Pic = item.Pic
        };

        BillItems = New_Item;

        PriceEnableDisable = item.IsInventoryItem == 1; 
        QtyEnableDisable = item.IsInventoryItem != 1;
        IsInventoryItem = item.IsInventoryItem == 0 ? false : true;

        ServingSizeOptions = null!;
        ServiceSizeEnableDisable = false;
        SelectedServingSize = string.Empty;

        if (!string.IsNullOrWhiteSpace(item.ServingSize))
        {
            try
            {
                ServingSizeOptions = JsonSerializer.Deserialize<List<ServingSizeModel>>(item.ServingSize);
                if (ServingSizeOptions != null && ServingSizeOptions.Count > 0)
                {
                    ServiceSizeEnableDisable = true;
                }
            }
            catch
            {
                ServiceSizeEnableDisable = false;
            }
        }

        StateHasChanged();
    }


    private void OnServingSizeChanged(ChangeEventArgs e)
    {
        var selectedSize = e.Value?.ToString();
        SelectedServingSize = selectedSize!;

        var selectedOption = ServingSizeOptions?.FirstOrDefault(s => s.Size == selectedSize);
        if (selectedOption != null)
        {
            BillItems.UnitPrice = selectedOption.Price;
            BillItems.Pic = selectedOption.Pic;
            BillItems.ServingSize = selectedOption.Size;
            BillItems.StockCondition = SelectedStockCondition;
        }

        StateHasChanged();
    }

    // -------------------------- Party --------------------------

    private async Task OnPartyChanged(int newValue)
    {
        record.Bill.PartyId = newValue;

        var party = Parties.FirstOrDefault(p => p.Id == newValue);
        if (party != null)
        {
            record.Bill.PartyName = party.Name;
            record.Bill.PartyPhone = party.Phone;
            record.Bill.PartyEmail = party.Email;
            record.Bill.PartyAddress = party.Address;
        }
    }

    // -------------------------- Dialogs --------------------------

    protected async Task AddParty()
    {
        await _drawerParty.OpenDrawerAsync();
    }

    private async Task Options()
    {
        await _drawer.OpenDrawerAsync();
    }


    // -------------------------- CRUD --------------------------

    private async void Save()
    {



        if (record.Bill.PartyId == 0 || record.Bill.SalesId == 0 || record.Bill.TableId == 0)
        {
            //SnackbarService.Add($"Cannot Save Record. Please check Selected Customer, Sales Id or Table", Severity.Error);
            return;
        }

        LoadingPanel = true;

        BillsModel BillHeader = new();
        var Action = "INSERT";

        if (Id != 0)
            Action = "UPDATE";

        //Bill Header
        record.Bill.Id = record.Bill.Id;
        record.Bill.OrganizationId = Globals.User.OrganizationId;
        record.Bill.Source = "MANUAL";
        record.Bill.LocationId = Globals.User.LocationId;
        record.Bill.CreatedBy = Globals.User.Id;
        record.Bill.CreatedOn = DateTime.Now;
        record.Bill.CreatedFrom = Functions.GetComputerDetails();
        record.Bill.UpdatedBy = Globals.User.Id;
        record.Bill.UpdatedOn = DateTime.Now;
        record.Bill.UpdatedFrom = Functions.GetComputerDetails();
        LoadingPanel = false;

        var result = await Functions.PostAsync<BillModel>($"Bill/{Action}", record, true);
        if (result.Success == false)
        {
            Snackbar.Add($"Record Save Fail.", Severity.Error);
        }
        else
        {
            Snackbar.Add($"Record Saved Successfully", Severity.Success);
            record.Bill.SeqNo = result.Result!.SeqNo;
            Id = result.Result.Id;
            Print();
        }

    }
}



<!-- Custom styling -->
<style>
    .app-bar {
        height: 56px;
    }

    .billing-table .mud-table-cell {
        font-size: 0.85rem;
        padding-top: 0.3rem;
        padding-bottom: 0.3rem;
    }
    .font-xs {
        font-size: 0.85rem;
    }

    .no-bottom-border input {
        border-bottom: none !important;
        box-shadow: none !important;
    }

    .no-bottom-border input:focus {
        outline: none;
    }

    .summary-grid .mud-input-input {
        text-align: right;
    }

    .item-card:hover {
        box-shadow: 0 0 10px rgba(0,0,0,.25);
        transform: translateY(-2px);
        transition: box-shadow .2s, transform .2s;
    }

    .truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .no-border input {
        border: none !important;
        background-color: transparent;
    }

    .summary-label {
        white-space: nowrap;
        display: flex;
        align-items: center;
        font-weight: 600;
    }

    .summary-icon {
        height: 24px;
        width: 24px;
        padding: 2px;
        margin-right: 6px;
    }

    .summary-row {
        padding: 0px 8px;
       /*  border: 0.5px solid lightgray; */
    }

    .summary-col {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        white-space: nowrap;
        padding: 4px 8px;
        /* border: 0.5px solid lightgray; */
    }

    .summary-value {
        text-align: right;
        width: 100%;
    }

    .mud-dialog.custom-dialog {
        width: 400px;
        height: 300px;
    }

    .summary-value .mud-input-control {
        text-align: right;
    }

    .billing-table tfoot {
        position: sticky;
        bottom: 0;
        background-color: lightgray; 
        z-index: 10;              
        border-top: 1px solid #ccc; 
    }

</style>