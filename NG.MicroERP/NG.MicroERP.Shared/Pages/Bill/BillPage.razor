@page "/BillPage/{Id:int?}"
@layout BlankLayout
@inject IDialogService dialogService
@inject ISnackbar SnackbarService
@inject IJSRuntime JS

@using MudBlazor
@using System.Text.Json


<Loading IsLoading="@LoadingPanel" />


<title>@DateTime.Now.ToString("dd-MMM-yyy HH:mm:ss tt")</title>
<MudPaper Class="p-3" Elevation="3" style="height: 100vh; overflow-y: hidden; overflow-x: auto;">
    <EditForm Model="record" >
        
        <!-- Top Row: Toolbar, Dropdowns, Search -->
        <MudGrid Class="mb-3">
            <MudItem xs="12">
                <div class="d-flex flex-wrap align-items-end gap-2 p-2"style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background-color: #0A4D61; color: white;">

                    <MudTooltip Text="Add Item"><MudIconButton Icon="@Icons.Material.Filled.AddBox" Color="Color.Secondary" OnClick="@(async () => await AddItemDialogShow(0))" /></MudTooltip>

                    <!-- Toolbar Buttons (KEEP AS-IS) -->
                        <div class="d-flex align-items-center flex-wrap me-3 gap-1">
                              <!-- Bill Type Dropdown -->
                        <div class="form-wrapper input-icon-container">
                            <select class="form-select form-select-sm" @bind="record.Bill.BillType">
                                <option value="SALE" selected>SALE</option>
                                <option value="SALE RETURN">SALE RETURN</option>
                                <option value="QUOTATION">QUOTATION</option>
                            </select>
                        </div>

                        <MudTooltip Text="Options"><MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Info" OnClick="@(()=>Options())"/></MudTooltip>
                        <MudTooltip Text="New"><MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="@(() => Clear())" /></MudTooltip>
                        <MudTooltip Text="Save"><MudIconButton Icon="@Icons.Material.Filled.Save" Color="Color.Success" OnClick="@(() => Save())" /></MudTooltip>

                        @if (Id!=0)
                        {
                            <MudTooltip Text="Delete"><MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" /></MudTooltip>
                            <MudTooltip Text="Print"><MudIconButton Icon="@Icons.Material.Filled.Print" Color="Color.Info" OnClick="Print" /></MudTooltip>
                        }
                       
                        <div class="form-wrapper input-icon-container">
                            <input class="form-control form-control-sm" type="text" @bind="record.Bill.SeqNo" placeholder="Bill #." />
                        </div>
                        <MudTooltip Text="Customer"><MudIconButton Icon="@Icons.Material.Filled.Person" Color="Color.Info" OnClick="AddParty" /></MudTooltip>
                    </div>

                </div>
            </MudItem>
        </MudGrid>


        <!-- Table and Summary Section -->
        <MudGrid Style="margin-top:40px;">
            <!-- Items Table -->
            <MudItem xs="12" md="6">
                <!-- Item Table -->
                <div style="overflow-y: auto; height: calc(100vh - 100px);">
                    <div style="height: calc(100vh - 200px); display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 4px;">
                        <table class="table table-hover table-striped table-sm w-100" style="border-collapse: separate;">
                            <thead style="display: table-header-group; background-color: #f8f9fa;">
                                <tr>
                                    <th style="width: 100px;">Actions</th>
                                    <th style="width: 300px;">Item</th>
                                    <th style="text-align: right; width: 100px;">Qty</th>
                                    <th style="text-align: right; width: 100px;">Price</th>
                                    <th style="text-align: right; width: 100px;">Discount</th>
                                    <th style="text-align: right; width: 100px;">Amount</th>
                                </tr>
                            </thead>
                        </table>

                        <div style="flex-grow: 1; overflow-y: auto;">
                            <table class="table table-hover table-striped table-sm w-100" style="margin-bottom: 0; border-collapse: separate;">
                                <tbody>
                                    @foreach (var item in record.BillDetails)
                                    {
                                        <tr>
                                            <td style="width: 100px; text-align: center;">
                                                <MudTooltip Text="Delete">
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                               Color="Color.Error"
                                                               Size="Size.Small"
                                                               OnClick="@(() => DeleteItem(item))" />
                                                </MudTooltip>

                                                <MudTooltip Text="Copy">
                                                <MudIconButton Icon="@Icons.Material.Filled.FileCopy"
                                                               Color="Color.Success"
                                                               Size="Size.Small"/>
                                                </MudTooltip>

                                                <MudTooltip Text="Update Qty">
                                            
                                                               <MudIconButton Icon="@Icons.Material.Filled.Update"
                                                               Color="Color.Info"
                                                               Size="Size.Small" />
                                                </MudTooltip>
                                            </td>
                                            <td style="width: 300px;">@item.Item</td>
                                            <td style="text-align: right; width: 100px;">@item.Qty</td>
                                            <td style="text-align: right; width: 100px;">@item.UnitPrice.ToString("#,##0.00")</td>
                                            <td style="text-align: right; width: 100px;">@item.DiscountAmount.ToString("#,##0.00")</td>
                                            <td style="text-align: right; width: 100px;">@item.Item_Amount.ToString("#,##0.00")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <table class="table table-striped table-sm w-100" style="margin-bottom: 0; border-collapse: separate;">
                            <tfoot style="display: table-header-group; background-color: #f8f9fa;">
                                <tr>
                                    <td style="text-align: right; width: 40px;"><strong></strong></td>
                                    <td style="text-align: right; width: 300px;"><strong>Total</strong></td>
                                    <td style="text-align: right; width: 100px;"><strong>@TotalQty.ToString("#,##0.00")</strong></td>
                                    <td style="text-align: right; width: 100px;"><strong></strong></td>
                                    <td style="text-align: right; width: 100px;"><strong>@TotalDiscountAmount.ToString("#,##0.00")</strong></td>
                                    <td style="text-align: right; width: 100px;"><strong>@TotalBillAmount.ToString("#,##0.00")</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                <!-- Summary Section -->
                <div class="mt-3 p-2" style="border: 0; border-radius: 4px; display: flex; gap: 1rem; flex-wrap: nowrap;">
                    <div style="flex: 1 1 0; min-width: 150px; display: flex; flex-direction: column;">
                        <label for="taxInput" class="form-label">Tax</label>
                            <input id="taxInput" type="number" class="form-control form-control-sm"
                                   @bind="record.Bill.TaxAmount"
                                   @bind:event="oninput"
                                   @onchange="CalculateTotalNetAmount"
                                   style="text-align: right;" />


                    </div>
                    <div style="flex: 1 1 0; min-width: 150px; display: flex; flex-direction: column;">
                        <label for="discountInput" class="form-label">Discount</label>
                            <input id="discountInput" type="number" class="form-control form-control-sm"
                                   @bind="record.Bill.DiscountAmount"
                                   @bind:event="oninput"
                                   @onchange="CalculateTotalNetAmount"
                                   style="text-align: right;" />

                    </div>
                    <div style="flex: 1 1 0; min-width: 150px; display: flex; flex-direction: column;">
                        <label for="paymentMethodSelect" class="form-label">Payment Method</label>
                        @if (PaymentMethod!=null)
                        {
                            <select id="SelectedPaymentMethod" class="form-select form-select-sm" @bind="record.Bill.PaymentMethod">
                                    @foreach (var pm in PaymentMethod)
                                {
                                    <option value="@pm.ListValue">@pm.ListValue</option>
                                } 
                            </select>
                        }
                    </div>
                    <div style="flex: 1 1 0; min-width: 150px; display: flex; flex-direction: column;">
                        <label for="paymentRefInput" class="form-label">Payment Ref</label>
                        <input id="paymentRefInput" type="text" class="form-control form-control-sm" @bind="record.Bill.PaymentRef" />
                    </div>
                    <div style="flex: 1 1 0; min-width: 150px; display: flex; flex-direction: column;">
                        <label class="form-label">Net Amount</label>
                            <input type="text" class="form-control form-control-sm" value="@TotalNetAmount.ToString("#,##0.00")" style="text-align: right;" />
                    </div>
                </div>
                </div>
            </MudItem>

            <!-- Favorite Items -->
            <MudItem xs="12" md="6">

                <div style="background-color: #B1D7B2; padding: 12px 20px; border-radius: 2px; margin-bottom: 10px;">
                    <MudText Typo="Typo.h6" Class="text-white m-0">
                        <i class="fas fa-star me-2"></i> Favorite Used - Top @MaxItems.ToString("#,##0") Items
                    </MudText>
                </div>

                <MudGrid GutterSize="GutterSize.Small">
                    @foreach (var fav in FavItemsData)
                    {
                        <MudItem xs="6" sm="4" md="3" lg="2" xl="2">
                             <div @onclick="@(async () => await AddItemDialogShow(fav.Id))" style="cursor:pointer;">
                                <MudPaper Elevation="2"
                                          Class="hoverable-card"
                                          Style="cursor:pointer; text-align:center; padding: 8px; display: flex; flex-direction: column; align-items: center; min-height: 150px; transition: box-shadow 0.2s ease-in-out; background-color: #F0EEE9;">

                                    <!-- Image -->
                                    <img src="@fav.Pic"
                                         alt="@fav.Name"
                                         style="width: 100%; max-height: 60px; object-fit: contain; margin-bottom: 6px;" />

                                    <!-- Text -->
                                    <div style="margin-top: auto;">
                                        <MudText Typo="Typo.body2" Align="Align.Center" Class="text-truncate">@fav.Name</MudText>
                                        <MudText Typo="Typo.overline" Color="Color.Secondary" Align="Align.Center">
                                            @fav.RetailPrice.ToString("#,##0.00")
                                        </MudText>
                                    </div>
                                </MudPaper>
                            </div>
                        </MudItem>
                    }
                </MudGrid>

                <div style="background-color: #B1D7B2; padding: 12px 20px; border-radius: 2px; margin-top: 20px; margin-bottom: 10px;">
                    <MudText Typo="Typo.h6" Class="text-white m-0">
                        <i class="fas fa-history me-2"></i> Recently Used - Top @MaxItems.ToString("#,##0") Items
                    </MudText>
                </div>


                <MudGrid GutterSize="GutterSize.Small">
                    @foreach (var fav in RecentItemsData)
                    {
                        <MudItem xs="6" sm="4" md="3" lg="2" xl="2">
                            <div @onclick="@(async () => await AddItemDialogShow(fav.Id))" style="cursor:pointer;">
                                <MudPaper Elevation="2"
                                          Class="hoverable-card"
                                          Style="cursor:pointer; text-align:center; padding: 8px; display: flex; flex-direction: column; align-items: center; min-height: 150px; transition: box-shadow 0.2s ease-in-out; background-color: #F0EEE9;">

                                    <!-- Image -->
                                    <img src="@fav.Pic"
                                         alt="@fav.Name"
                                         style="width: 100%; max-height: 60px; object-fit: contain; margin-bottom: 6px;" />

                                    <!-- Text -->
                                    <div style="margin-top: auto;">
                                        <MudText Typo="Typo.body2" Align="Align.Center" Class="text-truncate">@fav.Name</MudText>
                                        <MudText Typo="Typo.overline" Color="Color.Secondary" Align="Align.Center">
                                            @fav.RetailPrice.ToString("#,##0.00")
                                        </MudText>
                                    </div>
                                </MudPaper>
                            </div>
                        </MudItem>
                    }
                </MudGrid>
            </MudItem>

            <style>
                .hoverable-card:hover {
                    box-shadow: 0px 0px 10px rgba(0,0,0,0.2) !important;
                }
            </style>

        </MudGrid>
    </EditForm>


@* ---------------------------------------------------------------- Select Item ---------------------------------------------------------------- *@

<MyModelDialog Width="60%" Height="80%" @ref="_myDialogItemSelection" Title="Add Item to Bill">
    <HeaderContent>
        <!-- Optional: Add title bar styling here -->
    </HeaderContent>

    <ChildContent>
        <div class="container-fluid">

            <!-- Item Entry Panel -->
            <div class="row mb-4 shadow-sm rounded bg-white p-3">

                <!-- Left Block: Image & Info -->
                <div class="col-md-3 d-flex flex-column align-items-center justify-content-center bg-light border-end rounded-start p-4">
                    <img src="@(string.IsNullOrEmpty(BillItems.Pic) ? "/images/noimage.jpg" : BillItems.Pic)"
                         alt="Item Image"
                         class="img-thumbnail mb-3"
                         style="width: 120px; height: 120px; object-fit: cover; border-radius: 10px;" />

                    <div class="text-center">
                        <div class="text-danger fw-bold fs-3">@BillItems.Item</div>
                        <div class="text-success fw-semibold fs-5 mt-2">@BillItems.Item_Amount.ToString("#,##0.00")</div>
                    </div>
                </div>

                <!-- Right Block: Entry Form -->
                <div class="col-md-9 bg-white rounded-end p-4">
                    <div class="row g-3">
                        @if (IsInventoryItem)
                        {
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Stock Condition</label>
                                <select class="form-select" @bind="SelectedStockCondition">
                                    <option disabled selected value="">Select...</option>
                                    @if (StockCondition != null)
                                    {
                                        @foreach (var a in StockCondition)
                                        {
                                            <option value="@a.ListValue">@a.ListValue</option>
                                        }
                                    }
                                </select>
                            </div>
                        }

                        @if (ServiceSizeEnableDisable && ServingSizeOptions != null)
                        {
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Serving Size</label>
                                <select class="form-select" @onchange="OnServingSizeChanged">
                                    <option disabled selected value="">Select...</option>
                                    @foreach (var option in ServingSizeOptions)
                                    {
                                        <option value="@option.Size">@($"{option.Size} - {option.Price:N2}")</option>
                                    }
                                </select>
                            </div>
                        }

                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Qty</label>
                            <input type="number" class="form-control text-end" step="1"
                                   @bind-Value="BillItems.Qty"
                                   @bind-Value:event="oninput"
                                   readonly="@QtyEnableDisable" />
                        </div>

                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Price</label>
                            <input type="number" class="form-control text-end" step="1"
                                   @bind-Value="BillItems.UnitPrice"
                                   @bind-Value:event="oninput"
                                   readonly="@PriceEnableDisable" />
                        </div>

                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Discount</label>
                            <input type="number" class="form-control text-end" step="1"
                                   @bind-Value="BillItems.DiscountAmount"
                                   @bind-Value:event="oninput" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Final Amount</label>
                            <input type="text" class="form-control text-end bg-light fw-bold"
                                   value="@BillItems.Item_Amount.ToString("0.00")"
                                   readonly />
                        </div>

                        <div class="col-md-3 d-grid align-items-end">
                            <label class="form-label invisible">Add</label>
                            <button type="button" class="btn btn-primary" @onclick="AddItem">
                                <i class="fas fa-plus me-1"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Divider -->
            <hr class="mb-4" />

            <!-- Items Grid -->
            <div class="row">
                <div class="col-12">
                    <MudTextField @bind-Value="searchText" Placeholder="Search..." Immediate="true" OnBlur="FilterItems" OnKeyUp="FilterItems" />
                    @if (FilteredItems is not null && FilteredItems.Any())
                    {
                        <MudPaper Style="height: 500px; overflow-y: auto;">
                               

                                <MudTable T="ItemsModel" Items="@FilteredItems" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm" RowClass="cursor-pointer" @bind-SelectedItem="SelectedItem" OnRowClick="OnRowClick">
                                <HeaderContent>
                                    @* <MudTh>Actions</MudTh> *@
                                    <MudTh>Item</MudTh>
                                    <MudTh>Details</MudTh>
                                    <MudTh class="text-end">Discount</MudTh>
                                    <MudTh class="text-end">Price</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="row">
                                     @*    <MudTd>
                                            <MudIconButton Icon="@Icons.Material.Outlined.ArrowForward"
                                                           Size="Size.Small"
                                                           OnClick="@(() => Select(row.Id))"
                                                           Color="Color.Success" />
                                        </MudTd> *@
                                        <MudTd>
                                            <img src="@(string.IsNullOrEmpty(row.Pic) ? "/images/noimage.jpg" : row.Pic)"
                                                 alt="Item Image"
                                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" />
                                        </MudTd>
                                        <MudTd>
                                            <div class="fw-semibold">@row.Name</div>
                                            <div class="text-muted small">@row.Description</div>
                                            <div class="text-primary small">@row.CategoryName</div>
                                        </MudTd>
                                        <MudTd class="text-end align-middle">
                                            @row.Discount.ToString("#,##0.00")
                                        </MudTd>
                                        <MudTd class="text-end align-middle">
                                            @row.RetailPrice.ToString("#,##0.00")
                                        </MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudPaper>
                    }
                    else
                    {
                        <MudProgressCircular Indeterminate="true" />
                    }

                </div>
            </div>

        </div>
    </ChildContent>

    <FooterContent>
        <!-- Optional: Add footer actions -->
    </FooterContent>
</MyModelDialog>


@* ---------------------------------------------------------------- Add Party ---------------------------------------------------------------- *@

    <MyModelDialog Width="30%" Height="45%" @ref="_myDialogParties" Title="Customer Details">
    <HeaderContent>
    </HeaderContent>

    <ChildContent>
                <div class="mb-5">
                    <label for="PartyName" class="form-label">Name</label>
                    <input id="PartyName" type="text" class="form-control form-control-sm" placeholder="Customer (Optional)" @bind="record.Bill.PartyName" />
                </div>

                <div class="mb-5">
                    <label for="PartyPhone" class="form-label">Phone</label>
                <input id="PartyPhone" type="text" class="form-control form-control-sm" placeholder="Phone (Optional)" @bind="record.Bill.PartyPhone" />
                </div>

                <div class="mb-5">
                    <label for="PartyEmail" class="form-label">Email</label>
                <input id="PartyEmail" type="email" class="form-control form-control-sm" placeholder="Email (Optional)" style="text-transform: unset;" @bind="record.Bill.PartyEmail" />
                </div>

                <div class="mb-5">
                    <label for="PartyAddress" class="form-label">Address</label>
                <input id="PartyAddress" type="text" class="form-control form-control-sm" placeholder="Address (Optional)" @bind="record.Bill.PartyAddress" />
                </div>


                <MudButton Variant="Variant.Filled" OnClick="CloseParty" Class="px-2 py-2 mt-1 mr-2" Style="height:40px;">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Class="mr-1" />
                    Close
                </MudButton>

           

    </ChildContent>

    <FooterContent>
    </FooterContent>
</MyModelDialog>

@* ---------------------------------------------------------------- More Options ---------------------------------------------------------------- *@
<MyModelDialog Width="30%" Height="55%" @ref="_myDialogOptions" Title="Options">
    <HeaderContent>
    </HeaderContent>

        <ChildContent>
            <div class="container">
                <!-- Customer Dropdown -->
                <div class="mb-5">
                    <label for="SelectedParty" class="form-label">Customer</label>
                    <select id="SelectedParty" class="form-select form-select-sm" @bind="record.Bill.PartyId">
                        @if (Parties != null && Parties.Any())
                        {
                            foreach (var customer in Parties)
                            {
                                <option value="@customer.Id">@customer.Name</option>
                            }
                        }
                    </select>
                </div>

                <!-- Service Type Dropdown -->
                <div class="mb-5">
                    <label for="SelectedServiceType" class="form-label">Service Type</label>
                    <select id="SelectedServiceType" class="form-select form-select-sm" @bind="record.Bill.ServiceType">
                        @if (ServiceTypes != null)
                        {
                            @foreach (var pm in ServiceTypes)
                            {
                                <option value="@pm.ListValue">@pm.ListValue</option>
                            }
                        }
                    </select>
                </div>

                <!-- Bill Status Dropdown -->
                <div class="mb-5">
                    <label for="SelectedBillStatus" class="form-label">Bill Status</label>
                    <select id="SelectedBillStatus" class="form-select form-select-sm" @bind="record.Bill.Status">
                        @if (BillStatus != null)
                        {
                            @foreach (var pm in BillStatus)
                            {
                                <option value="@pm.ListValue">@pm.ListValue</option>
                            }
                        }
                    </select>
                </div>

                <!-- Table Dropdown -->
                <div class="mb-5">
                    <label for="SelectedTable" class="form-label">Table</label>
                        <select id="SelectedTable" class="form-select form-select-sm" @bind="record.Bill.TableId">
                            @if (Tables != null)
                            {
                                @foreach (var option in Tables)
                                {
                                    <option value="@option.Id">@($"{option.TableNumber} - {option.TableLocation}")</option>
                                }
                            }
                        </select>
                </div>

                <!-- Sales ID Dropdown -->
                <div class="mb-2">
                    <label for="SelectedSaleId" class="form-label">Sales ID</label>
                    <select id="SelectedSaleId" class="form-select form-select-sm" @bind="record.Bill.SalesId">
                        @if (SalesId != null)
                        {
                            @foreach (var option in SalesId)
                            {
                                <option value="@option.Id">@option.Fullname</option>
                            }
                        }
                    </select>
                </div>

                <MudButton Variant="Variant.Filled" OnClick="CloseOptions" Class="px-2 py-2 mt-1 mr-2" Style="height:40px;">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Class="mr-1" />
                    Close
                </MudButton>
            </div>

    </ChildContent>

    <FooterContent>
    </FooterContent>
</MyModelDialog>

</MudPaper>

@code {
    [Parameter] public int? Id { get; set; } = 0;

    [CascadingParameter] private bool isReadOnly { get; set; }

    Bill_And_Bill_Detail_Model record = new();
    BillDetailModel BillItems = new();

    //Select Item Window
    public ItemsModel SelectedItem { get; set; } = new();
    public bool QtyEnableDisable { get; set; } = true;
    public bool PriceEnableDisable { get; set; } = true;
    public bool IsInventoryItem { get; set; } = true;
    private string searchText = string.Empty;

    //Supporting List Data
    private List<PartiesModel> Parties = new();
    private List<RestaurantTablesModel>? Tables { get; set; } = null;
    public List<EmployeesModel> SalesId { get; set; } = new();

    //Drawers
    public MyModelDialog? _myDialogItemSelection;
    public MyModelDialog? _myDialogParties;
    public MyModelDialog? _myDialogOptions;

    private bool LoadingPanel { get; set; } = false;

    //TypeCode Data
    List<TypeCodeModel> PaymentMethod = new();
    List<TypeCodeModel> StockCondition = new();
    public string? SelectedStockCondition { get; set; } = "NEW";
    List<TypeCodeModel> ServiceTypes = new();


    List<TypeCodeModel> BillStatus = new();

    //Items
    private List<ItemsModel> ItemsData { get; set; } = new();
    private List<ItemsModel> FilteredItems { get; set; } = new();
    private List<ItemsModel> FavItemsData = new();
    private List<ItemsModel> RecentItemsData = new();
    public int MaxItems { get; set; } = 12;

    //Serving Size
    public string? ServingSizes { get; set; } = string.Empty;
    public string? SelectedServingSize { get; set; } = string.Empty;
    public bool ServiceSizeEnableDisable { get; set; } = true;
    private List<ServingSizeModel>? ServingSizeOptions { get; set; } = null;

    //Grid Totals
    private double TotalQty => record.BillDetails.Sum(i => i.Qty);
    private double TotalTaxAmount => record.BillDetails.Sum(i => i.TaxAmount);
    private double TotalDiscountAmount => record.BillDetails.Sum(i => i.DiscountAmount);
    private double TotalNetAmount = 0;
    private double TotalBillAmount => record.BillDetails.Sum(i => i.Item_Amount);

    protected override async Task OnInitializedAsync()
    {
        await GetAll();
    }

    protected async Task GetAll()
    {
        LoadingPanel = true;
        FavItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/Search/1=1/TOP {MaxItems}", true) ?? new List<ItemsModel>();
        RecentItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/SearchRecent/TOP {MaxItems}", true) ?? new List<ItemsModel>();
        Parties = await Functions.GetAsync<List<PartiesModel>>($"Parties/Search?PARTYTYPE=CUSTOMER", true) ?? new List<PartiesModel>();
        PaymentMethod = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/PAYMENT METHOD", true) ?? new List<TypeCodeModel>();
        StockCondition = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/STOCK CONDITION", true) ?? new List<TypeCodeModel>();
        ServiceTypes = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/SERVICE TYPE", true) ?? new List<TypeCodeModel>();
        BillStatus = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/BILL STATUS", true) ?? new List<TypeCodeModel>();
        Tables = await Functions.GetAsync<List<RestaurantTablesModel>>($"RestaurantTables/Search", true) ?? new List<RestaurantTablesModel>();
        SalesId = await Functions.GetAsync<List<EmployeesModel>>($"Employees/Search", true) ?? new List<EmployeesModel>();

        Clear();
        record = await Functions.GetAsync<Bill_And_Bill_Detail_Model>($"Bill/Get/{Id}", true) ?? new Bill_And_Bill_Detail_Model();

        LoadingPanel = false;
    }

    protected override void OnParametersSet()
    {
        Clear();
    }


    private void Clear()
    {

        if (string.IsNullOrEmpty(record.Bill.Status) && BillStatus?.Any() == true)
            record.Bill.Status = BillStatus.First().ListValue;

        if (Parties != null && Parties.Any() && record.Bill.PartyId == default)
            record.Bill.PartyId = Parties.First().Id;

        if (Tables != null && Tables.Any() && record.Bill.TableId == default)
            record.Bill.TableId = Tables.First().Id;

        if (SalesId != null && SalesId.Any() && record.Bill.SalesId == default)
            record.Bill.SalesId = SalesId.First().Id;

        record.Bill.BillType = "SALE";
        record.Bill.PartyId=1;

    } 

    private void CalculateTotalNetAmount()
    {
        double totalBillAmount = 0;

        foreach (var item in record.BillDetails)
        {
            totalBillAmount += item.Item_Amount;
        }

        TotalNetAmount = totalBillAmount + record.Bill.TaxAmount - record.Bill.DiscountAmount;
    }


    private void DeleteItem(BillDetailModel item)
    {
        record.BillDetails.Remove(item);
        CalculateTotalNetAmount();
    }


    private void Print()
    {
        var url = $"/BillReport/{Id}";
        JS.InvokeVoidAsync("open", url, "_blank");
    }

    // ---------------------------------------------------------------- Select Item ----------------------------------------------------------------

    private async Task AddItemDialogShow(int id)
    {
        string routeSuffix = id != 0 ? $"/Items.Id={id}" : string.Empty;

        ItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/Search{routeSuffix}", true) ?? new List<ItemsModel>();
        FilterItems();
        SelectedStockCondition = "NEW";
        searchText = string.Empty;
        _myDialogItemSelection!.Show();
    }

    private void FilterItems()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            FilteredItems = ItemsData;
        }
        else
        {
            FilteredItems = ItemsData
                .Where(item =>
                    (item.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (item.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (item.CategoryName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }

        SelectedItem = FilteredItems.FirstOrDefault()!;
        
    }

    private void AddItem()
    {

        // if (BillItems.ServingSize is null)
        // {
        //     var res = await Functions.ShowConfirmation(dialogService, "You havenot selected SERVINGSIZE, do you want to continue?");
        //     if (res == false)
        //         return;
        // }

        BillDetailModel BillItem = new();
        BillItem.ItemId = SelectedItem.Id;
        BillItem.Item= BillItems.Item + " " + BillItems.ServingSize;
        BillItem.ServingSize = BillItems.ServingSize;
        BillItem.StockCondition = BillItems.StockCondition;
        BillItem.Qty= BillItems.Qty;
        BillItem.UnitPrice= BillItems.UnitPrice;
        BillItem.DiscountAmount=BillItems.DiscountAmount;
        BillItem.TaxAmount = BillItems.TaxAmount;
        BillItem.Status = "COMPLETE";
        record.BillDetails.Add(BillItem);

        CalculateTotalNetAmount();
        SelectedItem = null!;
        _myDialogItemSelection!.Hide();
        StateHasChanged();

    }

    private void OnRowClick(TableRowClickEventArgs<ItemsModel> args)
    {
        var selectedItem = args.Item;
        Console.WriteLine($"Row clicked: {args.Item?.Name}");
        Select(selectedItem!);
    }


    private void Select(ItemsModel item)
    {
        if (item == null) return;

        SelectedServingSize = string.Empty;
        SelectedItem = item;
        //ItemsModel item = ItemsData.FirstOrDefault(x => x.Id == id)!;

        BillDetailModel New_Item = new()
        {
            Qty = 1,
            UnitPrice = item.RetailPrice,
            DiscountAmount = item.Discount,
            Item = item.Name!,
            Pic = item.Pic
        };

        BillItems = New_Item;

        PriceEnableDisable = item.IsInventoryItem == 1; 
        QtyEnableDisable = item.IsInventoryItem != 1;
        IsInventoryItem = item.IsInventoryItem == 0 ? false : true;

        ServingSizeOptions = null;
        ServiceSizeEnableDisable = false;
        SelectedServingSize = string.Empty;

        if (!string.IsNullOrWhiteSpace(item.ServingSize))
        {
            try
            {
                ServingSizeOptions = JsonSerializer.Deserialize<List<ServingSizeModel>>(item.ServingSize);
                if (ServingSizeOptions != null && ServingSizeOptions.Count > 0)
                {
                    ServiceSizeEnableDisable = true;
                }
            }
            catch
            {
                ServiceSizeEnableDisable = false;
            }
        }

        StateHasChanged();
    }


    private void OnServingSizeChanged(ChangeEventArgs e)
    {
        var selectedSize = e.Value?.ToString();
        SelectedServingSize = selectedSize!;

        var selectedOption = ServingSizeOptions?.FirstOrDefault(s => s.Size == selectedSize);
        if (selectedOption != null)
        {
            BillItems.UnitPrice = selectedOption.Price;
            BillItems.Pic = selectedOption.Pic;
            BillItems.ServingSize = selectedOption.Size;
            BillItems.StockCondition = SelectedStockCondition;
        }

        StateHasChanged();
    }


    // ---------------------------------------------------------------- Add Parties ----------------------------------------------------------------

    protected void AddParty()
    {
        _myDialogParties!.Show();
    }

    private void CloseParty()
    {
        _myDialogParties!.Hide();
    }

    // ---------------------------------------------------------------- Options ----------------------------------------------------------------


    private void Options()
    {
        _myDialogOptions!.Show();
    }


    private void CloseOptions()
    {
        _myDialogOptions!.Hide();
    }

    // ---------------------------------------------------------------- Select Item ----------------------------------------------------------------


    private async void Save()
    {

        // LoadingPanel = true;



        if (record.Bill.PartyId == 0 || record.Bill.SalesId == 0 || record.Bill.TableId == 0)
        {
            SnackbarService.Add($"Cannot Save Record. Please check Selected Customer, Sales Id or Table", Severity.Error);
            return;
        }

        Bill_And_Bill_Detail_Model BillHeader = new();
        var Action = "INSERT";

        if (Id != 0)
            Action = "UPDATE";

        //Bill Header
        record.Bill.Id = record.Bill.Id;
        record.Bill.OrganizationId = Globals.User.OrganizationId;
        record.Bill.Source = "MANUAL";
        record.Bill.LocationId = Globals.User.LocationId;
        record.Bill.CreatedBy = Globals.User.Id;
        record.Bill.CreatedOn = DateTime.Now;
        record.Bill.CreatedFrom = Functions.GetComputerDetails();
        record.Bill.UpdatedBy = Globals.User.Id;
        record.Bill.UpdatedOn = DateTime.Now;
        record.Bill.UpdatedFrom = Functions.GetComputerDetails();

        var result = await Functions.PostAsync<BillModel>($"Bill/{Action}", record, true);
        if (result.Success == false)
        {
            LoadingPanel = false;
            SnackbarService.Add($"Record Save Fail.", Severity.Error);
        }
        else
        {
            LoadingPanel = false;
            SnackbarService.Add($"Record Saved Successfully", Severity.Success);
            record.Bill.SeqNo = result.Result!.SeqNo;
            Id = result.Result.Id;
            Print();
        }

    }
}

<style>

    .form-wrapper {
        min-width: 150px;
    }

    .custom-select {
        background-color: black;
        color: white;
        border: 1px solid #555;
        height: 38px;
        font-size: 0.9rem;
    }

    .input-icon-container {
        position: relative;
        display: inline-block;
        width: 200px;
    }

        .input-icon-container input {
            padding-right: 30px;
        }

    .search-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        pointer-events: none;
    }


    .fav-block {
        display: flex;
        align-items: center;
        padding: 10px 14px; /* moderate padding */
        height: 130px; /* reduced height */
        border-radius: 6px;
        gap: 12px; /* spacing between image and info */
        cursor: pointer;
    }

    .fav-img {
        width: 90px; /* smaller image */
        height: 90px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .fav-info {
        padding-left: 10px;
        overflow: hidden;
        white-space: nowrap;
        color: #222; /* dark text */
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
        flex-grow: 1;
    }

        .fav-info .mud-typography-caption {
            color: #555 !important; /* darker gray for price */
        }



</style>