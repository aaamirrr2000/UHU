@page "/BillPage/{Act}/{Id:int?}"
@page "/BillPage"
@using System.Collections.ObjectModel
@using System.Text.Json
@inject NavigationManager NavManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudLayout>
    <!-- Top App Bar -->
    <MudAppBar Elevation="2" Color="Color.Surface" Dense="true" Class="app-bar px-2 w-100" Fixed="false" Style="margin-left:0; border-top: 1px solid gray; padding:5px;">
        <!-- Left‑aligned controls -->
        @* <MudIconButton Icon="@Icons.Material.Filled.AddBox" Color="Color.Secondary" Size="Size.Medium" OnClick="@(async () => await AddBlankRow())" /> *@

        <!-- Bill‑type selector -->
        <MudSelect Dense="true" T="string" @bind-Value="record.Bill.BillType" Disabled="@Disabled">
            @if (BillType != null)
            {
                @foreach (var pm in BillType)
                {
                    <MudSelectItem Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
                }
            }
        </MudSelect>

        <!-- Standard toolbar buttons -->
        <MudTooltip Text="Options"><MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Info" OnClick="Options" /></MudTooltip>
        <MudTooltip Text="New"><MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="Clear" /></MudTooltip>
        @if (Act != "VIEW")
        {
            <MudTooltip Text="Save"><MudIconButton Icon="@Icons.Material.Filled.Save" Color="Color.Success" OnClick="Save" /></MudTooltip>
            @* <MudTooltip Text="Delete"><MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="DeleteBill" /></MudTooltip> *@
        }
        @if (Id != 0)
        {
            <MudTooltip Text="Print"><MudIconButton Icon="@Icons.Material.Filled.Print" Color="Color.Info" OnClick="Print" /></MudTooltip>
        }

        <!-- Spacer pushes the next controls to the right -->
        <MudSpacer />

        <!-- Bill number + customer button -->
        <MudTextField Class="me-2" Dense="true" Variant="Variant.Text" Placeholder="Bill #" T="string" Style="max-width:120px;" @bind-Value="record.Bill.SeqNo" />
        <MudTooltip Text="Customer"><MudIconButton Icon="@Icons.Material.Filled.Person" Color="Color.Info" OnClick="AddParty" /></MudTooltip>
    </MudAppBar>

    <!-- Main content -->
    <MudMainContent Class="p-4" Style="margin-left:0;">
        <MudGrid>
            <!-- Left: Items & summary -->
            <MudItem xs="12" md="7">
                <!-- Items table -->
                <MudCard Elevation="1" Class="d-flex flex-column" Style="height:70vh; overflow:hidden;">
                    <MudCardContent Class="p-0" Style="flex-grow: 1; overflow: hidden;">
                        
                        <div style="height: 100%; overflow-y: auto; padding-right: 4px;">
                            <MudTable Items="record.BillDetails.OrderByDescending(x => x.Id)"
                                        Hover="true"
                                        Dense="true"
                                        StickyHeader="true"
                                        Elevation="0"
                                        Bordered="true"
                                        Breakpoint="Breakpoint.Xs"
                                        Striped="false"
                                        Class="billing-table">

                                <HeaderContent>
                                    <MudTh Width="5%" Align="Align.Center">#</MudTh>
                                    <MudTh Width="5%" Align="Align.Center">(...)</MudTh>
                                    <MudTh>Item</MudTh>
                                    <MudTh Width="10%" Align="Align.Right">Qty</MudTh>
                                    <MudTh Width="10%" Align="Align.Right">Price</MudTh>
                                    <MudTh Width="10%" Align="Align.Right">Discount</MudTh>
                                    <MudTh Width="10%" Align="Align.Right">Amount</MudTh>
                                </HeaderContent>

                                <RowTemplate Context="row">
                                    @{
                                        var idx = record.BillDetails.IndexOf(row) + 1;
                                        var itemAmount = (row.Qty * row.UnitPrice) - row.DiscountAmount;
                                    }

                                    <MudTd Align="Align.Center">@idx</MudTd>

                                    <MudTd Align="Align.Center">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                        Size="Size.Small"
                                                        Color="Color.Error"
                                                        OnClick="@(() => DeleteItem(row))" />
                                    </MudTd>

                                    <MudTd>
                                        <MudText Typo="Typo.subtitle2" Class="fw-semibold" Color="Color.Primary">
                                            @row.Item
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted" Color="Color.Error">
                                            @row.ServingSize
                                        </MudText>
                                    </MudTd>

                                    <MudTd Align="Align.Right">
                                        <MudNumericField T="double"
                                                            Dense="true"
                                                            Min="0"
                                                            HideSpinButtons="false"
                                                            @bind-Value="row.Qty"
                                                            InputClass="text-end no-bottom-border"
                                                            ToStringFormat="#,##0.00"
                                                            OnBlur="@(() => CalculateTotalNetAmountAsync())"
                                                            Class="w-100" 
                                                            Style="text-align:right;"/>
                                    </MudTd>

                                    <MudTd Style="text-align:right;">@row.UnitPrice.ToString("#,##0.00")</MudTd>
                                    <MudTd Style="text-align:right;">@row.DiscountAmount.ToString("#,##0.00")</MudTd>
                                    <MudTd Style="text-align:right;"><MudText Color="@(itemAmount < 0 ? Color.Error : Color.Default)">@itemAmount.ToString("#,##0.00")</MudText></MudTd>
                                </RowTemplate>

                                <FooterContent>
                                    <MudTd ColSpan="3" Style="text-align:right;"><b>Total</b></MudTd>
                                    <MudTd Style="text-align:right;"><b>@TotalQty.ToString("#,##0.00")</b></MudTd>
                                    <MudTd />
                                    <MudTd Style="text-align:right;"><b>@TotalDiscountAmount.ToString("#,##0.00")</b></MudTd>
                                    <MudTd Style="text-align:right;"><b>@TotalBillAmount.ToString("#,##0.00")</b></MudTd>
                                </FooterContent>
                            </MudTable>
                        </div>
                    </MudCardContent>
                </MudCard>
                    
              <MudCard Class="mt-2" Elevation="1">
                <MudCardContent>

<div class="row summary-row">
    <div class="col-4 summary-col">
        <MudText Typo="Typo.caption" Class="summary-label">
            <MudIconButton Icon="@Icons.Material.Outlined.RequestQuote"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           Class="summary-icon"
                           OnClick="@(() => OpenChargesDialog())" />
            Service Charges
        </MudText>
        <MudText Typo="Typo.subtitle2" Class="summary-value">
            @ServiceChargesTotal.ToString("#,##0.00")
        </MudText>
    </div>

    <div class="col-4 summary-col">
        <MudText Typo="Typo.caption" Class="summary-label">
            <MudIconButton Icon="@Icons.Material.Outlined.AccountBalance"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           Class="summary-icon"
                           OnClick="@(() => OpenTaxDialog())" />
            Tax
        </MudText>
        <MudText Typo="Typo.subtitle2" Class="summary-value">
            @TaxTotal.ToString("#,##0.00")
        </MudText>
    </div>

    <div class="col-4 summary-col">
        <MudText Typo="Typo.caption" Class="summary-label">
            <MudIconButton Icon="@Icons.Material.Outlined.LocalOffer"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           Class="summary-icon" />
            Discount
        </MudText>
        <MudNumericField T="decimal"
                         Dense="true"
                         @bind-Value="record.Bill.DiscountAmount"
                         Disabled="@Disabled"
                         ToStringFormat="#,##0.00"
                         Class="summary-value"
                         HideSpinButtons="true" />
    </div>

   @*  <div class="col-3 summary-col">
        <MudText Typo="Typo.caption" Class="summary-label">
            <MudIconButton Icon="@Icons.Material.Outlined.Summarize"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           Class="summary-icon" />
            Gross Amount
        </MudText>
        <MudText Typo="Typo.subtitle2" Class="summary-value">
            @record.Bill.BillAmount.ToString("#,##0.00")
        </MudText>
    </div> *@
</div>

<div class="row summary-row">
    <div class="col-4 summary-col">
        <MudText Typo="Typo.caption" Class="summary-label">
            <MudIconButton Icon="@Icons.Material.Outlined.Payment"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           Class="summary-icon" />
            Payment Method
        </MudText>
        <MudSelect T="string"
                   Dense="true"
                   @bind-Value="record.Bill.PaymentMethod"
                   Disabled="@Disabled"
                   Class="summary-value">
            @foreach (var pm in PaymentMethod)
            {
                <MudSelectItem Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
            }
        </MudSelect>
    </div>

    <div class="col-4 summary-col">
        <MudText Typo="Typo.caption" Class="summary-label">
            <MudIconButton Icon="@Icons.Material.Outlined.QrCode"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           Class="summary-icon" />
            Payment Ref
        </MudText>
        <MudTextField T="string"
                      Dense="true"
                      @bind-Value="record.Bill.PaymentRef"
                      Disabled="@Disabled"
                      Class="summary-value" />
    </div>

    <div class="col-4 summary-col">
        <MudText Typo="Typo.caption" Class="summary-label">
            <MudIconButton Icon="@Icons.Material.Outlined.Calculate"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           Class="summary-icon" />
            Net Amount
        </MudText>
        <MudText Typo="Typo.subtitle2" Class="summary-value">
            @TotalNetAmount.ToString("#,##0.00")
        </MudText>
    </div>
</div>


                </MudCardContent>
            </MudCard>

            </MudItem>

            <!-- Right: Favourites / Recent -->
            <MudItem xs="12" md="5">
                <MudTabs Rounded="true" Centered="false" Elevation="1" Class="mb-2" ScrollButtons="ScrollButtons.Auto"> 
                    <MudTabPanel Text=@($"Items") Class="p-2">
                        
                        <div class="m-3">
                            @foreach (var category in _categories)
                            {
                                <button class="btn btn-outline-primary m-1" @onclick="() => LoadItemsByCategory(category)">
                                    @category.Name
                                </button>
                            }
                        </div>

                        <MudTextField Dense="true" Class="mb-2 p-2" Placeholder="Search…" @bind-Value="ClickedItem.Name" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />

                        <MudGrid GutterSize="GutterSize.Small">
                            @foreach (var fav in SelectedItems.Where(f => string.IsNullOrWhiteSpace(ClickedItem.Name) || f.Name!.Contains(ClickedItem!.Name!, StringComparison.OrdinalIgnoreCase)))
                            {
                                <MudItem xs="6" sm="4" md="3">
                                    <MudCard Elevation="2" Class="item-card" Style="cursor:pointer;" @onclick="@(async () => await AddItemDialogShow(fav.Id))">
                                        <MudCardMedia Image="@fav.Pic" Height="80" />
                                        <MudCardContent>
                                            <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="truncate">@fav.Name</MudText>
                                            <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">@fav.RetailPrice.ToString("#,##0.00")</MudText>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudTabPanel>

                    <MudTabPanel Text=@($"Favorites ({MaxItems:#,##0})") Class="p-2">

                        <MudTextField Dense="true" Class="mb-2 p-2" Placeholder="Search…" @bind-Value="SelectedFavItem.Name" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                        
                        <MudGrid GutterSize="GutterSize.Small">
                            @foreach (var fav in FavItemsData.Where(f => string.IsNullOrWhiteSpace(SelectedFavItem.Name) || f.Name!.Contains(SelectedFavItem.Name, StringComparison.OrdinalIgnoreCase)))
                            {
                                <MudItem xs="6" sm="4" md="3">
                                    <MudCard Elevation="2" Class="item-card" Style="cursor:pointer;" @onclick="@(async () => await AddItemDialogShow(fav.Id))">
                                        <MudCardMedia Image="@fav.Pic" Height="80" />
                                        <MudCardContent>
                                            <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="truncate">@fav.Name</MudText>
                                            <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">@fav.RetailPrice.ToString("#,##0.00")</MudText>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudTabPanel>
                    <MudTabPanel Text=@($"Recent ({MaxItems:#,##0})") Class="p-2">

                        <MudTextField Dense="true" Class="mb-2 p-2" Placeholder="Search…" @bind-Value="SelectedRecentItem.Name" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                        
                        <MudGrid GutterSize="GutterSize.Small">

                            @foreach (var fav in RecentItemsData.Where(f => string.IsNullOrWhiteSpace(SelectedRecentItem.Name) || f.Name!.Contains(SelectedRecentItem.Name, StringComparison.OrdinalIgnoreCase)))
                            {
                                <MudItem xs="6" sm="4" md="3">
                                    <MudCard Elevation="2" Class="item-card" Style="cursor:pointer;" @onclick="@(async () => await AddItemDialogShow(fav.Id))">
                                        <MudCardMedia Image="@fav.Pic" Height="80" />
                                        <MudCardContent>
                                            <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="truncate">@fav.Name</MudText>
                                            <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">@fav.RetailPrice.ToString("#,##0.00")</MudText>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    </MudMainContent>
    @* Options ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MyDrawer @ref="_drawer" Title="Options" FaIcon="fas fa-address-book">
        <HeaderContent>
        </HeaderContent>
        <ChildContent>
                <MudForm>
                    <MudPaper Class="p-4" Elevation="0">
                        <!-- Customer Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="int" @bind-Value="record.Bill.PartyId" Disabled="@Disabled" Label="Select Customer" Dense="true">
                                @if (Parties != null)
                                {
                                    @foreach (var customer in Parties)
                                    {
                                        <MudSelectItem T="int" Value="@customer.Id">@customer.Name</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Service Type Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="string" @bind-Value="record.Bill.ServiceType" Disabled="@Disabled" Label="Select Service Type" Dense="true">
                                @if (ServiceTypes != null)
                                {
                                    @foreach (var pm in ServiceTypes)
                                    {
                                        <MudSelectItem T="string" Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Bill Status Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="string" @bind-Value="record.Bill.Status" Disabled="@Disabled" Label="Select Bill Status" Dense="true">
                                @if (BillStatus != null)
                                {
                                    @foreach (var pm in BillStatus)
                                    {
                                        <MudSelectItem T="string" Value="@pm.ListValue">@pm.ListValue</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Table Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="int" @bind-Value="record.Bill.TableId" Disabled="@Disabled" Label="Select Table" Dense="true">
                                @if (Tables != null)
                                {
                                    @foreach (var option in Tables)
                                    {
                                        <MudSelectItem T="int" Value="@option.Id">@($"{option.TableNumber} - {option.TableLocation}")</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Sales ID Dropdown -->
                        <MudItem Class="mb-5">
                            <MudSelect T="int" @bind-Value="record.Bill.SalesId" Disabled="@Disabled" Label="Select Sales ID" Dense="true">
                                @if (SalesId != null)
                                {
                                    @foreach (var option in SalesId)
                                    {
                                        <MudSelectItem T="int" Value="@option.Id">@option.Fullname</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                       @*  <!-- Close Button -->
                        <MudButton Variant="Variant.Filled" OnClick="CloseOptions" Class="px-2 py-2 mt-1 mr-2" Style="height:40px;">
                            <MudIcon Icon="@Icons.Material.Filled.Close" Class="mr-1" />
                            Close
                        </MudButton> *@
                    </MudPaper>
                </MudForm>
        </ChildContent>
        <FooterContent>
        </FooterContent>
    </MyDrawer>

    @* Parties ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MyDrawer @ref="_drawerParty" Title="Customer Details" FaIcon="fas fa-address-book">
        <HeaderContent>
        </HeaderContent>
        <ChildContent>
                <MudForm>
                    <MudPaper Class="p-4" Elevation="0">

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Name</MudText>
                        <MudTextField T="string" Placeholder="Customer (Optional)" Label="Customer (Optional)" @bind-Value="record.Bill.PartyName" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Phone</MudText>
                        <MudTextField T="string" Placeholder="Phone (Optional)" Label="Phone (Optional)" @bind-Value="record.Bill.PartyPhone" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Email</MudText>
                        <MudTextField T="string" InputType="InputType.Email" Placeholder="Email (Optional)" Label="Email (Optional)" Style="text-transform: unset;" @bind-Value="record.Bill.PartyEmail" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                        <MudItem Class="mb-5">
                            <MudText Typo="Typo.subtitle2">Address</MudText>
                        <MudTextField T="string" Placeholder="Address (Optional)" Label="Address (Optional)" @bind-Value="record.Bill.PartyAddress" Disabled="@Disabled" Dense="true" />
                        </MudItem>

                    </MudPaper>
                </MudForm>
        </ChildContent>
        <FooterContent>
        </FooterContent>
    </MyDrawer>

     @* Items Selection ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MudDialog @bind-Visible="_DialogItemsDetails" Options="_dialogOptions">

        <TitleContent>
            <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudItem xs="10">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                        Item details
                    </MudText>
                </MudItem>

                <MudItem xs="2" Class="d-flex justify-end">
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="OnCancel" />
                </MudItem>
            </MudGrid>
        </TitleContent>

        <DialogContent>

            <MudGrid Class="w-100" Justify="Justify.Center" AlignItems="AlignItems.Start">
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="pa-4" Style="background-color: var(--mud-palette-surface); border-radius: 8px;">
                        <!-- Header Section -->
                        <MudGrid GutterSize="GutterSize.Small" Class="mb-4">
                            <MudItem xs="12" sm="2" Class="d-flex justify-center">
                                <img src="@SelectedItem.Pic"
                                     alt="Item"
                                     style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;" />
                            </MudItem>
                            <MudItem xs="12" sm="7">
                                <MudText Typo="Typo.h6" Class="fw-bold mb-1">@SelectedItem.Name</MudText>
                            </MudItem>
                            <MudItem xs="12" sm="3" Class="d-flex align-items-end justify-end">
                                <MudText Typo="Typo.subtitle1" Color="Color.Success" Class="fw-bold">
                                    @SelectedItem.RetailPrice.ToString("N")
                                </MudText>
                            </MudItem>
                        </MudGrid>

                        <!-- Quantity Controls -->
                        <MudGrid Class="mb-4" Justify="Justify.Center" AlignItems="AlignItems.End">
                            <MudItem xs="12" sm="6" Class="d-flex justify-center align-items-end" Style="gap: 0.5rem;">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                           Size="Size.Medium" Style="min-width: 40px;"
                                           OnClick="@(() => DecreaseQty(SelectedItem))">
                                    <MudIcon Icon="@Icons.Material.Filled.Remove" />
                                </MudButton>

                                <MudTextField T="double"
                                              Value="@SelectedItem.Qty"
                                              ReadOnly="true"
                                              Dense="true"
                                              Class="text-center"
                                              Style="width: 60px;" />

                                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                           Size="Size.Medium" Style="min-width: 40px;"
                                           OnClick="@(() => IncreaseQty(SelectedItem))">
                                    <MudIcon Icon="@Icons.Material.Filled.Add" />
                                </MudButton>
                            </MudItem>
                        </MudGrid>

                        <!-- Serving Size Selector -->
                        <div class="mb-3">
                            <label class="fw-semibold d-block mb-1">Varity:</label>

                            @if (SelectedItem?.ServingSizes?.Any() == true)
                            {
                                <div class="btn-group flex-wrap gap-1" role="group">
                                    @foreach (var size in SelectedItem.ServingSizes)
                                    {
                                        <MudCard Style="width: 160px; cursor: pointer;"
                                                 Elevation="@(SelectedItem.ServingSize == size.Size ? 6 : 1)"
                                                 Class="text-center"
                                                 @onclick="@(() => OnServingSizeChanged(size.Size, SelectedItem))">

                                            <MudCardMedia Image="@size.Pic" Height="100" />

                                            <MudCardContent>
                                                <MudText Typo="Typo.subtitle2" Class="fw-semibold">
                                                    @size.Size
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @($"{size.Price:#,##0.00}")
                                                </MudText>
                                            </MudCardContent>

                                        </MudCard>
                                    }
                                </div>
                            }
                            else
                            {
                                <MudText Color="Color.Warning" Typo="Typo.caption">
                                    No varity available for this item.
                                </MudText>
                            }
                        </div>
                        <!-- Add to Cart -->
                        <MudDivider Class="my-2" />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.ShoppingCart"
                                   Class="w-100 mt-2"
                                   OnClick="@(() => AddToCart(SelectedItem))">
                            Add to Cart
                        </MudButton>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </DialogContent>

        <DialogActions>
           @*  <MudButton OnClick="OnCancel" Color="Color.Primary" Variant="Variant.Filled">Cancel</MudButton> *@
        </DialogActions>
    </MudDialog>

     @* Service Charges ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MudDialog @bind-Visible="_DialogServiceCharges" Options="_dialogOptions">


        <TitleContent>
            <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudItem xs="10">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                        Service Charges
                    </MudText>
                </MudItem>

                <MudItem xs="2" Class="d-flex justify-end">
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="OnCancel" />
                </MudItem>
            </MudGrid>
        </TitleContent>

        <DialogContent>
            <div class="d-flex justify-center align-start" style="min-height: 60vh;">
                <MudGrid GutterSize="GutterSize.Small"
                            Class="px-2 py-2"
                            Style="max-width: 600px; width: 100%;">

                    @* ── Service Charges ── *@
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2" Class="fw-bold">Service Charges</MudText>
                    </MudItem>

                    @foreach (var charge in ServiceCharges)
                    {
                        <MudItem xs="6" Class="text-end">
                            <MudText Typo="Typo.subtitle2" Class="fw-semibold">
                                @charge.ChargeName
                                @if (charge.ChargeType == "PERCENTAGE")
                                {
                                    @($" @ {charge.Amount}%")
                                }
                                else if (charge.ChargeType == "FLAT")
                                {
                                    @($" {charge.Amount} per Bill")
                                }
                            </MudText>
                        </MudItem>   
                                            
                        <MudItem xs="6" Class="text-end">
                            @{
                                var effectiveCharge = charge.ChargeType == "PERCENTAGE"
                                    ? (charge.Amount / 100) * Convert.ToDouble(TotalNetAmount)
                                    : charge.Amount;
                            }
                            <MudText Typo="Typo.subtitle2">
                                @effectiveCharge.ToString("#,##0.00")
                            </MudText>
                        </MudItem>
                    }

                </MudGrid>
            </div>
        </DialogContent>

        <DialogActions>

        </DialogActions>
    </MudDialog>

    @* Tax ---------------------------------------------------------------------------------------------------------------------------------------- *@
    <MudDialog @bind-Visible="_DialogTax" Options="_dialogOptions">


        <TitleContent>
            <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudItem xs="10">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                        Tax
                    </MudText>
                </MudItem>

                <MudItem xs="2" Class="d-flex justify-end">
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="OnCancel" />
                </MudItem>
            </MudGrid>
        </TitleContent>

        <DialogContent>
            <div class="d-flex justify-center align-start" style="min-height: 60vh;">
                <MudGrid GutterSize="GutterSize.Small"
                            Class="px-2 py-2"
                            Style="max-width: 600px; width: 100%;">

                   
                    @* ── Taxes ── *@
                    <MudItem xs="12" Class="mt-3">
                        <MudText Typo="Typo.subtitle2" Class="fw-bold">Taxes</MudText>
                    </MudItem>

                    @if (Tax?.Any() == true)
                    {
                        @foreach (var tax in Tax)
                        {
                            <MudItem xs="6" Class="text-end">
                                <MudText Typo="Typo.subtitle2" Class="fw-semibold">
                                    @tax.TaxName @($"@ {tax.RatePercent}%")
                                </MudText>
                            </MudItem>

                            <MudItem xs="6" Class="text-end">
                                @{
                                    var taxAmount = (tax.RatePercent / 100) * Convert.ToDouble(TotalNetAmount);
                                }
                                <MudText Typo="Typo.subtitle2">
                                    @taxAmount.ToString("#,##0.00")
                                </MudText>
                            </MudItem>
                        }
                    }

                </MudGrid>
            </div>
        </DialogContent>

        <DialogActions>

        </DialogActions>
    </MudDialog>

</MudLayout>


@code {
    // =======================
    // 1. Parameters
    // =======================
    [Parameter] public int? Id { get; set; } = 0;
    [Parameter] public string? Act { get; set; } = "INSERT";
    [CascadingParameter] private bool isReadOnly { get; set; }
    public bool Disabled { get; set; } = true;

    // =======================
    // 2. Main Models
    // =======================
    private Bill_And_Bill_Detail_Model record = new();
    private BillDetailModel BillItems = new();

    // =======================
    // 3. Selected Item & State Flags
    // =======================
    public bool QtyEnableDisable { get; set; } = true;
    public bool PriceEnableDisable { get; set; } = true;
    public bool IsInventoryItem { get; set; } = true;
    public bool ServiceSizeEnableDisable { get; set; } = true;
    private string searchText = string.Empty;
    private bool LoadingPanel { get; set; } = false;

    // =======================
    // 4. Dialog Components (Drawers)
    // =======================
    private MyDrawer _drawer = new();
    private MyDrawer _drawerParty = new();
    private bool _DialogServiceCharges;
    private bool _DialogTax;
    private bool _DialogItemsDetails;
    private DialogOptions _dialogOptions = new()
    {
        CloseOnEscapeKey = true,
        FullWidth = true,
        MaxWidth = MaxWidth.Medium
    };

    // =======================
    // 5. Supporting Lists
    // =======================
    private List<PartiesModel> Parties = new();
    private List<RestaurantTablesModel>? Tables { get; set; } = null;
    public List<EmployeesModel> SalesId { get; set; } = new();
    private List<CategoriesModel> _categories = new();

    // =======================
    // 6. TypeCode Data
    // =======================
    private List<TypeCodeModel> PaymentMethod = new();
    private List<TypeCodeModel> StockCondition = new();
    private List<TypeCodeModel> ServiceTypes = new();
    private List<TypeCodeModel> BillStatus = new();
    private List<TypeCodeModel> BillType = new();
    public string? SelectedStockCondition { get; set; } = "NEW";

    // =======================
    // 7. Items Data
    // =======================
    private List<ItemsModel> ItemsData { get; set; } = new();
    private List<ItemsModel> FilteredItems { get; set; } = new();
    private List<ItemsModel> FavItemsData = new();
    private List<ItemsModel> RecentItemsData = new();
    public int MaxItems { get; set; } = 12;

    public List<ItemsModel> SelectedItems { get; set; } = new();
    public ItemsModel SelectedItem { get; set; } = new();
    public ItemsModel ClickedItem { get; set; } = new();
    public ItemsModel SelectedFavItem { get; set; } = new();
    public ItemsModel SelectedRecentItem { get; set; } = new();

    // =======================
    // 8. Serving Sizes
    // =======================
    public string? ServingSizes { get; set; } = string.Empty;
    public string? SelectedServingSize { get; set; } = string.Empty;
    private List<ServingSizeModel>? ServingSizeOptions { get; set; } = null;

    // =======================
    // 9. Computed Totals
    // =======================
    private double TotalQty => record.BillDetails.Sum(i => i.Qty);
    private double TotalTaxAmount => record.BillDetails.Sum(i => i.TaxAmount);
    private double TotalDiscountAmount => record.BillDetails.Sum(i => i.DiscountAmount);
    double TotalNetAmount =0;
    private double TotalBillAmount => record.BillDetails.Sum(i => i.Item_Amount);

    // =======================
    // 10. Tax & Service Charges
    // =======================
    List<ServiceChargesModel> ServiceCharges = new();
    double ServiceChargesTotal = 0;

    List<TaxModel> Tax = new();
    double TaxTotal = 0;



    protected override async Task OnInitializedAsync()
    {
        await GetAll();
    }

    protected async Task GetAll()
    {
        LoadingPanel = true;

        await LoadCategories();
        ItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/Search", true) ?? new List<ItemsModel>();
        FavItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/Search/1=1/TOP {MaxItems}", true) ?? new List<ItemsModel>();
        RecentItemsData = await Functions.GetAsync<List<ItemsModel>>($"Items/SearchRecent/TOP {MaxItems}", true) ?? new List<ItemsModel>();
        Parties = await Functions.GetAsync<List<PartiesModel>>($"Parties/Search?PARTYTYPE=CUSTOMER", true) ?? new List<PartiesModel>();
        PaymentMethod = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/PAYMENT METHOD", true) ?? new List<TypeCodeModel>();
        StockCondition = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/STOCK CONDITION", true) ?? new List<TypeCodeModel>();
        ServiceTypes = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/SERVICE TYPE", true) ?? new List<TypeCodeModel>();
        BillStatus = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/BILL STATUS", true) ?? new List<TypeCodeModel>();
        Tables = await Functions.GetAsync<List<RestaurantTablesModel>>($"RestaurantTables/Search", true) ?? new List<RestaurantTablesModel>();
        SalesId = await Functions.GetAsync<List<EmployeesModel>>($"Employees/Search", true) ?? new List<EmployeesModel>();
        BillType = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/BILL TYPE", true) ?? new List<TypeCodeModel>();
        if (string.IsNullOrEmpty(record.Bill.PaymentMethod))
        {
            record.Bill.PaymentMethod = PaymentMethod.FirstOrDefault()?.ListValue ?? "CASH";
        }

        Clear();
        await GetTaskAsync(Id);

        LoadingPanel = false;
    }

    private async Task GetTaskAsync(int? id)
    {
        if (id != 0)
        {
            LoadingPanel = true;
            record = await Functions.GetAsync<Bill_And_Bill_Detail_Model>($"Bill/Get?Id={id}", true) ?? new Bill_And_Bill_Detail_Model();
            if (record.BillDetails == null)
            {
                record = new Bill_And_Bill_Detail_Model();
            }

            CalculateTotalNetAmountAsync();
            LoadingPanel = false;
        }
    }

    protected override void OnParametersSet()
    {
        Clear();
    }

    private async Task LoadCategories()
    {
        _categories = await Functions.GetAsync<List<CategoriesModel>>("Categories/Search", true) ?? new();
        if (_categories.Any())
        {
            await LoadItemsByCategory(_categories[0]);
        }
    }

    private async Task LoadItemsByCategory(CategoriesModel category)
    {
        SelectedItems = await Functions.GetAsync<List<ItemsModel>>($"Items/Search/CategoriesId={category.Id}", true) ?? new();
    }

    private void Clear()
    {

        if (string.IsNullOrEmpty(record.Bill.Status) && BillStatus?.Any() == true)
            record.Bill.Status = BillStatus.First().ListValue;

        if (Parties != null && Parties.Any() && record.Bill.PartyId == default)
            record.Bill.PartyId = Parties.First().Id;

        if (Tables != null && Tables.Any() && record.Bill.TableId == default)
            record.Bill.TableId = Tables.First().Id;

        if (SalesId != null && SalesId.Any() && record.Bill.SalesId == default)
            record.Bill.SalesId = SalesId.First().Id;

        record.Bill.BillType = "SALE";
        record.Bill.PartyId=1;
        Disabled = Act == "VIEW";

    } 

    private void OpenChargesDialog()
    {
        _DialogServiceCharges = true;
    }

    private void OpenTaxDialog()
    {
        _DialogTax = true;
    }

    private void OnCancel()
    {
        _DialogItemsDetails = false;
        _DialogServiceCharges = false;
        _DialogTax = false;
    }

    private async Task CalculateTotalNetAmountAsync()
    {
        double totalBillAmount = record.BillDetails.Sum(item => item.Item_Amount);

        // Apply Discount First
        double baseAmount = totalBillAmount - Convert.ToDouble(record.Bill.DiscountAmount);

        // Fetch Charges Based on Net of Discount
        var resServiceCharges = await Globals.GetServiceChargesAsync(DateTime.Now, baseAmount);
        var resTax = await Globals.GetTaxesAsync(DateTime.Now, baseAmount);

        ServiceCharges = resServiceCharges.Charges;
        ServiceChargesTotal = resServiceCharges.TotalAmount;

        Tax = resTax.Taxes;
        TaxTotal = resTax.TotalTaxAmount;

        TotalNetAmount = baseAmount + ServiceChargesTotal + TaxTotal;

        StateHasChanged();
    }


    private void DeleteItem(BillDetailModel item)
    {
        record.BillDetails.Remove(item);
        CalculateTotalNetAmountAsync();
    }


    private void Print()
    {
        var url = $"/BillReport/1/{Id}";                
        JS.InvokeVoidAsync("open", url, "_blank");
    }

    // ---------------------------------------------------------------- Item Dialog ----------------------------------------------------------------


    private void IncreaseQty(ItemsModel item)
    {
        item.Qty++;
        UpdateItemPrice(item);
    }

    private void DecreaseQty(ItemsModel item)
    {
        if (item.Qty > 1)
        {
            item.Qty--;
            UpdateItemPrice(item);
        }
    }

    private void OnServingSizeChanged(string selectedSize, ItemsModel item)
    {
        item.ServingSize = selectedSize;
        UpdateItemPrice(item);
    }

    private void UpdateItemPrice(ItemsModel item)
    {
        var selectedSize = item.ServingSizes?.FirstOrDefault(s => s.Size == item.ServingSize);
        if (selectedSize != null)
        {
            item.RetailPrice = Convert.ToDouble(selectedSize.Price) * item.Qty;
        }
    }


    // ---------------------------------------------------------------- Select Item ----------------------------------------------------------------
    private async Task AddItemDialogShow(int id)
    {
        FilterItems();

        string routeSuffix = id != 0 ? $"/Items.Id={id}" : string.Empty;
        var itm = await Functions.GetAsync<List<ItemsModel>>($"Items/Search{routeSuffix}", true) ?? new List<ItemsModel>();

        if (itm.Count == 0)
        {
            // Handle no item found
            SelectedItem = null;
            return;
        }

        SelectedItem = itm.FirstOrDefault()!;
        SelectedItem.Qty = 1;
        SelectedStockCondition = "NEW";
        searchText = string.Empty;

        // Clear previous serving sizes
        SelectedItem.ServingSizes = new List<ServingSizeModel>();

        if (!string.IsNullOrWhiteSpace(SelectedItem.ServingSize))
        {
            try
            {
                if (!string.IsNullOrWhiteSpace(SelectedItem.ServingSize))
                {
                    var sizes = JsonSerializer.Deserialize<List<ServingSizeModel>>(SelectedItem.ServingSize);
                    if (sizes?.Any() == true)
                    {
                        SelectedItem.ServingSizes = sizes;
                        SelectedItem.ServingSize = sizes.FirstOrDefault()?.Size ?? "Medium";
                    }
                    else
                    {
                        SelectedItem.ServingSizes = new List<ServingSizeModel>();
                        SelectedItem.ServingSize = "Medium"; 
                    }
                }
                else
                {
                    SelectedItem.ServingSizes = new List<ServingSizeModel>();
                    SelectedItem.ServingSize = "Medium"; 
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ServingSize deserialization failed: {ex.Message}");
                SelectedItem.ServingSizes = new List<ServingSizeModel>();
                SelectedItem.ServingSize = "Medium"; 
            }
        }

        _DialogItemsDetails = true;
    }

    private void FilterItems()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            FilteredItems = ItemsData;
        }
        else
        {
            FilteredItems = ItemsData
                .Where(item =>
                    (item.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (item.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (item.CategoryName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }

        SelectedItem = FilteredItems.FirstOrDefault()!;

    }

    private async Task AddBlankRow()
    {
        var firstItem = ItemsData.FirstOrDefault();
        if (firstItem == null) return;

        record.BillDetails.Add(new BillDetailModel
        {
            ItemId = firstItem.Id,
            Item = firstItem.Name!,
            ServingSize = firstItem.ServingSize,
            Qty = 1,
            UnitPrice = firstItem.RetailPrice,
            DiscountAmount = 0,
            TaxAmount = 0
        });

        await Task.Delay(10);
        StateHasChanged();
    }

    private void OnItemChanged(BillDetailModel row, int selectedItemId)
    {
        var item = ItemsData.FirstOrDefault(x => x.Id == selectedItemId);
        if (item == null) return;

        row.ItemId = item.Id;
        row.Item = item.Name!;
        row.UnitPrice = item.RetailPrice;
        row.ServingSize = item.ServingSize;
        row.TaxAmount = 0; 

        CalculateTotalNetAmountAsync();
    }

    private void AddToCart(ItemsModel selectedItem)
    {
        if (selectedItem == null) return;

        var row = new BillDetailModel
        {
            ItemId = selectedItem.Id,
            Item = selectedItem.Name!,
            UnitPrice = selectedItem.RetailPrice,
            ServingSize = selectedItem.ServingSize,
            Qty = selectedItem.Qty,
            DiscountAmount = 0,
            TaxAmount = 0
        };

        record.BillDetails.Add(row);
        CalculateTotalNetAmountAsync();
        _DialogItemsDetails = false;
    }


    private void AddItem()
    {

        // if (BillItems.ServingSize is null)
        // {
        //     var res = await Functions.ShowConfirmation(dialogService, "You havenot selected SERVINGSIZE, do you want to continue?");
        //     if (res == false)
        //         return;
        // }

        BillDetailModel BillItem = new();
        BillItem.ItemId = SelectedItem.Id;
        BillItem.Item= BillItems.Item;
        BillItem.ServingSize = BillItems.ServingSize;
        BillItem.StockCondition = BillItems.StockCondition;
        BillItem.Qty= BillItems.Qty;
        BillItem.UnitPrice= BillItems.UnitPrice;
        BillItem.DiscountAmount=BillItems.DiscountAmount;
        BillItem.TaxAmount = BillItems.TaxAmount;
        BillItem.Status = "COMPLETE";
        record.BillDetails.Add(BillItem);

        CalculateTotalNetAmountAsync();
        SelectedItem = null!;
        //_myDialogItemSelection!.Hide();
        StateHasChanged();

    }

    private void OnRowClick(TableRowClickEventArgs<ItemsModel> args)
    {
        var selectedItem = args.Item;
        Console.WriteLine($"Row clicked: {args.Item?.Name}");
        Select(selectedItem!);
    }


    private void Select(ItemsModel item)
    {
        if (item == null) return;

        SelectedServingSize = string.Empty;
        SelectedItem = item;
        //ItemsModel item = ItemsData.FirstOrDefault(x => x.Id == id)!;

        BillDetailModel New_Item = new()
        {
            Qty = 1,
            UnitPrice = item.RetailPrice,
            DiscountAmount = item.Discount,
            Item = item.Name!,
            Pic = item.Pic
        };

        BillItems = New_Item;

        PriceEnableDisable = item.IsInventoryItem == 1; 
        QtyEnableDisable = item.IsInventoryItem != 1;
        IsInventoryItem = item.IsInventoryItem == 0 ? false : true;

        ServingSizeOptions = null;
        ServiceSizeEnableDisable = false;
        SelectedServingSize = string.Empty;

        if (!string.IsNullOrWhiteSpace(item.ServingSize))
        {
            try
            {
                ServingSizeOptions = JsonSerializer.Deserialize<List<ServingSizeModel>>(item.ServingSize);
                if (ServingSizeOptions != null && ServingSizeOptions.Count > 0)
                {
                    ServiceSizeEnableDisable = true;
                }
            }
            catch
            {
                ServiceSizeEnableDisable = false;
            }
        }

        StateHasChanged();
    }


    private void OnServingSizeChanged(ChangeEventArgs e)
    {
        var selectedSize = e.Value?.ToString();
        SelectedServingSize = selectedSize!;

        var selectedOption = ServingSizeOptions?.FirstOrDefault(s => s.Size == selectedSize);
        if (selectedOption != null)
        {
            BillItems.UnitPrice = selectedOption.Price;
            BillItems.Pic = selectedOption.Pic;
            BillItems.ServingSize = selectedOption.Size;
            BillItems.StockCondition = SelectedStockCondition;
        }

        StateHasChanged();
    }


    // ---------------------------------------------------------------- Add Parties ----------------------------------------------------------------

    protected async Task AddParty()
    {
        await _drawerParty.OpenDrawerAsync();
    }

    // ---------------------------------------------------------------- Options ----------------------------------------------------------------

    private async Task Options()
    {
        await _drawer.OpenDrawerAsync();
    }


    // ---------------------------------------------------------------- Select Item ----------------------------------------------------------------


    private async void Save()
    {

        // LoadingPanel = true;



        if (record.Bill.PartyId == 0 || record.Bill.SalesId == 0 || record.Bill.TableId == 0)
        {
            //SnackbarService.Add($"Cannot Save Record. Please check Selected Customer, Sales Id or Table", Severity.Error);
            return;
        }

        Bill_And_Bill_Detail_Model BillHeader = new();
        var Action = "INSERT";

        if (Id != 0)
            Action = "UPDATE";

        //Bill Header
        record.Bill.Id = record.Bill.Id;
        record.Bill.OrganizationId = Globals.User.OrganizationId;
        record.Bill.Source = "MANUAL";
        record.Bill.LocationId = Globals.User.LocationId;
        record.Bill.CreatedBy = Globals.User.Id;
        record.Bill.CreatedOn = DateTime.Now;
        record.Bill.CreatedFrom = Functions.GetComputerDetails();
        record.Bill.UpdatedBy = Globals.User.Id;
        record.Bill.UpdatedOn = DateTime.Now;
        record.Bill.UpdatedFrom = Functions.GetComputerDetails();

        var result = await Functions.PostAsync<BillModel>($"Bill/{Action}", record, true);
        if (result.Success == false)
        {
            LoadingPanel = false;
            //SnackbarService.Add($"Record Save Fail.", Severity.Error);
        }
        else
        {
            LoadingPanel = false;
            //SnackbarService.Add($"Record Saved Successfully", Severity.Success);
            record.Bill.SeqNo = result.Result!.SeqNo;
            Id = result.Result.Id;
            Print();
        }

    }
}



<!-- Custom styling -->
<style>
    .app-bar {
        height: 56px;
    }

    .billing-table .mud-table-cell {
        font-size: 0.85rem;
        padding-top: 0.3rem;
        padding-bottom: 0.3rem;
    }
    .font-xs {
        font-size: 0.85rem;
    }

    .no-bottom-border input {
        border-bottom: none !important;
        box-shadow: none !important;
    }

    .no-bottom-border input:focus {
        outline: none;
    }

    .summary-grid .mud-input-input {
        text-align: right;
    }

    .item-card:hover {
        box-shadow: 0 0 10px rgba(0,0,0,.25);
        transform: translateY(-2px);
        transition: box-shadow .2s, transform .2s;
    }

    .truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .no-border input {
        border: none !important;
        background-color: transparent;
    }

    .summary-label {
        white-space: nowrap;
        display: flex;
        align-items: center;
        font-weight: 600;
    }

    .summary-icon {
        height: 24px;
        width: 24px;
        padding: 2px;
        margin-right: 6px;
    }

    .summary-row {
        padding: 0px 8px;
       /*  border: 0.5px solid lightgray; */
    }

    .summary-col {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        white-space: nowrap;
        padding: 4px 8px;
        border: 0.5px solid lightgray;
    }

    .summary-value {
        text-align: right;
        width: 100%;
    }

</style>