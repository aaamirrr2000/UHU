@page "/BackupPage"
@using Microsoft.AspNetCore.Components
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject Functions Functions
@inject Globals Globals

<PageTitle>System Backup</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>System Backup</h2>
            <p class="text-muted">Create a complete backup of your database and images folder</p>
        </div>
    </div>

    <!-- Full Backup Card -->
    <div class="row mt-4">
        <div class="col-md-6 offset-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-database me-2"></i>
                        System Backup
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Create a complete backup including:</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Database Export</li>
                        <li><i class="fas fa-check text-success me-2"></i>Images Folder (Compressed ZIP)</li>
                        <li><i class="fas fa-check text-success me-2"></i>Automatic Timestamp</li>
                        <li><i class="fas fa-check text-success me-2"></i>Backup Verification</li>
                        <li><i class="fas fa-check text-success me-2"></i>Email Backup</li>
                        <li><i class="fas fa-check text-success me-2"></i>FTP Backup</li>
                    </ul>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> This process may take several minutes depending on your data size.
                    </div>
                    
                    <div style="display: flex;">
                        <MudSwitch @bind-Value="Email" Color="Color.Primary" Label="Send Backup to Email" />
                        <MudSwitch @bind-Value="Ftp" Color="Color.Primary" Label="Save Backup to FTP Server" />
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary btn-lg w-100" @onclick="CreateFullBackup" disabled="@isBackupInProgress">
                        @if (isBackupInProgress)
                        {
                            <span>
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Creating Backup... Please Wait
                            </span>
                        }
                        else
                        {
                            <span>
                                <i class="fas fa-download me-2"></i>
                                Create Backup
                            </span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert @alertClass alert-dismissible fade show" role="alert">
                    <h5 class="alert-heading">
                        @if (alertClass.Contains("success"))
                        {
                            <i class="fas fa-check-circle me-2">Success!</i>
                            
                                            }
                        else if (alertClass.Contains("danger"))
                        {
                            <i class="fas fa-exclamation-triangle me-2">Error!</i>
                            
                                        }
                        else
                        {
                            <i class="fas fa-info-circle me-2">Information</i>
                            
                        }
                    </h5>
                    @statusMessage
                    <button type="button" class="btn-close" @onclick="ClearStatus"></button>
                </div>
            </div>
        </div>
    }

    <!-- Backup Results -->
    @if (lastBackupResult != null)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Last Backup Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Status:</strong>
                                @if (lastBackupResult.Success)
                                {
                                    <span class="badge bg-success">Success</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Failed</span>
                                }
                            </div>
                            <div class="col-md-6">
                                <strong>Timestamp:</strong> @lastBackupResult.Timestamp
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <strong>Message:</strong> @lastBackupResult.Message
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(lastBackupResult.Error))
                        {
                            <div class="row mt-2">
                                <div class="col-12">
                                    <strong>Error:</strong>
                                    <span class="text-danger">@lastBackupResult.Error</span>
                                </div>
                            </div>
                        }
                        @if (lastBackupResult.Details != null)
                        {
                            <div class="row mt-2">
                                <div class="col-12">
                                    <strong>Backup Files Created:</strong>
                                    <ul class="mt-1">
                                        @if (lastBackupResult.Details is System.Text.Json.JsonElement jsonElement)
                                        {
                                            @if (jsonElement.TryGetProperty("DatabaseBackup", out var dbBackup) && dbBackup.ValueKind != System.Text.Json.JsonValueKind.Null)
                                            {
                                                <li>
                                                    <strong>Database:</strong>
                                                    <code>@System.IO.Path.GetFileName(dbBackup.GetString())</code>
                                                </li>
                                            }
                                            @if (jsonElement.TryGetProperty("ImagesBackup", out var imagesBackup) && imagesBackup.ValueKind != System.Text.Json.JsonValueKind.Null)
                                            {
                                                <li>
                                                    <strong>Images:</strong>
                                                    <code>@System.IO.Path.GetFileName(imagesBackup.GetString())</code>
                                                </li>
                                            }
                                        }
                                    </ul>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isBackupInProgress = false;
    private string statusMessage = string.Empty;
    private string alertClass = "alert-info";
    private BackupResult? lastBackupResult;

    public bool Email { get; set; }=true;
    public bool Ftp { get; set; } = true;

    @inject ISnackbar SnackbarService

    private async Task CreateFullBackup()
    {
        try
        {
            isBackupInProgress = true;
            statusMessage = "Backup process started... This may take several minutes.";
            StateHasChanged();

            var result = await Functions.PostAsync<BackupResult>($"Backup/Create?Email={Email}&ftp={Ftp}", null, true);

            if (result.Success)
            {
                    statusMessage = $"Backup completed successfully!";
                    SnackbarService.Add(statusMessage, Severity.Success);
            }
            else
            {
                statusMessage = "Backup failed: No response from server. Please check if the backup service is running.";
                SnackbarService.Add(statusMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error during backup: {ex.Message}";
            SnackbarService.Add(statusMessage, Severity.Error);
        }
        finally
        {
            isBackupInProgress = false;
            StateHasChanged();
        }
    }

    private async Task<BackupResult?> CreateBackupWithHttpClient()
    {
        try
        {
            using var httpClient = new HttpClient
            {
                BaseAddress = new Uri(Navigation.BaseUri)
            };

            if (!string.IsNullOrEmpty(Globals.Token))
            {
                httpClient.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Globals.Token);
            }

            var response = await httpClient.PostAsync("api/backup/create", null);

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                if (!string.IsNullOrEmpty(content))
                {
                    return System.Text.Json.JsonSerializer.Deserialize<BackupResult>(content, new System.Text.Json.JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                return new BackupResult
                {
                    Success = false,
                    Error = $"HTTP {response.StatusCode}: {errorContent}"
                };
            }
        }
        catch (Exception ex)
        {
            return new BackupResult
            {
                Success = false,
                Error = ex.Message
            };
        }

        return null;
    }

    private void ClearStatus()
    {
        statusMessage = string.Empty;
        lastBackupResult = null;
        StateHasChanged();
    }
}