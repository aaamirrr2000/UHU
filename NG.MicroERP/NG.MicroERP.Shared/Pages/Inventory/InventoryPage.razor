@page "/InventoryPage/{Action}/{CurrentRecord?}"
@using NG.MicroERP.Shared.Models

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<div class="d-flex flex-column" style="margin: 5px; height: 80vh;">
    <div class="text-end" style="margin-top:10px;">
        <MudAlert Severity="Severity.Info" Class="mb-3">
            <MudText Typo="Typo.body2">
                <strong>Note:</strong> Inventory is automatically maintained through transactions. 
                Use Purchase Invoices to receive stock, Sale Invoices to issue stock, and Stock Movements to transfer between locations.
                You can only update Reorder Level, Max Level, and Reserved Quantity here.
            </MudText>
        </MudAlert>
        
        @if (Action != "VIEW")
        {
            @if (Action == "UPDATE")
            {
                <MudButton Variant="Variant.Filled" OnClick="Save" Color="Color.Info" Class="px-2 py-2 mt-1 mr-2" Style="height:40px; width: 100px;">
                    <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                    Update Settings
                </MudButton>
            }
        }
    </div>

    <br />

    <MudExpansionPanels MultiExpansion="true">
        <MudExpansionPanel Text="Inventory Information" Expanded="true" Style="margin-bottom:10px;">
            <TitleContent>
                <div class="d-flex align-items-center p-2 rounded" style="gap: 10px;">
                    <i class="fa fa-boxes" style="display:inline-block; width:40px; height:40px; font-size:24px; line-height:40px; text-align:center; border-radius:5%;"></i>
                    <div class="ms-2">
                        <MudText Typo="Typo.h6" Class="fw-bold">@(string.IsNullOrWhiteSpace(record.DisplayName) ? "NEW INVENTORY" : record.DisplayName)</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">Inventory stock level information</MudText>
                    </div>
                </div>
                <hr style="height: 6px; border: none; background: #4CAF50; border-radius: 10px;" />
            </TitleContent>

            <ChildContent>
                <div class="row" style="width:100%; display: flex;">
                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Location</label>
                        <MudTextField Value="@(Locations.FirstOrDefault(l => l.Id == record.LocationId)?.Name ?? "")"
                                      Variant="Variant.Outlined"
                                      FullWidth="@true"
                                      ReadOnly="@true" />
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Item</label>
                        <MudTextField Value="@(Items.FirstOrDefault(i => i.Id == record.ItemId)?.DisplayName ?? "")"
                                      Variant="Variant.Outlined"
                                      FullWidth="@true"
                                      ReadOnly="@true" />
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Stock Condition</label>
                        <MudTextField Value="@(record.StockCondition ?? "NEW")"
                                      Variant="Variant.Outlined"
                                      FullWidth="@true"
                                      ReadOnly="@true" />
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Quantity</label>
                        <MudNumericField @bind-Value="record.Quantity"
                                         Variant="Variant.Outlined"
                                         ReadOnly="@true"
                                         Format="#,##0.00"
                                         FullWidth="@true" />
                        <MudText Typo="Typo.caption" Class="text-muted">Calculated from transactions</MudText>
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Reserved Quantity</label>
                        <MudNumericField @bind-Value="record.ReservedQuantity"
                                         Variant="Variant.Outlined"
                                         ReadOnly="@isReadOnly"
                                         Format="#,##0.00"
                                         FullWidth="@true" />
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Average Cost</label>
                        <MudNumericField @bind-Value="record.AverageCost"
                                         Variant="Variant.Outlined"
                                         ReadOnly="@true"
                                         Format="#,##0.00"
                                         FullWidth="@true" />
                        <MudText Typo="Typo.caption" Class="text-muted">Calculated from transactions</MudText>
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Last Cost</label>
                        <MudNumericField @bind-Value="record.LastCost"
                                         Variant="Variant.Outlined"
                                         ReadOnly="@true"
                                         Format="#,##0.00"
                                         FullWidth="@true" />
                        <MudText Typo="Typo.caption" Class="text-muted">From last transaction</MudText>
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Reorder Level</label>
                        <MudNumericField @bind-Value="record.ReorderLevel"
                                         Variant="Variant.Outlined"
                                         ReadOnly="@isReadOnly"
                                         Format="#,##0.00"
                                         FullWidth="@true" />
                    </div>

                    <div class="col-12 col-md-6 mb-3 d-flex flex-column" style="height: 95px;">
                        <label class="form-label fw-bold mb-1">Max Level</label>
                        <MudNumericField @bind-Value="record.MaxLevel"
                                         Variant="Variant.Outlined"
                                         ReadOnly="@isReadOnly"
                                         Format="#,##0.00"
                                         FullWidth="@true" />
                    </div>
                </div>
            </ChildContent>
        </MudExpansionPanel>
    </MudExpansionPanels>
</div>

@code
{
    InventoryModel record = new();
    List<LocationsModel> Locations = new();
    List<ItemsModel> Items = new();

    [Parameter] public string Action { get; set; } = "INSERT";
    [Parameter] public int CurrentRecord { get; set; } = 0;
    [Parameter] public EventCallback OnSaved { get; set; }

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        Globals.AccessLevel = Globals.PageAccess(NavManager, "InventoryDashboard");
        await GetAll();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        GetDefaultValues();
    }

    protected async Task GetAll()
    {
        LoadingPanel = true;
        Locations = await Functions.GetAsync<List<LocationsModel>>($"Locations/Search", true) ?? new List<LocationsModel>();
        Items = await Functions.GetAsync<List<ItemsModel>>($"Items/Search", true) ?? new List<ItemsModel>();

        if (Action == "INSERT")
        {
            // Inventory cannot be created directly - redirect to view mode
            Action = "VIEW";
            record = new InventoryModel();
            isReadOnly = true;
        }
        else if (Action == "UPDATE")
        {
            await Get(CurrentRecord);
            isReadOnly = false; // Allow editing reorder/max levels only
        }
        else if (Action == "VIEW")
        {
            await Get(CurrentRecord);
            isReadOnly = true;
        }

        LoadingPanel = false;
    }

    protected async Task Get(int id)
    {
        LoadingPanel = true;
        record = await Functions.GetAsync<InventoryModel>($"Inventory/Get/{id}", true) ?? new InventoryModel();
        LoadingPanel = false;
    }

    protected void GetDefaultValues()
    {
        StateHasChanged();
    }

    protected async Task Save()
    {
        record.OrganizationId = Globals.User.OrganizationId;
        record.CreatedBy = Globals.User.Id;
        record.CreatedOn = DateTime.Now;
        record.CreatedFrom = Globals.ClientInfo;
        record.UpdatedBy = Globals.User.Id;
        record.UpdatedOn = DateTime.Now;
        record.UpdatedFrom = Globals.ClientInfo;

        LoadingPanel = true;
        var result = await Functions.PostAsync<InventoryModel>($"Inventory/{Action}", record, true);
        LoadingPanel = false;

        if (result.Success == false || result.Result == null)
        {
            SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
        }
        else
        {
            SnackbarService.Add($"Record {Action} Successfully", Severity.Success);
            await OnSaved.InvokeAsync();
        }
    }

    protected async Task Delete()
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete existing record?");
        if (res == false)
            return;

        LoadingPanel = true;
        var result = await Functions.PostAsync<InventoryModel>($"Inventory/SOFTDELETE", record, true);
        LoadingPanel = false;

        if (result.Success == false)
        {
            SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
        }
        else
        {
            SnackbarService.Add("Record Deleted Successfully", Severity.Success);
            await OnSaved.InvokeAsync();
        }
    }
}

