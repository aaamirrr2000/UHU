@page "/Error"
@using System.Diagnostics
@using NG.ControlCenter.WebSite.Services
@inject NavigationManager NavigationManager
@inject IStateService StateService

<PageTitle>Error</PageTitle>

<div class="error-container">
    <div class="error-content">
        <div class="error-icon">⚠️</div>
        <h1 class="text-danger">Oops! An Error Occurred</h1>
        
        <div class="error-message">
            <p>We encountered an unexpected issue while processing your request.</p>
            
            @if (ShowRequestId)
            {
                <div class="request-info">
                    <strong>Request ID:</strong> 
                    <code>@RequestId</code>
                    <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="CopyRequestId">
                        Copy
                    </button>
                </div>
            }
        </div>

        <div class="error-details">
            <MudExpansionPanels>
                <MudExpansionPanel Text="Development Details" Dense="true">
                    <p>
                        To see detailed error information for debugging, set the <strong>ASPNETCORE_ENVIRONMENT</strong> 
                        environment variable to <strong>Development</strong> and restart the application.
                    </p>
                    <MudAlert Severity="Severity.Warning" Dense="true">
                        <strong>Security Note:</strong> Development mode may expose sensitive information. 
                        Never enable it in production!
                    </MudAlert>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </div>

        <div class="error-actions mt-4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoHome">
                🏠 Go Home
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="GoBack" class="ms-2">
                ← Go Back
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="RefreshPage" class="ms-2">
                🔄 Refresh Page
            </MudButton>
        </div>

        @if (!string.IsNullOrEmpty(PreviousUrl))
        {
            <div class="mt-3">
                <small class="text-muted">
                    Previous page: @PreviousUrl
                </small>
            </div>
        }
    </div>
</div>

<style>
    .error-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        padding: 2rem;
    }

    .error-content {
        text-align: center;
        max-width: 600px;
    }

    .error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .error-message {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }

    .request-info {
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0.75rem;
        margin-top: 1rem;
        word-break: break-all;
        font-size: 0.85rem;
    }

    .error-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
</style>

@code {
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private string? RequestId { get; set; }
    private string? PreviousUrl { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    protected override void OnInitialized()
    {
        RequestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;
    }

    protected override async Task OnInitializedAsync()
    {
        // Try to load previous URL from state
        if (StateService != null)
        {
            PreviousUrl = await StateService.LoadStateAsync<string>("last_url");
        }
    }

    private void GoHome()
    {
        NavigationManager.NavigateTo("/", forceLoad: false);
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("javascript:history.back()", forceLoad: false);
    }

    private void RefreshPage()
    {
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

    private async Task CopyRequestId()
    {
        if (!string.IsNullOrEmpty(RequestId))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", RequestId);
        }
    }

    [Inject]
    private IJSRuntime? JSRuntime { get; set; }
}

