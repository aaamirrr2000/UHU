@page "/login"
@using MudBlazor
@using Microsoft.Extensions.ServiceDiscovery
@inject IConfiguration Configuration
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Login - MicroERP</PageTitle>

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6" Style="color: #1976d2; font-weight: 700;">
            Sign In
        </MudText>

        <MudText Align="Align.Center" Class="mb-6" Style="color: #666;">
            Sign in to access your ERP system
        </MudText>

        <EditForm Model="@model" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <MudStack Spacing="4">
                <MudTextField Value="@model.Username"
                              ValueChanged="@((string v) => model.Username = v?.ToUpper() ?? string.Empty)"
                              Label="Username"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Username is required"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Person"
                              FullWidth="true" />

                <MudTextField @bind-Value="model.Password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              InputType="@InputType.Password"
                              Required="true"
                              RequiredError="Password is required"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Lock"
                              FullWidth="true" />

                <MudButton ButtonType="ButtonType.Submit"
                          Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          Size="Size.Large"
                          Disabled="@isLoading"
                          Class="mt-4">
                    @if (isLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Signing In...</MudText>
                    }
                    else
                    {
                        <MudText>Sign In</MudText>
                    }
                </MudButton>

                <MudText Align="Align.Center" Class="mt-4">
                    Don't have an account? <MudLink Href="/register" Color="Color.Primary">Sign up</MudLink>
                </MudText>
            </MudStack>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private LoginModel model = new();
    private bool isLoading = false;

    private string GetApiBaseUrl()
    {
        // In Aspire, service discovery is handled automatically via HttpClient
        // The service name "nexgen-api-service" will be resolved by Aspire
        return "http://nexgen-api-service/api";
    }

    private async Task HandleLogin()
    {
        isLoading = true;

        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            var apiUrl = GetApiBaseUrl();
            
            // Convert username to uppercase
            var username = model.Username?.ToUpper() ?? string.Empty;
            
            var response = await httpClient.GetAsync($"{apiUrl}/Login/Login/{Uri.EscapeDataString(username)}/{Uri.EscapeDataString(model.Password)}");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                
                if (result != null && !string.IsNullOrEmpty(result.Token))
                {
                    Snackbar.Add("Login successful! Redirecting...", Severity.Success);
                    
                    await Task.Delay(1000);
                    
                    // Redirect to the main ERP application login page
                    // The user will need to login again with their credentials in the main app
                    // Or you can pass the token if you implement token sharing
                    var erpAppUrl = Configuration["ErpAppUrl"] ?? "http://nexgen-api-webapp";
                    Navigation.NavigateTo(erpAppUrl, forceLoad: true);
                }
                else
                {
                    Snackbar.Add("Invalid username or password", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Invalid username or password", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    public class LoginResponse
    {
        public int Id { get; set; }
        public string? Username { get; set; }
        public string? Token { get; set; }
    }
}
