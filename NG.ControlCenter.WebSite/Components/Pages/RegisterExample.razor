@page "/register"
@using NG.ControlCenter.WebSite.Models
@using NG.ControlCenter.WebSite.Services
@inject IStateService StateService
@inject NavigationManager NavigationManager
@inject INotificationService NotificationService

<PageTitle>Register - MicroERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudPaper Class="pa-6" Elevation="2">
        <MudText Typo="Typo.h4" Class="mb-4" Align="Align.Center">
            Create Account
        </MudText>

        <EditForm Model="registerModel" OnSubmit="HandleRegisterAsync" OnInvalidSubmit="HandleInvalidSubmit">
            <DataAnnotationsValidator />
            
            @if (ShowValidationSummary)
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    <ValidationSummary />
                </MudAlert>
            }

            <MudTextField 
                @bind-Value="registerModel.Email" 
                Label="Email" 
                Type="InputType.Email"
                Required="true"
                For="@(() => registerModel.Email)"
                Class="mb-4"
                Clearable="true" />

            <MudTextField 
                @bind-Value="registerModel.FirstName" 
                Label="First Name" 
                Required="true"
                For="@(() => registerModel.FirstName)"
                Class="mb-4"
                Clearable="true" />

            <MudTextField 
                @bind-Value="registerModel.LastName" 
                Label="Last Name" 
                Required="true"
                For="@(() => registerModel.LastName)"
                Class="mb-4"
                Clearable="true" />

            <MudTextField 
                @bind-Value="registerModel.Password" 
                Label="Password" 
                Type="InputType.Password"
                Required="true"
                For="@(() => registerModel.Password)"
                Class="mb-4"
                HelperText="Minimum 8 characters with uppercase, lowercase, number, and special character" />

            <MudTextField 
                @bind-Value="registerModel.ConfirmPassword" 
                Label="Confirm Password" 
                Type="InputType.Password"
                Required="true"
                For="@(() => registerModel.ConfirmPassword)"
                Class="mb-4" />

            <MudCheckBox 
                @bind-Checked="registerModel.AcceptTerms" 
                For="@(() => registerModel.AcceptTerms)"
                Label="I accept the Terms and Conditions"
                Required="true"
                Class="mb-6" />

            <MudButton 
                ButtonType="ButtonType.Submit" 
                Variant="Variant.Filled" 
                Color="Color.Primary" 
                FullWidth="true"
                Loading="isLoading"
                Disabled="isLoading">
                Create Account
            </MudButton>
        </EditForm>

        <MudDivider Class="my-4" />

        <MudText Align="Align.Center">
            Already have an account? 
            <MudLink Href="/login">Sign In</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private RegisterModel registerModel = new();
    private bool isLoading = false;
    private bool ShowValidationSummary = false;

    protected override async Task OnInitializedAsync()
    {
        // Try to restore form state if user had unsaved data
        var savedData = await StateService.LoadStateAsync<RegisterModel>("register_form");
        if (savedData != null)
        {
            registerModel = savedData;
            NotificationService.ShowInfo("Form data restored from previous session");
        }
    }

    private async Task HandleRegisterAsync()
    {
        try
        {
            isLoading = true;
            ShowValidationSummary = false;

            // Clear saved form data on successful submission
            await StateService.RemoveStateAsync("register_form");

            // TODO: Call API to register
            // var response = await AuthService.RegisterAsync(registerModel);

            NotificationService.ShowSuccess("Registration successful! Please sign in.");
            NavigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Registration failed", ex.Message);
            // Save form data for recovery
            await StateService.SaveStateAsync("register_form", registerModel);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleInvalidSubmit()
    {
        ShowValidationSummary = true;
        // Save form data so user doesn't lose it
        await StateService.SaveStateAsync("register_form", registerModel);
    }
}
