@page "/register"
@using MudBlazor
@using Microsoft.Extensions.ServiceDiscovery
@inject IConfiguration Configuration
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Register - MicroERP</PageTitle>

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6" Style="color: #1976d2; font-weight: 700;">
            Create Your Account
        </MudText>

        <EditForm Model="@model" OnValidSubmit="HandleRegister">
            <DataAnnotationsValidator />
            <MudStack Spacing="4">
                <MudTextField Value="@model.FullName"
                              ValueChanged="@((string v) => model.FullName = v?.ToUpper() ?? string.Empty)"
                              Label="Full Name"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Full name is required"
                              FullWidth="true" />

                <MudTextField @bind-Value="model.Email"
                              Label="Email Address"
                              Variant="Variant.Outlined"
                              InputType="InputType.Email"
                              Required="true"
                              RequiredError="Email is required"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              FullWidth="true"
                              OnBlur="CheckEmail" />

                @if (emailExists)
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        This email is already registered. Please use a different email or <MudLink Href="/login">sign in</MudLink>.
                    </MudAlert>
                }

                <MudTextField @bind-Value="model.Phone"
                              Label="Phone Number (Optional)"
                              Variant="Variant.Outlined"
                              InputType="@InputType.Text"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Phone"
                              FullWidth="true" />

                <MudTextField @bind-Value="model.Password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              InputType="@InputType.Password"
                              Required="true"
                              RequiredError="Password is required"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Lock"
                              FullWidth="true" />

                <MudTextField @bind-Value="confirmPassword"
                              Label="Confirm Password"
                              Variant="Variant.Outlined"
                              InputType="@InputType.Password"
                              Required="true"
                              RequiredError="Please confirm your password"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Lock"
                              FullWidth="true" />

                @if (!string.IsNullOrEmpty(passwordError))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-2">@passwordError</MudAlert>
                }

                <MudButton ButtonType="ButtonType.Submit"
                          Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          Size="Size.Large"
                          Disabled="@(isLoading || emailExists)"
                          Class="mt-4">
                    @if (isLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Creating Account...</MudText>
                    }
                    else
                    {
                        <MudText>Create Account</MudText>
                    }
                </MudButton>

                <MudText Align="Align.Center" Class="mt-4">
                    Already have an account? <MudLink Href="/login" Color="Color.Primary">Sign in</MudLink>
                </MudText>
            </MudStack>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private ControlCenterUserRegistrationModel model = new();
    private string confirmPassword = string.Empty;
    private bool isLoading = false;
    private bool emailExists = false;
    private string passwordError = string.Empty;

    private string GetApiBaseUrl()
    {
        // In Aspire, service discovery is handled automatically via HttpClient
        // The service name "nexgen-api-service" will be resolved by Aspire
        return "http://nexgen-api-service/api";
    }

    private async Task CheckEmail()
    {
        if (string.IsNullOrEmpty(model.Email) || !IsValidEmail(model.Email))
            return;

        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            var apiUrl = GetApiBaseUrl();
            var response = await httpClient.PostAsJsonAsync($"{apiUrl}/WebsiteRegistration/CheckEmail", new { Email = model.Email });
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<CheckEmailResponse>();
                emailExists = result?.Exists ?? false;
            }
        }
        catch
        {
            // Silently fail - don't block registration
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private async Task HandleRegister()
    {
        passwordError = string.Empty;
        emailExists = false;

        if (model.Password != confirmPassword)
        {
            passwordError = "Passwords do not match";
            return;
        }

        if (model.Password.Length < 6)
        {
            passwordError = "Password must be at least 6 characters long";
            return;
        }

        // Convert text fields to uppercase before saving (except email)
        model.FullName = model.FullName?.ToUpper() ?? string.Empty;
        // Keep email in original case
        if (!string.IsNullOrEmpty(model.Phone))
        {
            model.Phone = model.Phone.ToUpper();
        }

        isLoading = true;

        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            var apiUrl = GetApiBaseUrl();
            
            // Create user in main application database using website registration endpoint
            var response = await httpClient.PostAsJsonAsync($"{apiUrl}/WebsiteRegistration/Register", model);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<RegisterResponse>();
                Snackbar.Add("Account created successfully! Redirecting to organization setup...", Severity.Success);
                
                await Task.Delay(1500);
                Navigation.NavigateTo($"/create-organization?userId={result?.UserId}");
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Registration failed: {errorMessage}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class ControlCenterUserRegistrationModel
    {
        public string FullName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? Phone { get; set; }
        public string Password { get; set; } = string.Empty;
    }

    public class CheckEmailResponse
    {
        public bool Exists { get; set; }
    }

    public class RegisterResponse
    {
        public int UserId { get; set; }
        public string Message { get; set; } = string.Empty;
    }
}
