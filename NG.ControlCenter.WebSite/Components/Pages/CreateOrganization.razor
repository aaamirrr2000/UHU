@page "/create-organization"
@using MudBlazor
@using Microsoft.Extensions.ServiceDiscovery
@inject IConfiguration Configuration
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Create Organization - MicroERP</PageTitle>

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6" Style="color: #1976d2; font-weight: 700;">
            Create Your Organization
        </MudText>

        <MudText Align="Align.Center" Class="mb-6" Style="color: #666;">
            Set up your organization to start using MicroERP
        </MudText>

        <EditForm Model="@model" OnValidSubmit="HandleCreateOrganization">
            <DataAnnotationsValidator />
            <MudStack Spacing="4">
                <MudTextField Value="@model.OrganizationName"
                              ValueChanged="@((string v) => model.OrganizationName = v?.ToUpper() ?? string.Empty)"
                              Label="Organization Name"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Organization name is required"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Business"
                              FullWidth="true" />

                <MudTextField @bind-Value="model.Email"
                              Label="Organization Email (Optional)"
                              Variant="Variant.Outlined"
                              InputType="InputType.Email"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              FullWidth="true" />

                <MudTextField @bind-Value="model.Phone"
                              Label="Organization Phone (Optional)"
                              Variant="Variant.Outlined"
                              InputType="@InputType.Text"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Phone"
                              FullWidth="true" />

                <MudButton ButtonType="ButtonType.Submit"
                          Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          Size="Size.Large"
                          Disabled="@isLoading"
                          Class="mt-4">
                    @if (isLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Creating Organization...</MudText>
                    }
                    else
                    {
                        <MudText>Create Organization</MudText>
                    }
                </MudButton>
            </MudStack>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private CreateOrganizationModel model = new();
    private bool isLoading = false;
    private int userId = 0;

    private string GetApiBaseUrl()
    {
        // In Aspire, service discovery is handled automatically via HttpClient
        // The service name "nexgen-api-service" will be resolved by Aspire
        return "http://nexgen-api-service/api";
    }

    protected override void OnInitialized()
    {
        // Get userId from query string
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("userId", out var userIdParam))
        {
            int.TryParse(userIdParam, out userId);
            model.OwnerUserId = userId;
        }

        if (userId == 0)
        {
            Snackbar.Add("Invalid user session. Please register again.", Severity.Error);
            Navigation.NavigateTo("/register");
        }
    }

    private async Task HandleCreateOrganization()
    {
        if (model.OwnerUserId == 0)
        {
            Snackbar.Add("Invalid user session. Please register again.", Severity.Error);
            Navigation.NavigateTo("/register");
            return;
        }

        // Convert text fields to uppercase before saving
        model.OrganizationName = model.OrganizationName?.ToUpper() ?? string.Empty;
        if (!string.IsNullOrEmpty(model.Email))
        {
            model.Email = model.Email.ToUpper();
        }
        if (!string.IsNullOrEmpty(model.Phone))
        {
            model.Phone = model.Phone.ToUpper();
        }

        isLoading = true;

        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            var apiUrl = GetApiBaseUrl();
            var response = await httpClient.PostAsJsonAsync($"{apiUrl}/ControlCenterOrganizations/Create", model);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<CreateOrganizationResponse>();
                Snackbar.Add("Organization created successfully!", Severity.Success);
                
                await Task.Delay(1500);
                Snackbar.Add("Your account is ready! You can now log in to your ERP system.", Severity.Info);
                
                await Task.Delay(2000);
                Navigation.NavigateTo("/");
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to create organization: {errorMessage}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class CreateOrganizationModel
    {
        public int OwnerUserId { get; set; }
        public string OrganizationName { get; set; } = string.Empty;
        public string? Email { get; set; }
        public string? Phone { get; set; }
    }

    public class CreateOrganizationResponse
    {
        public int OrganizationId { get; set; }
        public string Message { get; set; } = string.Empty;
    }
}
