<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:MicroERP.App.SwiftServe.Components.MauiPages.Controls"
             x:Class="MicroERP.App.SwiftServe.Components.MauiPages.GenerateBillPage"
             x:Name="Page"
             Title="Final Bill"
             BackgroundColor="#F5F5F5">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="PrimaryColor">#512BD4</Color>
            <Color x:Key="WhiteColor">#FFFFFF</Color>
            <Color x:Key="TextPrimary">#212121</Color>
            <Color x:Key="TextSecondary">#666666</Color>
            <Color x:Key="SuccessColor">#28a745</Color>
            <Color x:Key="BorderColor">#E0E0E0</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*">
        <controls:NavigationMenu x:Name="NavMenu" Grid.Row="0" Grid.RowSpan="2" ZIndex="1000"/>
        <ScrollView Grid.Row="0">
            <StackLayout Spacing="12" Padding="12" Margin="0,0,0,24">
                <!-- Header -->
                <Frame BackgroundColor="{StaticResource PrimaryColor}" CornerRadius="12" Padding="16" Margin="0,0,0,8" HasShadow="True">
                    <StackLayout Spacing="8">
                        <Button Text="← Back" Clicked="OnBackClicked" BackgroundColor="#E0FFFFFF" TextColor="{StaticResource PrimaryColor}"
                                FontSize="14" Padding="12,8" HorizontalOptions="Start"/>
                        <Label Text="Final Bill" FontSize="22" FontAttributes="Bold" TextColor="{StaticResource WhiteColor}"/>
                        <Label x:Name="BillCodeLabel" Text="{Binding BillCode}" FontSize="16" TextColor="#E0FFFFFF"/>
                        <Label x:Name="TableLabel" Text="{Binding TableInfo}" FontSize="14" TextColor="#E0FFFFFF"/>
                    </StackLayout>
                </Frame>

                <!-- Line items -->
                <Frame BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                       CornerRadius="12" Padding="14" HasShadow="True">
                    <StackLayout Spacing="10">
                        <Label Text="Items" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                        <CollectionView x:Name="DetailsList" ItemsSource="{Binding BillDetails}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="*,Auto,Auto" Padding="0,6" ColumnSpacing="8">
                                        <Label Text="{Binding Item}" FontSize="14" TextColor="{StaticResource TextPrimary}" Grid.Column="0"/>
                                        <Label Text="{Binding Qty}" FontSize="14" TextColor="{StaticResource TextSecondary}" Grid.Column="1"/>
                                        <Label Text="{Binding UnitPrice, StringFormat='{0:N2}'}" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" Grid.Column="2"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <BoxView HeightRequest="1" Color="{StaticResource BorderColor}" Margin="0,8,0,4"/>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Subtotal" FontSize="15" TextColor="{StaticResource TextSecondary}" Grid.Column="0"/>
                            <Label Text="{Binding SubTotal, StringFormat='{0:N2}'}" FontSize="15" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" Grid.Column="1"/>
                        </Grid>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Paid" FontSize="15" TextColor="{StaticResource TextSecondary}" Grid.Column="0"/>
                            <Label Text="{Binding PaidTotal, StringFormat='{0:N2}'}" FontSize="15" FontAttributes="Bold" TextColor="{StaticResource SuccessColor}" Grid.Column="1"/>
                        </Grid>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Balance due" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" Grid.Column="0"/>
                            <Label Text="{Binding TotalDue, StringFormat='{0:N2}'}" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource PrimaryColor}" Grid.Column="1"/>
                        </Grid>
                    </StackLayout>
                </Frame>

                <!-- Existing payments -->
                <Frame BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                       CornerRadius="12" Padding="14" HasShadow="True">
                    <StackLayout Spacing="8">
                        <Label Text="Payments received" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                        <CollectionView ItemsSource="{Binding ExistingPayments}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="*,Auto" Padding="0,4">
                                        <Label Text="Payment" FontSize="13" TextColor="{StaticResource TextSecondary}" Grid.Column="0"/>
                                        <Label Text="{Binding Amount, StringFormat='{0:N2}'}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" Grid.Column="1"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Add payments -->
                <Frame BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                       CornerRadius="12" Padding="14" HasShadow="True">
                    <StackLayout Spacing="12">
                        <Label Text="Add payment" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                        <CollectionView ItemsSource="{Binding PaymentRows}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame BackgroundColor="#FAFAFA" BorderColor="#EEEEEE" CornerRadius="8" Padding="10" Margin="0,0,0,8" HasShadow="False">
                                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="8">
                                            <Picker Grid.Row="0" Grid.ColumnSpan="2" Title="Payment method"
                                                    ItemsSource="{Binding Source={x:Reference Page}, Path=PaymentMethods}"
                                                    ItemDisplayBinding="{Binding Name}"
                                                    SelectedItem="{Binding SelectedMethod}"
                                                    FontSize="14"/>
                                            <Entry Grid.Row="1" Grid.Column="0" Placeholder="Amount" Keyboard="Numeric"
                                                   Text="{Binding AmountText}" FontSize="14"/>
                                            <Button Grid.Row="1" Grid.Column="1" Text="✕" Clicked="OnRemovePayment"
                                                    BackgroundColor="#dc3545" TextColor="White" Padding="12,0"
                                                    BindingContext="{Binding .}"/>
                                            <Entry Grid.Row="2" Grid.ColumnSpan="2" Placeholder="Ref (optional)"
                                                   Text="{Binding PaymentRef}" FontSize="13"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <Button Text="+ Add payment" Clicked="OnAddPayment" BackgroundColor="{StaticResource BorderColor}"
                                TextColor="{StaticResource TextPrimary}" CornerRadius="8" Padding="12"/>
                        <Label x:Name="NewPaymentsLabel" Text="{Binding NewPaymentsTotal, StringFormat='New payments total: {0:N2}'}" FontSize="14"
                               TextColor="{StaticResource TextSecondary}"/>
                        <Button Text="Save payments" Clicked="OnSavePayments" BackgroundColor="{StaticResource PrimaryColor}"
                                TextColor="{StaticResource WhiteColor}" CornerRadius="10" Padding="14" FontSize="16" FontAttributes="Bold"/>
                        <Button Text="Close bill (complete)" Clicked="OnCloseBill" BackgroundColor="{StaticResource SuccessColor}"
                                TextColor="{StaticResource WhiteColor}" CornerRadius="10" Padding="14" FontSize="16" FontAttributes="Bold"/>
                    </StackLayout>
                </Frame>
            </StackLayout>
        </ScrollView>
        <controls:LoadingOverlay x:Name="LoadingOverlay" Grid.Row="0" IsVisible="False" Message="Loading..."/>
    </Grid>
</ContentPage>
