<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:MicroERP.App.SwiftServe.Components.MauiPages.Converters"
             xmlns:controls="clr-namespace:MicroERP.App.SwiftServe.Components.MauiPages.Controls"
             x:Class="MicroERP.App.SwiftServe.Components.MauiPages.CartPage"
             Title="Cart"
             BackgroundColor="#F0F0F0">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="PrimaryColor">#512BD4</Color>
            <Color x:Key="WhiteColor">#FFFFFF</Color>
            <Color x:Key="TextPrimary">#212121</Color>
            <Color x:Key="TextSecondary">#666666</Color>
            <Color x:Key="BorderColor">#E0E0E0</Color>
            <Color x:Key="DangerColor">#dc3545</Color>
            <Color x:Key="GreenAccent">#2E7D32</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <controls:NavigationMenu x:Name="NavMenu" Grid.Row="0" Grid.RowSpan="2" ZIndex="1000"/>

        <ScrollView Grid.Row="1">
            <StackLayout Spacing="0" Padding="16" Margin="0,0,0,24">
                <!-- Header: Back | Cart | Close -->
                <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,8,0,20" ColumnSpacing="8">
                    <Button Text="&lt;" Clicked="OnBackClicked" BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}"
                            FontSize="24" WidthRequest="44" HeightRequest="44" VerticalOptions="Center" Grid.Column="0"/>
                    <Label Text="Cart" FontSize="22" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"
                           HorizontalOptions="Center" VerticalOptions="Center" Grid.Column="1"/>
                    <Button Text="âœ•" Clicked="OnBackClicked" BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}"
                            FontSize="22" WidthRequest="44" HeightRequest="44" VerticalOptions="Center" Grid.Column="2"/>
                </Grid>

                <!-- Table/Service subtitle (optional, small) -->
                <Label x:Name="HeaderSubtitle" Text="Table: - | Service: -" FontSize="13" TextColor="{StaticResource TextSecondary}"
                       Margin="0,0,0,12" IsVisible="True"/>

                <!-- Cart items: white cards with image, name, price, green pill qty -->
                <CollectionView x:Name="CartItemsCollectionView"
                                ItemsSource="{Binding CartItems}"
                                SelectionMode="None"
                                Margin="0,0,0,16">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="{StaticResource WhiteColor}"
                                   BorderColor="{StaticResource BorderColor}"
                                   CornerRadius="12"
                                   Padding="14"
                                   HasShadow="True"
                                   Margin="0,0,0,12">
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="14">
                                    <Ellipse WidthRequest="64" HeightRequest="64" Fill="#F5F5F5" Grid.Column="0" VerticalOptions="Center"/>
                                    <Label Text="ðŸ½" FontSize="28" HorizontalOptions="Center" VerticalOptions="Center"
                                           Margin="0,0,0,0" Grid.Column="0"/>
                                    <StackLayout Grid.Column="1" VerticalOptions="Center" Spacing="4">
                                        <Label Text="{Binding Name}" FontSize="16" FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding UnitPrice, StringFormat='${0:N2}'}" FontSize="14"
                                               TextColor="{StaticResource TextSecondary}"/>
                                        <!-- Green pill quantity: âˆ’ qty + -->
                                        <Border HeightRequest="36" BackgroundColor="{StaticResource GreenAccent}" StrokeThickness="0"
                                                VerticalOptions="Start" HorizontalOptions="Start" Margin="0,8,0,0">
                                            <Border.StrokeShape><RoundRectangle CornerRadius="18"/></Border.StrokeShape>
                                            <Grid ColumnDefinitions="Auto,*,Auto" WidthRequest="120" ColumnSpacing="0">
                                                <Button Text="âˆ’" Clicked="OnDecreaseQty" CommandParameter="{Binding .}"
                                                        BackgroundColor="Transparent" TextColor="{StaticResource WhiteColor}"
                                                        WidthRequest="40" FontSize="18" FontAttributes="Bold" VerticalOptions="Center" Grid.Column="0"/>
                                                <Label Text="{Binding MaxQty}" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource WhiteColor}"
                                                       HorizontalTextAlignment="Center" VerticalOptions="Center" Grid.Column="1"/>
                                                <Button Text="+" Clicked="OnIncreaseQty" CommandParameter="{Binding .}"
                                                        BackgroundColor="Transparent" TextColor="{StaticResource WhiteColor}"
                                                        WidthRequest="40" FontSize="18" FontAttributes="Bold" VerticalOptions="Center" Grid.Column="2"/>
                                            </Grid>
                                        </Border>
                                    </StackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Promo code -->
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10" Margin="0,0,0,16">
                    <Frame BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                           CornerRadius="10" Padding="14,12" HasShadow="False">
                        <Grid ColumnDefinitions="Auto,*">
                            <Label Text="ðŸ·" FontSize="18" VerticalOptions="Center" Grid.Column="0" Margin="0,0,8,0"/>
                            <Entry x:Name="PromoCodeEntry" Placeholder="Promo Code" TextColor="{StaticResource TextPrimary}"
                                   BackgroundColor="Transparent" Grid.Column="1" VerticalOptions="Center"/>
                        </Grid>
                    </Frame>
                    <Button x:Name="PromoApplyButton" Text="Apply" Clicked="OnPromoApplyClicked"
                            BackgroundColor="{StaticResource DangerColor}" TextColor="{StaticResource WhiteColor}"
                            CornerRadius="10" Padding="20,12" VerticalOptions="Center" Grid.Column="1"/>
                </Grid>

                <!-- Order summary: Subtotal, Delivery, Total -->
                <Frame BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                       CornerRadius="12" Padding="20" Margin="0,0,0,16" HasShadow="True">
                    <StackLayout Spacing="12">
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Label Text="Subtotal:" FontSize="16" TextColor="{StaticResource TextPrimary}" Grid.Column="0"/>
                            <Label x:Name="SubTotalLabel" Text="0.00" FontSize="16" TextColor="{StaticResource TextPrimary}"
                                   HorizontalOptions="End" Grid.Column="1"/>
                        </Grid>
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" x:Name="ServiceChargeRow">
                            <Label x:Name="ServiceChargeLabel" Text="Delivery:" FontSize="16" TextColor="{StaticResource TextPrimary}" Grid.Column="0"/>
                            <Label x:Name="ServiceChargeAmountLabel" Text="0.00" FontSize="16" TextColor="{StaticResource TextPrimary}"
                                   HorizontalOptions="End" Grid.Column="1"/>
                        </Grid>
                        <BoxView HeightRequest="1" Color="{StaticResource BorderColor}" Margin="0,4,0,4"/>
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Label Text="Total:" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" Grid.Column="0"/>
                            <Label x:Name="GrandTotalLabel" Text="0.00" FontSize="18" FontAttributes="Bold"
                                   TextColor="{StaticResource TextPrimary}" HorizontalOptions="End" Grid.Column="1"/>
                        </Grid>
                        <!-- Hidden rows for discount/tax (still calculated, optional to show) -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" x:Name="DiscountRow" IsVisible="False">
                            <Label x:Name="DiscountLabel" Text="Discount:" FontSize="16" TextColor="{StaticResource TextPrimary}" Grid.Column="0"/>
                            <Label x:Name="DiscountAmountLabel" Text="0.00" FontSize="16" TextColor="{StaticResource TextPrimary}" HorizontalOptions="End" Grid.Column="1"/>
                        </Grid>
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" x:Name="TaxRow" IsVisible="False">
                            <Label x:Name="TaxLabel" Text="Tax:" FontSize="16" TextColor="{StaticResource TextPrimary}" Grid.Column="0"/>
                            <Label x:Name="TaxAmountLabel" Text="0.00" FontSize="16" TextColor="{StaticResource TextPrimary}" HorizontalOptions="End" Grid.Column="1"/>
                        </Grid>
                    </StackLayout>
                </Frame>

                <!-- Note (collapsed by default or small) -->
                <Frame BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                       CornerRadius="12" Padding="14" Margin="0,0,0,16" HasShadow="True">
                    <Editor x:Name="BillNoteEditor" Placeholder="Note (optional)" TextChanged="OnBillNoteChanged"
                            HeightRequest="72" BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}"/>
                </Frame>

                <!-- Parcel details (when service = Parcel) -->
                <Frame x:Name="ParcelDetailsFrame" BackgroundColor="{StaticResource WhiteColor}"
                       BorderColor="{StaticResource BorderColor}" CornerRadius="12" Padding="16" Margin="0,0,0,16"
                       HasShadow="True" IsVisible="False">
                    <StackLayout Spacing="12">
                        <Label Text="Parcel Delivery Details" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                        <Entry x:Name="PartyNameEntry" Placeholder="Name" TextColor="{StaticResource TextPrimary}"/>
                        <Entry x:Name="PartyPhoneEntry" Placeholder="Phone" Keyboard="Telephone" TextColor="{StaticResource TextPrimary}"/>
                        <Entry x:Name="PartyEmailEntry" Placeholder="Email" Keyboard="Email" TextColor="{StaticResource TextPrimary}"/>
                        <Editor x:Name="PartyAddressEditor" Placeholder="Address" HeightRequest="80" TextColor="{StaticResource TextPrimary}"/>
                    </StackLayout>
                </Frame>

                <!-- CHECK OUT button -->
                <Button x:Name="PlaceOrderButton" Text="CHECK OUT" Clicked="OnPlaceOrderClicked"
                        BackgroundColor="{StaticResource GreenAccent}" TextColor="{StaticResource WhiteColor}"
                        CornerRadius="14" HeightRequest="56" FontSize="18" FontAttributes="Bold"
                        Margin="0,8,0,32"/>

                <!-- Empty state -->
                <StackLayout x:Name="EmptyStateLayout" IsVisible="False" Spacing="16"
                             HorizontalOptions="Center" VerticalOptions="Center" Margin="0,40">
                    <Label Text="ðŸ›’" FontSize="72" HorizontalOptions="Center" Opacity="0.4"/>
                    <Label Text="Cart is empty" FontSize="20" FontAttributes="Bold"
                           TextColor="{StaticResource TextSecondary}" HorizontalOptions="Center"/>
                </StackLayout>
            </StackLayout>
        </ScrollView>

        <Grid x:Name="PlaceOrderOverlay" Grid.Row="0" Grid.RowSpan="2" IsVisible="False"
              BackgroundColor="#CC000000" ZIndex="2000">
            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="16">
                <ActivityIndicator IsRunning="True" IsVisible="True" Color="{StaticResource WhiteColor}"
                                   WidthRequest="48" HeightRequest="48"/>
                <Label x:Name="PlaceOrderBusyLabel" Text="Placing order..." TextColor="{StaticResource WhiteColor}" FontSize="16"/>
            </VerticalStackLayout>
        </Grid>
        <controls:LoadingOverlay x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="2" IsVisible="False" Message="Loading..."/>
    </Grid>
</ContentPage>
