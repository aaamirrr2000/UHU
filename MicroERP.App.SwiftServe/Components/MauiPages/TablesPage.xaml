<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:MicroERP.App.SwiftServe.Components.MauiPages.Converters"
             xmlns:controls="clr-namespace:MicroERP.App.SwiftServe.Components.MauiPages.Controls"
             x:Class="MicroERP.App.SwiftServe.Components.MauiPages.TablesPage"
             Title="Restaurant Tables"
             BackgroundColor="#F0F0F0">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="WhiteColor">#FFFFFF</Color>
            <Color x:Key="TextPrimary">#212121</Color>
            <Color x:Key="TextSecondary">#666666</Color>
            <Color x:Key="BorderColor">#E0E0E0</Color>
            <Color x:Key="GreenAccent">#2E7D32</Color>
            <Color x:Key="DangerColor">#dc3545</Color>
            <converters:InvertBoolConverter x:Key="InvertBoolConverter"/>
            <converters:IsAvailableToColorConverter x:Key="IsAvailableToColorConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <controls:NavigationMenu x:Name="NavMenu" Grid.Row="0" Grid.RowSpan="2" ZIndex="1000"/>

        <!-- Header: Back | Restaurant Tables | (refresh) -->
        <StackLayout Grid.Row="0" Spacing="4" Margin="16,8,16,12">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                <Button Text="&lt;" Clicked="OnBackClicked" BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}"
                        FontSize="24" WidthRequest="44" HeightRequest="44" VerticalOptions="Center" Grid.Column="0"/>
                <Label Text="Restaurant Tables" FontSize="22" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"
                       HorizontalOptions="Center" VerticalOptions="Center" Grid.Column="1"/>
                <Button Text="â†»" Clicked="OnRefreshClicked" BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}"
                        FontSize="22" WidthRequest="44" HeightRequest="44" VerticalOptions="Center" Grid.Column="2"/>
            </Grid>
            <!-- Search + count (Cart-style: white bar) -->
            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                <Frame Grid.Column="0" BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                       CornerRadius="10" Padding="12,10" HasShadow="False">
                    <Entry x:Name="SearchEntry" Placeholder="Search tables..." TextChanged="OnSearchTextChanged"
                           BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}" PlaceholderColor="{StaticResource TextSecondary}"/>
                </Frame>
                <Label x:Name="TableCountLabel" Text="0 Tables" FontSize="14" TextColor="{StaticResource TextSecondary}"
                       VerticalOptions="Center" Grid.Column="1"/>
            </Grid>
        </StackLayout>

        <!-- Tables list -->
        <CollectionView x:Name="TablesCollectionView" Grid.Row="1" ItemsSource="{Binding FilteredTables}"
                        SelectionMode="None" Margin="16,0,16,20">
            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical" Span="2" HorizontalItemSpacing="10" VerticalItemSpacing="10"/>
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame BackgroundColor="{StaticResource WhiteColor}" BorderColor="{StaticResource BorderColor}"
                           CornerRadius="12" Padding="14" HasShadow="True" Margin="0,0,0,10">
                        <StackLayout Spacing="12">
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="14">
                                <Border WidthRequest="56" HeightRequest="56" StrokeThickness="0"
                                        BackgroundColor="{Binding IsAvailable, Converter={StaticResource IsAvailableToColorConverter}}"
                                        Grid.Column="0" VerticalOptions="Center">
                                    <Border.StrokeShape><RoundRectangle CornerRadius="28"/></Border.StrokeShape>
                                    <Label Text="ðŸ½" FontSize="24" HorizontalOptions="Center" VerticalOptions="Center"/>
                                </Border>
                                <StackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                    <Label Text="{Binding TableNumber}" FontSize="17" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                    <Label Text="{Binding TableLocation}" FontSize="13" TextColor="{StaticResource TextSecondary}"/>
                                    <Label Text="{Binding AvailableStatus}" FontSize="13" FontAttributes="Bold"
                                           TextColor="{Binding IsAvailable, Converter={StaticResource IsAvailableToColorConverter}}"/>
                                </StackLayout>
                            </Grid>
                            <Label Text="{Binding Capacity, StringFormat='Capacity: {0} people'}"
                                   FontSize="13" TextColor="{StaticResource TextSecondary}" HorizontalOptions="Center"/>
                            <StackLayout Spacing="8" Margin="0,4,0,0">
                                <Button Text="Dine-In" Clicked="OnServiceTypeSelected" CommandParameter="{Binding .}"
                                        BackgroundColor="{StaticResource GreenAccent}" TextColor="{StaticResource WhiteColor}"
                                        CornerRadius="10" HeightRequest="40" IsEnabled="{Binding IsAvailable, Converter={StaticResource InvertBoolConverter}}"/>
                                <Button Text="Takeaway" Clicked="OnTakeawaySelected" CommandParameter="{Binding .}"
                                        BackgroundColor="#6c757d" TextColor="{StaticResource WhiteColor}"
                                        CornerRadius="10" HeightRequest="38" IsEnabled="{Binding IsAvailable, Converter={StaticResource InvertBoolConverter}}"/>
                                <Button Text="Parcel" Clicked="OnParcelSelected" CommandParameter="{Binding .}"
                                        BackgroundColor="#17a2b8" TextColor="{StaticResource WhiteColor}"
                                        CornerRadius="10" HeightRequest="38" IsEnabled="{Binding IsAvailable, Converter={StaticResource InvertBoolConverter}}"/>
                            </StackLayout>
                            <Button Text="View Orders" Clicked="OnViewOrderClicked" CommandParameter="{Binding Id}"
                                    BackgroundColor="Transparent" TextColor="{StaticResource GreenAccent}"
                                    CornerRadius="8" HeightRequest="36" Margin="0,2,0,0"/>
                        </StackLayout>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <StackLayout x:Name="EmptyStateLayout" Grid.Row="1" IsVisible="False" Spacing="16"
                     HorizontalOptions="Center" VerticalOptions="Center" Margin="0,40">
            <Label Text="ðŸ½" FontSize="72" HorizontalOptions="Center" Opacity="0.4"/>
            <Label Text="No tables found" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource TextSecondary}" HorizontalOptions="Center"/>
            <Label x:Name="EmptyStateMessage" Text="Please ensure tables are configured in the system."
                   FontSize="14" TextColor="{StaticResource TextSecondary}" HorizontalOptions="Center" HorizontalTextAlignment="Center"/>
        </StackLayout>

        <controls:LoadingOverlay x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="2" IsVisible="False" Message="Loading tables..."/>
    </Grid>
</ContentPage>

