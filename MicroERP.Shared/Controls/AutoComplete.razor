@using MudBlazor
@typeparam TItem where TItem : class

<MudAutocomplete T="TItem"
                 Value="@_selectedItem"
                 ValueChanged="@OnValueChanged"
                 SearchFunc="@SearchItems"
                 ToStringFunc="@ItemToString"
                 Adornment="Adornment.End"
                 Clearable="@Clearable"
                 ReadOnly="@ReadOnly"
                 Disabled="@Disabled"
                 CoerceText="true"
                 CoerceValue="true"
                 ResetValueOnEmptyText="true"
                 DebounceInterval="300"
                 FullWidth="FullWidth"
                 Variant="Variant"
                 Label="@(string.IsNullOrWhiteSpace(Label) ? null : Label)"
                 Placeholder="@Placeholder"
                 Class="@Class"
                 Style="@Style"
                 @attributes="AdditionalAttributes">

    <ProgressIndicatorTemplate>
        <MudProgressLinear Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
    </ProgressIndicatorTemplate>
</MudAutocomplete>

@code {
    [Parameter] public bool FullWidth { get; set; } = true;
    [Parameter] public Variant Variant { get; set; } = Variant.Outlined;
    [Parameter] public string? Label { get; set; } = "Select";
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public bool Clearable { get; set; } = true;
    [Parameter] public bool ReadOnly { get; set; } = false;
    [Parameter] public bool Disabled { get; set; } = false;

    [Parameter] public TItem? SelectedValue { get; set; }
    [Parameter] public EventCallback<TItem?> SelectedValueChanged { get; set; }

    [Parameter] public int SelectedId { get; set; }
    [Parameter] public EventCallback<int> SelectedIdChanged { get; set; }
    [Parameter] public Func<TItem, int>? IdProperty { get; set; }

    [Parameter] public List<TItem>? DataList { get; set; }
    [Parameter] public Func<TItem, string>? DisplayProperty { get; set; }
    [Parameter] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    [Parameter] public bool IncludeDefaultOption { get; set; } = false;
    [Parameter] public string DefaultOptionText { get; set; } = "Select...";
    [Parameter] public int DefaultOptionId { get; set; } = 0;
    [Parameter] public string DefaultOptionDisplayName { get; set; } = "Select...";
    /// <summary>When opening with no search text, max items to show. 0 = show all.</summary>
    [Parameter] public int MaxItemsWhenEmpty { get; set; } = 20;

    private TItem? _selectedItem;
    private List<TItem> _combinedList = new();
    private TItem? _defaultOption;

    protected override void OnParametersSet()
    {
        PrepareDataList();
        _selectedItem = GetSelectedItem();
    }

    private void PrepareDataList()
    {
        _combinedList.Clear();
        _defaultOption = null;

        if (IncludeDefaultOption)
        {
            _defaultOption = CreateDefaultOption();
            if (_defaultOption != null)
                _combinedList.Add(_defaultOption);
        }

        if (DataList != null && DataList.Any())
        {
            _combinedList.AddRange(DataList);
        }
    }

    private TItem? CreateDefaultOption()
    {
        try
        {
            var defaultItem = Activator.CreateInstance<TItem>();

            var displayProp = typeof(TItem).GetProperty("DisplayName");
            if (displayProp?.CanWrite == true) displayProp.SetValue(defaultItem, DefaultOptionDisplayName);

            var nameProp = typeof(TItem).GetProperty("Name");
            if (nameProp?.CanWrite == true) nameProp.SetValue(defaultItem, DefaultOptionText);

            var idProp = typeof(TItem).GetProperty("Id");
            if (idProp?.CanWrite == true) idProp.SetValue(defaultItem, DefaultOptionId);

            return defaultItem;
        }
        catch
        {
            return null;
        }
    }

    private async Task<IEnumerable<TItem>> SearchItems(string value, CancellationToken token)
    {
        await Task.Delay(100, token);

        if (_combinedList == null || !_combinedList.Any())
            return Enumerable.Empty<TItem>();

        if (string.IsNullOrEmpty(value))
        {
            var list = _combinedList.Where(x => IncludeDefaultOption && _defaultOption != null ? IdProperty?.Invoke(x) != DefaultOptionId : true).ToList();
            if (IncludeDefaultOption && _defaultOption != null)
                list = new List<TItem> { _defaultOption }.Concat(list).ToList();
            if (MaxItemsWhenEmpty <= 0)
                return list;
            return list.Take(MaxItemsWhenEmpty);
        }

        return _combinedList.Where(x =>
        {
            var text = ItemToString(x);
            return !string.IsNullOrEmpty(text) && text.Contains(value, StringComparison.InvariantCultureIgnoreCase);
        });
    }

    private string ItemToString(TItem? item)
    {
        if (item == null) return string.Empty;
        if (IncludeDefaultOption && _defaultOption != null && IdProperty != null && IdProperty(item) == DefaultOptionId)
            return DefaultOptionText;
        return DisplayProperty?.Invoke(item) ?? item.ToString() ?? string.Empty;
    }

    private async Task OnValueChanged(TItem? newValue)
    {
        _selectedItem = newValue;

        if (IdProperty != null)
        {
            int newId = 0;
            if (IncludeDefaultOption && _defaultOption != null && newValue != null && IdProperty(newValue) == DefaultOptionId)
            {
                newId = DefaultOptionId;
            }
            else if (newValue != null)
            {
                newId = IdProperty(newValue);
            }

            await SelectedIdChanged.InvokeAsync(newId);
        }

        await SelectedValueChanged.InvokeAsync(newValue);
    }

    private TItem? GetSelectedItem()
    {
        if (IncludeDefaultOption && SelectedId == DefaultOptionId && _defaultOption != null)
            return _defaultOption;

        if (SelectedId == 0) return null;

        if (IdProperty != null && SelectedId > 0 && _combinedList.Any())
            return _combinedList.FirstOrDefault(x => IdProperty(x) == SelectedId);

        return SelectedValue;
    }
}
