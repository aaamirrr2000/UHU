@using System.Text.Json
@inject MicroERP.Shared.Helper.Globals Globals

<MyModelDialog @ref="_dialog" Title="Item Details" Width="800px" Height="auto">
    <ChildContent>


        <MudGrid Class="w-100" Justify="Justify.Center" AlignItems="AlignItems.Start">
            <MudItem xs="12">
                <MudPaper Elevation="4" Class="pa-6 item-detail-card" Style="border-radius: 16px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%); border: 1px solid rgba(63, 81, 181, 0.12); box-shadow: 0 4px 16px rgba(63, 81, 181, 0.1);">
                    
                    <!-- Main Item Row: Name, Qty, Rate -->
                    <div class="item-main-row d-flex align-items-center mb-4" style="padding: 16px; background: linear-gradient(135deg, rgba(63, 81, 181, 0.03) 0%, rgba(63, 81, 181, 0.01) 100%); border-radius: 12px;">
                        
                        <!-- Left: Item Image -->
                        <div class="item-image-container mr-4">
                            @if (!string.IsNullOrWhiteSpace(SelectedItem.Pic))
                            {
                                <AvatarDisplay Pic="@SelectedItem.Pic" Name="@SelectedItem.Name" Size="120" />
                            }
                            else
                            {
                                <div class="item-initials-avatar d-flex align-items-center justify-content-center" style="box-shadow: 0 4px 12px rgba(63, 81, 181, 0.2);">
                                    @SelectedItem.Name!.Substring(0, Math.Min(2, SelectedItem.Name.Length)).ToUpper()
                                </div>
                            }
                        </div>
                        
                        <!-- Center: Item Name with Description -->
                        <div class="item-info-section flex-grow-1">
                            <MudText Typo="Typo.h5" Align="Align.Start" Color="Color.Primary" Class="fw-bold mb-2" Style="font-size: 1.5rem; line-height: 1.3;">
                                @SelectedItem.Name
                            </MudText>
                            @if (!string.IsNullOrWhiteSpace(SelectedItem.Description))
                            {
                                <MudText Typo="Typo.body1" Class="item-description text-muted" Style="font-size: 0.9rem; line-height: 1.5; max-width: 500px;">
                                    @SelectedItem.Description
                                </MudText>
                            }
                        </div>
                        
                        <!-- Right: Qty and Rate -->
                        <div class="item-actions-section d-flex align-items-center gap-4">
                            
                            <!-- Quantity Controls -->
                            @if (SelectedItem.StockType == "ITEM")
                            {
                                <MudPaper Elevation="2" Class="pa-2 quantity-controls" Style="border-radius: 10px; background: white; border: 1px solid rgba(63, 81, 181, 0.2);">
                                    <div class="d-flex align-items-center">
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   OnClick="@(() => DecreaseQty(SelectedItem))"
                                                   Class="qty-button minus-button">
                                            <MudIcon Icon="@Icons.Material.Filled.Remove" Size="Size.Small" />
                                        </MudButton>
                                        
                                        <MudNumericField T="double"
                                                         Value="SelectedItem.Qty"
                                                         ValueChanged="OnQtyChanged"
                                                         Variant="Variant.Outlined"
                                                         HideSpinButtons="true"
                                                         Class="mx-2 qty-input"
                                                         Style="width: 90px;"
                                                         Label="Qty"
                                                         AdornmentIcon="@Icons.Material.Filled.ShoppingCart" />
                                        
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   OnClick="@(() => IncreaseQty(SelectedItem))"
                                                   Class="qty-button plus-button">
                                            <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                                        </MudButton>
                                    </div>
                                </MudPaper>
                            }
                            
                            <!-- Unit Price -->
                            <MudPaper Elevation="2" Class="pa-2 price-section" Style="border-radius: 10px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%); border: 1px solid rgba(76, 175, 80, 0.3);">
                                <MudNumericField T="double"
                                                 @bind-Value="SelectedItem.BasePrice"
                                                 Variant="Variant.Outlined"
                                                 HideSpinButtons="true"
                                                 Class="unit-price fw-bold"
                                                 Style="width: 160px;"
                                                 Label="Unit Price"
                                                 Format="#,##0.00"
                                                 ToStringFormat="N2"
                                                 AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
                            </MudPaper>
                        </div>
                    </div>
                    
                    <!-- Serving Sizes Section -->
                    @if (SelectedItem?.ServingSizes?.Any() == true)
                    {
                        <MudDivider Class="my-4" Style="border-color: rgba(63, 81, 181, 0.2);" />
                        
                        <div class="serving-sizes-section">
                            <MudText Typo="Typo.h6" Class="fw-bold mb-3" Color="Color.Primary" Style="font-size: 1.1rem;">
                                <MudIcon Icon="@Icons.Material.Filled.Category" Class="me-2" Size="Size.Small" />
                                Available Varieties
                            </MudText>
                           <div class="d-flex flex-wrap gap-3">
                                @foreach (var size in SelectedItem.ServingSizes)
                                {
                                    var isSelected = SelectedItem.ServingSize == size.Size;
                                    var borderColor = isSelected ? "var(--mud-palette-primary)" : "transparent";
                                    var servingCardStyle = $"width:110px; cursor:pointer; border-radius: 12px; transition: all 0.3s ease; border: 2px solid {borderColor};";
                                    
                                    <MudPaper Elevation="@(isSelected ? 6 : 2)"
                                              Class="pa-3 text-center serving-card"
                                              Style="@servingCardStyle"
                                              OnClick="@(() => HandleServingSizeChanged(size.Size))"
                                              OnMouseOver="@(() => StateHasChanged())"
                                              OnMouseOut="@(() => StateHasChanged())">

                                        <!-- Image -->
                                        <MudTooltip Text="@size.Size">
                                            <MudImage Src="@Globals.GetImageUrl(size.Pic)"
                                                      Width="80"
                                                      Height="70"
                                                      Class="rounded-lg mx-auto mb-2"
                                                      Style="object-fit: cover; border: 1px solid rgba(0,0,0,0.1);"
                                                      FallbackSrc="files/noimage.png" />
                                        </MudTooltip>

                                        <!-- Size Chip (Middle) -->
                                        <MudChip T="string"
                                                 Variant="Variant.Filled"
                                                 Color="@(SelectedItem.ServingSize == size.Size ? Color.Primary : Color.Default)"
                                                 Class="mx-auto my-1 fw-bold"
                                                 Size="Size.Small">
                                            @size.Size
                                        </MudChip>

                                        <!-- Price (Bottom) -->
                                        <MudText Typo="Typo.body2"
                                                 Color="Color.Success"
                                                 Class="mt-1 fw-bold">
                                            @($"{size.Price:N2}")
                                        </MudText>

                                    </MudPaper>
                                }

                            </div>

                        </div>
                    }
                    
                    <!-- Add to Cart Button -->
                    <MudDivider Class="my-4" Style="border-color: rgba(63, 81, 181, 0.2);" />
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.AddShoppingCart"
                               Class="w-100 fw-bold py-4 add-to-cart-button"
                               Style="font-size: 1.1rem; letter-spacing: 0.5px; border-radius: 12px; box-shadow: 0 4px 12px rgba(63, 81, 181, 0.3); text-transform: uppercase;"
                               OnClick="@(() => OnAddToCart.InvokeAsync(SelectedItem!))">
                        Add to Cart - @($"${(SelectedItem.Qty * SelectedItem.BasePrice):N2}")
                    </MudButton>
                    
                </MudPaper>
            </MudItem>
        </MudGrid>
    </ChildContent>
</MyModelDialog>

<style>
    .item-detail-card {
        background-color: var(--mud-palette-surface);
    }
    
    .item-main-row {
        padding: 16px;
        transition: all 0.3s ease;
    }
    
    .item-image-container {
        flex-shrink: 0;
    }
    
    .item-initials-avatar {
        width: 120px;
        height: 120px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-secondary) 100%);
        color: white;
        font-weight: 700;
        font-size: 36px;
        transition: transform 0.3s ease;
    }

    .item-initials-avatar:hover {
        transform: scale(1.05);
    }
    
    .item-name {
        font-size: 1.75rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        color: var(--mud-palette-text-primary);
        line-height: 1.2;
    }
    
    .item-description {
        font-size: 0.9rem;
        color: var(--mud-palette-text-secondary);
        max-width: 500px;
        line-height: 1.5;
    }
    
    .item-actions-section {
        flex-shrink: 0;
        min-width: 320px;
    }
    
    .quantity-controls {
        background-color: white;
        border-radius: 10px;
        padding: 6px;
        border: 1px solid rgba(63, 81, 181, 0.2);
        transition: all 0.3s ease;
    }

    .quantity-controls:hover {
        border-color: var(--mud-palette-primary);
        box-shadow: 0 2px 8px rgba(63, 81, 181, 0.15);
    }
    
    .qty-button {
        min-width: 40px !important;
        height: 40px !important;
        border-radius: 8px !important;
    }
    
    .qty-input {
        font-weight: 600;
        text-align: center;
        font-size: 0.95rem;
    }
    
    .unit-price {
        font-size: 1.1rem;
    }
    
    .unit-price .mud-input-outlined-border {
        border-color: var(--mud-palette-success) !important;
    }

    .price-section {
        transition: all 0.3s ease;
    }

    .price-section:hover {
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
    }
    
    .serving-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .serving-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(63, 81, 181, 0.2) !important;
    }
    
    .serving-size-chip {
        height: 42px;
        padding: 0 16px;
        border-radius: 21px;
    }
    
    .serving-size-chip .mud-avatar {
        width: 24px !important;
        height: 24px !important;
        min-width: 24px !important;
    }
    
    .size-name {
        font-weight: 500;
        margin-right: 4px;
    }
    
    .size-price {
        font-weight: 600;
        color: var(--mud-palette-success);
    }
    
    .add-to-cart-button {
        font-size: 1.1rem;
        letter-spacing: 0.5px;
        border-radius: 12px;
        text-transform: uppercase;
        transition: all 0.3s ease;
    }

    .add-to-cart-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(63, 81, 181, 0.4) !important;
    }
    
    .dialog-title {
        color: var(--mud-palette-primary);
        font-weight: 600;
    }
    
    .close-button {
        color: var(--mud-palette-text-secondary);
    }
    
    /* Responsive adjustments */
    @@media (max-width: 960px) {
        .item-main-row {
            flex-direction: column;
            text-align: center;
        }
        
        .item-image-container {
            margin-right: 0;
            margin-bottom: 20px;
        }
        
        .item-actions-section {
            min-width: 100%;
            justify-content: center;
            margin-top: 20px;
        }
        
        .item-name {
            font-size: 1.5rem;
        }
    }
</style>

@code {
    private bool Visible { get; set; }
    private MyModelDialog _dialog;

    [Parameter] public ItemsModel SelectedItem { get; set; } = new();
    [Parameter] public string InvoiceType { get; set; } = "SALE";
    [Parameter] public EventCallback<ItemsModel> OnAddToCart { get; set; }
    [Parameter] public EventCallback<double> OnQtyChanged { get; set; }
    [Parameter] public EventCallback<(string Size, ItemsModel Item)> OnServingSizeChanged { get; set; }

    private async Task IncreaseQty(ItemsModel item)
    {
        item.Qty++;
        await UpdateItemPrice(item);
        await OnQtyChanged.InvokeAsync(item.Qty);
    }

    private async Task DecreaseQty(ItemsModel item)
    {
        if (item.Qty > 1)
        {
            item.Qty--;
            await UpdateItemPrice(item);
            await OnQtyChanged.InvokeAsync(item.Qty);
        }
    }

    private Task UpdateItemPrice(ItemsModel item)
    {
        var selectedSize = item.ServingSizes?.FirstOrDefault(s => s.Size == item.ServingSize);
        if (selectedSize != null && double.TryParse(selectedSize.Price.ToString(), out var price))
        {
            item.BasePrice = price;
        }
        return Task.CompletedTask;
    }

    private async Task HandleServingSizeChanged(string size)
    {
        // Update local item first
        SelectedItem.ServingSize = size;

        // Find the corresponding price
        var selectedSize = SelectedItem.ServingSizes?.FirstOrDefault(s => s.Size == size);
        if (selectedSize != null && double.TryParse(selectedSize.Price.ToString(), out var price))
        {
            SelectedItem.BasePrice = price;
        }

        // Call parent - still passing a tuple
        await OnServingSizeChanged.InvokeAsync((size, SelectedItem));
        StateHasChanged();
    }

    public async Task Open()
    {
        Visible = true;
        _dialog.Show();
        StateHasChanged();
    }

    public async Task Close()
    {
        Visible = false;
        _dialog.Hide();
        StateHasChanged();
    }
}
