@using MicroERP.Shared.Models
@inject Functions Functions
@inject Globals Globals

<MudDialog>
    <DialogContent>
        <MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Class="me-2" />
                Invoice Tax Calculation
            </MudText>

            @if (Invoice?.Invoice == null)
            {
                <MudAlert Severity="Severity.Warning">Invoice data not available.</MudAlert>
            }
            else
            {
                <MudPaper Elevation="2" Class="pa-3 mb-3">
                    <MudText Typo="Typo.subtitle1" Class="mb-2 fw-bold">Invoice Details</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.body2"><strong>Invoice Amount:</strong> @Invoice.Invoice.InvoiceAmount.ToString("N2")</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.body2"><strong>Tax Amount:</strong> @Invoice.Invoice.TaxAmount.ToString("N2")</MudText>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                @if (TaxDetails != null && TaxDetails.Any())
                {
                    <MudPaper Elevation="2" Class="pa-3">
                        <MudText Typo="Typo.subtitle1" Class="mb-3 fw-bold">Tax Breakdown</MudText>
                        <MudTable Items="@TaxDetails" Dense="true" Hover="true" Bordered="true">
                            <HeaderContent>
                                <MudTh>Tax Name</MudTh>
                                <MudTh Align="Align.Right">Type</MudTh>
                                <MudTh Align="Align.Right">Rate/Amount</MudTh>
                                <MudTh Align="Align.Right">Taxable Amount</MudTh>
                                <MudTh Align="Align.Right">Tax Amount</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.TaxName</MudTd>
                                <MudTd Align="Align.Right">@context.TaxType</MudTd>
                                <MudTd Align="Align.Right">
                                    @if (context.TaxType == "PERCENTAGE")
                                    {
                                        <text>@context.TaxAmount.ToString("N2")%</text>
                                    }
                                    else
                                    {
                                        <text>@context.TaxAmount.ToString("N2")</text>
                                    }
                                </MudTd>
                                <MudTd Align="Align.Right">@context.TaxableAmount.ToString("N2")</MudTd>
                                <MudTd Align="Align.Right" Class="fw-bold">@context.CalculatedTax.ToString("N2")</MudTd>
                            </RowTemplate>
                            <FooterContent>
                                <MudTd Colspan="4" Class="text-end fw-bold">Total Tax:</MudTd>
                                <MudTd Align="Align.Right" Class="fw-bold">
                                    @TaxDetails.Sum(t => t.CalculatedTax).ToString("N2")
                                </MudTd>
                            </FooterContent>
                        </MudTable>
                    </MudPaper>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">Tax calculation details are not available. Tax amount: @Invoice.Invoice.TaxAmount.ToString("N2")</MudAlert>
                }
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter] public InvoicesModel? Invoice { get; set; }
    [Parameter] public string InvoiceType { get; set; } = "SALE";

    private List<TaxCalculationDetail> TaxDetails { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (Invoice?.Invoice != null && Invoice.Invoice.TaxAmount > 0)
        {
            await LoadTaxDetails();
        }
    }

    private async Task LoadTaxDetails()
    {
        try
        {
            if (Invoice?.Invoice == null || Invoice.Invoice.PartyId == 0)
                return;

            decimal invoiceBaseAmount = Invoice.Invoice.InvoiceAmount;

            // Get the first active tax rule for SALE
            var taxRules = await Functions.GetAsync<List<TaxRuleModel>>(
                $"TaxRule/Search/OrganizationId={Globals.User.OrganizationId} and AppliesTo='SALE' and IsActive=1 and IsSoftDeleted=0", true)
                ?? new List<TaxRuleModel>();

            var today = DateTime.Today;
            var applicableRule = taxRules
                .Where(tr =>
                    tr.EffectiveFrom <= today &&
                    (tr.EffectiveTo == null || tr.EffectiveTo >= today)
                )
                .OrderBy(tr => tr.Id)
                .FirstOrDefault();

            if (applicableRule == null)
                return;

            // Get tax rule details
            var taxRuleDetails = await Functions.GetAsync<List<TaxRuleDetailModel>>(
                $"TaxRuleDetail/Search/TaxRuleId={applicableRule.Id}", true)
                ?? new List<TaxRuleDetailModel>();

            if (!taxRuleDetails.Any())
                return;

            // Get party for conditions
            var party = await Functions.GetAsync<PartiesModel>($"Parties/Get/{Invoice.Invoice.PartyId}", true);

            // Filter by party conditions and order by sequence
            var applicableDetails = new List<TaxRuleDetailModel>();
            foreach (var detail in taxRuleDetails.OrderBy(trd => trd.SequenceNo))
            {
                var taxMaster = await Functions.GetAsync<TaxMasterModel>($"TaxMaster/Get/{detail.TaxId}", true);
                if (taxMaster == null) continue;

                bool shouldApply = true;
                if (!string.IsNullOrWhiteSpace(taxMaster.ConditionType) && party != null)
                {
                    bool registeredMatch = detail.IsRegistered == null || 
                        detail.IsRegistered == (party.IsRegistered == 1 ? 1 : 0);
                    bool filerMatch = detail.IsFiler == null || 
                        detail.IsFiler == (party.IsFiler == 1 ? 1 : 0);
                    shouldApply = registeredMatch && filerMatch;
                }

                if (shouldApply)
                {
                    applicableDetails.Add(detail);
                }
            }

            // Calculate tax for each detail
            TaxDetails = new List<TaxCalculationDetail>();
            decimal runningBase = invoiceBaseAmount;

            foreach (var detail in applicableDetails)
            {
                decimal taxableAmount = invoiceBaseAmount;
                if (detail.TaxBaseType == "RUNNING_TOTAL")
                {
                    taxableAmount = runningBase;
                }

                decimal taxAmount = 0;
                if (detail.TaxType == "PERCENTAGE" && detail.TaxAmount.HasValue)
                {
                    taxAmount = taxableAmount * (decimal)detail.TaxAmount.Value / 100m;
                }
                else if (detail.TaxType == "FLAT" && detail.TaxAmount.HasValue)
                {
                    taxAmount = (decimal)detail.TaxAmount.Value;
                }

                if (!string.IsNullOrEmpty(InvoiceType) && InvoiceType.ToUpper().Contains("RETURN"))
                {
                    taxAmount = -taxAmount;
                }

                var taxMaster = await Functions.GetAsync<TaxMasterModel>($"TaxMaster/Get/{detail.TaxId}", true);
                TaxDetails.Add(new TaxCalculationDetail
                {
                    TaxName = taxMaster?.TaxName ?? $"Tax {detail.TaxId}",
                    TaxType = detail.TaxType ?? "PERCENTAGE",
                    TaxAmount = detail.TaxAmount ?? 0,
                    TaxableAmount = taxableAmount,
                    CalculatedTax = taxAmount
                });

                if (detail.TaxBaseType == "RUNNING_TOTAL")
                {
                    runningBase += taxAmount;
                }
            }
        }
        catch (Exception ex)
        {
            // Log error but don't show to user
            System.Console.WriteLine($"Error loading tax details: {ex.Message}");
        }
    }

    private void Close()
    {
        MudDialog?.Close();
    }

    private class TaxCalculationDetail
    {
        public string TaxName { get; set; } = "";
        public string TaxType { get; set; } = "PERCENTAGE";
        public decimal TaxAmount { get; set; }
        public decimal TaxableAmount { get; set; }
        public decimal CalculatedTax { get; set; }
    }
}

