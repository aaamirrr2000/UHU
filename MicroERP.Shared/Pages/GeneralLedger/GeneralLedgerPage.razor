@page "/GeneralLedgerPage/{Action}/{CurrentRecord?}"
@using System.Collections.ObjectModel
@using MicroERP.Shared.Pages.Invoices

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject FileUploadService FileUploadService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<div class="d-flex flex-column" style="margin: 5px; height: 100%; overflow-y: auto;">

    
        
    <!-- Period Validation Warning -->

    <!-- Period Validation Warning -->
    @if (!string.IsNullOrWhiteSpace(PeriodValidationMessage))
    {
        <MudAlert Severity="Severity.Warning" Class="mb-2" Variant="Variant.Outlined" Dense="true">
            <MudText Typo="Typo.body2">@PeriodValidationMessage</MudText>
        </MudAlert>
    }

    <!-- Entry Header Information -->
    <MudCard Elevation="0" Class="mb-3" Style="background: transparent;">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 px-1">
             <!-- Left Side: Chips for Entry Info -->
             <div class="d-flex flex-wrap align-items-center gap-2">
                <MudChip T="string" Label="true" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" Class="ms-0">
                    <span class="fw-bold me-1">Entry No:</span> @(record.EntryNo ?? "Auto-generated")
                </MudChip>

                <MudChip T="string" Label="true" Variant="Variant.Filled" Color="Color.Surface" Size="Size.Small">
                    <span class="fw-bold me-1" style="color: var(--mud-palette-text-secondary);">Source:</span> @(record.Source ?? "MANUAL")
                </MudChip>

                 <MudChip T="string" Label="true" Variant="Variant.Filled" Color="Color.Surface" Size="Size.Small">
                    <span class="fw-bold me-1" style="color: var(--mud-palette-text-secondary);">Ref:</span> @(record.ReferenceNo ?? record.EntryNo ?? "â€”")
                </MudChip>
             </div>

             <!-- Right Side: Currency Selection -->
             <div class="d-flex align-items-center gap-3">
                 <div class="d-flex align-items-center gap-2 bg-white rounded px-3 py-1 border">
                    <div>
                         <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">Currency</MudText>
                         <div class="d-flex align-items-center">
                             <MudText Typo="Typo.body2" Class="fw-bold text-primary">
                                @(Currencies.FirstOrDefault(c => c.Id == record.EnteredCurrencyId)?.DisplayName ?? Currencies.FirstOrDefault(c => c.Id == record.BaseCurrencyId)?.DisplayName ?? "N/A")
                            </MudText>
                            @if (!isReadOnly)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                               Size="Size.Small" 
                                               Color="Color.Default"
                                               OnClick="ToggleCurrencySelection"
                                               Class="ms-1"
                                               Title="Change Currency"/>
                            }
                         </div>
                    </div>
                </div>

                @if (showCurrencySelection && !isReadOnly)
                {
                    <div style="min-width: 150px;">
                        <AutoComplete TItem="CurrenciesModel"
                                      DataList="@Currencies"
                                      DisplayProperty="@(p => p.DisplayName)"
                                      IdProperty="@(p => p.Id)"
                                      @bind-SelectedId="record.EnteredCurrencyId"
                                      @bind-SelectedId:after="OnEnteredCurrencyChanged"
                                      Label="Select Currency"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      FullWidth="@true" />
                    </div>
                }

                @if (record.EnteredCurrencyId != record.BaseCurrencyId || showCurrencySelection)
                {
                     <div style="width: 120px;">
                        <MudNumericField @bind-Value="record.ExchangeRate"
                                         Label="Exchange Rate"
                                         Format="#,##0.000000"
                                         Placeholder="Rate"
                                         ReadOnly="@isReadOnly"
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         FullWidth="@true" />
                    </div>
                }
            </div>
        </div>
    </MudCard>
    <!-- Second row: rest of inputs -->
    <MudCard Elevation="1" Class="mb-3" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row g-2">
                <div class="col-12 col-md-3 col-lg-3">
                    <MudDatePicker @bind-Date="record.EntryDate"
                                   @bind-Date:after="OnEntryDateChanged"
                                   Label="Entry Date" DateFormat="dd MMM yyyy"
                                   Placeholder="Entry Date"
                                   ReadOnly="@isReadOnly" Variant="Variant.Outlined"
                                   Dense="@true"
                                   FullWidth="@true" />
                </div>
                <div class="col-12 col-md-3 col-lg-3">
                    <MudTextField Value="@(Loc.FirstOrDefault(l => l.Id == record.LocationId)?.Name ?? "")"
                                  Label="Location"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  FullWidth="@true"
                                  ReadOnly="true" />
                </div>
                <div class="col-12 col-md-3 col-lg-3">
                    @if (isReadOnly)
                    {
                        <MudText Typo="Typo.body2" Class="mb-1">Party (Optional)</MudText>
                        <MudText Typo="Typo.body1">@(Par.FirstOrDefault(p => p.Id == record.PartyId)?.DisplayName ?? "â€”")</MudText>
                    }
                    else
                    {
                        <AutoComplete TItem="PartiesModel"
                                      DataList="@Par"
                                      DisplayProperty="@(p => p.DisplayName)"
                                      IdProperty="@(p => p.Id)"
                                      @bind-SelectedId="record.PartyId"
                                      Variant="Variant.Outlined"
                                      Label="Party (Optional)"
                                      FullWidth="@true"
                                      MaxItemsWhenEmpty="0"
                                      Clearable="true" />
                    }
                </div>

                <div class="col-12 col-md-3 col-lg-3">
                    <MudTextField id="Description"
                                  @bind-Value="record.Description"
                                  Label="Description"
                                  Placeholder="Description"
                                  ReadOnly="@isReadOnly"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  FullWidth="@true" />
                </div>
            </div>
        </MudCardContent>
    </MudCard>

    <!-- Account Details -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <MudText Typo="Typo.subtitle2" Class="fw-bold">Account Details</MudText>
                @if (!isReadOnly)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Add" 
                              Variant="Variant.Filled" 
                              Color="Color.Success" 
                              Size="Size.Small"
                              Dense="@true"
                              OnClick="AddDetailLine">
                        Add Line
                    </MudButton>
                }
            </div>

            <div class="d-flex align-items-center gap-2 mb-2" style="flex-wrap: wrap; font-size: 0.9rem;">
                <MudText Typo="Typo.body2" Class="fw-bold">
                    Debit: <MudText Typo="Typo.body2" Color="Color.Error" Class="fw-semibold" Style="display:inline;">@TotalDebit.ToString("N2")</MudText>
                </MudText>
                <MudText Typo="Typo.body2" Class="fw-bold">
                    Credit: <MudText Typo="Typo.body2" Color="Color.Success" Class="fw-semibold" Style="display:inline;">@TotalCredit.ToString("N2")</MudText>
                </MudText>
                @if (Math.Abs(TotalDebit - TotalCredit) < 0.01)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Balanced</MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">
                        Diff: @Math.Abs(TotalDebit - TotalCredit).ToString("N2")
                    </MudChip>
                }
            </div>

            <div style="max-height: 350px; overflow-y: auto;">
                <MudTable Items="@record.Details"
                          Hover="true"
                          Dense="@true"
                          Bordered="true"
                          Striped="true"
                          StickyHeader="true">
                    <HeaderContent>
                        <MudTh Style="width:4%;">#</MudTh>
                        <MudTh Style="width:4%;">â‹®</MudTh>
                        <MudTh Style="min-width: 220px;">Account</MudTh>
                        <MudTh Style="width:14%;" Class="text-end">Debit</MudTh>
                        <MudTh Style="width:14%;" Class="text-end">Credit</MudTh>
                        <MudTh Style="width:22%;">Description</MudTh>
                        <MudTh Style="width:20%;">Party</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="detail">
                        @{
                            var index = record.Details.IndexOf(detail) + 1;
                        }
                        <MudTd>@index</MudTd>
                        <MudTd>
                            @if (!isReadOnly)
                            {
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="@true">
                                    <MudMenuItem OnClick="@(() => RemoveDetailLine(detail))" Color="Color.Error">
                                        <MudIcon Icon="@Icons.Material.Filled.Delete" Class="me-2" />
                                        Delete
                                    </MudMenuItem>
                                </MudMenu>
                            }
                        </MudTd>
                        <MudTd Style="min-width: 220px;">
                            @if (isReadOnly)
                            {
                                <MudText Typo="Typo.body2">@(Acc.FirstOrDefault(a => a.Id == detail.AccountId)?.DisplayName ?? "â€”")</MudText>
                            }
                            else
                            {
                                <AutoComplete TItem="ChartOfAccountsModel"
                                              DataList="@Acc"
                                              DisplayProperty="@(p => p.DisplayName)"
                                              IdProperty="@(p => p.Id)"
                                              @bind-SelectedId="detail.AccountId"
                                              Variant="Variant.Outlined"
                                              Label="Account"
                                              FullWidth="@true"
                                              MaxItemsWhenEmpty="0"
                                              Class="gl-account-autocomplete" />
                            }
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.DebitAmount"
                                             Format="#,##0.00"
                                             Variant="Variant.Outlined"
                                             FullWidth="@true"
                                             Dense="@true"
                                             ReadOnly="@isReadOnly"
                                             @bind-Value:after="@(() => OnAmountChanged(detail))" />
                        </MudTd>
                        <MudTd>
                            <MudNumericField @bind-Value="detail.CreditAmount"
                                             Format="#,##0.00"
                                             Variant="Variant.Outlined"
                                             FullWidth="@true"
                                             Dense="@true"
                                             ReadOnly="@isReadOnly"
                                             @bind-Value:after="@(() => OnAmountChanged(detail))" />
                        </MudTd>
                        <MudTd>
                            <MudTextField @bind-Value="detail.Description"
                                          Variant="Variant.Outlined"
                                          FullWidth="@true"
                                          Dense="@true"
                                          ReadOnly="@isReadOnly" />
                        </MudTd>
                        <MudTd>
                            @if (isReadOnly)
                            {
                                <MudText Typo="Typo.body2">@(Par.FirstOrDefault(p => p.Id == detail.PartyId)?.DisplayName ?? "â€”")</MudText>
                            }
                            else
                            {
                                <AutoComplete TItem="PartiesModel"
                                              DataList="@Par"
                                              DisplayProperty="@(p => p.DisplayName)"
                                              IdProperty="@(p => p.Id)"
                                              @bind-SelectedId="detail.PartyId"
                                              Variant="Variant.Outlined"
                                              Label="Party"
                                              FullWidth="@true"
                                              MaxItemsWhenEmpty="0"
                                              Clearable="true" />
                            }
                        </MudTd>
                    </RowTemplate>
                    <FooterContent>
                        <MudTd Class="fw-bold">TOTAL</MudTd>
                        <MudTd></MudTd>
                        <MudTd></MudTd>
                        <MudTd Class="text-end fw-bold">
                            <MudText Typo="Typo.body2" Color="Color.Error">@TotalDebit.ToString("#,##0.00")</MudText>
                        </MudTd>
                        <MudTd Class="text-end fw-bold">
                            <MudText Typo="Typo.body2" Color="Color.Success">@TotalCredit.ToString("#,##0.00")</MudText>
                        </MudTd>
                        <MudTd></MudTd>
                        <MudTd></MudTd>
                    </FooterContent>
                </MudTable>
            </div>
            @if (record.Details != null && record.Details.Any())
            {
                @if (Math.Abs(TotalDebit - TotalCredit) < 0.01)
                {
                    <MudAlert Severity="Severity.Success" Class="mt-2">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="me-2" />
                        Entry is balanced: Debit = Credit (reconciled).
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Class="me-2" />
                        Entry is not reconciled: Debit (@TotalDebit.ToString("N2")) â‰  Credit (@TotalCredit.ToString("N2")).
                    </MudAlert>
                }
            }
        </MudCardContent>
    </MudCard>

    <!-- Additional Information -->
    <MudCard Elevation="1" Class="mb-2" Style="padding: 8px;">
        <MudCardContent Style="padding: 12px !important;">
            <div class="row">
                <div class="col-12 mb-3">
                    <MudTextField @bind-Value="record.Notes"
                                  Label="Notes"
                                  Placeholder="Additional notes"
                                  ReadOnly="@isReadOnly"
                                  Variant="Variant.Outlined"
                                  Dense="@true"
                                  Lines="2"
                                  FullWidth="@true" />
                </div>
                <div class="col-12">
                    <div class="mt-2">
                        @if (!isReadOnly)
                        {
                            <InputFile class="form-control" OnChange="OnFileInputChanged" />
                        }
                        @if (!string.IsNullOrWhiteSpace(record.FileAttachment))
                        {
                            <a href="@record.FileAttachment" download class="btn btn-link" style="font-size: 12px; margin-top: 5px;">
                                <i class="fas fa-download me-1"></i>@record.FileAttachment
                            </a>
                        }
                    </div>
                </div>
            </div>
        </MudCardContent>
    </MudCard>

</div>

<style>
    .gl-preview-dialog {
        z-index: 10000 !important;
    }
    
    .mud-dialog-container {
        z-index: 10000 !important;
    }

    .gl-account-autocomplete .mud-input-root {
        min-height: 40px;
    }
    .gl-account-autocomplete .mud-input-slot {
        font-size: 0.95rem;
    }
    
    .mud-snackbar-container {
        z-index: 10001 !important;
    }

    .gl-page-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 12px;
    }
    .gl-page-header .mud-typography {
        color: white !important;
    }
    .gl-page-header-subtitle {
        color: rgba(255, 255, 255, 0.9) !important;
        margin-top: 4px;
    }
    .gl-page-header-btn {
        background: rgba(255, 255, 255, 0.2) !important;
        border: 1px solid rgba(255, 255, 255, 0.35);
        color: white !important;
    }
    .gl-page-header-btn:hover {
        background: rgba(255, 255, 255, 0.3) !important;
    }
    .gl-page-header-btn-danger {
        background: rgba(244, 67, 54, 0.9) !important;
        border-color: rgba(255,255,255,0.4);
    }
    .gl-info-row .mud-typography {
        line-height: 1.3;
    }
</style>

@code
{
    GeneralLedgerHeaderModel record = new();
    List<LocationsModel> Loc = new();
    List<PartiesModel> Par = new();
    List<ChartOfAccountsModel> Acc = new();
    List<CurrenciesModel> Currencies = new();
    List<TypeCodeModel> RefTypes = new();

    [Parameter] public string? Action { get; set; } = "INSERT";
    [Parameter] public string? CurrentRecord { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private int CurrentRecordId => int.TryParse(CurrentRecord, System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out var id) ? id : 0;

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;
    private bool _isSaving = false;
    public bool IsSaving => _isSaving;
    private string PeriodValidationMessage { get; set; } = string.Empty;
    private bool PeriodValidationChecked { get; set; } = false;
    private bool showCurrencySelection = false;

    private double TotalDebit => record.Details?.Sum(d => d.DebitAmount) ?? 0;
    private double TotalCredit => record.Details?.Sum(d => d.CreditAmount) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Ensure Details collection is initialized
            if (record.Details == null)
                record.Details = new System.Collections.ObjectModel.ObservableCollection<GeneralLedgerDetailModel>();
            
            Globals.AccessLevel = Globals.PageAccess(NavManager, "GeneralLedgerDashboard");
            await GetAll();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error initializing: {ex.Message}", Severity.Error);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // When opened in dialog for Edit/View, parameters (Action, CurrentRecord) are set by parent; reload so record appears
        if (CurrentRecordId > 0 && (Action == "UPDATE" || Action == "VIEW"))
        {
            await GetAll();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            GetDefaultValues();
        }
    }

    protected async Task GetAll()
    {
        try
        {
            LoadingPanel = true;
            Loc = await Functions.GetAsync<List<LocationsModel>>($"Locations/Search", true) ?? new List<LocationsModel>();
            Par = await Functions.GetAsync<List<PartiesModel>>($"Parties/Search", true) ?? new List<PartiesModel>();
            Acc = await Functions.GetAsync<List<ChartOfAccountsModel>>($"ChartOfAccounts/Search", true) ?? new List<ChartOfAccountsModel>();
            Currencies = await Functions.GetAsync<List<CurrenciesModel>>($"Currencies/Search", true) ?? new List<CurrenciesModel>();
            RefTypes = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/REFERENCE TYPE", true) ?? new List<TypeCodeModel>();

            if (Action == "INSERT")
            {
                Clear();
                GetDefaultValues();
                isReadOnly = false;
            }
            else if (CurrentRecordId > 0)
            {
                await Get(CurrentRecordId);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    protected void GetDefaultValues()
    {
        if (Loc != null && Loc.Any() && record.LocationId == 0)
        {
            record.LocationId = Globals.User.LocationId;
        }
        if (string.IsNullOrWhiteSpace(record.Source))
            record.Source = "MANUAL";
        if (string.IsNullOrWhiteSpace(record.ReferenceType))
            record.ReferenceType = "JOURNAL";
        // Set base currency and entered currency to default
        if (Currencies != null && Currencies.Any())
        {
            var baseCurrency = Currencies.FirstOrDefault(c => c.IsBaseCurrency == 1);
            if (baseCurrency != null)
            {
                if (record.BaseCurrencyId == 0)
                    record.BaseCurrencyId = baseCurrency.Id;
                if (record.EnteredCurrencyId == 0)
                    record.EnteredCurrencyId = baseCurrency.Id;
            }
        }
        if (record.ExchangeRate == 0)
            record.ExchangeRate = 1.0;

        StateHasChanged();
    }

    protected async Task Get(int id)
    {
        try
        {
            LoadingPanel = true;
            record = await Functions.GetAsync<GeneralLedgerHeaderModel>($"GeneralLedger/Get/{id}", true) ?? new GeneralLedgerHeaderModel();
            if (record.Details == null)
                record.Details = new ObservableCollection<GeneralLedgerDetailModel>();
            if (string.IsNullOrWhiteSpace(record.Source))
                record.Source = "MANUAL";
            // Lock location for non-admin users
            if (Globals.User.GroupId != 1 && record.LocationId != Globals.User.LocationId)
            {
                record.LocationId = Globals.User.LocationId;
            }
            // Set default exchange rate if not set
            if (record.ExchangeRate == 0)
                record.ExchangeRate = 1.0;
            // Show currency selection if different from base currency
            showCurrencySelection = record.EnteredCurrencyId != record.BaseCurrencyId;
            // Set read-only if posted or in VIEW mode
            isReadOnly = Action == "VIEW" || record.IsPosted == 1;
            await ValidatePeriodAsync();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading record: {ex.Message}", Severity.Error);
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    protected async void Clear()
    {
        Action = "INSERT";
        record = new GeneralLedgerHeaderModel();
        record.Details = new ObservableCollection<GeneralLedgerDetailModel>();
        record.Source = "MANUAL"; // Always MANUAL for manual entries
        record.ReferenceType = "JOURNAL"; // Auto-set to JOURNAL for manual entries
        isReadOnly = false;
        record.EntryDate = DateTime.Now;
        record.LocationId = Globals.User.LocationId;
        // Set base currency (get from organization or first base currency)
        var baseCurrency = Currencies.FirstOrDefault(c => c.IsBaseCurrency == 1);
        if (baseCurrency != null)
        {
            record.BaseCurrencyId = baseCurrency.Id;
            record.EnteredCurrencyId = baseCurrency.Id; // Default entered currency to base currency
        }
        record.ExchangeRate = 1.0; // Default exchange rate to 1.0
        showCurrencySelection = false; // Hide currency selection by default
        AddDetailLine(); // Add one empty line
        await ValidatePeriodAsync();
    }

    private void OnEnteredCurrencyChanged()
    {
        // When entered currency changes, auto-populate exchange rate
        // If entered currency is same as base currency, set rate to 1.0
        if (record.EnteredCurrencyId == record.BaseCurrencyId)
        {
            record.ExchangeRate = 1.0;
            showCurrencySelection = false; // Hide selection when back to base currency
        }
        else if (record.EnteredCurrencyId > 0 && record.BaseCurrencyId > 0)
        {
            // If different currency, set default rate to 1.0 (user can change it)
            // In a real scenario, you might fetch the exchange rate from an API here
            record.ExchangeRate = 1.0;
        }
        StateHasChanged();
    }

    private void ToggleCurrencySelection()
    {
        showCurrencySelection = !showCurrencySelection;
        // If hiding and currency is base, reset to base
        if (!showCurrencySelection && record.EnteredCurrencyId == record.BaseCurrencyId)
        {
            record.ExchangeRate = 1.0;
        }
        StateHasChanged();
    }

    private async Task OnEntryDateChanged()
    {
        await ValidatePeriodAsync();
    }

    private async Task ValidatePeriodAsync()
    {
        PeriodValidationChecked = false;
        PeriodValidationMessage = string.Empty;
        
        if (record?.EntryDate == null || record.OrganizationId == 0)
        {
            PeriodValidationMessage = string.Empty;
            await InvokeAsync(StateHasChanged);
            return;
        }

        try
        {
            string moduleType = "GENERALLEDGER"; // General Ledger module type
            string dateStr = record.EntryDate.Value.ToString("yyyy-MM-dd");
            var result = await Functions.GetAsync<PeriodCloseModel>(
                $"PeriodClose/GetOpenPeriod/{record.OrganizationId}/{dateStr}/{moduleType}", 
                true);

            PeriodValidationChecked = true;

            // Period is OPEN if we get a valid result with Id > 0 and Status is OPEN or OPEN_PENDING
            // Period is CLOSED if result is null, Id is 0, or Status is CLOSE
            if (result != null && result.Id > 0 && 
                (result.Status?.ToUpper() == "OPEN" || result.Status?.ToUpper() == "OPEN_PENDING"))
            {
                // Period is open - clear any warning
                PeriodValidationMessage = string.Empty;
            }
            else
            {
                // Period is closed - show warning
                PeriodValidationMessage = $"âš ï¸ Period is CLOSED for {moduleType} module on {dateStr}. You cannot save transactions for this date. Please ensure the period is open before saving.";
            }
        }
        catch (Exception ex)
        {
            PeriodValidationChecked = true;
            PeriodValidationMessage = $"Error checking period status: {ex.Message}";
            SnackbarService.Add(PeriodValidationMessage, Severity.Error);
        }
        
        await InvokeAsync(StateHasChanged);
    }

    protected void AddDetailLine()
    {
        if (record.Details == null)
            record.Details = new ObservableCollection<GeneralLedgerDetailModel>();
        
        record.Details.Add(new GeneralLedgerDetailModel
        {
            SeqNo = record.Details.Count + 1
        });
        StateHasChanged();
    }

    protected void RemoveDetailLine(GeneralLedgerDetailModel detail)
    {
        if (record.Details != null)
        {
            record.Details.Remove(detail);
            // Reorder sequence numbers
            for (int i = 0; i < record.Details.Count; i++)
            {
                record.Details[i].SeqNo = i + 1;
            }
            StateHasChanged();
        }
    }

    protected void OnAmountChanged(GeneralLedgerDetailModel detail)
    {
        // Ensure only debit or credit is set, not both - both cannot have value at the same time
        if (detail.DebitAmount > 0)
            detail.CreditAmount = 0;
        if (detail.CreditAmount > 0)
            detail.DebitAmount = 0;
        
        record.TotalDebit = TotalDebit;
        record.TotalCredit = TotalCredit;
        StateHasChanged();
    }

    public async Task Delete()
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete existing record?");
        if (res == false)
            return;

        Action = "SOFTDELETE";
        await Save();
    }

    public async Task Save()
    {
        if (_isSaving) return;
        _isSaving = true;
        await InvokeAsync(StateHasChanged);
        try
        {
            // Validate
            if (record.Details == null || record.Details.Count == 0)
            {
                SnackbarService.Add("Please add at least one account line.", Severity.Warning);
                return;
            }

            if (Math.Abs(TotalDebit - TotalCredit) > 0.01)
            {
                SnackbarService.Add($"Entry is not balanced. Total Debit: {TotalDebit:N2}, Total Credit: {TotalCredit:N2}", Severity.Error);
                return;
            }

            record.OrganizationId = Globals.User.OrganizationId;
            record.CreatedBy = Globals.User.Id;
            record.CreatedOn = DateTime.Now;
            record.CreatedFrom = Globals.ClientInfo;
            record.UpdatedBy = Globals.User.Id;
            record.UpdatedOn = DateTime.Now;
            record.UpdatedFrom = Globals.ClientInfo;
            record.TotalDebit = TotalDebit;
            record.TotalCredit = TotalCredit;
            // Source is always MANUAL for manual entries (other sources come from invoices/cashbook)
            if (string.IsNullOrWhiteSpace(record.Source) || Action == "INSERT")
                record.Source = "MANUAL";

            LoadingPanel = true;
            var result = await Functions.PostAsync<GeneralLedgerHeaderModel>($"GeneralLedger/{Action}", record, true);
            LoadingPanel = false;

            if (result.Success == false || result.Result == null)
            {
                SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
            }
            else
            {
                var res = result.Result;
                await OnSaved.InvokeAsync();
                SnackbarService.Add($"Record {Action} Successfully", Severity.Success);
                
                await Get(res.Id);
                CurrentRecord = res.Id.ToString();
                Action = "UPDATE";
            }
        }
        catch (Exception ex)
        {
            LoadingPanel = false;
            SnackbarService.Add($"Error saving General Ledger Entry: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public async Task ShowGLPreview()
    {
        try
        {
            // Validate required fields for preview (works before saving)
            if (record?.Details == null || !record.Details.Any())
            {
                SnackbarService.Add("Please add at least one account entry first", Severity.Warning);
                return;
            }

            if (record.Details.All(d => d.DebitAmount == 0 && d.CreditAmount == 0))
            {
                SnackbarService.Add("Please enter debit or credit amounts for at least one entry", Severity.Warning);
                return;
            }

            // Validate organization is set
            if (record.OrganizationId == 0)
            {
                record.OrganizationId = Globals.User.OrganizationId;
            }

            GeneralLedgerHeaderModel? previewData;
            if (CurrentRecordId > 0)
            {
                LoadingPanel = true;
                StateHasChanged();
                previewData = await Functions.GetAsync<GeneralLedgerHeaderModel>($"GeneralLedger/Get/{CurrentRecordId}", true);
                LoadingPanel = false;
                StateHasChanged();
                if (previewData == null)
                {
                    SnackbarService.Add("Unable to generate preview. Unable to load entry details.", Severity.Error);
                    return;
                }
            }
            else
            {
                // Use current form data for preview
                previewData = new GeneralLedgerHeaderModel
                {
                    Id = 0,
                    EntryNo = record.EntryNo ?? "PREVIEW",
                    EntryDate = record.EntryDate ?? DateTime.Today,
                    OrganizationId = record.OrganizationId,
                    LocationId = record.LocationId,
                    Source = record.Source ?? "MANUAL",
                    Description = record.Description,
                    ReferenceNo = record.ReferenceNo,
                    ReferenceType = record.ReferenceType,
                    PartyId = record.PartyId,
                    BaseCurrencyId = record.BaseCurrencyId,
                    EnteredCurrencyId = record.EnteredCurrencyId,
                    Details = new ObservableCollection<GeneralLedgerDetailModel>(record.Details.Select(d => new GeneralLedgerDetailModel
                    {
                        Id = d.Id,
                        AccountId = d.AccountId,
                        AccountCode = d.AccountCode,
                        AccountName = d.AccountName,
                        AccountType = d.AccountType,
                        DebitAmount = d.DebitAmount,
                        CreditAmount = d.CreditAmount,
                        Description = d.Description,
                        PartyId = d.PartyId
                    }))
                };
            }

            int recordId = CurrentRecordId > 0 ? CurrentRecordId : 0;
            var parameters = new DialogParameters<InvoiceGLPreviewDialog>
            {
                { x => x.PreviewData, previewData },
                { x => x.RecordId, recordId },
                { x => x.IsPostedToGL, record.IsPosted == 1 },
                { x => x.OnPostToGL, EventCallback.Factory.Create(this, async () => 
                {
                    if (CurrentRecordId == 0)
                    {
                        SnackbarService.Add("Please save the entry before posting to GL", Severity.Warning);
                        return;
                    }
                    await PostEntry();
                    await ShowGLPreview();
                }) }
            };

            var options = new DialogOptions()
            {
                MaxWidth = MaxWidth.Large,
                FullWidth = true,
                CloseButton = true,
                CloseOnEscapeKey = true,
                BackdropClick = false,
                Position = DialogPosition.Center
            };

            await dialogService.ShowAsync<InvoiceGLPreviewDialog>("Accounting Entry Preview", parameters, options);
        }
        catch (Exception ex)
        {
            LoadingPanel = false;
            StateHasChanged();
            SnackbarService.Add($"Error generating preview: {ex.Message}", Severity.Error);
        }
    }

    protected async Task PostEntry()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(record.EntryNo))
            {
                SnackbarService.Add("Entry No is required", Severity.Warning);
                return;
            }

            if (record.IsPosted == 1)
            {
                SnackbarService.Add("This entry is already posted", Severity.Info);
                return;
            }

            var res = await Functions.ShowConfirmation(dialogService, "Do you want to post this entry? Once posted, it cannot be modified.");
            if (res == false)
                return;

            LoadingPanel = true;
            var result = await Functions.PostAsync<string>($"GeneralLedger/PostEntry", record.EntryNo, true);
            LoadingPanel = false;

            if (result.Success == false)
            {
                SnackbarService.Add($"ERROR: {result.Message}", Severity.Error);
            }
            else
            {
                SnackbarService.Add("Entry posted successfully", Severity.Success);
                // Reload entry to get updated IsPosted status
                await Get(CurrentRecordId);
            }
        }
        catch (Exception ex)
        {
            LoadingPanel = false;
            SnackbarService.Add($"Error posting entry: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnFileInputChanged(InputFileChangeEventArgs e)
    {
        try
        {
            var result = await Functions.FileUpload(e, FileUploadService, 25);

            if (result.Item1 == true)
            {
                record.FileAttachment = result.Item2;
                SnackbarService.Add("Document uploaded successfully", Severity.Success);
            }
            else
            {
                SnackbarService.Add($"Error: {result.Item2}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Exception: {ex.Message}", Severity.Error);
            record.FileAttachment = null;
        }
    }
}


