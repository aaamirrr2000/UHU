@page "/CashReconciliationReport"
@using MicroERP.Shared.Models
@using System.Linq
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals
@inject IJSRuntime JSRuntime

<PageTitle>Cash Reconciliation Report</PageTitle>
<Loading IsLoading="@LoadingPanel" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-0" Style="padding: 2px;">
    <div class="dashboard-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div>
                <MudText Typo="Typo.h5" Class="mb-0 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Class="me-2" Style="color: white;" />
                    Cash Reconciliation Report
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted mt-1" Style="color: rgba(255,255,255,0.85) !important;">Reconcile cash transactions against physical cash count</MudText>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2 mt-md-0 flex-wrap">
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <MudDatePicker @bind-Date="reportDate"
                                   @bind-Date:after="OnDateOrLocationChanged"
                                   Label="Report Date" DateFormat="dd MMM yyyy" Variant="Variant.Outlined" />
                    <AutoComplete TItem="LocationsModel"
                                  DataList="@Locations"
                                  DisplayProperty="@(p => p.Name)"
                                  IdProperty="@(p => p.Id)"
                                  @bind-SelectedId="selectedLocationId"
                                  @bind-SelectedId:after="OnDateOrLocationChanged"
                                  Variant="Variant.Outlined"
                                  Label="Location"
                                  Placeholder="All Locations"
                                  Style="background: rgba(255,255,255,0.95); width: 180px;" />
                    <AutoComplete TItem="UsersModel"
                                  DataList="@Users"
                                  DisplayProperty="@(p => p.Username)"
                                  IdProperty="@(p => p.Id)"
                                  @bind-SelectedId="selectedUserId"
                                  Variant="Variant.Outlined"
                                  Label="User"
                                  Placeholder="All Users (Optional)"
                                  Clearable="true"
                                  Disabled="@(selectedPhysicalCountSession != null)"
                                  Style="background: rgba(255,255,255,0.95); width: 180px;" />
                    @if (selectedPhysicalCountSession != null)
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Class="ms-2">
                            User: @selectedPhysicalCountSession.CountedByName
                        </MudChip>
                    }
                    <MudSelect T="PhysicalCashCountSessionModel"
                               @bind-Value="selectedPhysicalCountSession"
                               Label="Physical Count Session"
                               Placeholder="Select Count Session (Optional)"
                               Variant="Variant.Outlined"
                               Clearable="true"
                               Style="background: rgba(255,255,255,0.95); min-width: 300px; max-width: 400px;"
                               Dense="true">
                        <MudSelectItem T="PhysicalCashCountSessionModel" Value="@((PhysicalCashCountSessionModel?)null)">
                            All Physical Count Sessions
                        </MudSelectItem>
                        @if (physicalCountSessions != null && physicalCountSessions.Any())
                        {
                            @foreach (var session in physicalCountSessions)
                            {
                                <MudSelectItem T="PhysicalCashCountSessionModel" Value="@session">
                                    @(session.DisplayText ?? $"{session.LocationName} - {session.Locker} - {session.CountedByName} - {session.CountedOn:dd MMM yyyy HH:mm}") (@session.TotalAmount.ToString("#,##0.00"))
                                </MudSelectItem>
                            }
                        }
                        else if (reportDate.HasValue)
                        {
                            <MudSelectItem T="PhysicalCashCountSessionModel" Value="@(null)" Disabled="true">
                                No physical count sessions found for selected date/location
                            </MudSelectItem>
                        }
                    </MudSelect>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <MudButton StartIcon="@Icons.Material.TwoTone.Search" 
                               Size="Size.Small" 
                               Variant="Variant.Filled" 
                               Color="Color.Primary"
                               Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                               OnClick="@(() => LoadReport())">
                        Generate
                    </MudButton>
                    <MudButton StartIcon="@Icons.Material.TwoTone.Print" 
                               Size="Size.Small" 
                               Variant="Variant.Filled" 
                               Color="Color.Info"
                               Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                               OnClick="@(() => PrintReport())">
                        Print
                    </MudButton>
                </div>
            </div>
        </div>
    </div>

    @if (reportData != null && reportData.Any())
    {
        <MudPaper Elevation="3" Class="pa-4" Style="border-radius: 12px; margin-bottom: 8px;">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <MudText Typo="Typo.h6">Cash Reconciliation for @reportDate.Value.ToString("dd MMM yyyy")</MudText>
                <div class="d-flex gap-2 align-items-center mt-2 mt-md-0">
                    @if (selectedLocationId > 0)
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">
                            Location: @Locations.FirstOrDefault(l => l.Id == selectedLocationId)?.Name
                        </MudChip>
                    }
                    @if (selectedPhysicalCountSession != null)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">
                            Session: @selectedPhysicalCountSession.CountedByName - @selectedPhysicalCountSession.CountedOn?.ToString("HH:mm")
                        </MudChip>
                    }
                    else if (selectedUserId > 0)
                    {
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small">
                            User: @Users.FirstOrDefault(u => u.Id == selectedUserId)?.Username
                        </MudChip>
                    }
                </div>
            </div>
            
            <!-- Information Note -->
            <MudAlert Severity="Severity.Info" Class="mb-3" Dense="true">
                <MudText Typo="Typo.body2">
                    <strong>Cash Sources:</strong> Cash Receipts include Sale Invoices (cash payments), CashBook receipts, and General Ledger (cash account debits). 
                    Cash Payments include Purchase Invoices (cash payments), CashBook payments, and General Ledger (cash account credits).
                </MudText>
            </MudAlert>
            
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-2">
                    <MudPaper Elevation="2" Class="pa-3 text-center summary-card">
                        <MudText Typo="Typo.caption" Class="text-muted">Total Cash in Hand</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold text-primary">
                            @reportData.Sum(r => r.ExpectedBalance).ToString("#,##0.00")
                        </MudText>
                    </MudPaper>
                </div>
                <div class="col-md-3 mb-2">
                    <MudPaper Elevation="2" Class="pa-3 text-center summary-card">
                        <MudText Typo="Typo.caption" Class="text-muted">Total Physical</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold text-success">
                            @reportData.Sum(r => r.PhysicalCount).ToString("#,##0.00")
                        </MudText>
                    </MudPaper>
                </div>
                <div class="col-md-3 mb-2">
                    <MudPaper Elevation="2" Class="pa-3 text-center summary-card">
                        <MudText Typo="Typo.caption" Class="text-muted">Total Difference</MudText>
                        <MudText Typo="Typo.h6" Class="@($"fw-bold {(reportData.Sum(r => r.Variance) == 0 ? "text-success" : "text-error")}")">
                            @reportData.Sum(r => r.Variance).ToString("#,##0.00")
                        </MudText>
                    </MudPaper>
                </div>
                <div class="col-md-3 mb-2">
                    <MudPaper Elevation="2" Class="pa-3 text-center summary-card">
                        <MudText Typo="Typo.caption" Class="text-muted">Reconciled</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold text-info">
                            @reportData.Count(r => r.Status == "RECONCILED") / @reportData.Count
                        </MudText>
                    </MudPaper>
                </div>
            </div>
            
            <MudDataGrid T="CashReconciliationReportModel"
                         Items="@reportData"
                         SortMode="SortMode.Multiple"
                         Filterable="true"
                         Hideable="true"
                         Dense="true"
                         Striped="true"
                         Hover="true"
                         Bordered="true">
                <Columns>
                    <PropertyColumn Property="x => x.LocationName" 
                                    Title="Location" 
                                    Sortable="true" 
                                    Filterable="true" />
                    
                    <PropertyColumn Property="x => x.Locker" 
                                    Title="Locker" 
                                    Sortable="true" 
                                    Filterable="true" />
                    
                    <PropertyColumn Property="x => x.OpeningBalance" 
                                    Title="Opening Balance" 
                                    Format="#,##0.00" 
                                    Sortable="true"
                                    CellClass="text-end" />
                    
                    <PropertyColumn Property="x => x.CashReceipts" 
                                    Title="Cash Receipts" 
                                    Format="#,##0.00" 
                                    Sortable="true"
                                    CellClass="text-end text-success" />
                    
                    <PropertyColumn Property="x => x.CashPayments" 
                                    Title="Cash Payments" 
                                    Format="#,##0.00" 
                                    Sortable="true"
                                    CellClass="text-end text-error" />
                    
                    <PropertyColumn Property="x => x.ExpectedBalance" 
                                    Title="Cash in Hand" 
                                    Format="#,##0.00" 
                                    Sortable="true"
                                    CellClass="text-end fw-bold text-primary" />
                    
                    <PropertyColumn Property="x => x.PhysicalCount" 
                                    Title="Physical Count" 
                                    Format="#,##0.00" 
                                    Sortable="true"
                                    CellClass="text-end fw-bold text-success" />
                    
                    <TemplateColumn Title="Difference" 
                                    Sortable="true"
                                    CellClass="text-end">
                        <CellTemplate Context="row">
                            <MudText Typo="Typo.body2" 
                                     Class="@($"fw-bold {(row.Item.Variance == 0 ? "text-success" : row.Item.Variance > 0 ? "text-warning" : "text-error")}")">
                                @row.Item.Variance.ToString("#,##0.00")
                            </MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    
                    <TemplateColumn Title="Status" 
                                    Sortable="true">
                        <CellTemplate Context="row">
                            <MudChip Color="@(row.Item.Status == "RECONCILED" ? Color.Success : Color.Warning)" 
                                     Size="Size.Small"
                                     Variant="Variant.Filled">
                                @row.Item.Status
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    
                    <PropertyColumn Property="x => x.CountedByName" 
                                    Title="Counted By" 
                                    Sortable="true" 
                                    Filterable="true" />
                    
                    <PropertyColumn Property="x => x.CountedOn" 
                                    Title="Counted On" 
                                    Format="dd MMM yyyy HH:mm" 
                                    Sortable="true" />
                </Columns>
            </MudDataGrid>
            @{
                // Calculate grand totals (to avoid double-counting location totals)
                var totalExpected = reportData
                    .Where(r => r.Locker != "LOCATION TOTAL" && r.Locker != "NO PHYSICAL COUNT")
                    .GroupBy(r => r.LocationId)
                    .Select(g => g.First().ExpectedBalance)
                    .Sum();
                    
                var totalPhysical = reportData
                    .Where(r => r.Locker != "NO PHYSICAL COUNT")
                    .GroupBy(r => r.LocationId)
                    .Sum(g => 
                    {
                        var locationTotal = g.FirstOrDefault(r => r.Locker == "LOCATION TOTAL");
                        return locationTotal != null 
                            ? locationTotal.PhysicalCount 
                            : g.Where(r => r.Locker != "LOCATION TOTAL").Sum(r => r.PhysicalCount);
                    });
                    
                var totalVariance = totalPhysical - totalExpected;
            }

            <!-- Grand Totals Row -->
            <MudPaper Elevation="1" Class="pa-3 mt-2" Style="background-color: #f5f5f5;">
                <div class="row">
                    <div class="col-md-2 text-end fw-bold">
                        <MudText Typo="Typo.h6">Grand Totals:</MudText>
                    </div>
                    <div class="col-md-2 text-end fw-bold">
                        <MudText Typo="Typo.h6" Class="text-primary">
                            @totalExpected.ToString("#,##0.00")
                        </MudText>
                    </div>
                    <div class="col-md-2 text-end fw-bold">
                        <MudText Typo="Typo.h6" Class="text-success">
                            @totalPhysical.ToString("#,##0.00")
                        </MudText>
                    </div>
                    <div class="col-md-2 text-end fw-bold">
                        <MudText Typo="Typo.h6" Class="@($"{(totalVariance == 0 ? "text-success" : "text-error")}")">
                            @totalVariance.ToString("#,##0.00")
                        </MudText>
                    </div>
                    <div class="col-md-4"></div>
                </div>
            </MudPaper>
        </MudPaper>
    }
    else if (!LoadingPanel && reportDate.HasValue)
    {
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudText Typo="Typo.body1">No reconciliation data available for the selected date.</MudText>
            <MudText Typo="Typo.body2" Class="text-muted mt-2">Please ensure cash transactions and physical cash counts exist for this date.</MudText>
        </MudPaper>
    }
</MudContainer>

<style>
    .dashboard-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 8px;
    }

    .summary-card {
        border-radius: 8px;
        transition: transform 0.2s;
    }

    .summary-card:hover {
        transform: translateY(-2px);
    }

    @@media print {
        .dashboard-header {
            background: white !important;
            color: black !important;
        }
        
        .no-print {
            display: none !important;
        }
    }
</style>

@code
{
    public DateTime? reportDate { get; set; } = DateTime.Today;
    private bool LoadingPanel { get; set; } = false;
    private List<CashReconciliationReportModel> reportData = new();
    private List<LocationsModel> Locations = new();
    private List<UsersModel> Users = new();
    private List<PhysicalCashCountSessionModel> physicalCountSessions = new();
    private int selectedLocationId { get; set; } = 0;
    private int selectedUserId { get; set; } = 0;
    
    private PhysicalCashCountSessionModel? _selectedPhysicalCountSession;
    private PhysicalCashCountSessionModel? selectedPhysicalCountSession
    {
        get => _selectedPhysicalCountSession;
        set
        {
            _selectedPhysicalCountSession = value;
            // When a physical count session is selected, update the user filter
            if (value != null && value.CountedBy > 0)
            {
                selectedUserId = value.CountedBy;
            }
            // If session is cleared, user selection remains (user might want to filter by user only)
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Globals.AccessLevel = Globals.PageAccess(NavManager, "CashReconciliationReport");
        
        // Load locations and users
        Locations = await Functions.GetAsync<List<LocationsModel>>($"Locations/Search/IsActive=1", true) ?? new List<LocationsModel>();
        Users = await Functions.GetAsync<List<UsersModel>>($"Users/Search/IsActive=1", true) ?? new List<UsersModel>();
        
        // Apply location filter if user is not admin
        if (Globals.User.GroupId != 1)
        {
            selectedLocationId = Globals.User.LocationId;
        }
        
        // Load physical count sessions for initial date/location
        await LoadPhysicalCountSessions();
        await LoadReport();
    }

    protected async Task OnDateOrLocationChanged()
    {
        // Reset physical count session selection when date or location changes
        _selectedPhysicalCountSession = null;
        selectedUserId = 0; // Reset user selection when date/location changes
        await LoadPhysicalCountSessions();
    }

    private async Task LoadPhysicalCountSessions()
    {
        if (!reportDate.HasValue)
        {
            physicalCountSessions = new List<PhysicalCashCountSessionModel>();
            return;
        }

        try
        {
            var dateStr = reportDate.Value.ToString("yyyy-MM-dd");
            string url = $"Reports/PhysicalCashCountSessions/{Globals.User.OrganizationId}/{dateStr}";
            
            // Add location filter if specified
            if (selectedLocationId > 0 && Globals.User.GroupId == 1)
            {
                url += $"?locationId={selectedLocationId}";
            }
            else if (Globals.User.GroupId != 1)
            {
                url += $"?locationId={Globals.User.LocationId}";
            }
            
            physicalCountSessions = await Functions.GetAsync<List<PhysicalCashCountSessionModel>>(url, true) ?? new List<PhysicalCashCountSessionModel>();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading physical count sessions: {ex.Message}", Severity.Error);
            physicalCountSessions = new List<PhysicalCashCountSessionModel>();
        }
    }

    private async Task LoadReport()
    {
        if (!reportDate.HasValue)
        {
            SnackbarService.Add("Please select a date", Severity.Warning);
            return;
        }

        LoadingPanel = true;
        try
        {
            var dateStr = reportDate.Value.ToString("yyyy-MM-dd");
            string url = $"Reports/CashReconciliation/{Globals.User.OrganizationId}/{dateStr}";
            
            // Build query parameters
            var queryParams = new List<string>();
            
            // Add location filter
            if (selectedLocationId > 0 && Globals.User.GroupId == 1)
            {
                queryParams.Add($"locationId={selectedLocationId}");
            }
            else if (Globals.User.GroupId != 1)
            {
                queryParams.Add($"locationId={Globals.User.LocationId}");
            }
            
            // Add user/physical count session filter
            // Priority: Physical Count Session > User Selection
            if (selectedPhysicalCountSession != null && selectedPhysicalCountSession.CountedBy > 0)
            {
                // Filter by specific physical count session (user + timestamp)
                queryParams.Add($"countedBy={selectedPhysicalCountSession.CountedBy}");
                
                // Add countedOn timestamp if available to get specific session
                if (selectedPhysicalCountSession.CountedOn.HasValue)
                {
                    string countedOnStr = selectedPhysicalCountSession.CountedOn.Value.ToString("yyyy-MM-dd HH:mm:ss");
                    queryParams.Add($"countedOn={Uri.EscapeDataString(countedOnStr)}");
                }
            }
            else if (selectedUserId > 0)
            {
                // If user is selected but no physical count session, filter by user only (all sessions by that user)
                queryParams.Add($"countedBy={selectedUserId}");
            }
            
            if (queryParams.Any())
            {
                url += "?" + string.Join("&", queryParams);
            }
            
            reportData = await Functions.GetAsync<List<CashReconciliationReportModel>>(url, true) ?? new List<CashReconciliationReportModel>();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading report: {ex.Message}", Severity.Error);
            reportData = new List<CashReconciliationReportModel>();
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    private void PrintReport()
    {
        JSRuntime.InvokeVoidAsync("window.print");
    }
}


