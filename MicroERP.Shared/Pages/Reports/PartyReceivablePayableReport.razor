@page "/PartyReceivablePayableReport"
@using MicroERP.Shared.Models
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals
@inject IJSRuntime JSRuntime

<PageTitle>Party Receivable/Payable Report</PageTitle>
<Loading IsLoading="@LoadingPanel" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-0" Style="padding: 2px;">
    <div class="dashboard-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div>
                <MudText Typo="Typo.h5" Class="mb-0 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="me-2" Style="color: white;" />
                    Party Receivable/Payable Report
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted mt-1" Style="color: rgba(255,255,255,0.85) !important;">Outstanding receivables and payables by party</MudText>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2 mt-md-0 flex-wrap">
                <MudSelect @bind-Value="selectedPartyType"
                           Label="Party Type"
                           Variant="Variant.Outlined"
                           Style="background: rgba(255,255,255,0.95); width: 200px;"
                           Clearable="true">
                    <MudSelectItem Value=@("Customer")>Customer</MudSelectItem>
                    <MudSelectItem Value=@("Supplier")>Supplier</MudSelectItem>
                </MudSelect>
                <MudButton StartIcon="@Icons.Material.TwoTone.Search" 
                           Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary"
                           Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                           OnClick="@(() => LoadReport())">
                    Generate
                </MudButton>
                <MudButton StartIcon="@Icons.Material.TwoTone.Print" 
                           Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Info"
                           Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                           OnClick="@(() => PrintReport())">
                    Print
                </MudButton>
            </div>
        </div>
    </div>

    @if (reportData != null && reportData.Any())
    {
        <MudPaper Elevation="3" Class="pa-4" Style="border-radius: 12px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <MudText Typo="Typo.h6">Party Receivable/Payable Report</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    @if (!string.IsNullOrWhiteSpace(selectedPartyType))
                    {
                        <span>Party Type: @selectedPartyType</span>
                    }
                    else
                    {
                        <span>All Party Types</span>
                    }
                </MudText>
            </div>
            
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <MudPaper Elevation="2" Class="pa-3 text-center" Style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%); border-left: 4px solid #4CAF50;">
                        <MudText Typo="Typo.caption" Class="text-muted">Total Receivables</MudText>
                        <MudText Typo="Typo.h5" Class="fw-bold" Style="color: #4CAF50;">@totalReceivables.ToString("#,##0.00")</MudText>
                    </MudPaper>
                </div>
                <div class="col-md-4">
                    <MudPaper Elevation="2" Class="pa-3 text-center" Style="background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.05) 100%); border-left: 4px solid #F44336;">
                        <MudText Typo="Typo.caption" Class="text-muted">Total Payables</MudText>
                        <MudText Typo="Typo.h5" Class="fw-bold" Style="color: #F44336;">@totalPayables.ToString("#,##0.00")</MudText>
                    </MudPaper>
                </div>
                <div class="col-md-4">
                    <MudPaper Elevation="2" Class="pa-3 text-center" Style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(33, 150, 243, 0.05) 100%); border-left: 4px solid #2196F3;">
                        <MudText Typo="Typo.caption" Class="text-muted">Net Outstanding</MudText>
                    <MudText Typo="Typo.h5"
                             Class="fw-bold"
                             Color="@(netOutstanding >= 0 ? Color.Success : Color.Error)">
                        @(netOutstanding >= 0
                                                ? $"{netOutstanding:#,##0.00} Dr"
                                                : $"{Math.Abs(netOutstanding):#,##0.00} Cr")
                        </MudText>
                    </MudPaper>
                </div>
            </div>
            
            <MudDataGrid T="PartyReceivablePayableModel"
                         Items="@reportData"
                         SortMode="SortMode.Multiple"
                         Filterable="true"
                         Hideable="true"
                         Dense="true"
                         Striped="true"
                         Hover="true">
                <Columns>
                    <PropertyColumn Property="x => x.PartyCode" Title="Code" Sortable="true" />
                    <PropertyColumn Property="x => x.PartyName" Title="Party Name" Sortable="true" />
                    <TemplateColumn Title="Party Type" Sortable="true" Filterable="true">
                        <CellTemplate>
                            @if (!string.IsNullOrWhiteSpace(context.Item.PartyType))
                            {
                                <MudChip Size="Size.Small" Variant="Variant.Text" 
                                        Color="@(context.Item.PartyType.ToUpper() == "CUSTOMER" ? Color.Success : Color.Warning)">
                                    @context.Item.PartyType
                                </MudChip>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Phone" Title="Phone" Sortable="true" />
                    <PropertyColumn Property="x => x.Email" Title="Email" Sortable="true" />
                    <TemplateColumn Title="Invoice Amount" Sortable="true" Filterable="false" CellClass="text-end">
                        <CellTemplate>
                            <MudText Typo="Typo.body2" Class="fw-semibold">
                                @context.Item.TotalInvoiceAmount.ToString("#,##0.00")
                            </MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Paid Amount" Sortable="true" Filterable="false" CellClass="text-end">
                        <CellTemplate>
                            <MudText Typo="Typo.body2" Class="fw-semibold" Style="color: #2196F3;">
                                @context.Item.TotalPaidAmount.ToString("#,##0.00")
                            </MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Receivable" Sortable="true" Filterable="false" CellClass="text-end">
                        <CellTemplate>
                            @if (context.Item.ReceivableAmount > 0)
                            {
                                <MudText Typo="Typo.body2" Class="fw-bold" Style="color: #4CAF50;">
                                    @context.Item.ReceivableAmount.ToString("#,##0.00")
                                </MudText>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Payable" Sortable="true" Filterable="false" CellClass="text-end">
                        <CellTemplate>
                            @if (context.Item.PayableAmount > 0)
                            {
                                <MudText Typo="Typo.body2" Class="fw-bold" Style="color: #F44336;">
                                    @context.Item.PayableAmount.ToString("#,##0.00")
                                </MudText>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Outstanding" Sortable="true" Filterable="false" CellClass="text-end">
                        <CellTemplate>
                            <MudText Typo="Typo.body2"
                                     Class="fw-bold"
                                     Color="@(context.Item.OutstandingBalance >= 0 ? Color.Success : Color.Error)">

                                @context.Item.OutstandingBalance.ToString("#,##0.00")
                            </MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.InvoiceCount" Title="Invoices" Sortable="true" />
                    <PropertyColumn Property="x => x.LastTransactionDate" Title="Last Transaction" Sortable="true" Format="dd-MMM-yyyy" />
                </Columns>
            </MudDataGrid>
        </MudPaper>
    }
    else if (!LoadingPanel)
    {
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudText Typo="Typo.body1">No receivable/payable data available.</MudText>
        </MudPaper>
    }
</MudContainer>

<style>
    .dashboard-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 8px;
    }
</style>

@code
{
    private string? selectedPartyType { get; set; }
    private bool LoadingPanel { get; set; } = false;
    private List<PartyReceivablePayableModel> reportData = new();
    private decimal totalReceivables = 0;
    private decimal totalPayables = 0;
    private decimal netOutstanding = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        LoadingPanel = true;
        try
        {
            var partyTypeParam = !string.IsNullOrWhiteSpace(selectedPartyType) ? $"?partyType={Uri.EscapeDataString(selectedPartyType)}" : "";
            
            reportData = await Functions.GetAsync<List<PartyReceivablePayableModel>>(
                $"Reports/PartyReceivablePayable/{Globals.User.OrganizationId}{partyTypeParam}", 
                true) ?? new List<PartyReceivablePayableModel>();
            
            // Calculate totals
            totalReceivables = reportData.Sum(x => x.ReceivableAmount);
            totalPayables = reportData.Sum(x => x.PayableAmount);
            netOutstanding = totalReceivables - totalPayables;
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading report: {ex.Message}", Severity.Error);
            reportData = new List<PartyReceivablePayableModel>();
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    private void PrintReport()
    {
        JSRuntime.InvokeVoidAsync("window.print");
    }
}

