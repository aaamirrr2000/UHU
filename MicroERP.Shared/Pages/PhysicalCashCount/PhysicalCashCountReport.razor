@page "/PhysicalCashCountReport/{id:int}"
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@inject Functions Functions
@inject Globals Globals

@if (reportData != null && reportData.Any())
{
    <div class="invoice-actions no-print text-end mb-3">
        <button class="btn btn-outline-secondary me-2" @onclick="GoBack">
            <i class="fas fa-arrow-left me-1"></i> Back
        </button>
        <button class="btn btn-primary" @onclick="PrintReport">
            <i class="fas fa-print me-1"></i> Print
        </button>
    </div>

    <div class="receipt shadow p-4 bg-white rounded">
        <!-- Header -->
        <div class="text-center mb-4">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <img src="@Globals.GetImageUrl(Globals.Organization.Logo)" alt="Logo" class="img-fluid rounded" style="height: 60px;" />
                </div>
                <div class="col-md-8">
                    <h2 class="fw-bold m-0">@Globals.Organization.Name</h2>
                    <h5 class="text-muted mt-1">Physical Cash Count Report</h5>
                </div>
            </div>
            <p class="text-muted mt-2">Count Date: @(reportData.First().CountDate?.ToString("dd-MMM-yyyy") ?? "N/A")</p>
        </div>

        <!-- Info Table -->
        <table class="table table-bordered table-sm">
            <tbody>
                <tr>
                    <th style="width: 35%;">Location</th>
                    <td>@(reportData.First().LocationName ?? "N/A")</td>
                </tr>
                <tr>
                    <th>Locker</th>
                    <td>@(reportData.First().Locker ?? "N/A")</td>
                </tr>
                <tr>
                    <th>Counted By</th>
                    <td>@(reportData.First().CountedByName ?? "N/A")</td>
                </tr>
                <tr>
                    <th>Status</th>
                    <td>@(reportData.First().StatusDisplay ?? "N/A")</td>
                </tr>
                @if (!string.IsNullOrWhiteSpace(reportData.First().Comments))
                {
                    <tr>
                        <th>Comments</th>
                        <td>@reportData.First().Comments</td>
                    </tr>
                }
                @if (!string.IsNullOrWhiteSpace(reportData.First().Notes))
                {
                    <tr>
                        <th>Notes</th>
                        <td>@reportData.First().Notes</td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Denominations Table -->
        <div class="mt-4">
            <h5 class="fw-bold mb-3">Cash Count by Denomination</h5>
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>Denomination</th>
                        <th class="text-center">Quantity</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in reportData.OrderByDescending(x => x.Denomination))
                    {
                        <tr>
                            <td>@item.Denomination.ToString("#,##0.00")</td>
                            <td class="text-center">@item.Quantity.ToString("#,##0")</td>
                            <td class="text-end">@item.Amount.ToString("#,##0.00")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="fw-bold">
                        <td>Grand Total</td>
                        <td class="text-center">@reportData.Sum(x => x.Quantity).ToString("#,##0")</td>
                        <td class="text-end">@reportData.Sum(x => x.Amount).ToString("#,##0.00")</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Footer -->
        <div class="footer mt-4 text-center">
            <p class="text-muted mb-0">
                <strong>Generated On:</strong> @DateTime.Now.ToString("dd-MMM-yyyy HH:mm:ss tt")
            </p>
            @if (reportData.First().CreatedOn != null)
            {
                <p class="text-muted mb-0">
                    <strong>Created On:</strong> @reportData.First().CreatedOn.ToString("dd-MMM-yyyy HH:mm:ss tt")
                </p>
            }
        </div>
    </div>
}

<style>
    .receipt {
        max-width: 800px;
        width: 100%;
        margin: auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .receipt .header {
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
        padding-bottom: 10px;
    }

    .receipt .footer {
        border-top: 1px solid #ddd;
        margin-top: 20px;
        padding-top: 10px;
    }

    .receipt .table th, .receipt .table td {
        padding: 8px;
        text-align: left;
    }

    .receipt .table th {
        background-color: #f2f2f2;
        width: 40%;
    }

    .text-center {
        text-align: center;
    }

    .text-end {
        text-align: right;
    }

    @@media print {
        .no-print {
            display: none !important;
        }

        .receipt {
            border: none;
            box-shadow: none;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 20px;
        }
    }
</style>

<script>
    function printReceipt() {
        var receiptContent = document.querySelector('.receipt').innerHTML;
        var originalContent = document.body.innerHTML;

        document.body.innerHTML = '<div>' + receiptContent + '</div>';
        window.print();
        document.body.innerHTML = originalContent;
        location.reload();
    }
</script>

@code {
    [Parameter] public int id { get; set; }
    private List<PhysicalCashCountModel> reportData = new();
    private bool LoadingPanel { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            //Globals.AccessLevel = Globals.PageAccess(NavManager, "PhysicalCashCountDashboard");
            
            // Get the first record to get session details
            var firstRecord = await Functions.GetAsync<PhysicalCashCountModel>($"PhysicalCashCount/Get/{id}", true);
            if (firstRecord == null || firstRecord.Id == 0)
            {
                return;
            }

            // Load all records for the same session (same CountDate, LocationId, Locker, CountedBy)
            string lockerEscaped = firstRecord.Locker?.Replace("'", "''") ?? string.Empty;
            string dateStr = firstRecord.CountDate.HasValue ? firstRecord.CountDate.Value.ToString("yyyy-MM-dd") : string.Empty;
            
            DateTime startTime = firstRecord.CreatedOn.AddMinutes(-1);
            DateTime endTime = firstRecord.CreatedOn.AddMinutes(1);
            string startTimeStr = startTime.ToString("yyyy-MM-dd HH:mm:ss");
            string endTimeStr = endTime.ToString("yyyy-MM-dd HH:mm:ss");
            string criteria = $"pcc.CountDate='{dateStr}' AND pcc.LocationId={firstRecord.LocationId} AND pcc.Locker='{lockerEscaped}' AND pcc.CountedBy={firstRecord.CountedBy} AND pcc.CreatedOn >= '{startTimeStr}' AND pcc.CreatedOn <= '{endTimeStr}'";
            
            reportData = await Functions.GetAsync<List<PhysicalCashCountModel>>($"PhysicalCashCount/SearchIndividual/{Uri.EscapeDataString(criteria)}", true) ?? new List<PhysicalCashCountModel>();
        }
        catch (Exception ex)
        {
            // Handle error silently or show message
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    private async Task PrintReport()
    {
        await JSRuntime.InvokeVoidAsync("printReceipt");
    }

    private void GoBack()
    {
        NavManager.NavigateTo("/PhysicalCashCountDashboard");
    }
}
