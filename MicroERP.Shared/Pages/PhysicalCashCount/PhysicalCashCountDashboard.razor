@page "/PhysicalCashCountDashboard"
@using MicroERP.Shared.Models
@using System.Linq

@inject IJSRuntime JSRuntime
@inject IDialogService dialogService
@inject NavigationManager NavManager
@inject ISnackbar SnackbarService
@inject Functions Functions
@inject Globals Globals

<Loading IsLoading="@LoadingPanel" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-0" Style="padding: 2px;">
    <div class="dashboard-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div>
                <MudText Typo="Typo.h5" Class="mb-0 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.Money" Class="me-2" Style="color: white;" />
                    Physical Cash Count Management
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted mt-1" Style="color: rgba(255,255,255,0.85) !important;">Manage daily physical cash counts by denomination</MudText>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2 mt-md-0 flex-wrap">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <MudDatePicker @bind-Date="startDate"
                                   Label="Start Date" DateFormat="dd MMM yyyy" Variant="Variant.Outlined" />
                    <MudDatePicker @bind-Date="endDate"
                                   Label="End Date" DateFormat="dd MMM yyyy" Variant="Variant.Outlined" />
                </div>
                @if (Globals.AccessLevel == 1)
                {
                    <MudButton StartIcon="@Icons.Material.TwoTone.Add" 
                               Size="Size.Small" 
                               Variant="Variant.Filled" 
                               Color="Color.Success" 
                               Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                               OnClick="@(() => Clear())">
                        New
                    </MudButton>
                }
                <MudButton StartIcon="@Icons.Material.TwoTone.Search" 
                           Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary"
                           Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                           OnClick="@(() => GetAll())">
                    Search
                </MudButton>
                <MudButton StartIcon="@Icons.Material.TwoTone.Refresh" 
                           Size="Size.Small" 
                           Variant="Variant.Filled" 
                           Color="Color.Info"
                           Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                           OnClick="@(() => Refresh())">
                    Refresh
                </MudButton>
            </div>
        </div>
    </div>

    <MyDrawer @ref="_drawer" Title="Physical Cash Count" FaIcon="fas fa-money-bill-wave">
        <HeaderContent>
             @if (Action != "VIEW" && Globals.AccessLevel == 1)
            {
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           Size="Size.Small"
                           OnClick="Save"
                           Disabled="@(_isSaving || !string.IsNullOrEmpty(PeriodValidationMessage))"
                           Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; margin-right: 8px;">
                    <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                    @(_isSaving ? "Saving..." : (Action == "INSERT" ? "Save" : "Update"))
                </MudButton>

                @if (Action == "UPDATE")
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Error"
                               Size="Size.Small"
                               OnClick="@(() => Delete(record.Id))"
                               Disabled="@(!string.IsNullOrEmpty(PeriodValidationMessage))"
                               Style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                        <MudIcon Icon="@Icons.Material.Filled.Delete" Class="mr-1" />
                        Delete
                    </MudButton>
                }
            }
        </HeaderContent>
        <ChildContent>
             <PhysicalCashCountPage Model="@record" 
                                    DenominationEntries="@denominationEntries"
                                    Locations="@Locations"
                                    Users="@Users"
                                    Lockers="@Lockers"
                                    IsReadOnly="@isReadOnly"
                                    IsAdmin="@(Globals.User.GroupId == 1)"
                                    PeriodValidationMessage="@PeriodValidationMessage"
                                    OnDateChanged="@ValidatePeriodAsync" />
        </ChildContent>
        <FooterContent>
        </FooterContent>
    </MyDrawer>

    @if (data == null)
    {
        <SimpleLoading />
    }
    else
    {
        <MudPaper Elevation="3" Style="border-radius: 12px; overflow: hidden;">
            <MudDataGrid T="PhysicalCashCountModel"
                         MultiSelection="false"
                         Items="@data"
                         SortMode="SortMode.Multiple"
                         Filterable="true"
                         Hideable="true"
                         RowsPerPage="20"
                         Dense="true"
                         Striped="true"
                         Hover="true"
                         Class="professional-grid elevation-8">

                <Columns>
                    <TemplateColumn Title="Actions"
                                    CellStyle="width: 80px; min-width: 80px;"
                                    HeaderClass="grid-header">
                        <CellTemplate Context="row">
                            <div class="actions-cell">
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="actions-menu">
                                    <MudMenuItem OnClick="@(() => View(row.Item.Id))"
                                                 Class="menu-item view-item">
                                        <MudIcon Icon="@Icons.Material.Filled.Visibility" Class="menu-icon" />
                                        <span>View</span>
                                    </MudMenuItem>
                                    @if (Globals.AccessLevel == 1)
                                    {
                                        <MudMenuItem OnClick="@(() => Edit(row.Item.Id))"
                                                     Class="menu-item edit-item">
                                            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="menu-icon" />
                                            <span>Edit</span>
                                        </MudMenuItem>
                                    
                                        <MudMenuItem OnClick="@(() => Delete(row.Item.Id))"
                                        Color="Color.Error"
                                        Class="menu-item delete-item">
                                            <MudIcon Icon="@Icons.Material.Filled.Delete" Class="menu-icon" />
                                            <span>Delete</span>
                                        </MudMenuItem>
                                    }
                                    <hr />
                                    <MudMenuItem OnClick="@(() => Print(row.Item.Id))"
                                                 Class="menu-item print-item">
                                        <MudIcon Icon="@Icons.Material.Filled.Print" Class="menu-icon" />
                                        <span>Print</span>
                                    </MudMenuItem>
                                </MudMenu>
                            </div>
                        </CellTemplate>
                    </TemplateColumn>

                    <PropertyColumn Property="x => x.CountDate"
                                    Title="Date"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Format="dd MMM yyyy"
                                    Width="120px" />

                    <PropertyColumn Property="x => x.CountedByName"
                                    Title="Employee"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="150px" />

                    <PropertyColumn Property="x => x.LocationName"
                                    Title="Location"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="150px" />

                    <PropertyColumn Property="x => x.Locker"
                                    Title="Locker"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="120px" />

                    <PropertyColumn Property="x => x.Amount"
                                    Title="Total Amount"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Format="#,##0.00"
                                    Width="150px" />

                    <PropertyColumn Property="x => x.StatusDisplay"
                                    Title="Status"
                                    Sortable="true"
                                    Filterable="true"
                                    HeaderClass="grid-header"
                                    CellClass="grid-cell"
                                    Width="100px" />

                </Columns>

                <PagerContent>
                    <div class="pager-container">
                        <MudDataGridPager T="PhysicalCashCountModel" Class="grid-pager" />
                    </div>
                </PagerContent>

            </MudDataGrid>
        </MudPaper>
    }
</MudContainer>

<style>
    .dashboard-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 8px;
    }

    .dashboard-header .mud-typography {
        color: white !important;
    }

    .dashboard-header .text-muted {
        color: rgba(255, 255, 255, 0.85) !important;
    }

    /* Dark mode adjustments */
    .mud-theme-dark .dashboard-header {
        background: linear-gradient(135deg, var(--mud-palette-primary-darken) 0%, var(--mud-palette-primary) 100%);
    }
</style>

@code
{
    List<PhysicalCashCountModel> data = new();
    PhysicalCashCountModel record = new();
    List<PhysicalCashCountDenominationEntry> denominationEntries = new();
    
    // Lists for dropdowns
    List<LocationsModel> Locations = new();
    List<UsersModel> Users = new();
    List<TypeCodeModel> Lockers = new();
    List<TypeCodeModel> Denominations = new();

    public DateTime? startDate { get; set; } = DateTime.Today;
    public DateTime? endDate { get; set; } = DateTime.Today;

    public string? Action { get; set; } = "INSERT";
    private bool _isSaving = false;
    
    string PeriodValidationMessage = string.Empty;

    bool isReadOnly = true;
    private bool LoadingPanel { get; set; } = false;
    private MyDrawer _drawer = new();

    protected override async Task OnInitializedAsync()
    {
        Globals.AccessLevel = Globals.PageAccess(NavManager, "PhysicalCashCountDashboard");
        await LoadDropdowns();
        await GetAll();
    }
    
    private async Task LoadDropdowns()
    {
        try 
        {
            // Load locations
            Locations = await Functions.GetAsync<List<LocationsModel>>($"Locations/Search/IsActive=1", true) ?? new List<LocationsModel>();

            // Load employees
            var employees = await Functions.GetAsync<List<EmployeesModel>>($"Employees/Search", true) ?? new List<EmployeesModel>();
            if (employees != null && employees.Any())
            {
                Users = employees.Select(e => new UsersModel
                {
                    Id = e.Id,
                    FullName = e.Fullname,
                    Username = e.EmpId,
                    IsActive = e.IsActive
                }).Where(u => u.IsActive == 1).OrderBy(u => u.FullName ?? u.Username ?? "").ToList();
            }
            else
            {
                 Users = await Functions.GetAsync<List<UsersModel>>($"Users/Search/IsActive=1", true) ?? new List<UsersModel>();
            }

            // Load lockers
            Lockers = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/LOCKER", true) ?? new List<TypeCodeModel>();
            Lockers = Lockers.OrderBy(l => l.ListValue).ToList();

            // Load denominations
            var allDenominations = await Functions.GetAsync<List<TypeCodeModel>>($"TypeCode/Search/DENOMINATION", true) ?? new List<TypeCodeModel>();
            Denominations = allDenominations
                .OrderByDescending(d => decimal.TryParse(d.ListValue, out decimal val) ? val : 0)
                .ToList();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading dropdowns: {ex.Message}", Severity.Error);
        }
    }

    protected async Task GetAll()
    {
        try
        {
            if (!startDate.HasValue || !endDate.HasValue)
            {
                SnackbarService.Add("Please select both start and end dates.", Severity.Warning);
                return;
            }

            if (startDate > endDate)
            {
                SnackbarService.Add("Start date must be earlier than end date.", Severity.Warning);
                return;
            }

            string formattedStartDate = startDate.Value.ToString("yyyy-MM-dd");
            string formattedEndDateNextDay = endDate.Value.Date.AddDays(1).ToString("yyyy-MM-dd");

            // Use ISNULL so criteria passes API SQL-injection safe pattern (CAST(ISNULL(pcc.CountDate, pcc.CreatedOn) AS DATE))
            string Criteria = $"CAST(ISNULL(pcc.CountDate, pcc.CreatedOn) AS DATE) >= CAST('{formattedStartDate}' AS DATE) " +
                              $"AND CAST(ISNULL(pcc.CountDate, pcc.CreatedOn) AS DATE) < CAST('{formattedEndDateNextDay}' AS DATE)";

            if (Globals.User.GroupId != 1)
            {
                Criteria += $" AND pcc.LocationId = {Globals.User.LocationId}";
            }

            string encodedCriteria = Uri.EscapeDataString(Criteria);
            string apiUrl = $"PhysicalCashCount/Search/{encodedCriteria}";

            LoadingPanel = true;
            data = await Functions.GetAsync<List<PhysicalCashCountModel>>(apiUrl, true) ?? new List<PhysicalCashCountModel>();
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error loading data: {ex.Message}", Severity.Error);
            data = new List<PhysicalCashCountModel>();
        }
        finally
        {
            LoadingPanel = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private void InitializeDenominations()
    {
        denominationEntries.Clear();
        foreach (var d in Denominations)
        {
            if (decimal.TryParse(d.ListValue, out decimal val))
            {
                denominationEntries.Add(new PhysicalCashCountDenominationEntry
                {
                    Denomination = val,
                    Quantity = 0,
                    Amount = 0
                });
            }
        }
    }

    protected async Task Clear()
    {
        Action = "INSERT";
        record = new PhysicalCashCountModel();
        record.CountDate = DateTime.Now;
        record.CountedBy = Globals.User.Id;
        record.Status = "NOT RECONCILED";
        record.SessionId = Guid.NewGuid();
        
        if (Globals.User.GroupId == 1)
             record.LocationId = Locations.FirstOrDefault()?.Id ?? 0;
        else
             record.LocationId = Globals.User.LocationId;

        InitializeDenominations();
        isReadOnly = false;
        
        await ValidatePeriodAsync();
        
        await _drawer.OpenDrawerAsync();
    }
    
    protected async Task ValidatePeriodAsync()
    {
        if (!record.CountDate.HasValue || record.LocationId == 0)
        {
            PeriodValidationMessage = string.Empty;
            return;
        }

        try
        {
            string dateStr = record.CountDate.Value.ToString("yyyy-MM-dd");
            //// Assuming CASHBOOK check is appropriate here as copied from original
            var periodResult = await Functions.GetAsync<PeriodCloseModel>($"PeriodClose/GetOpenPeriod/{Globals.User.OrganizationId}/{dateStr}/CASHBOOK", true);

            if (periodResult == null || periodResult.Id == 0)
            {
                PeriodValidationMessage = $"Period is CLOSED for CashBook on {record.CountDate.Value:dd MMM yyyy}. You cannot save cash count for this date.";
            }
            else
            {
                PeriodValidationMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            PeriodValidationMessage = $"Error validating period: {ex.Message}";
        }
        
        StateHasChanged();
    }

    protected async Task Refresh()
    {
        await GetAll();
    }

    protected async Task View(int id)
    {
        await LoadRecord(id);
        Action = "VIEW";
        isReadOnly = true;
        await _drawer.OpenDrawerAsync();
    }

    protected async Task Edit(int id)
    {
        await LoadRecord(id);
        Action = "UPDATE"; 
        isReadOnly = false;
        
        await ValidatePeriodAsync();
        
        await _drawer.OpenDrawerAsync();
    }
    
    private async Task LoadRecord(int id)
    {
        LoadingPanel = true;
        try 
        {
            record = await Functions.GetAsync<PhysicalCashCountModel>($"PhysicalCashCount/Get/{id}", true) ?? new PhysicalCashCountModel();
            
            InitializeDenominations();
            
            if (record.Id > 0)
            {
                 // Load details
                 List<PhysicalCashCountModel> allSessionRecords;
                 
                 if (record.SessionId.HasValue)
                 {
                    string sessionIdStr = record.SessionId.Value.ToString();
                    string criteria = $"pcc.SessionId='{sessionIdStr}'";
                    allSessionRecords = await Functions.GetAsync<List<PhysicalCashCountModel>>($"PhysicalCashCount/SearchIndividual/{Uri.EscapeDataString(criteria)}", true) ?? new List<PhysicalCashCountModel>();
                 }
                 else
                 {
                    // Fallback
                    string lockerEscaped = record.Locker?.Replace("'", "''") ?? string.Empty;
                    string countDateStr = record.CountDate.HasValue ? record.CountDate.Value.ToString("yyyy-MM-dd HH:mm:ss") : string.Empty;
                    string criteria = $"pcc.CountDate='{countDateStr}' AND pcc.LocationId={record.LocationId} AND pcc.Locker='{lockerEscaped}' AND pcc.CountedBy={record.CountedBy}";
                    allSessionRecords = await Functions.GetAsync<List<PhysicalCashCountModel>>($"PhysicalCashCount/SearchIndividual/{Uri.EscapeDataString(criteria)}", true) ?? new List<PhysicalCashCountModel>();
                 }
                 
                 foreach (var entry in denominationEntries)
                 {
                     var existing = allSessionRecords.FirstOrDefault(r => r.Denomination == entry.Denomination);
                     if (existing != null)
                     {
                         entry.Quantity = existing.Quantity;
                         entry.Amount = existing.Amount;
                         entry.RecordId = existing.Id;
                     }
                 }
            }
        }
        finally 
        {
            LoadingPanel = false;
        }
    }

    protected async Task Delete(int id)
    {
        var res = await Functions.ShowConfirmation(dialogService, "Do you want to delete this cash count session? All denomination records in this session will be deleted.");
        if (res == false)
            return;

        try
        {
            LoadingPanel = true;
            
            // Re-fetch to ensure we have session ID
            var recordToDelete = await Functions.GetAsync<PhysicalCashCountModel>($"PhysicalCashCount/Get/{id}", true);
            
            if (recordToDelete == null || recordToDelete.Id == 0)
            {
                SnackbarService.Add("Record not found", Severity.Error);
                return;
            }

            // Set update information
            recordToDelete.UpdatedBy = Globals.User.Id;
            recordToDelete.UpdatedOn = DateTime.Now;
            recordToDelete.UpdatedFrom = Globals.ClientInfo;

            // SoftDelete will delete all records in the session
            var result = await Functions.PostAsync<PhysicalCashCountModel>("PhysicalCashCount/SoftDelete", recordToDelete, true);
            
            if (result.Success)
            {
                SnackbarService.Add("Cash count session deleted successfully", Severity.Success);
                await GetAll();
                await _drawer.CloseDrawerAsync();
            }
            else
            {
                SnackbarService.Add($"Failed to delete: {result.Message ?? "Unknown error"}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error deleting records: {ex.Message}", Severity.Error);
        }
        finally
        {
            LoadingPanel = false;
        }
    }

    protected async Task Save()
    {
        if (_isSaving) return;
        _isSaving = true;

        try
        {
            // Validations
            if (!record.CountDate.HasValue) { SnackbarService.Add("Please select a Count Date", Severity.Warning); return; }
            if (record.LocationId == 0) { SnackbarService.Add("Please select a Location", Severity.Warning); return; }
            if (string.IsNullOrWhiteSpace(record.Locker)) { SnackbarService.Add("Please enter a Locker name/number", Severity.Warning); return; }
            if (record.CountedBy == 0) { SnackbarService.Add("Please select the employee", Severity.Warning); return; }
            if (!denominationEntries.Any(e => e.Quantity > 0)) { SnackbarService.Add("Please enter quantity for at least one denomination", Severity.Warning); return; }

            LoadingPanel = true;
            
            // Common fields setup
            record.OrganizationId = Globals.User.OrganizationId;
            record.CreatedBy = Globals.User.Id;
            record.CreatedOn = DateTime.Now;
            record.CreatedFrom = Globals.ClientInfo;
            record.UpdatedBy = Globals.User.Id;
            record.UpdatedOn = DateTime.Now;
            record.UpdatedFrom = Globals.ClientInfo;
            
            if (!record.SessionId.HasValue) record.SessionId = Guid.NewGuid();
            
            // Auto-generate comments if needed
            decimal grandTotal = denominationEntries.Sum(e => e.Amount);
            if (string.IsNullOrWhiteSpace(record.Comments))
            {
                record.Comments = $"{record.Locker} Total Amount {grandTotal:N2} on {record.CountDate.Value:dd MMM yyyy HH:mm}";
            }

            // Save individual records
            string actionToUse = Action == "UPDATE" ? "UPDATE" : "INSERT"; // Use UPDATE if updating invalid records logic? 
            // Actually API handles Insert/Update based on ID usually, but here we might have mixed inserts/updates?
            // The original logic just loop saves.
            
            bool allSuccess = true;
            
            foreach (var entry in denominationEntries)
            {
                var entryRecord = new PhysicalCashCountModel
                {
                    Id = entry.RecordId ?? 0,
                    OrganizationId = record.OrganizationId,
                    LocationId = record.LocationId,
                    Locker = record.Locker,
                    CountedBy = record.CountedBy,
                    CountDate = record.CountDate,
                    Notes = record.Notes,
                    Comments = record.Comments,
                    Status = record.Status,
                    SessionId = record.SessionId,
                    
                    Denomination = entry.Denomination,
                    Quantity = entry.Quantity,
                    Amount = entry.Amount,
                    
                    CreatedBy = record.CreatedBy,
                    CreatedOn = record.CreatedOn,
                    CreatedFrom = record.CreatedFrom,
                    UpdatedBy = record.UpdatedBy,
                    UpdatedOn = record.UpdatedOn,
                    UpdatedFrom = record.UpdatedFrom
                };
                
                // If ID is 0, action is INSERT, else UPDATE
                string itemAction = (entryRecord.Id == 0) ? "INSERT" : "UPDATE";
                
                // Optimized: Only save if quantity > 0 OR (quantity is 0 AND it was an existing record we want to zero out/delete?)
                // If it's a new record with 0 quantity, no need to save?
                // Original logic saved everything? Let's save if Quantity > 0 or Id > 0
                if (entryRecord.Quantity > 0 || entryRecord.Id > 0)
                {
                    var result = await Functions.PostAsync<PhysicalCashCountModel>($"PhysicalCashCount/{itemAction}", entryRecord, true);
                    if (!result.Success) allSuccess = false;
                    else 
                    {
                         // Update local ID if inserted
                         if (entryRecord.Id == 0 && result.Result != null)
                         {
                             entry.RecordId = result.Result.Id;
                         }
                    }
                }
            }

            if (allSuccess)
            {
                SnackbarService.Add($"Cash count saved successfully", Severity.Success);
                await GetAll();
                
                 // Reload to get fresh state including any new IDs
                 // Or just keep drawer open? Usually we can close or keep open.
                 // Let's match typical behavior - keep open in edit mode
                 if (Action == "INSERT") 
                 {
                     // Get ONE ID to reload the session
                     var oneEntry = denominationEntries.FirstOrDefault(e => e.RecordId > 0);
                     if (oneEntry != null && oneEntry.RecordId.HasValue)
                     {
                         await LoadRecord(oneEntry.RecordId.Value);
                         Action = "UPDATE";
                     }
                     else
                     {
                         // Backup reload using session
                         // Implies re-search... let's just close drawer to be safe
                         await _drawer.CloseDrawerAsync();
                     }
                 }
                 else
                 {
                     // Refresh current session
                     var currentId = record.Id; // This might be stale if we didn't update it
                     if(currentId > 0) await LoadRecord(currentId);
                     else await _drawer.CloseDrawerAsync();
                 }
                 await GetAll();
            }
            else
            {
                SnackbarService.Add($"Some records failed to save. Please check details.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            SnackbarService.Add($"Error saving: {ex.Message}", Severity.Error);
        }
        finally
        {
            LoadingPanel = false;
            _isSaving = false;
        }
    }

    protected void Print(int id)
    {
        var url = $"/PhysicalCashCountReport/{id}";
        NavManager.NavigateTo(url);
    }
}

