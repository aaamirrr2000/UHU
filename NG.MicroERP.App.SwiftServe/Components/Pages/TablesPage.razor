@page "/TablesPage"
@using System.Collections.ObjectModel
@inject NavigationManager Nav
@inject CartStateService CartState
@inject IJSRuntime JS
@layout MyMenuLayout
<div class="container py-4">
    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (Tables?.Any() == true)
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var table in Tables)
            {
                <div class="col">
                    <div class="card h-100 border-0 shadow rounded-4" style="background-color: #ffffff;">
                        <div class="card-body text-start px-4 py-4">
                            <div class="d-flex justify-content-between align-items-start flex-wrap mb-3">
                                <div class="mb-2">
                                    <h5 class="card-title fw-semibold text-dark mb-1">
                                        <i class="fas fa-chair text-secondary me-2"></i>
                                        Table @table.TableNumber - @table.TableLocation
                                    </h5>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-users me-1"></i> Capacity: @table.Capacity Persons
                                    </p>
                                </div>
                                <div>
                                    <button class="btn btn-icon btn-success"
                                            title="View Current Order"
                                            @onclick="@(() => OnViewOrderClicked(table.Id))">
                                        <i class="fas fa-receipt"></i>
                                    </button>

                                </div>
                            </div>

                            <div class="d-flex justify-content-center gap-3 mb-3">
                                <button class="btn w-100 px-3 py-3 text-center service-button" style="background-color: #007bff; color: white;" @onclick="@(() => OnServiceTypeSelected(table, "Dine-In"))">
                                    <div class="mb-1">
                                        <i class="fas fa-utensils fa-2x"></i>
                                    </div>
                                    <div class="fw-semibold small">Dine-In</div>
                                </button>

                                <button class="btn w-100 px-3 py-3 text-center service-button" style="background-color: #ffc107; color: #212529;" @onclick="@(() => OnServiceTypeSelected(table, "Takeaway"))">
                                    <div class="mb-1">
                                        <i class="fas fa-shopping-bag fa-2x"></i>
                                    </div>
                                    <div class="fw-semibold small">Takeaway</div>
                                </button>

                                <button class="btn w-100 px-3 py-3 text-center service-button" style="background-color: #17a2b8; color: white;" @onclick="@(() => OnServiceTypeSelected(table, "Parcel"))">
                                    <div class="mb-1">
                                        <i class="fas fa-box-open fa-2x"></i>
                                    </div>
                                    <div class="fw-semibold small">Parcel</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center text-muted mt-5">
            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
            <p>No tables found.</p>
        </div>
    }
</div>


@code {
    private List<RestaurantTablesModel> Tables = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Globals.PageTitle = "Tables";
        StateHasChanged();
        await LoadTablesAsync();
    }

    private async Task LoadTablesAsync()
    {
        try
        {
            isLoading = true;
            var result = await Functions.GetAsync<List<RestaurantTablesModel>>("RestaurantTables/Search", true);

            if (result is not null)
            {
                Tables = result.Select(table =>
                {
                    table.AvailableStatus = table.IsAvailable == 1 ? "Busy" : "Available";
                    return table;
                }).ToList();
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnServiceTypeSelected(RestaurantTablesModel selectedTable, string serviceType)
    {
        if (Globals._selectedTable != null)
        {
            if (Globals._selectedTable.Id != selectedTable.Id)
                Globals._cart.Clear();
        }
        else 
            Globals._cart.Clear();
            Globals._serviceType = serviceType;
            Nav.NavigateTo($"/OrderPage?tableId={selectedTable.Id}");
    }

    private void OnViewOrderClicked(int tableId)
    {
        Nav.NavigateTo($"/OrderDetailsPage/TABLE/{tableId}");
        //Nav.NavigateTo($"/ViewOrderPage?tableId={tableId}");
    }
}

<style>
    .card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-5px);
}

.btn {
    font-weight: 500;
    font-size: 0.95rem;
}

    .btn-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        transition: background-color 0.2s ease-in-out, transform 0.2s;
    }

        .btn-icon i {
            font-size: 1.2rem;
        }

        .btn-icon:hover {
            background-color: #218838; /* darker shade of green */
            transform: scale(1.05);
        }
</style>