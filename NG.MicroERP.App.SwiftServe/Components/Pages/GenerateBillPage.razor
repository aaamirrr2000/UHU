@page "/GenerateBillPage/{id:int}"
@inject NavigationManager Nav
@layout MyMenuLayout
@using System.Collections.ObjectModel
@using NG.MicroERP.Shared.Services

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-0" Style="padding: 8px;">
<div class="invoice-container" id="billContent">
    <header class="invoice-header">
        <h2>B I L L</h2>
        <div class="invoice-info">
            <div class="info-row"><strong>Bill #:</strong> @Invoices.Invoice?.Code</div>
            <div class="info-row"><strong>Date:</strong> @Invoices.Invoice?.TranDate?.ToString("dd-MMM-yyyy")</div>
            <div class="info-row"><strong>Location:</strong> @Invoices.Invoice?.Location</div>
        </div>
    </header>

    <hr />

    <section class="invoice-table">
        <div class="table-header">
            <div class="col-item">Item</div>
            <div class="col-center">Qty</div>
            <div class="col-right">Rate</div>
            <div class="col-right">Total</div>
        </div>

        @foreach (var item in InvoiceDetails)
        {
            <div class="table-row">
                <div class="col-item">@item.ItemName @item.ServingSize</div>
                <div class="col-center">@item.Qty</div>
                <div class="col-right">@item.UnitPrice.ToString("N2")</div>
                <div class="col-right">@item.ItemTotalAmount.ToString("N2")</div>
            </div>
        }
    </section>

    <section class="invoice-total">
        <div class="total-row">
            <label>Sub Total:</label>
            <div class="readonly">@GetSubTotal().ToString("N2")</div>
        </div>
       @*  <div class="total-row">
            <label>Service Charges @@ @MyGlobals.ServiceCharge.Amount%:</label>
            <div class="readonly">@Bills.Bill!.ServiceCharge.ToString("N2")</div>
        </div>
        <div class="total-row">
            <label>GST  @@ @MyGlobals.GST%:</label>
            <div class="readonly">@Bills.Bill!.TaxAmount.ToString("N2")</div>
        </div> *@
        <div class="total-row">
            <label>Discount:</label>
            @if (BillGenerated == false)
            {
                <input type="number" step="1" class="editable" @bind="Invoices.Invoice!.DiscountAmount" @oninput="RecalculateTotal" disabled="@BillGenerated" />
            }
            else
            {
                <div class="readonly">@Invoices.Invoice!.DiscountAmount.ToString("N2")</div>
            }
        </div>
        <div class="grand-total">
            <label>Grand Total:</label>
            <div class="readonly">@GetGrandTotal().ToString("N2")</div>
        </div>
    </section>

    <div class="invoice-actions">
        @if (Invoices.Invoice.Status != "COMPLETE")
        {
            <button class="btn btn-primary" @onclick="GenerateBill" disabled="@BillGenerated">Generate Bill</button>
        }
        <button class="btn btn-outline-secondary" @onclick="PrintInvoice">🖨️ Print</button>
    </div>

    <footer class="invoice-footer">
        <p>Thank you for your business!</p>
    </footer>
</div>
</MudContainer>

@code {
    [Parameter] public int id { get; set; }
    [CascadingParameter] private List<ItemsModel> _cart { get; set; }

    private InvoicesModel Invoices = new();
    private ObservableCollection<InvoiceItemReportModel> InvoiceDetails = new();

    private List<TypeCodeModel> GST = new();

    // Hide or show service charge input
    private bool ServiceCharges = false;
    private bool BillGenerated = false;


    protected override async Task OnInitializedAsync()
    {
        MyGlobals.PageTitle = "Generate Bill";

        GST = await MyFunctions.GetAsync<List<TypeCodeModel>>("TypeCode/Search/GST", true) ?? new List<TypeCodeModel>();

        await LoadBills(id);
        StateHasChanged();
    }

    private async Task LoadBills(int Id)
    {
        var res = await MyFunctions.GetAsync<List<InvoiceModel>>($"Invoice/Search/i.Id={Id}", true);
        if (res is { Count: > 0 })
        {
            Invoices.Invoice = res.First();

            if (Invoices.Invoice.Status == "COMPLETE")
                BillGenerated = true;

            var detailRes = await MyFunctions.GetAsync<List<InvoiceItemReportModel>>($"InvoiceDetail/Search/InvoiceDetail.InvoiceId={Id}", true);
            if (detailRes != null)
            {
                InvoiceDetails.Clear();
                foreach (var item in detailRes)
                {
                    InvoiceDetails.Add(item);
                }
            }
        }
    }

    private double GetSubTotal() => InvoiceDetails.Sum(x => x.ItemTotalAmount);

    private double GetGrandTotal()
    {

        double subTotal = GetSubTotal();

        // ✅ Calculate Service Amount based on type
        double serviceAmount = 0;
        if (MyGlobals.ServiceCharge.ChargeType == "PERCENTAGE")
        {
            serviceAmount = (MyGlobals.ServiceCharge.Amount / 100) * subTotal;
        }
        else if (MyGlobals.ServiceCharge.ChargeType == "FLAT")
        {
            serviceAmount = MyGlobals.ServiceCharge.Amount;
        }

        // ✅ Discount
        double discount = Convert.ToDouble(Invoices.Invoice?.DiscountAmount ?? 0);

        // ✅ Calculate tax on base amount (subtotal + service charge - discount)
        double taxBase = subTotal + serviceAmount - discount;
        double tax = (MyGlobals.GST / 100) * taxBase;
        //Bills.Bill!.TaxAmount = Convert.ToDecimal(tax);

        // ✅ Optional: Store service amount too
        //Bills.Bill.ServiceCharge = serviceAmount;



        //var res = MyGlobals.CalculateBillAmounts(Bills.Bill.Id);

        return subTotal + serviceAmount + tax - discount;
    }

    private void RecalculateTotal(ChangeEventArgs e)
    {
        StateHasChanged();
    }

    private async Task GenerateBill()
    {
        var tranDate = DateTime.Now;
        var invoice = new InvoiceModel
        {
            Id = id,
            DiscountAmount = Invoices.Invoice.DiscountAmount,
        };


        var result = await MyFunctions.PostAsync<string>("Invoice/GenerateBill", invoice, true);

        if (!result.Success)
        {
            await Application.Current.MainPage.DisplayAlert("⚠️ Billing Error", "Unable to generate the bill. Please check the order details and try again.", "OK");
        }
        else
        {
            await Application.Current.MainPage.DisplayAlert("✅ Done", "Bill generated and ready to go!", "Great");
            _cart.Clear();
            Nav.NavigateTo($"/OrdersPage");

        }
    }

    private async void PrintInvoice()
    {
        // await pdfHelper.GenerateBill();
    }

    public static void ApplyChargesToItems(
     List<InvoiceItemReportModel> items,
     List<InvoiceChargesReportModel> charges)
    {
        if (items == null || charges == null || !items.Any() || !charges.Any()) return;

        decimal totalBaseAmount = Convert.ToDecimal(items.Sum(i => i.ItemTotalAmount));

        foreach (var charge in charges)
        {
            foreach (var item in items)
            {
                decimal itemTotal = Convert.ToDecimal(item.ItemTotalAmount);
                decimal proportion = totalBaseAmount == 0 ? 0 : itemTotal / totalBaseAmount;
                decimal chargeAmount = 0;

                if (charge.AmountType?.ToUpper() == "FIXED")
                {
                    chargeAmount = Convert.ToDecimal(charge.AppliedAmount) * proportion;
                }
                else if (charge.AmountType?.ToUpper() == "PERCENTAGE")
                {
                    chargeAmount = itemTotal * (Convert.ToDecimal(charge.Rate) / 100m);
                }

                /*
                if (item.ChargesBreakdown.ContainsKey(charge.RuleName!))
                    item.ChargesBreakdown[charge.RuleName!] += chargeAmount;
                else
                    item.ChargesBreakdown[charge.RuleName!] = chargeAmount;
                */
            }
        }
    }
}

<style>
    .invoice-container {
        max-width: 800px;
        margin: auto;
        background: #fff;
        padding: 30px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 0.88rem; /* Reduced font size */
        box-shadow: 0 0 10px rgba(0,0,0,0.15);
        border-radius: 8px;
        color: #333;
    }

    .invoice-header h2 {
        text-align: center;
        margin-bottom: 10px;
    }

    .invoice-info {
        display: flex;
        flex-direction: column;
        font-size: 0.95rem;
        margin-bottom: 10px;
        gap: 4px; /* Optional: space between rows */
    }

    .info-row {
        display: flex;
        justify-content: space-between;
    }

    hr {
        border-top: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .invoice-table {
        width: 100%;
        margin-bottom: 20px;
    }

    .table-header,
    .table-row {
        display: grid;
        grid-template-columns: 3fr 1fr 1fr 1fr; /* 3fr for Item, equal 1fr for others */
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }



    .table-header {
        font-weight: bold;
        background: #f5f5f5;
    }

    .col-item {
        padding-right: 10px;
    }

    .col-center {
        text-align: center;
    }

    .col-right {
        text-align: right;
    }

    .invoice-total {
        margin-top: 20px;
        max-width: 400px;
        margin-left: auto;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
    }

        .total-row label {
            font-weight: 600;
            min-width: 140px;
        }

        .total-row input.editable {
            max-width: 120px;
            text-align: right;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .total-row .total-value {
            font-weight: bold;
            text-align: right;
            min-width: 120px;
        }

        .total-row.grand label {
            font-size: 1.1rem;
        }

        .total-row.grand .total-value {
            font-size: 1.1rem;
            color: #000;
            border-top: 2px solid #000;
        }

    .invoice-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }

        .invoice-actions .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
        }

    .invoice-footer {
        text-align: center;
        margin-top: 40px;
        font-size: 0.9rem;
        color: #777;
    }

    .grand-total {
        font-weight: bold;
        font-size: 1rem;
        border-top: 1px solid #333;
        margin-top: 8px;
        padding-top: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>