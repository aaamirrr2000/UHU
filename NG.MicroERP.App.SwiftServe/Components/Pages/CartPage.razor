@page "/CartPage"
@using System.Collections.ObjectModel
@inject NavigationManager Nav
@inject CartStateService CartState
@inject IJSRuntime JS
@layout MyMenuLayout

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-0" Style="padding: 8px;">
    <div class="cart-header mb-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div>
                <h4 class="mb-0 fw-bold" style="color: white;">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Shopping Cart
                </h4>
                <p class="text-muted mt-1 mb-0" style="color: rgba(255,255,255,0.85) !important;">
                    <i class="fas fa-chair me-1"></i> Table: @CartState.SelectedTable?.TableNumber | 
                    <i class="fas fa-concierge-bell me-1"></i> Service: @CartState.ServiceType
                </p>
            </div>
            <div>
                <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px;" @onclick="GoBackToOrderPage" title="Back to Order">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
            </div>
        </div>
    </div>


    @if (CartState.CartItems?.Any() == true)
    {
        @foreach (var item in CartState.CartItems)
        {
            <div class="cart-item">
                <div class="d-flex justify-content-between align-items-center">
                    <h4>@item.Name</h4>
                    <button class="btn mt-2" style="background-color: #dc3545; color: white; border-radius: 8px;" @onclick="() => RemoveItem(item)">Remove</button>
                </div>
               <div class="d-flex flex-column mt-2">
                    <!-- Row 1: Quantity -->
                    <div class="input-group mb-2" style="width: 120px;">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => DecreaseQty(item)">-</button>
                        <input type="text" class="form-control text-center" value="@item.MaxQty" readonly />
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => IncreaseQty(item)">+</button>
                    </div>

                    <!-- Row 2: Size, Price, Person -->
                    <div class="d-flex flex-wrap gap-3">
                        <div><small>Size: @item.ServingSize</small></div>
                        <div><small>Price: @item.RetailPrice.ToString("N2")</small></div>
                        @if (item.Person > 0)
                        {
                            <div><small>Chair: @item.Person</small></div>
                        }
                    </div>
                </div>

                <input class="form-control mt-2" placeholder="Instructions" maxlength="255" @bind="item.Description" />
            </div>
        }
    }
    else
    {
        <p class="text-center text-muted">Cart is empty.</p>
    }

    <textarea class="form-control mt-3" placeholder="Note" rows="4" maxlength="255" @bind="CartState.BillNote"></textarea>

    <div class="cart-footer mt-3">
        <div class="summary-row">
            <span>Sub Total:</span>
            <span>@TotalAmount.ToString("N2")</span>
        </div>

        @{
            double serviceAmount = 0;
            if (MyGlobals.ServiceCharge.ChargeType == "PERCENTAGE")
            {
                serviceAmount = (MyGlobals.ServiceCharge.Amount / 100) * TotalAmount;
            }
            else if (MyGlobals.ServiceCharge.ChargeType == "FLAT")
            {
                serviceAmount = MyGlobals.ServiceCharge.Amount;
            }

            // Tax is calculated on base amount (subtotal + service charge)
            var taxableAmount = TotalAmount + serviceAmount;
            var gstAmount = (MyGlobals.GST / 100) * taxableAmount;
            var grandTotal = taxableAmount + gstAmount;
        }

        @if (serviceAmount > 0)
        {
            @if (MyGlobals.ServiceCharge.ChargeType == "FLAT")
            {
                <div class="summary-row">
                    <span>Service Charges:</span>
                    <span>@serviceAmount.ToString("N2")</span>
                </div>
            }
            else if (MyGlobals.ServiceCharge.ChargeType == "PERCENTAGE")
            {
                <div class="summary-row">
                    <span>Service Charges @MyGlobals.ServiceCharge.Amount.ToString("N2")%:</span>
                    <span>@serviceAmount.ToString("N2")</span>
                </div>
            }
        }

        @if (MyGlobals.GST > 0)
        {
            <div class="summary-row">
                <span>Tax @MyGlobals.GST.ToString("N2")%:</span>
                <span>@gstAmount.ToString("N2")</span>
            </div>
        }

        <div class="summary-row grand-total">
            <span>Grand Total:</span>
            <span>@grandTotal.ToString("N2")</span>
        </div>
    </div>

    @if (MyGlobals._serviceType.ToUpper() == "PARCEL")
    {
        <div class="cart-item mt-4 p-4 rounded shadow-sm" style="background-color: #ffffff; border: 1px solid #e3e3e3;">
            <h5 class="text-primary fw-semibold mb-4">
                <i class="fas fa-box-open me-2"></i> Parcel Delivery Details
            </h5>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold text-muted">Name</label>
                    <InputText class="form-control form-control-sm" @bind-Value="party.PartyName" />
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold text-muted">Phone</label>
                    <InputText class="form-control form-control-sm" @bind-Value="party.PartyPhone" />
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold text-muted">Email</label>
                    <InputText class="form-control form-control-sm" @bind-Value="party.PartyEmail" />
                </div>

                <div class="col-12">
                    <label class="form-label fw-semibold text-muted">Address</label>
                    <InputText class="form-control form-control-sm" @bind-Value="party.PartyAddress" />
                </div>
            </div>
        </div>
    }


    <button class="btn mt-2" style="background-color: #512BD4; color: white; border-radius: 8px; padding: 12px 24px; font-weight: 600;" @onclick="PlaceOrder">
        <i class="fas fa-check-circle me-2"></i> Place Order
    </button>

   
</MudContainer>

@code {
    private double TotalAmount => CartState.CartItems?.Sum(i => i.RetailPrice * i.MaxQty) ?? 0;
    public InvoiceModel party { get; set; } = new();
    [CascadingParameter] private List<ItemsModel> _cart { get; set; }

    private void RemoveItem(ItemsModel item)
    {
        CartState.CartItems.Remove(item);
    }

    private async Task PlaceOrder()
    {
        var tranDate = DateTime.Now;
        var billDetails = CartState.CartItems.Select(item => new InvoiceItemReportModel
        {
            ItemId = item.Id,
            StockCondition = "NEW",
            Qty = item.MaxQty,
            UnitPrice = item.RetailPrice,
            TranDate = tranDate,
            Instructions = item.Description!,
            Status = "PENDING",
            ServingSize = item.ServingSize,
            Person = item.Person
        }).ToList();

        var bill = new InvoiceModel
        {
            OrganizationId = MyGlobals.Organization.Id,
            InvoiceType = "BILL",
            Source = "POS",
            TableId = CartState.SelectedTable?.Id ?? 0,
            SalesId = MyGlobals.User.EmpId,
            PartyId = 1,
            PartyName = party.PartyName ?? "",
            PartyPhone = party.PartyPhone ?? "",
            PartyEmail = party.PartyEmail ?? "",
            PartyAddress = party.PartyAddress ?? "",
            TranDate = tranDate,
            ServiceType = CartState.ServiceType,
            CreatedBy = MyGlobals.User.Id,
            CreatedOn = tranDate,
            CreatedFrom = Environment.MachineName,
            LocationId = MyGlobals.User.LocationId,
            Description = CartState.BillNote,
            BillAmount = Convert.ToDecimal(billDetails.Sum(d => d.Qty * Convert.ToDouble(d.UnitPrice)))
        };

        var request = new InvoicesModel
        {
            Invoice = bill,
            InvoiceDetails = new ObservableCollection<InvoiceItemReportModel>(billDetails)
        };

        var result = await MyFunctions.PostAsync<InvoicesModel>("Invoice/Insert", request, true);

        if (!result.Success)
        {
            await Application.Current.MainPage.DisplayAlert("❌ Save Failed", "Record not saved.", "OK");
        }
        else
        {
            await Application.Current.MainPage.DisplayAlert("✅ Save", "Record saved successfully.", "OK");
            CartState.Clear();
            _cart.Clear();
            Nav.NavigateTo($"/OrdersPage");
        }
    }

    private void IncreaseQty(ItemsModel item)
    {
        item.MaxQty++;
        StateHasChanged(); // To update UI
    }

    private void DecreaseQty(ItemsModel item)
    {
        if (item.MaxQty > 1)
        {
            item.MaxQty--;
            StateHasChanged(); // To update UI
        }
    }

    private void GoBackToOrderPage()
    {
        var tableId = CartState.SelectedTable?.Id ?? 0;
        var serviceType = CartState.ServiceType ?? "Dine-In";

        Nav.NavigateTo($"/OrderPage?tableId={tableId}");
    }
}


<style>
    .cart-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .cart-header h4 {
        color: white !important;
    }

    .cart-header .text-muted {
        color: rgba(255, 255, 255, 0.85) !important;
    }

    .cart-item {
        background-color: #fff;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transition: box-shadow 0.2s ease;
        border: 1px solid #E0E0E0;
    }

        .cart-item:hover {
            box-shadow: 0 8px 18px rgba(81, 43, 212, 0.2);
        }

        .cart-item h4 {
            margin: 0 0 0.5rem 0;
            font-weight: bold;
            font-size: 1rem;
            color: #222;
        }

        .cart-item small {
            color: #614D0A;
            font-size: 0.875rem;
        }

    .input-group {
        max-width: 120px;
        margin-top: 0.5rem;
    }

        .input-group .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            border: 1px solid #512BD4;
            color: #512BD4;
        }

        .input-group input {
            height: 32px;
            padding: 0 0.5rem;
            font-size: 0.9rem;
        }

    .cart-footer {
        font-size: 0.9rem;
        max-width: 450px;
        margin-left: auto;
        background-color: #f8f9fa;
        padding: 1rem 1.25rem;
        border-radius: 12px;
        border: 1px solid #E0E0E0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        font-size: 0.95rem;
        color: #444;
        border-bottom: 1px solid #e6e6e6;
    }

    .grand-total {
        font-weight: bold;
        font-size: 1.05rem;
        color: #512BD4;
        border-top: 2px solid #512BD4;
        margin-top: 10px;
        padding-top: 8px;
    }

</style>