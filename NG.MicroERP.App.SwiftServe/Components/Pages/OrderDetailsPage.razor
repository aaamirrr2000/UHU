@page "/OrderDetailsPage/{Action}/{id:int}"
@layout MyMenuLayout
@inject NavigationManager Nav

<h2 class="text-center mb-4 text-dark" style="font-family: 'Orbitron', sans-serif; font-size: 30px;">
    
    <button class="btn btn-outline-primary rounded-pill px-3 py-2"
            @onclick="GoBack"
            title="Back to Order">
        <i class="fas fa-arrow-left"></i>
    </button>

    <i class="fas fa-receipt text-secondary me-2"></i> 
    
    @if(Action == "ORDER")
    {
        <span>Order Summary</span>
    }    
    else
    {
        <span>Table Summary</span>
    }
</h2>

@if (Bills.Bill != null)
{
    <div class="mb-3 text-center fw-bold">
        Order #: @Bills.Bill?.SeqNo &nbsp;|&nbsp;
        Table #: @Bills.Bill?.TableName &nbsp;|&nbsp;
        Total Items: @BillDetails.Count
    </div>

   @foreach (var group in BillDetails.GroupBy(x => x.Person))
    {
        <div class="mb-4">
            <h5 class="text-primary">
                <i class="fas fa-chair me-2"></i> Person/Chair: @group.Key
            </h5>

            @foreach (var item in group)
            {
                <div class="border rounded shadow-sm p-3 mb-3 bg-light">
                    <div class="row align-items-center">
                        <!-- Left Column: Item Info -->
                        <div class="col-md-8">
                            <div class="mb-1">
                                <strong>Item:</strong>
                                <span class="text-success">@item.Item</span>
                                <span class="text-primary ms-2">@item.ServingSize</span>
                            </div>
                            <div class="mb-1">
                                @item.Qty x @item.UnitPrice.ToString("N2") = <strong>@item.Item_Amount.ToString("N2")</strong>
                            </div>
                            <div class="mb-1">
                                <strong>Status:</strong>
                                @if (item.BillDetailStatus == "COMPLETE")
                                {
                                    <span class="badge bg-success">Completed</span>
                                }
                                else if (item.BillDetailStatus == "CANCEL")
                                {
                                    <span class="badge bg-danger text-dark">Cancel</span>
                                }
                                else if (item.BillDetailStatus == "READY")
                                {
                                    <span class="badge bg-info text-dark">Ready</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                            </div>
                        </div>

                        <!-- Right Column: Buttons -->
                        <div class="col-md-4 text-md-end text-start">
                            <div class="d-flex justify-content-md-end justify-content-start gap-2">
                                @if (item.BillDetailStatus != "COMPLETE" && item.BillDetailStatus != "READY" && Globals.User.UserType != "KITCHEN")
                                {
                                    <button class="btn btn-danger btn-sm" @onclick="@(() => OrderStatus(item, "CANCEL", 1))">
                                        <i class="fas fa-times-circle me-1"></i> Cancel
                                    </button>
                                }

                                @if (Globals.User.UserType == "KITCHEN" && item.BillDetailStatus=="PENDING")
                                {
                                    <button class="btn btn-info btn-sm" @onclick="@(() => OrderStatus(item, "READY"))">
                                        <i class="fas fa-check-circle me-1"></i> Ready
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>


            }
        </div>
    }
}
else
{
    <div class="text-muted text-center">Loading order details...</div>
}

@code {
    [Parameter] public int id { get; set; }
    [Parameter] public string Action { get; set; } = "ORDER";
    private Bill_And_Bill_Detail_Model Bills = new();
    private ObservableCollection<BillDetailModel> BillDetails = new();

    protected override async Task OnInitializedAsync()
    {
        Globals.PageTitle = "Order View";
        await LoadBills(id);
    }

    private async Task LoadBills(int Id)
    {
        string bill_url = string.Empty;
        string billDetail_url = string.Empty;
        if (Action == "ORDER")
        {
            bill_url = $"Bill/Search/bill.Id={Id}";
            billDetail_url = $"BillDetail/Search/BillDetail.BillId={Id}";
        }
        else if (Action == "TABLE")
        {
            bill_url = $"Bill/Search/bill.TableId={Id}";
            //billDetail_url = $"BillDetail/Search/Bill.TableId={Id} AND BillDetail.Status!='COMPLETE' and Bill.Status!='COMPLETE'";
            billDetail_url = $"BillDetail/Search/Bill.TableId={Id} and Bill.Status!='COMPLETE'";
        }


        var res = await Functions.GetAsync<List<BillModel>>(bill_url, true);
        if (res != null && res.Count > 0)
        {
            Bills.Bill = res.First();

            var res1 = await Functions.GetAsync<List<BillDetailModel>>(billDetail_url, true);
            if (res1 != null)
            {
                BillDetails.Clear();
                foreach (var item in res1)
                {
                    BillDetails.Add(item);
                }
            }
        }
    }

    private string GetTotal() => BillDetails.Sum(x => x.Item_Amount).ToString("N2");


    private async void OrderStatus(BillDetailModel item, string Status, int IsSoftDelete=0)
    {
        bool confirm = await App.Current.MainPage.DisplayAlert("Item Status", $"{Status} Item: {item.Item}?", "Yes", "No");
        if (!confirm)
            return;

        var res = await Functions.PostAsync<BillDetailModel>($"BillDetail/BillItemStatus/{item.Id}/{Status}/{IsSoftDelete}", null, true);
        if (res.Success)
            await Application.Current.MainPage.DisplayAlert("✅ Done", $"The item status is now set to {Status}.", "Great!");
        else
            await Application.Current.MainPage.DisplayAlert("❌ Status Update Failed", $"Unable to mark item as {Status}. Please try again.", "OK");

        await LoadBills(id);
        StateHasChanged();
        BillDetails.Remove(item);
    }

    private void GoBack()
    {
        Nav.NavigateTo($"/OrdersPage");
    }
}
