@page "/"
@page "/OrdersPage"
@using System.Text

@layout MyMenuLayout
@inject NavigationManager Nav
@inject Globals Globals
@implements IDisposable

<div class="row g-2 align-items-end mb-3">
    <!-- Date Input -->
    <div class="col-4 col-md-4 col-sm-6">
        <label class="form-label fw-semibold text-muted">Date</label>
        <input type="date" class="form-control form-control-sm"
               @bind="FromDate" @bind:event="oninput" />
    </div>

    <!-- Search Input -->
    <div class="col-5 col-md-6 col-sm-6">
        <label class="form-label fw-semibold text-muted">Search</label>
        <input type="text" class="form-control form-control-sm"
               placeholder="Search"
               @bind="SearchQuery" @bind:event="oninput" />
    </div>

    <!-- Refresh Button -->
    <div class="col-1 col-md-1">
        <button class="btn btn-info" @onclick="LoadBills"> <i class="fas fa-search m-2"></i></button>
    </div>
</div>


<div class="orders-container">


    @if (FilteredBills?.Any() == true)
    {
        @foreach (var bill in FilteredBills)
        {
            <div class="bill-card p-3 border rounded shadow-sm mb-4 bg-white">
                <div class="d-flex justify-content-between align-items-stretch">
                    <!-- Left Column: Bill Info -->
                    <div class="pe-3 flex-grow-1 d-flex flex-column justify-content-between">
                      <div>

                            <div class="pb-2 mb-2 border-bottom text-muted small d-flex align-items-center" style="font-size: 16px;">
                                <i class="fas fa-chair text-primary me-2"></i>
                                <strong class="text-dark me-1">Table:</strong> @bill.TableName
                                <div class="pb-2 ml-5 d-flex align-items-center" style="font-size: 16px;">
                                    @* <i class="fas fa-flag text-warning me-2"></i> *@
                                    @if (bill.Status == "COMPLETE")
                                    {
                                        <span class="badge rounded-pill bg-success px-3 py-1">Completed</span>
                                    }
                                    else if (bill.Status == "CANCEL")
                                    {
                                        <span class="badge rounded-pill bg-danger px-3 py-1">Cancelled</span>
                                    }
                                    else if (bill.Status == "READY")
                                    {
                                        <span class="badge rounded-pill bg-info px-3 py-1">Ready</span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill bg-warning text-dark px-3 py-1">Pending</span>
                                    }
                                </div>
                            </div>

                            <div class="pb-2 mb-2 border-bottom text-muted small d-flex align-items-center" style="font-size: 16px;">
                                <i class="fas fa-utensils text-primary me-2"></i>
                                <strong class="text-dark me-1">Service:</strong> @bill.ServiceType
                            </div>


                            <div class="pb-2 mb-2 border-bottom text-muted small d-flex align-items-center" style="font-size: 16px;">
                                <i class="fas fa-file-invoice text-info me-2"></i>
                                <strong class="text-dark me-1">Bill:</strong> @bill.SeqNo
                            </div>

                            @if(@bill.PartyName != string.Empty)
                            {
                                <div class="pb-2 mb-2 border-bottom text-muted small d-flex align-items-center" style="font-size: 16px;">
                                    <i class="fas fa-user text-secondary me-2"></i>
                                    <strong class="text-dark me-1">Customer:</strong> @bill.PartyName
                                </div>
                            }

                            @if (bill.Status != "COMPLETE" && bill.Status != "READY")
                            {
                                <div class="pb-2 mb-2 border-bottom text-muted small d-flex align-items-center" style="font-size: 16px;">
                                    <i class="far fa-clock text-primary me-2"></i>
                                    <strong class="me-1" style="color: red;">Waiting Time: @bill.ElapsedTime</strong> 
                                </div>
                            }
                            <div class="pb-2 mb-2 border-bottom text-muted small d-flex align-items-center" style="font-size: 16px;">
                                <i class="fas fa-user text-primary me-2"></i>
                                <strong class="text-dark me-1">Nico:</strong> @Globals.User.FullName
                            </div>

                        </div>

                    </div>

                    <!-- Common Button Style: Icon on Top, Label Below -->
                    <div class="d-flex flex-column align-items-center gap-2">

                        <!-- View Button -->
                        <button class="btn btn-info btn-sm" @onclick="@(() => EditBill(bill))">
                            <i class="fas fa-eye fa-sm me-1"></i> View
                        </button>

                        @if (Globals.User.UserType == "WAITER")
                        {
                            @if (bill.Status != "COMPLETE" && bill.Status != "READY")
                            {
                                <!-- Delete Button -->
                                <button class="btn btn-danger btn-sm" @onclick="@(() => DeleteBill(bill))">
                                    <i class="fas fa-trash fa-sm me-1"></i> Delete
                                </button>
                            }

                            <!-- Generate Bill Button -->
                            <button class="btn btn-success btn-sm" @onclick="@(() => OnGenerateBill(bill))">
                                <i class="fas fa-file-invoice fa-sm me-1"></i> @(bill.Status != "COMPLETE" ? "Gen. Bill" : "Bill")
                            </button>

                            <!-- Notes Button -->
                            <button class="btn btn-primary btn-sm" @onclick="@(() => ClientComments(bill))">
                                <i class="fas fa-comment-dots fa-sm me-1"></i> Notes
                            </button>

                        }
                        else if (Globals.User.UserType == "KITCHEN")
                        {
                            @if (bill.Status != "READY")
                            {
                                <!-- Ready Button -->
                                <button class="btn btn-info btn-sm" @onclick="@(() => OrderStatusUpdate(bill, "READY"))">
                                    <i class="fas fa-check-circle me-1"></i> Ready
                                </button>
                            }
                        }
                    </div>

                </div>
            </div>

        }
    }
    else
    {
        <p class="text-muted fst-italic">No bills found.</p>
    }

</div>

@code {
    private DateTime FromDate = DateTime.Today;
    private string SearchQuery = string.Empty;
    private string status = "READY";

    private List<BillModel> AllBills = new();
    private List<BillModel> FilteredBills = new();
    private System.Timers.Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        Globals.PageTitle = "Orders";
        await LoadBills();
        StartTimer();
    }

    private async Task LoadBills()
    {
        // Use organization's GMT offset to convert local date to UTC range
        double gmtOffset = Convert.ToDouble( Globals.Organization.GMT); // e.g., 5

        var localStart = FromDate.Date;
        var localEnd = localStart.AddDays(1);

        // Convert from local to UTC using offset
        var utcStart = localStart.AddHours(-gmtOffset);
        var utcEnd = localEnd.AddHours(-gmtOffset);

        // Create SQL-friendly range based on UTC
        string criteria = $"bill.TranDate >= '{utcStart:yyyy-MM-dd HH:mm:ss}' AND bill.TranDate < '{utcEnd:yyyy-MM-dd HH:mm:ss}'";

        var res = await Functions.GetAsync<List<BillModel>>($"Bill/Search/{criteria}", true);
        if (res != null)
        {
            AllBills = res;

            foreach (var item in AllBills)
            {
                item.ElapsedTime = GetElapsedTime(item.CreatedOn);
            }
        }
        else
        {
            AllBills.Clear();
        }

        ApplySearch();
    }

    private void ApplySearch()
    {
        string query = SearchQuery.ToLowerInvariant();
        FilteredBills = AllBills.Where(b =>
            string.IsNullOrEmpty(query) ||
            (b.SeqNo?.ToLower().Contains(query) ?? false) ||
            (b.PartyName?.ToLower().Contains(query) ?? false) ||
            (b.Party?.ToLower().Contains(query) ?? false)
        ).ToList();
    }

    private async Task DeleteBill(BillModel bill)
    {
        bool confirm = await App.Current.MainPage.DisplayAlert("Delete", $"Delete Bill ID: {bill.SeqNo}?", "Yes", "No");

        if (confirm)
        {
            try
            {
                bill.UpdatedBy = Globals.User.Id;
                await Functions.PostAsync<List<BillModel>>("Bill/SoftDelete", bill, true);
                await LoadBills();
            }
            catch (Exception ex)
            {
                await App.Current.MainPage.DisplayAlert("Error", $"An error occurred: {ex.Message}", "OK");
            }
        }
    }

    string GetElapsedTime(DateTime? created)
    {
        if (created == null) return "N/A";

        var span = DateTime.UtcNow - created.Value;

        return $"{(int)span.TotalHours:00}:{span.Minutes:00}:{span.Seconds:00}";
    }

    private void StartTimer()
    {
        _refreshTimer = new System.Timers.Timer(1000); // 1 second
        _refreshTimer.Elapsed += RefreshElapsedTime;
        _refreshTimer.AutoReset = true;
        _refreshTimer.Start();
    }

    private async void RefreshElapsedTime(object sender, System.Timers.ElapsedEventArgs e)
    {
        await InvokeAsync(() =>
        {
            foreach (var item in AllBills)
            {
                item.ElapsedTime = GetElapsedTime(item.CreatedOn);
            }

            StateHasChanged();
        });
    }

    public void Dispose()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
    }

    private async Task ClientComments(BillModel bill)
    {
        Nav.NavigateTo($"/ClientFeedbackPage/{bill.Id}");
    }

    private void EditBill(BillModel bill)
    {
        Nav.NavigateTo($"/OrderDetailsPage/ORDER/{bill.Id}");
    }

    private void OnGenerateBill(BillModel bill)
    {
        Nav.NavigateTo($"/GenerateBillPage/{bill.Id}");
    }

     private async void OrderStatusUpdate(BillModel item, string Status)
    {
        bool confirm = await App.Current.MainPage.DisplayAlert("Status", $"Update Bill Status ID: {item.SeqNo}?", "Yes", "No");
        if (!confirm)
            return;

        var res = await Functions.PostAsync<BillModel>($"Bill/BillStatus/{item.Id}/{Status}/0", null, true);
        if (res.Success)
           await Application.Current.MainPage.DisplayAlert("✅ Done", $"The item status is now set to {Status}.", "Great!");
        else
            await Application.Current.MainPage.DisplayAlert("❌ Status Update Failed", $"Unable to mark the item as {Status}. Please try again.", "OK");

        await LoadBills();
        StateHasChanged();
    }
}


<style>
    .orders-container {
        padding: 1rem;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-control {
        height: 38px;
        font-size: 0.95rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        padding: 0 0.5rem;
    }

    .btn {
        min-width: 90px;
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 6px;
    }

    .btn-refresh {
        background-color: #2980b9;
        color: white;
        border: none;
    }

        .btn-refresh:hover {
            background-color: #1f6391;
        }

    /* Card for each bill */
    .bill-card {
        background: #fff;
        border: 2px solid #dcdcdc;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* First row: labels */
    .bill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    .bill-col {
        flex: 1;
        min-width: 150px;
    }

    /* Second row: equal buttons */
    .bill-actions {
        display: flex;
        gap: 10px;
    }

        .bill-actions .btn {
            flex: 1;
        }

    /* Button styles */
    .btn-info {
        background-color: #3498db;
        color: white;
        border: none;
    }

        .btn-info:hover {
            background-color: #2c80b4;
        }

    .btn-danger {
        background-color: #e74c3c;
        color: white;
        border: none;
    }

        .btn-danger:hover {
            background-color: #c0392b;
        }

    .btn-warning {
        background-color: #f39c12;
        color: white;
        border: none;
    }

        .btn-warning:hover {
            background-color: #d78b0d;
        }

    .bill-actions {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .service-button {
        border-radius: 0.5rem;
        transition: transform 0.2s;
    }

        .service-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

    .form-label {
        font-size: 0.9rem;
    }

    input.form-control-sm {
        border-radius: 0.375rem;
        font-size: 0.9rem;
    }

</style>
