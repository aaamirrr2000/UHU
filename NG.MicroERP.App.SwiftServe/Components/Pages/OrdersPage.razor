@page "/"
@page "/OrdersPage"
@using System.Text

@layout MyMenuLayout
@inject NavigationManager Nav
@inject Globals Globals
@* @inject JSRuntime JS
@inject HttpClient Http *@

<div class="orders-container">
    <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" @bind="FromDate" @bind:event="oninput" />
    </div>

    <div class="form-group">
        <label>Search</label>
        <input type="text" class="form-control" placeholder="Search" @bind="SearchQuery" @bind:event="oninput" />
    </div>

    <div class="form-group">
        <button class="btn btn-outline-info " @onclick="LoadBills">Refresh</button>
    </div>

    @if (FilteredBills?.Any() == true)
    {
        @foreach (var bill in FilteredBills)
        {
            <div class="bill-card p-3 border rounded shadow-sm mb-3 bg-white">
                <div class="bill-row d-flex flex-wrap justify-content-between mb-2">
                    <div class="bill-col"><strong>Table:</strong> @bill.TableName</div>
                    <div class="bill-col"><strong>Bill:</strong> @bill.SeqNo</div>
                    <div class="bill-col"><strong>Customer:</strong> @bill.PartyName</div>
                    <div class="bill-col"><strong>Amount:</strong> @bill.BillAmount.ToString("#,##0.00")</div>
                    <div class="bill-col"><strong>Status:</strong> @bill.Status</div>
                </div>

                <div class="bill-actions d-flex flex-wrap gap-2">
                    <!-- View Button -->
                    <button class="btn w-100 px-3 py-3 text-center service-button"
                            style="background-color: #17a2b8; color: white;"
                            @onclick="() => EditBill(bill)">
                        <div class="mb-1">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                        <div class="fw-semibold small">View</div>
                    </button>

                    @if (bill.IsDeleteVisible)
                    {
                        <!-- Delete Button -->
                        <button class="btn w-100 px-3 py-3 text-center service-button"
                                style="background-color: #dc3545; color: white;"
                                @onclick="() => DeleteBill(bill)">
                            <div class="mb-1">
                                <i class="fas fa-trash fa-2x"></i>
                            </div>
                            <div class="fw-semibold small">Delete</div>
                        </button>
                    }

                    <!-- Generate Bill Button -->
                    <button class="btn w-100 px-3 py-3 text-center service-button"
                            style="background-color: #ffc107; color: #212529;"
                            @onclick="() => OnGenerateBill(bill)">
                        <div class="mb-1">
                            <i class="fas fa-file-invoice fa-2x"></i>
                        </div>
                        <div class="fw-semibold small">@((bill.Status != "COMPLETE") ? "Gen. Bill" : "Bill")</div>
                    </button>

                    <!-- Comments Button -->
                    <button class="btn w-100 px-3 py-3 text-center service-button"
                            style="background-color: #28a745; color: white;"
                            @onclick="() => ClientComments(bill)">
                        <div class="mb-1">
                            <i class="fas fa-comment-dots fa-2x"></i>
                        </div>
                        <div class="fw-semibold small">Notes</div>
                    </button>
                </div>


            </div>
        }
    }
    else
    {
        <p>No bills found.</p>
    }
</div>


@code {
    private DateTime FromDate = DateTime.Today;
    private string SearchQuery = string.Empty;

    private List<BillModel> AllBills = new();
    private List<BillModel> FilteredBills = new();

    protected override async Task OnInitializedAsync()
    {
        Globals.PageTitle = "Orders";
        StateHasChanged();
        await LoadBills();
    }

    private async Task LoadBills()
    {
        string date = FromDate.ToString("yyyy-MM-dd");
        string criteria = $"CAST(bill.TranDate AS DATE)='{date}'";

        var res = await Functions.GetAsync<List<BillModel>>($"Bill/Search/{criteria}", true);
        if (res != null)
        {
            AllBills = res;

            foreach (var item in AllBills)
            {
                item.IsDeleteVisible = item.TranDate.Date == DateTime.Today && item.Status != "COMPLETE";
                item.IsStatusVisible = item.Status != "COMPLETE";
            }

            ApplySearch();
        }
        else
        {
            AllBills.Clear();
            ApplySearch();
        }
    }

    private void ApplySearch()
    {
        string query = SearchQuery.ToLowerInvariant();
        FilteredBills = AllBills.Where(b =>
            string.IsNullOrEmpty(query) ||
            (b.SeqNo?.ToLower().Contains(query) ?? false) ||
            (b.PartyName?.ToLower().Contains(query) ?? false) ||
            (b.Party?.ToLower().Contains(query) ?? false)
        ).ToList();
    }

    private async Task DeleteBill(BillModel bill)
    {
        bool confirm = await App.Current.MainPage.DisplayAlert("Delete", $"Delete Bill ID: {bill.SeqNo}?", "Yes", "No");

        if (confirm)
        {
            try
            {
                bill.UpdatedBy = Globals.User.Id;
                await Functions.PostAsync<List<BillModel>>("Bill/SoftDelete", bill, true);
                await LoadBills();
            }
            catch (Exception ex)
            {
                await App.Current.MainPage.DisplayAlert("Error", $"An error occurred: {ex.Message}", "OK");
            }
        }
    }

    // private async Task MarkComplete(BillModel bill)
    // {
    //     var res = await Functions.PostAsync<List<BillModel>>($"Bill/StatusUpdate/COMPLETE", bill, true);
    //     if (res.Success)
    //     {
    //         await App.Current.MainPage.DisplayAlert("Status Update", "Order marked as complete.", "OK");
    //     }
    //     else
    //     {
    //         await App.Current.MainPage.DisplayAlert("Error", $"Could not update status of Bill {bill.SeqNo}", "OK");
    //     }

    //     await LoadBills();
    // }

    private async Task ClientComments(BillModel bill)
    {
        Nav.NavigateTo($"/ClientFeedbackPage/{bill.Id}");
    }

    private void EditBill(BillModel bill)
    {
        Nav.NavigateTo($"/OrderDetailsPage/ORDER/{bill.Id}");
    }

    private void OnGenerateBill(BillModel bill)
    {
        Nav.NavigateTo($"/GenerateBillPage/{bill.Id}");
    }


    public async Task DownloadPdfAsync()
    {
        // var html = "<h1>Hello PDF</h1><p>This is a test.</p>";

        // var requestPayload = new { Html = html };
        // var json = JsonSerializer.Serialize(requestPayload);
        // var content = new StringContent(json, Encoding.UTF8, "application/json");

        // var response = await Http.PostAsync("https://localhost:7019/api/GeneratePDF", content);

        // if (response.IsSuccessStatusCode)
        // {
        //     var pdfBytes = await response.Content.ReadAsByteArrayAsync();
        //     var base64 = Convert.ToBase64String(pdfBytes);
        //     var url = $"data:application/pdf;base64,{base64}";
        //     await JS.InvokeVoidAsync("open", url, "_blank");
        // }
        // else
        // {
        //     Console.WriteLine("PDF generation failed.");
        // }
    }
}


<style>
    .orders-container {
        padding: 1rem;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-control {
        height: 38px;
        font-size: 0.95rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        padding: 0 0.5rem;
    }

    .btn {
        min-width: 90px;
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 6px;
    }

    .btn-refresh {
        background-color: #2980b9;
        color: white;
        border: none;
    }

        .btn-refresh:hover {
            background-color: #1f6391;
        }

    /* Card for each bill */
    .bill-card {
        background: #fff;
        border: 2px solid #dcdcdc;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* First row: labels */
    .bill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    .bill-col {
        flex: 1;
        min-width: 150px;
    }

    /* Second row: equal buttons */
    .bill-actions {
        display: flex;
        gap: 10px;
    }

        .bill-actions .btn {
            flex: 1;
        }

    /* Button styles */
    .btn-info {
        background-color: #3498db;
        color: white;
        border: none;
    }

        .btn-info:hover {
            background-color: #2c80b4;
        }

    .btn-danger {
        background-color: #e74c3c;
        color: white;
        border: none;
    }

        .btn-danger:hover {
            background-color: #c0392b;
        }

    .btn-warning {
        background-color: #f39c12;
        color: white;
        border: none;
    }

        .btn-warning:hover {
            background-color: #d78b0d;
        }

    .bill-actions {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

</style>
